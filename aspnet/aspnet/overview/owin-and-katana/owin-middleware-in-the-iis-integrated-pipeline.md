---
uid: aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
title: "OWIN ミドルウェア iis 統合パイプライン |Microsoft ドキュメント"
author: Praburaj
description: "ここでは、IIS 統合パイプラインの OWIN ミドルウェア コンポーネント (OMCs) を実行する方法を説明し、OMC パイプライン イベントを設定する方法が実行します。 行う必要があります."
ms.author: aspnetcontent
manager: wpickett
ms.date: 11/07/2013
ms.topic: article
ms.assetid: d031c021-33c2-45a5-bf9f-98f8fa78c2ab
ms.technology: 
ms.prod: .net-framework
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
msc.type: authoredcontent
ms.openlocfilehash: 5f6ed1ae0309e9bdd3ca4ae229195835f20bc729
ms.sourcegitcommit: a510f38930abc84c4b302029d019a34dfe76823b
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/30/2018
---
<a name="owin-middleware-in-the-iis-integrated-pipeline"></a><span data-ttu-id="d22f7-104">IIS 統合パイプラインの OWIN ミドルウェア</span><span class="sxs-lookup"><span data-stu-id="d22f7-104">OWIN Middleware in the IIS integrated pipeline</span></span>
====================
<span data-ttu-id="d22f7-105">によって[Praburaj Thiagarajan](https://github.com/Praburaj)、 [Rick Anderson](https://github.com/Rick-Anderson)</span><span class="sxs-lookup"><span data-stu-id="d22f7-105">by [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span></span>

> <span data-ttu-id="d22f7-106">ここでは、IIS 統合パイプラインの OWIN ミドルウェア コンポーネント (OMCs) を実行する方法を説明し、OMC パイプライン イベントを設定する方法が実行します。</span><span class="sxs-lookup"><span data-stu-id="d22f7-106">This article shows how to run OWIN middleware Components (OMCs) in the IIS integrated pipeline, and how to set the pipeline event an OMC runs on.</span></span> <span data-ttu-id="d22f7-107">確認する必要があります[プロジェクト Katana の概要を](an-overview-of-project-katana.md)と[OWIN スタートアップ クラス検出](owin-startup-class-detection.md)このチュートリアルを読む前にします。</span><span class="sxs-lookup"><span data-stu-id="d22f7-107">You should review [An Overview of Project Katana](an-overview-of-project-katana.md) and [OWIN Startup Class Detection](owin-startup-class-detection.md) before reading this tutorial.</span></span> <span data-ttu-id="d22f7-108">このチュートリアルは、Rick Anderson によって書き込まれました ( [ @RickAndMSFT ](https://twitter.com/#!/RickAndMSFT) )、Chris Ross、Praburaj Thiagarajan および Howard Dierking ( [ @howard \_dierking](https://twitter.com/howard_dierking) )。</span><span class="sxs-lookup"><span data-stu-id="d22f7-108">This tutorial was written by Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ), Chris Ross, Praburaj Thiagarajan, and Howard Dierking ( [@howard\_dierking](https://twitter.com/howard_dierking) ).</span></span>


<span data-ttu-id="d22f7-109">[OWIN](an-overview-of-project-katana.md)ミドルウェア コンポーネント (OMCs) がサーバーにもとらわれないパイプラインで実行する主な用途は、IIS 統合パイプラインも、OMC を実行することは (**クラシック モードが*いない*サポート**)。</span><span class="sxs-lookup"><span data-stu-id="d22f7-109">Although [OWIN](an-overview-of-project-katana.md) middleware components (OMCs) are primarily designed to run in a server-agnostic pipeline, it is possible to run an OMC in the IIS integrated pipeline as well (**classic mode is *not* supported**).</span></span> <span data-ttu-id="d22f7-110">パッケージ マネージャー コンソール (PMC) から、次のパッケージをインストールすることで、IIS 統合パイプラインで動作する、OMC を変更できます。</span><span class="sxs-lookup"><span data-stu-id="d22f7-110">An OMC can be made to work in the IIS integrated pipeline by installing the following package from the Package Manager Console (PMC):</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample1.cmd)]

<span data-ttu-id="d22f7-111">これはまだ IIS と、System.Web の外部で実行できるものも、すべてのアプリケーション フレームワークが既存の OWIN ミドルウェア コンポーネントを活用できることを意味します。</span><span class="sxs-lookup"><span data-stu-id="d22f7-111">This means that all application frameworks, even those that are not yet able to run outside of IIS and System.Web, can benefit from existing OWIN middleware components.</span></span> 

> [!NOTE]
> <span data-ttu-id="d22f7-112">すべての`Microsoft.Owin.Security.*`Visual Studio 2013 で新しい Id システムと配布のパッケージ (例: Cookie、Microsoft アカウント、Google、Facebook、Twitter、[ベアラー トークン](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html)OAuth、承認サーバー、JWT、Azure Activeディレクトリ、および Active directory フェデレーション サービス) OMCs、として作成されたおよびと IIS でホストされる自己ホスト型の両方のシナリオで使用できます。</span><span class="sxs-lookup"><span data-stu-id="d22f7-112">All of the `Microsoft.Owin.Security.*` packages shipping with the new Identity System in Visual Studio 2013 (for example: Cookies, Microsoft Account, Google, Facebook, Twitter, [Bearer Token](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, Authorization server, JWT, Azure Active directory, and Active directory federation services) are authored as OMCs, and can be used in both self-hosted and IIS-hosted scenarios.</span></span>

## <a name="how-owin-middleware-executes-in-the-iis-integrated-pipeline"></a><span data-ttu-id="d22f7-113">IIS 統合パイプラインの OWIN ミドルウェアを実行する方法</span><span class="sxs-lookup"><span data-stu-id="d22f7-113">How OWIN Middleware Executes in the IIS Integrated Pipeline</span></span>

<span data-ttu-id="d22f7-114">、コンソール アプリケーションの OWIN アプリケーション パイプライン ビルドを使用して、[起動構成](owin-startup-class-detection.md)を使用して、コンポーネントが追加された順序によって設定されている、`IAppBuilder.Use`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="d22f7-114">For OWIN console applications, the application pipeline built using the [startup configuration](owin-startup-class-detection.md) is set by the order the components are added using the `IAppBuilder.Use` method.</span></span> <span data-ttu-id="d22f7-115">OWIN パイプライン、 [Katana](an-overview-of-project-katana.md)ランタイムを使用して、登録済みの順序で OMCs の処理は`IAppBuilder.Use`します。</span><span class="sxs-lookup"><span data-stu-id="d22f7-115">That is, the OWIN pipeline in the [Katana](an-overview-of-project-katana.md) runtime will process OMCs in the order they were registered using `IAppBuilder.Use`.</span></span> <span data-ttu-id="d22f7-116">要求パイプラインは、IIS 統合パイプラインの[HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx)など、定義済みの一連のパイプライン イベントにサブスクライブしている[BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx)、 [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)、 [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), などです。</span><span class="sxs-lookup"><span data-stu-id="d22f7-116">In the IIS integrated pipeline the request pipeline consists of [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) subscribed to a pre-defined set of the pipeline events such as [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etc.</span></span>

<span data-ttu-id="d22f7-117">比較、OMC の場合、 [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx)世界では、ASP.NET、OMC を正しい定義済みのパイプラインのイベントに登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d22f7-117">If we compare an OMC to that of an [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) in the ASP.NET world, an OMC must be registered to the correct pre-defined pipeline event.</span></span> <span data-ttu-id="d22f7-118">HttpModule など`MyModule`要求を受信ときに呼び出されるが、 [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)パイプラインのステージで。</span><span class="sxs-lookup"><span data-stu-id="d22f7-118">For example, the HttpModule `MyModule` will get invoked when a request comes to the [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) stage in the pipeline:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample2.cs?highlight=10)]

<span data-ttu-id="d22f7-119">OMC この、イベント ベースの同時実行の順序に参加するために、 [Katana](an-overview-of-project-katana.md)ランタイム コードのスキャン、[起動構成](owin-startup-class-detection.md)のミドルウェア コンポーネントごとに定期受信し、統合パイプラインのイベントです。</span><span class="sxs-lookup"><span data-stu-id="d22f7-119">In order for an OMC to participate in this same, event-based execution ordering, the [Katana](an-overview-of-project-katana.md) runtime code scans through the [startup configuration](owin-startup-class-detection.md) and subscribes each of the middleware components to an integrated pipeline event.</span></span> <span data-ttu-id="d22f7-120">たとえば、OMC と登録の次のコードを使用すると、ミドルウェア コンポーネントの既定のイベント登録を確認できます。</span><span class="sxs-lookup"><span data-stu-id="d22f7-120">For example, the following OMC and registration code enables you to see the default event registration of middleware components.</span></span> <span data-ttu-id="d22f7-121">(詳細については、OWIN スタートアップ クラスを作成する手順についてを参照してください[OWIN スタートアップ クラス検出](owin-startup-class-detection.md))。</span><span class="sxs-lookup"><span data-stu-id="d22f7-121">(For more detailed instructions on creating an OWIN startup class, see [OWIN Startup Class Detection](owin-startup-class-detection.md).)</span></span>

1. <span data-ttu-id="d22f7-122">空の web アプリケーション プロジェクトを作成し、名前を付けます**owin2**です。</span><span class="sxs-lookup"><span data-stu-id="d22f7-122">Create an empty web application project and name it **owin2**.</span></span>
2. <span data-ttu-id="d22f7-123">パッケージ マネージャー コンソール (PMC) からは、次のコマンドを実行します。</span><span class="sxs-lookup"><span data-stu-id="d22f7-123">From the Package Manager Console (PMC), run the following command:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample3.cmd)]
3. <span data-ttu-id="d22f7-124">追加、`OWIN Startup Class`し名前を付けます`Startup`です。</span><span class="sxs-lookup"><span data-stu-id="d22f7-124">Add an `OWIN Startup Class` and name it `Startup`.</span></span> <span data-ttu-id="d22f7-125">生成されたコードを (変更が強調表示されます)、次に置き換えます。</span><span class="sxs-lookup"><span data-stu-id="d22f7-125">Replace the generated code with the following (the changes are highlighted):</span></span>  

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample4.cs?highlight=5-7,15-36)]
4. <span data-ttu-id="d22f7-126">F5 キーを押して、アプリを実行します。</span><span class="sxs-lookup"><span data-stu-id="d22f7-126">Hit F5 to run the app.</span></span>

<span data-ttu-id="d22f7-127">スタートアップ構成は、次の 3 つのミドルウェア コンポーネントと、最初の 2 つの診断情報とイベントに応答する最後の 1 つの表示 (も診断情報の表示) パイプラインを設定します。</span><span class="sxs-lookup"><span data-stu-id="d22f7-127">The Startup configuration sets up a pipeline with three middleware components, the first two displaying diagnostic information and the last one responding to events (and also displaying diagnostic information).</span></span> <span data-ttu-id="d22f7-128">`PrintCurrentIntegratedPipelineStage`メソッドは、このミドルウェアはで呼び出される統合パイプラインのイベントとメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="d22f7-128">The `PrintCurrentIntegratedPipelineStage` method displays the integrated pipeline event this middleware is invoked on and a message.</span></span> <span data-ttu-id="d22f7-129">出力ウィンドウには、次の情報が表示されます。</span><span class="sxs-lookup"><span data-stu-id="d22f7-129">The output windows displays the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample5.cmd)]

<span data-ttu-id="d22f7-130">Katana ランタイムをマップする OWIN ミドルウェア コンポーネントの各[PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) IIS パイプライン イベントに対応する既定では、 [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="d22f7-130">The Katana runtime mapped each of the OWIN middleware components to [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) by default, which corresponds to the IIS pipeline event [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span></span>

## <a name="stage-markers"></a><span data-ttu-id="d22f7-131">ステージ マーカー</span><span class="sxs-lookup"><span data-stu-id="d22f7-131">Stage Markers</span></span>

<span data-ttu-id="d22f7-132">使用して、パイプラインの特定の段階で実行する OMCs をマークすることができます、`IAppBuilder UseStageMarker()`拡張メソッド。</span><span class="sxs-lookup"><span data-stu-id="d22f7-132">You can mark OMCs to execute at specific stages of the pipeline by using the `IAppBuilder UseStageMarker()` extension method.</span></span> <span data-ttu-id="d22f7-133">最後の要素の直後にステージ マーカーを挿入する特定のステージ中にミドルウェア コンポーネントのセットを実行するには、セットを登録中にします。</span><span class="sxs-lookup"><span data-stu-id="d22f7-133">To run a set of middleware components during a particular stage, insert a stage marker right after the last component is the set during registration.</span></span> <span data-ttu-id="d22f7-134">ミドルウェアを実行するパイプラインのどのステージで規則があるし、順序は、コンポーネントを実行する必要があります (ルールは、チュートリアルの後半で説明します)。</span><span class="sxs-lookup"><span data-stu-id="d22f7-134">There are rules on which stage of the pipeline you can execute middleware and the order components must run (The rules are explained later in the tutorial).</span></span> <span data-ttu-id="d22f7-135">追加、`UseStageMarker`メソッドを`Configuration`コードの次のようにします。</span><span class="sxs-lookup"><span data-stu-id="d22f7-135">Add the `UseStageMarker` method to the `Configuration` code as shown below:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample6.cs?highlight=13,19)]

<span data-ttu-id="d22f7-136">`app.UseStageMarker(PipelineStage.Authenticate)`呼び出しパイプラインの認証段階で実行する (ここでは、2 つの診断コンポーネント) のすべての以前に登録したミドルウェア コンポーネントを構成します。</span><span class="sxs-lookup"><span data-stu-id="d22f7-136">The `app.UseStageMarker(PipelineStage.Authenticate)` call configures all the previously registered middleware components (in this case, our two diagnostic components) to run on the authentication stage of the pipeline.</span></span> <span data-ttu-id="d22f7-137">実行されます (これ診断を表示し、要求に応答) の最後のミドルウェア コンポーネント、`ResolveCache`ステージ (、 [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx)イベント)。</span><span class="sxs-lookup"><span data-stu-id="d22f7-137">The last middleware component (which displays diagnostics and responds to requests) will run on the `ResolveCache` stage (the [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) event).</span></span>

<span data-ttu-id="d22f7-138">F5 キーを押して、アプリを実行します。次は、出力ウィンドウを示しています。</span><span class="sxs-lookup"><span data-stu-id="d22f7-138">Hit F5 to run the app.The output window shows the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample7.cmd)]

## <a name="stage-marker-rules"></a><span data-ttu-id="d22f7-139">ステージ マーカーのルール</span><span class="sxs-lookup"><span data-stu-id="d22f7-139">Stage Marker Rules</span></span>

<span data-ttu-id="d22f7-140">次の OWIN パイプラインのステージ イベントに実行する Owin ミドルウェア コンポーネント (OMC) を構成できます。</span><span class="sxs-lookup"><span data-stu-id="d22f7-140">Owin middleware components (OMC) can be configured to run at the following OWIN pipeline stage events:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample8.cs)]

1. <span data-ttu-id="d22f7-141">既定では、OMCs は最後のイベントで実行 (`PreHandlerExecute`)。</span><span class="sxs-lookup"><span data-stu-id="d22f7-141">By default, OMCs run at the last event (`PreHandlerExecute`).</span></span> <span data-ttu-id="d22f7-142">その理由は、最初のコード例には"PreExecuteRequestHandler"が表示されます。</span><span class="sxs-lookup"><span data-stu-id="d22f7-142">That's why our first example code displayed "PreExecuteRequestHandler".</span></span>
2. <span data-ttu-id="d22f7-143">使用することができます、`app.UseStageMarker`に OWIN パイプラインのいずれかの段階で以前に実行する OMC を登録する方法が示されている、`PipelineStage`列挙型。</span><span class="sxs-lookup"><span data-stu-id="d22f7-143">You can use the a `app.UseStageMarker` method to register a OMC to run earlier, at any stage of the OWIN pipeline listed in the `PipelineStage` enum.</span></span>
3. <span data-ttu-id="d22f7-144">OWIN パイプラインと IIS パイプラインが順序付け、そのために呼び出し`app.UseStageMarker`の順序である必要があります。</span><span class="sxs-lookup"><span data-stu-id="d22f7-144">The OWIN pipeline and the IIS pipeline is ordered, therefore calls to `app.UseStageMarker` must be in order.</span></span> <span data-ttu-id="d22f7-145">登録されている最後のイベントの前に、イベントにイベント ハンドラーを設定することはできません`app.UseStageMarker`です。</span><span class="sxs-lookup"><span data-stu-id="d22f7-145">You cannot set the event handler to an event that precedes the last event registered with to `app.UseStageMarker`.</span></span> <span data-ttu-id="d22f7-146">たとえば、*後*呼び出し。</span><span class="sxs-lookup"><span data-stu-id="d22f7-146">For example, *after* calling:</span></span>

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample9.cmd)]

 <span data-ttu-id="d22f7-147">呼び出す`app.UseStageMarker`渡す`Authenticate`または`PostAuthenticate`受け入れられ、できず、例外はスローされません。</span><span class="sxs-lookup"><span data-stu-id="d22f7-147">calls to `app.UseStageMarker` passing `Authenticate` or `PostAuthenticate` will not be honored, and no exception will be thrown.</span></span> <span data-ttu-id="d22f7-148">既定では、最新の段階で実行 OMCs`PreHandlerExecute`です。</span><span class="sxs-lookup"><span data-stu-id="d22f7-148">OMCs run at the latest stage, which by default is `PreHandlerExecute`.</span></span> <span data-ttu-id="d22f7-149">以前を実行するようにするステージ マーカーが使用されます。</span><span class="sxs-lookup"><span data-stu-id="d22f7-149">The stage markers are used to make them to run earlier.</span></span> <span data-ttu-id="d22f7-150">誤順序のステージ マーカーを指定する場合は、以前のマーカーにお丸められます。</span><span class="sxs-lookup"><span data-stu-id="d22f7-150">If you specify stage markers out of order, we round to the earlier marker.</span></span> <span data-ttu-id="d22f7-151">つまり、ステージ マーカーを追加することを通知"Run ステージ X 以降"。</span><span class="sxs-lookup"><span data-stu-id="d22f7-151">In other words, adding a stage marker says "Run no later than stage X".</span></span> <span data-ttu-id="d22f7-152">OWIN パイプラインの後に追加された最初のステージ マーカーで OMC の実行。</span><span class="sxs-lookup"><span data-stu-id="d22f7-152">OMC's run at the earliest stage marker added after them in the OWIN pipeline.</span></span>
4. <span data-ttu-id="d22f7-153">呼び出しの最も早いステージ`app.UseStageMarker`wins です。</span><span class="sxs-lookup"><span data-stu-id="d22f7-153">The earliest stage of calls to `app.UseStageMarker` wins.</span></span> <span data-ttu-id="d22f7-154">たとえばの順序を切り替えた場合`app.UseStageMarker`前の例からの呼び出し。</span><span class="sxs-lookup"><span data-stu-id="d22f7-154">For example, if you switch the order of `app.UseStageMarker` calls from our previous example:</span></span>

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample10.cs?highlight=13,19)]

 <span data-ttu-id="d22f7-155">出力ウィンドウに表示されます。</span><span class="sxs-lookup"><span data-stu-id="d22f7-155">The output window will display:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample11.cmd)]

 <span data-ttu-id="d22f7-156">OMCs で動作するように、`AuthenticateRequest`最後 OMC に登録されているため、ステージ、`Authenticate`イベント、および`Authenticate`イベントの前に他のすべてのイベントです。</span><span class="sxs-lookup"><span data-stu-id="d22f7-156">The OMCs all run in the `AuthenticateRequest` stage, because the last OMC registered with the `Authenticate` event, and the `Authenticate` event precedes all other events.</span></span>
