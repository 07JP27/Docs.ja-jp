---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: "アカウントの確認と ASP.NET Identity (c#) とパスワードの回復 |Microsoft ドキュメント"
author: HaoK
description: "このチュートリアルを実行する前に、電子メールの確認とパスワードのリセットのログで web アプリの作成をセキュリティで保護された ASP.NET MVC 5 を完了する必要があります。 このチュートリアルには."
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/26/2015
ms.topic: article
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.technology: 
ms.prod: .net-framework
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 548baaaa06980fb793c079b66b6edc34422eb579
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/24/2018
---
<a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="ff36b-104">アカウントの確認と ASP.NET Identity (c#) とパスワードの回復</span><span class="sxs-lookup"><span data-stu-id="ff36b-104">Account Confirmation and Password Recovery with ASP.NET Identity (C#)</span></span>
====================
<span data-ttu-id="ff36b-105">によって[ハオ最後にトリム](https://github.com/HaoK)、 [Pranav Rastogi](https://github.com/rustd)、 [Rick Anderson](https://github.com/Rick-Anderson)、 [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="ff36b-105">by [Hao Kung](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="ff36b-106">このチュートリアルを実行する前に完了してください[ログイン、電子メールの確認とパスワードのリセットをセキュリティで保護された ASP.NET MVC 5 web アプリケーションを作成](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md)です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-106">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="ff36b-107">このチュートリアルでは、詳細が含まれています、ローカル アカウントの確認の電子メールを設定し、ASP.NET Identity の中で、パスワードをリセットできるようにする方法を示します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-107">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span> <span data-ttu-id="ff36b-108">この記事は、Rick Anderson によって書き込まれました ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT))、Pranav Rastogi ([@rustd](https://twitter.com/rustd))、最後に、ハオ トリムと Suhas Joshi です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-108">This article was written by Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung, and Suhas Joshi.</span></span> <span data-ttu-id="ff36b-109">NuGet サンプルは、最後にハオ トリムによって、主に書き込まれました。</span><span class="sxs-lookup"><span data-stu-id="ff36b-109">The NuGet sample was written primarily by Hao Kung.</span></span>


<span data-ttu-id="ff36b-110">ローカル ユーザー アカウントには、アカウントのパスワードを作成するユーザーが必要とされ、そのパスワードは、web app で (安全) 格納されます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-110">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="ff36b-111">ASP.NET の Id には、ソーシャル アカウントは、アプリのパスワードを作成するユーザーを必要としないもサポートしています。</span><span class="sxs-lookup"><span data-stu-id="ff36b-111">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="ff36b-112">[ソーシャル アカウント](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)(Google、Twitter、Facebook、または Microsoft) などのサード パーティを使用してユーザーを認証します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-112">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook or Microsoft) to authenticate users.</span></span> <span data-ttu-id="ff36b-113">このトピックは、次について説明します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-113">This topic covers the following:</span></span>

- <span data-ttu-id="ff36b-114">[ASP.NET MVC アプリの作成](#createMvc)と ASP.NET Identity の機能を調査します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-114">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="ff36b-115">Id サンプルのビルド</span><span class="sxs-lookup"><span data-stu-id="ff36b-115">Building the Identity sample</span></span>](#build)
- [<span data-ttu-id="ff36b-116">確認の電子メールを設定します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-116">Set up email confirmation</span></span>](#email)

<span data-ttu-id="ff36b-117">新しいユーザーは、その電子メールのエイリアスを作成するローカル アカウントを登録します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-117">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="ff36b-118">登録 ボタンをクリックすると、メール アドレスの検証トークンを含む確認の電子メールを送信します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-118">Clicking the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="ff36b-119">ユーザーには、自分のアカウントの確認トークンを使用して電子メールが送信されます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-119">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="ff36b-120">リンクをクリックすると、アカウントを確認します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-120">Clicking the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="ff36b-121">パスワードの回復またはリセット</span><span class="sxs-lookup"><span data-stu-id="ff36b-121">Password recovery/reset</span></span>

<span data-ttu-id="ff36b-122">ローカルのユーザーが自分のパスワードを忘れたパスワードのリセットを有効にすると、電子メール アカウントに送信されるセキュリティ トークンことができます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-122">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="ff36b-123">ユーザーはすぐに電子メールをリンクに、パスワードをリセットすることです。</span><span class="sxs-lookup"><span data-stu-id="ff36b-123">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="ff36b-124">リンクをクリックに移動し、リセットされたページ。</span><span class="sxs-lookup"><span data-stu-id="ff36b-124">Clicking the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="ff36b-125">クリックすると、**リセット**ボタンは、パスワードがリセットされたことを確認します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-125">Clicking the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="ff36b-126">ASP.NET Web アプリを作成します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-126">Create an ASP.NET Web app</span></span>

<span data-ttu-id="ff36b-127">インストールと実行によって開始[Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058)または[Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566)です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-127">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span> <span data-ttu-id="ff36b-128">Visual Studio のインストール[2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521)またはそれ以降。</span><span class="sxs-lookup"><span data-stu-id="ff36b-128">Install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) or higher.</span></span>

> [!NOTE]
> <span data-ttu-id="ff36b-129">警告: Visual Studio をインストールする必要があります[2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521)このチュートリアルを完了します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-129">Warning: You must install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) to complete this tutorial.</span></span>


1. <span data-ttu-id="ff36b-130">新しい ASP.NET Web プロジェクトを作成し、MVC テンプレートを選択します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-130">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="ff36b-131">Web フォームは、web フォーム アプリケーションで同じ手順を実行できなかったために、ASP.NET Identity もサポートします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-131">Web Forms also supports ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="ff36b-132">既定の認証としてのままにして**個々 のユーザー アカウント**です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-132">Leave the default authentication as **Individual User Accounts**.</span></span>
3. <span data-ttu-id="ff36b-133">アプリを実行する をクリックして、**登録**リンクし、ユーザーを登録します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-133">Run the app, click the **Register** link and register a user.</span></span> <span data-ttu-id="ff36b-134">この時点では、電子メールにのみ、検証、 [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx)属性。</span><span class="sxs-lookup"><span data-stu-id="ff36b-134">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="ff36b-135">サーバー エクスプ ローラーに移動**データ Connections\DefaultConnection\Tables\AspNetUsers**を右クリックし、選択**テーブル定義を開き**です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-135">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right click and select **Open table definition**.</span></span>

    <span data-ttu-id="ff36b-136">次の図は、`AspNetUsers`スキーマ。</span><span class="sxs-lookup"><span data-stu-id="ff36b-136">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="ff36b-137">右クリックして、 **AspNetUsers**テーブルを選択して**テーブル データの表示**です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-137">Right click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
 <span data-ttu-id="ff36b-138">この時点で、電子メールが確認されていません。</span><span class="sxs-lookup"><span data-stu-id="ff36b-138">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="ff36b-139">ASP.NET Id の既定のデータ ストアは、Entity Framework が、他のデータ ストアを使用して、フィールドを追加することを構成することができます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-139">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="ff36b-140">参照してください[その他のリソース](#addRes)このチュートリアルの最後のセクションでします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-140">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="ff36b-141">[OWIN スタートアップ クラス](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md)( *Startup.cs* )、アプリが起動しを呼び出すときに呼び出される、`ConfigureAuth`メソッド*アプリ\_Start\Startup.Auth.cs*、これにより、OWIN パイプラインを構成して、ASP.NET Identity を初期化します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-141">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="ff36b-142">確認、`ConfigureAuth`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="ff36b-142">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="ff36b-143">各`CreatePerOwinContext`呼び出し、コールバックの登録 (に保存されている、 `OwinContext`) 指定した型のインスタンスを作成する要求あたり 1 回呼び出すされます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-143">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="ff36b-144">コンス トラクターにブレークポイントを設定することができ、`Create`各型のメソッド (`ApplicationDbContext, ApplicationUserManager`) 要求のたびに呼び出されることを確認します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-144">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="ff36b-145">インスタンスを`ApplicationDbContext`と`ApplicationUserManager`は、アプリケーション全体でアクセス可能な OWIN コンテキストに格納します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-145">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="ff36b-146">ASP.NET Identity は、cookie ミドルウェアを OWIN パイプラインにフックします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-146">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="ff36b-147">詳細については、次を参照してください。 [UserManager クラスは、ASP.NET Identity の要求の有効期間管理あたり](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-147">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="ff36b-148">新しいセキュリティ スタンプが生成されに格納されているセキュリティ プロファイルを変更するときに、`SecurityStamp`のフィールド、 *AspNetUsers*テーブル。</span><span class="sxs-lookup"><span data-stu-id="ff36b-148">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="ff36b-149">注意してください、`SecurityStamp`フィールドとは異なるセキュリティ クッキー。</span><span class="sxs-lookup"><span data-stu-id="ff36b-149">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="ff36b-150">セキュリティ クッキーに保存されていない、`AspNetUsers`テーブル (または Identity db では、他の場所から)。</span><span class="sxs-lookup"><span data-stu-id="ff36b-150">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="ff36b-151">Cookie のセキュリティ トークンは、自己署名を使用して[DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx)で作成し、`UserId, SecurityStamp`と有効期限の時刻情報。</span><span class="sxs-lookup"><span data-stu-id="ff36b-151">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="ff36b-152">Cookie ミドルウェアでは、各要求の cookie を確認します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-152">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="ff36b-153">`SecurityStampValidator`メソッドで、`Startup`クラスの DB のヒット数およびセキュリティ スタンプを定期的にチェックで指定されたとおり、`validateInterval`です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-153">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="ff36b-154">これはセキュリティ プロファイルを変更する場合を除きます (この例では) で 30 分おきのみ発生します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-154">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="ff36b-155">データベースへのトリップを最小限に抑える、30 分間隔が選択されました。</span><span class="sxs-lookup"><span data-stu-id="ff36b-155">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="ff36b-156">参照してください  [2 要素認証チュートリアル](index.md)詳細についてはします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-156">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="ff36b-157">コードでは、コメント、`UseCookieAuthentication`メソッドは、cookie 認証をサポートしています。</span><span class="sxs-lookup"><span data-stu-id="ff36b-157">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="ff36b-158">`SecurityStamp`フィールドと関連付けられているコードは、層を追加、アプリケーションにセキュリティのパスワードを変更するときにログインする必要がログインで使用するブラウザー外です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-158">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="ff36b-159">`SecurityStampValidator.OnValidateIdentity`メソッドは、パスワードを変更または外部ログインを使用する際に使用される、ユーザーがログインすると、セキュリティ トークンを検証するアプリを使用します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-159">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="ff36b-160">古いパスワードを使用して生成されたトークン (クッキー) を無効にしたことを確認する必要です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-160">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="ff36b-161">サンプル プロジェクトで変更した場合のユーザーのパスワード、新しいトークンでは、ユーザーが生成、以前のすべてのトークンが無効にし、`SecurityStamp`フィールドを更新します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-161">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="ff36b-162">Id システムを許可するアプリを構成するため、ユーザーのセキュリティ プロファイルが変更されたときに (たとえば、ユーザーが、パスワードまたは変更を変更するときに関連付けられているログイン (Facebook、Google、2016/2/14 などの Microsoft アカウントなど)、外のすべてのユーザーがログインしています。ブラウザーのインスタンス。</span><span class="sxs-lookup"><span data-stu-id="ff36b-162">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="ff36b-163">たとえば、下の例のイメージ、[シングル サインアウトのサンプル](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt)アプリで、1 つのボタンをクリックしてすべてのブラウザー インスタンス (ここでは、IE、Firefox および Chrome) からサインアウトすることができます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-163">For example, the image below shows the [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by clicking one button.</span></span> <span data-ttu-id="ff36b-164">または、サンプルには、のみ、特定のブラウザー インスタンスからログアウトすることができます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-164">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="ff36b-165">[シングル サインアウトのサンプル](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt)アプリは、ASP.NET Identity を使用すると、セキュリティ トークンを再生成する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="ff36b-165">The [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="ff36b-166">古いパスワードを使用して生成されたトークン (クッキー) を無効にしたことを確認する必要です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-166">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="ff36b-167">この機能を提供すると、アプリケーションのセキュリティ層を追加パスワードを変更するときに、このアプリケーションにログインした場所に記録されます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-167">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="ff36b-168">*アプリ\_Start\IdentityConfig.cs*ファイルが含まれています、 `ApplicationUserManager`、`EmailService`と`SmsService`クラスです。</span><span class="sxs-lookup"><span data-stu-id="ff36b-168">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="ff36b-169">`EmailService`と`SmsService`各実装するクラス、`IIdentityMessageService`インターフェイス、電子メールと SMS を構成するには、各クラスに共通のメソッドがあるようにします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-169">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="ff36b-170">このチュートリアルはのみを使用して電子メール通知を追加する方法を示しますが[SendGrid](http://sendgrid.com/)SMTP、およびその他のメカニズムを使用して電子メールを送信することができます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-170">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="ff36b-171">`Startup`クラスは、ソーシャル ログイン (Facebook、Twitter など) が自分のチュートリアルを参照して追加するボイラー プレートも含まれています。 [Facebook、Twitter、LinkedIn および Google OAuth2 サインオン MVC 5 アプリ](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)詳細についてはします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-171">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="ff36b-172">確認、`ApplicationUserManager`クラスでは、ユーザー id 情報が含まれており、次の機能を構成します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-172">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="ff36b-173">パスワードの強度要件です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-173">Password strength requirements.</span></span>
- <span data-ttu-id="ff36b-174">ユーザーのロックアウト (試行と時刻)。</span><span class="sxs-lookup"><span data-stu-id="ff36b-174">User lock out (attempts and time).</span></span>
- <span data-ttu-id="ff36b-175">2 要素認証 (2 fa)。</span><span class="sxs-lookup"><span data-stu-id="ff36b-175">Two-factor authentication (2FA).</span></span> <span data-ttu-id="ff36b-176">別のチュートリアルでは 2 fa と SMS を説明します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-176">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="ff36b-177">電子メールと SMS サービスをフックします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-177">Hooking up the email and SMS services.</span></span> <span data-ttu-id="ff36b-178">(取り上げ、SMS 別のチュートリアルでは)。</span><span class="sxs-lookup"><span data-stu-id="ff36b-178">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="ff36b-179">`ApplicationUserManager`ジェネリック クラス`UserManager<ApplicationUser>`クラスです。</span><span class="sxs-lookup"><span data-stu-id="ff36b-179">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="ff36b-180">`ApplicationUser`派生した[IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-180">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="ff36b-181">`IdentityUser`ジェネリックから派生した`IdentityUser`クラス。</span><span class="sxs-lookup"><span data-stu-id="ff36b-181">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="ff36b-182">上記のプロパティで指定したプロパティと一致し、`AspNetUsers`上に示す表。</span><span class="sxs-lookup"><span data-stu-id="ff36b-182">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="ff36b-183">ジェネリック引数`IUser`を使用する主キーの種類を使用してクラスを派生できます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-183">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="ff36b-184">参照してください、 [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt)サンプル int または GUID を文字列から主キーを変更する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-184">See the [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="ff36b-185">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="ff36b-185">ApplicationUser</span></span>

<span data-ttu-id="ff36b-186">`ApplicationUser`(`public class ApplicationUserManager : UserManager<ApplicationUser>`) で定義された*Models\IdentityModels.cs*として。</span><span class="sxs-lookup"><span data-stu-id="ff36b-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="ff36b-187">上記の強調表示されたコードの生成、 [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-187">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="ff36b-188">ASP.NET Identity と OWIN の Cookie 認証クレームに基づく、ため、フレームワークが、アプリを生成する必要があります、`ClaimsIdentity`ユーザー。</span><span class="sxs-lookup"><span data-stu-id="ff36b-188">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="ff36b-189">`ClaimsIdentity`情報を持つユーザーの名前など、ユーザーのすべての要求について age し、ユーザーが所属するロール。</span><span class="sxs-lookup"><span data-stu-id="ff36b-189">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="ff36b-190">この段階で、ユーザーのクレームを追加することもできます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-190">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="ff36b-191">OWIN`AuthenticationManager.SignIn`メソッドでは、渡します、`ClaimsIdentity`し、ユーザーがサインインします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-191">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="ff36b-192">[Facebook、Twitter、LinkedIn および Google OAuth2 サインオン MVC 5 アプリ](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)する他のプロパティを追加する方法を示しています、`ApplicationUser`クラスです。</span><span class="sxs-lookup"><span data-stu-id="ff36b-192">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="ff36b-193">確認の電子メール</span><span class="sxs-lookup"><span data-stu-id="ff36b-193">Email confirmation</span></span>

<span data-ttu-id="ff36b-194">他のユーザーを偽装するしていないことを確認すると、新しいユーザーが登録電子メールを確認することをお勧め (つまり、まだに登録されている他のユーザーの電子メール)。</span><span class="sxs-lookup"><span data-stu-id="ff36b-194">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="ff36b-195">しないようにする、ディスカッション フォーラムするいたと仮定`"bob@example.com"`としての登録から`"joe@contoso.com"`です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-195">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="ff36b-196">電子メールの確認なし`"joe@contoso.com"`アプリから不要な電子メールを取得する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ff36b-196">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="ff36b-197">として誤って Bob が登録されていると仮定します`"bib@example.com"`いなかったが検出されました。 これは、と彼は、アプリは、正しいメール アドレスが見つからないため、パスワードの回復を使用できなくします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-197">Suppose Bob accidently registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="ff36b-198">確認の電子メールが bot から制限の保護のみを提供し、決定スパム攻撃者から保護を提供しません、登録に使用できる多くの作業電子メール エイリアスが。次のサンプルでは、ユーザーことはできませんのアカウントが確認されるまで、パスワードを変更する (それらによりに登録されている電子メール アカウントで受信確認のリンクをクリックするとします)。このワークフローは、例を確認し、自分のプロファイルに変更されたときに、ユーザー、電子メールを送信する、管理者によって作成された新しいアカウントのパスワードをリセット リンクを送信するその他のシナリオに適用できます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-198">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them clicking on a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="ff36b-199">一般にする新しいユーザーが電子メール、SMS テキスト メッセージ、または別のメカニズムによって確認されて前に、web サイトにデータを送信するを防ぐ。</span><span class="sxs-lookup"><span data-stu-id="ff36b-199">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="building-a-more-complete-sample"></a><span data-ttu-id="ff36b-200">完全なサンプルの構築</span><span class="sxs-lookup"><span data-stu-id="ff36b-200">Building a more complete sample</span></span>

<span data-ttu-id="ff36b-201">このセクションでは、させるより完全なサンプルをダウンロードする NuGet を使用します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-201">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="ff36b-202">新しい***空***ASP.NET Web プロジェクトです。</span><span class="sxs-lookup"><span data-stu-id="ff36b-202">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="ff36b-203">パッケージ マネージャー コンソールで、次を入力して、次のコマンド。</span><span class="sxs-lookup"><span data-stu-id="ff36b-203">In the Package Manager Console, enter the following the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

 <span data-ttu-id="ff36b-204">このチュートリアルで使用されます[SendGrid](http://sendgrid.com/)電子メールを送信します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-204">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="ff36b-205">`Identity.Samples`パッケージは操作するコードをインストールします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-205">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="ff36b-206">設定、 [SSL を使用するプロジェクト](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-206">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="ff36b-207">クリックすると、アプリを実行して、テストの作成にローカル アカウント、**登録**をリンクして、登録フォームを投稿します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-207">Test local account creation by running the app, clicking on the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="ff36b-208">確認の電子メールをシミュレートするデモ電子メールのリンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-208">Click the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="ff36b-209">このサンプルからデモ電子メール リンク確認コードを削除 (、`ViewBag.Link`アカウント コント ローラー内のコード。</span><span class="sxs-lookup"><span data-stu-id="ff36b-209">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="ff36b-210">参照してください、`DisplayEmail`と`ForgotPasswordConfirmation`アクション メソッドと razor ビュー)。</span><span class="sxs-lookup"><span data-stu-id="ff36b-210">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!NOTE]
> <span data-ttu-id="ff36b-211">警告: このサンプルでは、セキュリティ設定のいずれかを変更すると、運用アプリが行われた変更を明示的に呼び出すのセキュリティ監査を受ける必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff36b-211">Warning: If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>


## <a name="examine-the-code-in-appstartidentityconfigcs"></a><span data-ttu-id="ff36b-212">アプリでコードを調べる\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="ff36b-212">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="ff36b-213">サンプルは、アカウントを作成し、それを追加する方法を示します、 *Admin*ロール。</span><span class="sxs-lookup"><span data-stu-id="ff36b-213">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="ff36b-214">サンプルの電子メールは、管理者アカウントに使用する電子メールを置き換えてください。</span><span class="sxs-lookup"><span data-stu-id="ff36b-214">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="ff36b-215">管理者アカウントを作成するには、今すぐ最も簡単な方法は、プログラム的に、`Seed`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="ff36b-215">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="ff36b-216">ツールがあると、将来の作成し、ユーザーとロールを管理することを許可する予定です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-216">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="ff36b-217">サンプル コードには、ユーザーおよびロールを作成および管理することが、ロールとユーザー管理ページを実行する管理者アカウントがあります。</span><span class="sxs-lookup"><span data-stu-id="ff36b-217">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="ff36b-218">このサンプルでは、データベースがシード処理時に、管理者アカウントが作成されます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-218">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="ff36b-219">パスワードを変更し、電子メール通知を受信できるアカウントに名前を変更します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-219">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="ff36b-220">セキュリティ - ソース コード内の機密データはストアことはありません。</span><span class="sxs-lookup"><span data-stu-id="ff36b-220">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="ff36b-221">前に述べたよう、`app.CreatePerOwinContext`スタートアップ クラス内の呼び出しへのコールバックの追加、`Create`アプリ DB コンテンツ、ユーザー マネージャーと役割マネージャー クラスのメソッドです。</span><span class="sxs-lookup"><span data-stu-id="ff36b-221">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="ff36b-222">OWIN パイプラインの呼び出し、`Create`これらのメソッドは、要求ごとにクラスし、各クラスのコンテキストを格納します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-222">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="ff36b-223">アカウント コント ローラーは、(を OWIN コンテキストを含む)、HTTP コンテキストからユーザー マネージャーを公開します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-223">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="ff36b-224">ユーザーがローカル アカウントを登録すると、`HTTP Post Register`メソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-224">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="ff36b-225">上記のコードでは、モデル データを使用して、電子メールおよび入力したパスワードを使用して、新しいユーザー アカウントを作成します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-225">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="ff36b-226">電子メール エイリアスがデータ ストア内にある場合は、アカウントの作成に失敗して、フォームが再度表示されます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-226">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="ff36b-227">`GenerateEmailConfirmationTokenAsync`メソッドは、セキュリティで保護された確認トークンを作成し、ASP.NET Identity のデータ ストアに保存します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-227">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="ff36b-228">[Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx)メソッドは、リンクを含む、作成、`UserId`および確認トークン。</span><span class="sxs-lookup"><span data-stu-id="ff36b-228">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="ff36b-229">このリンクは、ユーザーに電子メールで送信し、ユーザーが自分のアカウントを確認するには、その電子メール アプリでリンクをクリックできます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-229">This link is then emailed to the user, the user can click on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="ff36b-230">確認の電子メールを設定します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-230">Set up email confirmation</span></span>

<span data-ttu-id="ff36b-231">移動して、 [Azure SendGrid のサインアップ ページ](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/)無料アカウントを登録するとします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-231">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="ff36b-232">SendGrid を構成するのには、次のようなコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-232">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="ff36b-233">電子メール クライアントには、頻繁にテキスト メッセージ (HTML なし) のみがそのまま使用します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-233">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="ff36b-234">メッセージ テキストと HTML を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff36b-234">You should provide the message in text and HTML.</span></span> <span data-ttu-id="ff36b-235">サンプルでは、SendGrid 上、これは、`myMessage.Text`と`myMessage.Html`上に示したコードです。</span><span class="sxs-lookup"><span data-stu-id="ff36b-235">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>


<span data-ttu-id="ff36b-236">次のコードは、電子メールを使用して送信する方法を示します、 [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx)クラス`message.Body`リンクのみを返します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-236">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="ff36b-237">セキュリティ - ソース コード内の機密データはストアことはありません。</span><span class="sxs-lookup"><span data-stu-id="ff36b-237">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="ff36b-238">アカウントと資格情報は、appSetting に格納されます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-238">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="ff36b-239">Azure で安全に格納できますこれらの値で、 **[構成](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)**  タブで、Azure ポータルです。</span><span class="sxs-lookup"><span data-stu-id="ff36b-239">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="ff36b-240">参照してください[ASP.NET と Azure へのパスワードや他の機密データの展開のベスト プラクティス](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md)です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-240">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>


<span data-ttu-id="ff36b-241">アプリを実行するには、登録電子メール エイリアスを持つリンクをクリックすることを確認して、電子メールで、SendGrid の資格情報を入力します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-241">Enter your SendGrid credentials, run the app, register with an email alias can click the confirm link in your email.</span></span> <span data-ttu-id="ff36b-242">これを行う方法について、 [Outlook.com](http://outlook.com)電子メール アカウントは、「John Atten [c# SMTP ホスト構成に Outlook.Com SMTP](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx)彼と[ASP.NET Identity 2.0: アカウントの検証を設定2 要素認証と](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)ポストします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-242">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="ff36b-243">ユーザーがクリックした後、**登録**検証トークンを含む確認電子メールがユーザーの電子メール アドレスに送信ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-243">Once a user clicks the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="ff36b-244">ユーザーには、自分のアカウントの確認トークンを使用して電子メールが送信されます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-244">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="ff36b-245">コードを調べます</span><span class="sxs-lookup"><span data-stu-id="ff36b-245">Examine the code</span></span>

<span data-ttu-id="ff36b-246">次のコードは `POST ForgotPassword` メソッドを示します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-246">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="ff36b-247">ユーザーの電子メール アドレスが確認されていない場合、メソッドはサイレント モードで失敗します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-247">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="ff36b-248">エラーが無効な電子メール アドレス、ポストされた場合、悪意のあるユーザーを攻撃する有効なユーザー Id (電子メールの別名) を検索するその情報を使用できます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-248">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="ff36b-249">次のコードは、`ConfirmEmail`でアカウント コント ローラー、ユーザーに電子メールを送信するために確認のリンクをクリックしたときに呼び出されるメソッド。</span><span class="sxs-lookup"><span data-stu-id="ff36b-249">The following code shows the `ConfirmEmail` method in the account controller that is called when the user clicks the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="ff36b-250">パスワードを忘れたトークンが使用されるは無効になります。</span><span class="sxs-lookup"><span data-stu-id="ff36b-250">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="ff36b-251">次のコードの変更、`Create`メソッド (で、*アプリ\_Start\IdentityConfig.cs*ファイル) 3 時間に期限切れにトークンを設定します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-251">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="ff36b-252">上記のコードでは、パスワードを忘れてしまったと電子メール確認トークン有効期限が切れる 3 時間にします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-252">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="ff36b-253">既定値`TokenLifespan`は 1 日です。</span><span class="sxs-lookup"><span data-stu-id="ff36b-253">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="ff36b-254">次のコードは、電子メールの確認方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="ff36b-254">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="ff36b-255">アプリをより安全にするには、ASP.NET Identity には、2 要素認証 (2 fa) がサポートしています。</span><span class="sxs-lookup"><span data-stu-id="ff36b-255">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="ff36b-256">参照してください[ASP.NET Identity 2.0: アカウントの検証と 2 要素認証を設定する](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)John Atten でします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-256">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="ff36b-257">ログイン パスワード試行の失敗では、アカウントのロックアウトを設定できますが、その手法では、現在のログインの影響を受け[DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack)ロックアウトされます。</span><span class="sxs-lookup"><span data-stu-id="ff36b-257">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="ff36b-258">アカウントのロックアウトを 2 fa でのみ使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-258">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="ff36b-259">その他のリソース</span><span class="sxs-lookup"><span data-stu-id="ff36b-259">Additional Resources</span></span>

- [<span data-ttu-id="ff36b-260">ASP.NET Identity のカスタム ストレージ プロバイダーの概要</span><span class="sxs-lookup"><span data-stu-id="ff36b-260">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="ff36b-261">[Facebook、Twitter、LinkedIn および Google OAuth2 サインオン MVC 5 アプリ](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)プロファイル情報をユーザー テーブルに追加する方法についても説明します。</span><span class="sxs-lookup"><span data-stu-id="ff36b-261">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="ff36b-262">[ASP.NET MVC と Id 2.0: 基本を理解する](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx)John Atten でします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-262">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="ff36b-263">ASP.NET Identity 入門</span><span class="sxs-lookup"><span data-stu-id="ff36b-263">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="ff36b-264">[Announcing ASP.NET Identity 2.0.0 の RTM](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) Pranav Rastogi でします。</span><span class="sxs-lookup"><span data-stu-id="ff36b-264">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
