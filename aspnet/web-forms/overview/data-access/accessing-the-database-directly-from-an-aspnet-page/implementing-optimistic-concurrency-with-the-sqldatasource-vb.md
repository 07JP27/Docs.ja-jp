---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-vb
title: SqlDataSource (VB) によるオプティミスティック同時実行制御を実装する |Microsoft ドキュメント
author: rick-anderson
description: このチュートリアルではオプティミスティック同時実行制御の essentials を確認し、SqlDataSource コントロールを使用してそれを実装する方法を調査します。
ms.author: aspnetcontent
manager: wpickett
ms.date: 02/20/2007
ms.topic: article
ms.assetid: a8fa72ee-8328-4854-a419-c1b271772303
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-vb
msc.type: authoredcontent
ms.openlocfilehash: 6e7e81b3f3a54596c033caa2cf75e5e3ec01764c
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/06/2018
---
<a name="implementing-optimistic-concurrency-with-the-sqldatasource-vb"></a><span data-ttu-id="93c4d-103">SqlDataSource (VB) によるオプティミスティック同時実行制御を実装します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-103">Implementing Optimistic Concurrency with the SqlDataSource (VB)</span></span>
====================
<span data-ttu-id="93c4d-104">によって[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="93c4d-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="93c4d-105">[サンプル アプリをダウンロード](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_VB.exe)または[PDF のダウンロード](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/datatutorial50vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="93c4d-105">[Download Sample App](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_VB.exe) or [Download PDF](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/datatutorial50vb1.pdf)</span></span>

> <span data-ttu-id="93c4d-106">このチュートリアルではオプティミスティック同時実行制御の essentials を確認し、SqlDataSource コントロールを使用してそれを実装する方法を調査します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-106">In this tutorial we review the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource control.</span></span>


## <a name="introduction"></a><span data-ttu-id="93c4d-107">はじめに</span><span class="sxs-lookup"><span data-stu-id="93c4d-107">Introduction</span></span>

<span data-ttu-id="93c4d-108">前のチュートリアルは、挿入、更新、および削除、SqlDataSource コントロールする機能を追加する方法を調査します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-108">In the preceding tutorial we examined how to add inserting, updating, and deleting capabilities to the SqlDataSource control.</span></span> <span data-ttu-id="93c4d-109">つまり、これらの機能を提供する必要がある、対応するを指定する`INSERT`、 `UPDATE`、または`DELETE`s コントロール内の SQL ステートメント`InsertCommand`、 `UpdateCommand`、または`DeleteCommand`プロパティは、適切なと共に内のパラメーター、 `InsertParameters`、 `UpdateParameters`、および`DeleteParameters`コレクション。</span><span class="sxs-lookup"><span data-stu-id="93c4d-109">In short, to provide these features we needed to specify the corresponding `INSERT`, `UPDATE`, or `DELETE` SQL statement in the control s `InsertCommand`, `UpdateCommand`, or `DeleteCommand` properties, along with the appropriate parameters in the `InsertParameters`, `UpdateParameters`, and `DeleteParameters` collections.</span></span> <span data-ttu-id="93c4d-110">データ ソースの構成ウィザードの [詳細設定] には、生成中に、これらのプロパティとコレクションを手動で指定することができます、 `INSERT`、 `UPDATE`、および`DELETE`は自動的に作成するこれらのステートメントをステートメントのチェック ボックスがに基づいて、`SELECT`ステートメントです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-110">While these properties and collections can be specified manually, the Configure Data Source wizard s Advanced button offers a Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox that will auto-create these statements based on the `SELECT` statement.</span></span>

<span data-ttu-id="93c4d-111">生成と共に`INSERT`、 `UPDATE`、および`DELETE`SQL 生成の詳細オプション ダイアログ ボックス、ステートメントのチェック ボックスには使用するオプティミスティック同時実行制御オプションが含まれています (図 1 を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="93c4d-111">Along with the Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox, the Advanced SQL Generation Options dialog box includes a Use optimistic concurrency option (see Figure 1).</span></span> <span data-ttu-id="93c4d-112">オンにした場合、`WHERE`自動生成された句`UPDATE`と`DELETE`だけ更新プログラムを実行するステートメントが変更または削除のユーザーから、基になるデータベース データいない t が変更された最後に読み込まれ、データ グリッドです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-112">When checked, the `WHERE` clauses in the autogenerated `UPDATE` and `DELETE` statements are modified to only perform the update or delete if the underlying database data hasn t been modified since the user last loaded the data into the grid.</span></span>


![オプティミスティック同時実行制御のサポートを追加するには、高度なから SQL 生成のオプション ダイアログ ボックス](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image1.gif)

<span data-ttu-id="93c4d-114">**図 1**: オプティミスティック同時実行制御のサポートを追加するには、高度なから SQL 生成のオプション ダイアログ ボックス</span><span class="sxs-lookup"><span data-stu-id="93c4d-114">**Figure 1**: You Can Add Optimistic Concurrency Support from the Advanced SQL Generation Options Dialog Box</span></span>


<span data-ttu-id="93c4d-115">戻り、[オプティミスティック同時実行制御で実装する](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md)チュートリアル オプティミスティック同時実行制御および、ObjectDataSource を追加する方法の基礎について説明しました。</span><span class="sxs-lookup"><span data-stu-id="93c4d-115">Back in the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md) tutorial we examined the fundamentals of optimistic concurrency control and how to add it to the ObjectDataSource.</span></span> <span data-ttu-id="93c4d-116">このチュートリアルでは、オプティミスティック同時実行制御の essentials レタッチを SqlDataSource を使用してそれを実装する方法を調査します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-116">In this tutorial we'll retouch on the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource.</span></span>

## <a name="a-recap-of-optimistic-concurrency"></a><span data-ttu-id="93c4d-117">オプティミスティック同時実行制御の要約</span><span class="sxs-lookup"><span data-stu-id="93c4d-117">A Recap of Optimistic Concurrency</span></span>

<span data-ttu-id="93c4d-118">複数、web アプリケーションの同時ユーザーを編集または削除は、同一データが存在する可能性のあるユーザーが別の s の変更を誤って上書き可能性があります。</span><span class="sxs-lookup"><span data-stu-id="93c4d-118">For web applications that allow multiple, simultaneous users to edit or delete the same data, there exists a possibility that one user may accidentally overwrite another s changes.</span></span> <span data-ttu-id="93c4d-119">[オプティミスティック同時実行制御で実装する](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md)チュートリアルの次の例を入力します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-119">In the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md) tutorial I provided the following example:</span></span>

<span data-ttu-id="93c4d-120">ある Jisun と Sam、2 人のユーザーが両方のページにアクセス更新および削除の GridView コントロールを使用して製品への訪問者を許可するアプリケーションで想像してください。</span><span class="sxs-lookup"><span data-stu-id="93c4d-120">Imagine that two users, Jisun and Sam, were both visiting a page in an application that allowed visitors to update and delete products through a GridView control.</span></span> <span data-ttu-id="93c4d-121">両方を Chai の同時期、[編集] ボタンがクリックします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-121">Both click the Edit button for Chai around the same time.</span></span> <span data-ttu-id="93c4d-122">Jisun はチャイに製品名を変更し、[更新] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-122">Jisun changes the product name to Chai Tea and clicks the Update button.</span></span> <span data-ttu-id="93c4d-123">最終的には、`UPDATE`を設定すると、データベースに送信されるステートメント*すべて*製品の更新可能なフィールドの (Jisun では、1 つのフィールドのみ更新される場合でも`ProductName`)。</span><span class="sxs-lookup"><span data-stu-id="93c4d-123">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product s updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="93c4d-124">この時点では、データベースでは、チャイ、飲料カテゴリ供給業者の特別な液体この特定の製品についての値があります。</span><span class="sxs-lookup"><span data-stu-id="93c4d-124">At this point in time, the database has the values Chai Tea, the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="93c4d-125">ただし、Sam の画面の GridView であっても、製品名の編集可能な GridView 行 Chai として。</span><span class="sxs-lookup"><span data-stu-id="93c4d-125">However, the GridView on Sam s screen still shows the product name in the editable GridView row as Chai.</span></span> <span data-ttu-id="93c4d-126">Jisun の変更がコミットされた後、数秒 Sam は調味料にカテゴリを更新し、更新プログラムをクリックします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-126">A few seconds after Jisun s changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="93c4d-127">これは、結果、 `UPDATE` Chai に製品名を設定しているデータベースに送信されたステートメント、`CategoryID`対応する調味料カテゴリ ID というようにします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-127">This results in an `UPDATE` statement sent to the database that sets the product name to Chai, the `CategoryID` to the corresponding Condiments category ID, and so on.</span></span> <span data-ttu-id="93c4d-128">Jisun の製品名の変更が上書きされました。</span><span class="sxs-lookup"><span data-stu-id="93c4d-128">Jisun s changes to the product name have been overwritten.</span></span>

<span data-ttu-id="93c4d-129">図 2 は、この操作を示します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-129">Figure 2 illustrates this interaction.</span></span>


<span data-ttu-id="93c4d-130">[![2 人のユーザーがレコードを同時に更新があります s れる可能性がある 1 つのユーザーの変更を他の s を上書き](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="93c4d-130">[![When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image1.png)</span></span>

<span data-ttu-id="93c4d-131">**図 2**: ときに 2 つのユーザーに同時に更新、レコードが潜在的な 1 つのユーザーの変更を上書きする他のため ([フルサイズのイメージを表示するをクリックして](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="93c4d-131">**Figure 2**: When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image2.png))</span></span>


<span data-ttu-id="93c4d-132">このシナリオのフォームを開くことを防ぐため[同時実行制御](http://en.wikipedia.org/wiki/Concurrency_control)実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="93c4d-132">To prevent this scenario from unfolding, a form of [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) must be implemented.</span></span> <span data-ttu-id="93c4d-133">[オプティミスティック同時実行制御](http://en.wikipedia.org/wiki/Optimistic_concurrency_control)このチュートリアルの焦点はこともありますが同時実行の競合し、このような競合で優先 t 時間の大部分が発生することを前提に動作します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-133">[Optimistic concurrency](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) the focus of this tutorial works on the assumption that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won t arise.</span></span> <span data-ttu-id="93c4d-134">そのため場合は、競合が発生した場合、オプティミスティック同時実行制御だけでユーザーに通知して、別のユーザーには、同じデータが変更されたために、その変更が t が保存されることです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-134">Therefore, if a conflict does arise, optimistic concurrency control simply informs the user that their changes can t be saved because another user has modified the same data.</span></span>

> [!NOTE]
> <span data-ttu-id="93c4d-135">場所と見なされます多くの同時実行の競合があるか、このような競合が許容されないかどうかは、アプリケーションをペシミスティック同時実行制御ことがでく代わりに使用します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-135">For applications where it is assumed that there will be many concurrency conflicts or if such conflicts are not tolerable, then pessimistic concurrency control can be used instead.</span></span> <span data-ttu-id="93c4d-136">戻って、[オプティミスティック同時実行制御で実装する](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md)の詳細については、ペシミスティック同時実行制御のためのチュートリアルです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-136">Refer back to the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md) tutorial for a more thorough discussion on pessimistic concurrency control.</span></span>


<span data-ttu-id="93c4d-137">オプティミスティック同時実行制御は、更新または削除されたレコードの同じ値は、更新または削除プロセスが開始されたときと同様にあることを確認することによって機能します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-137">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="93c4d-138">たとえば、編集可能な GridView [編集] ボタンをクリックすると、レコード秒の値をデータベースからの読み取りし、がテキスト ボックスおよびその他の Web コントロールに表示されます。</span><span class="sxs-lookup"><span data-stu-id="93c4d-138">For example, when clicking the Edit button in an editable GridView, the record s values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="93c4d-139">元の値が GridView で保存されます。</span><span class="sxs-lookup"><span data-stu-id="93c4d-139">These original values are saved by the GridView.</span></span> <span data-ttu-id="93c4d-140">その後、ユーザーは自分が加えた変更は、し、更新ボタンをクリックすると、`UPDATE`ステートメントを使用が元の値と新しい値を考慮し、元の値は、ユーザーが編集を開始した場合にのみ、基になるデータベースのレコードを更新する必要があります引き続き、データベース内の値と同じです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-140">Later, after the user makes her changes and clicks the Update button, the `UPDATE` statement used must take into account the original values plus the new values and only update the underlying database record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="93c4d-141">図 3 は、このイベントのシーケンスを示しています。</span><span class="sxs-lookup"><span data-stu-id="93c4d-141">Figure 3 depicts this sequence of events.</span></span>


<span data-ttu-id="93c4d-142">[![正常に更新または削除は、元の値を現在のデータベースの値と同じにする必要があります。](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="93c4d-142">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image3.png)</span></span>

<span data-ttu-id="93c4d-143">**図 3**: For Update または Delete の成功を元の値必要がある値に等しく、現在データベースに ([フルサイズのイメージを表示するをクリックして](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="93c4d-143">**Figure 3**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image4.png))</span></span>


<span data-ttu-id="93c4d-144">オプティミスティック同時実行制御を実装するためのさまざまな方法があります (を参照してください[Peter A. 作成](http://peterbromberg.net/)s [Optmistic 同時実行更新ロジック](http://www.eggheadcafe.com/articles/20050719.asp)いくつかのオプションについて簡単に説明用)。</span><span class="sxs-lookup"><span data-stu-id="93c4d-144">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://peterbromberg.net/) s [Optmistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="93c4d-145">SqlDataSource (別、およびデータ アクセス層で使用される ADO.NET 型指定されたデータセット) に使用される手法の強化、`WHERE`に含めるすべての元の値の比較句。</span><span class="sxs-lookup"><span data-stu-id="93c4d-145">The technique used by the SqlDataSource (as well as by the ADO.NET Typed DataSets used in our Data Access Layer) augments the `WHERE` clause to include a comparison of all of the original values.</span></span> <span data-ttu-id="93c4d-146">次`UPDATE`ステートメントでは、たとえば、更新プログラム名と製品の価格データベースの現在の値が GridView でレコードを更新するときに取得された元の値に等しい場合のみです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-146">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="93c4d-147">`@ProductName`と`@UnitPrice`パラメーターに対し、ユーザーが入力した新しい値を含める`@original_ProductName`と`@original_UnitPrice`もともと読み込まれた GridView [編集] ボタンがクリックしてされたときに値が含まれます。</span><span class="sxs-lookup"><span data-stu-id="93c4d-147">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample1.sql)]

<span data-ttu-id="93c4d-148">このチュートリアルで後ほどお見せ、としては、チェック ボックスをオンなどの単純なは、SqlDataSource によるオプティミスティック同時実行制御を有効にします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-148">As we'll see in this tutorial, enabling optimistic concurrency control with the SqlDataSource is as simple as checking a checkbox.</span></span>

## <a name="step-1-creating-a-sqldatasource-that-supports-optimistic-concurrency"></a><span data-ttu-id="93c4d-149">手順 1: は、オプティミスティック同時実行制御をサポートする、SqlDataSource の作成</span><span class="sxs-lookup"><span data-stu-id="93c4d-149">Step 1: Creating a SqlDataSource that Supports Optimistic Concurrency</span></span>

<span data-ttu-id="93c4d-150">開いて開始、`OptimisticConcurrency.aspx`ページから、`SqlDataSource`フォルダーです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-150">Start by opening the `OptimisticConcurrency.aspx` page from the `SqlDataSource` folder.</span></span> <span data-ttu-id="93c4d-151">SqlDataSource コントロールをドラッグして、デザイナーの設定には、ツールボックスからその`ID`プロパティを`ProductsDataSourceWithOptimisticConcurrency`です。</span><span class="sxs-lookup"><span data-stu-id="93c4d-151">Drag a SqlDataSource control from the Toolbox onto the Designer, settings its `ID` property to `ProductsDataSourceWithOptimisticConcurrency`.</span></span> <span data-ttu-id="93c4d-152">次に、コントロールのスマート タグからのデータ ソースの構成のリンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-152">Next, click on the Configure Data Source link from the control s smart tag.</span></span> <span data-ttu-id="93c4d-153">ウィザードの最初の画面から作業を選択すると、 `NORTHWINDConnectionString` [次へ] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-153">From the first screen in the wizard, choose to work with the `NORTHWINDConnectionString` and click Next.</span></span>


<span data-ttu-id="93c4d-154">[![NORTHWINDConnectionString を選択します。](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="93c4d-154">[![Choose to Work with the NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image5.png)</span></span>

<span data-ttu-id="93c4d-155">**図 4**: を選択して、 `NORTHWINDConnectionString` ([フルサイズのイメージを表示するをクリックして](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="93c4d-155">**Figure 4**: Choose to Work with the `NORTHWINDConnectionString` ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image6.png))</span></span>


<span data-ttu-id="93c4d-156">この例で追加されます。 ユーザーが編集できるようにする GridView、`Products`テーブル。</span><span class="sxs-lookup"><span data-stu-id="93c4d-156">For this example we'll be adding a GridView that enables users to edit the `Products` table.</span></span> <span data-ttu-id="93c4d-157">そのため、Select ステートメントの画面の構成 を選択、`Products`ドロップダウン リストからテーブルを選択して、 `ProductID`、 `ProductName`、 `UnitPrice`、および`Discontinued`列、図 5 に示すようにします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-157">Therefore, from the Configure the Select Statement screen, choose the `Products` table from the drop-down list and select the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` columns, as shown in Figure 5.</span></span>


<span data-ttu-id="93c4d-158">[![Products テーブルから ProductID、ProductName、単価、および提供が中止された列を返す](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="93c4d-158">[![From the Products Table, Return the ProductID, ProductName, UnitPrice, and Discontinued Columns](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image7.png)</span></span>

<span data-ttu-id="93c4d-159">**図 5**: から、`Products`テーブルで、返す、 `ProductID`、 `ProductName`、 `UnitPrice`、および`Discontinued`列 ([フルサイズのイメージを表示するをクリックして](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="93c4d-159">**Figure 5**: From the `Products` Table, Return the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` Columns ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image8.png))</span></span>


<span data-ttu-id="93c4d-160">列を選択した後に、SQL 生成の詳細オプション ダイアログ ボックスを表示する高度なボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-160">After picking the columns, click the Advanced button to bring up the Advanced SQL Generation Options dialog box.</span></span> <span data-ttu-id="93c4d-161">確認の生成`INSERT`、 `UPDATE`、および`DELETE`ステートメント オプティミスティック同時実行制御チェック ボックスを使用し、[ok] をクリックして (戻る図 1 を参照スクリーン ショットの)。</span><span class="sxs-lookup"><span data-stu-id="93c4d-161">Check the Generate `INSERT`, `UPDATE`, and `DELETE` statements and Use optimistic concurrency checkboxes and click OK (refer back to Figure 1 for a screenshot).</span></span> <span data-ttu-id="93c4d-162">[次へ] をクリックしてウィザードを完了し、完了します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-162">Complete the wizard by clicking Next, then Finish.</span></span>

<span data-ttu-id="93c4d-163">データ ソース構成ウィザードを完了すると、結果を確認する少し時間を取って`DeleteCommand`と`UpdateCommand`プロパティおよび`DeleteParameters`と`UpdateParameters`コレクション。</span><span class="sxs-lookup"><span data-stu-id="93c4d-163">After completing the Configure Data Source wizard, take a moment to examine the resulting `DeleteCommand` and `UpdateCommand` properties and the `DeleteParameters` and `UpdateParameters` collections.</span></span> <span data-ttu-id="93c4d-164">これを行う最も簡単な方法では、ページの s 宣言の構文を表示する左下隅の ソース タブをクリックします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-164">The easiest way to do this is to click on the Source tab in the lower left corner to see the page s declarative syntax.</span></span> <span data-ttu-id="93c4d-165">サイトでは、`UpdateCommand`の値。</span><span class="sxs-lookup"><span data-stu-id="93c4d-165">There you will find an `UpdateCommand` value of:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample2.sql)]

<span data-ttu-id="93c4d-166">7 つのパラメーターを持つ、`UpdateParameters`コレクション。</span><span class="sxs-lookup"><span data-stu-id="93c4d-166">With seven parameters in the `UpdateParameters` collection:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample3.aspx)]

<span data-ttu-id="93c4d-167">同様に、`DeleteCommand`プロパティおよび`DeleteParameters`コレクションは、次のようになります。</span><span class="sxs-lookup"><span data-stu-id="93c4d-167">Similarly, the `DeleteCommand` property and `DeleteParameters` collection should look like the following:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample4.sql)]


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample5.aspx)]

<span data-ttu-id="93c4d-168">拡張だけでなく、`WHERE`の句、`UpdateCommand`と`DeleteCommand`プロパティ (とそれぞれのパラメーター コレクションに追加のパラメーターを追加する)、オプティミスティック同時実行オプションを調整しますその他の 2 つの使用を選択します。プロパティ:</span><span class="sxs-lookup"><span data-stu-id="93c4d-168">In addition to augmenting the `WHERE` clauses of the `UpdateCommand` and `DeleteCommand` properties (and adding the additional parameters to the respective parameter collections), selecting the Use optimistic concurrency option adjusts two other properties:</span></span>

- <span data-ttu-id="93c4d-169">変更、 [ `ConflictDetection`プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx)から`OverwriteChanges`(既定) に `CompareAllValues`</span><span class="sxs-lookup"><span data-stu-id="93c4d-169">Changes the [`ConflictDetection` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) from `OverwriteChanges` (the default) to `CompareAllValues`</span></span>
- <span data-ttu-id="93c4d-170">変更、 [ `OldValuesParameterFormatString`プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx){0} (既定) に元から\_{0}。</span><span class="sxs-lookup"><span data-stu-id="93c4d-170">Changes the [`OldValuesParameterFormatString` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) from {0} (the default) to original\_{0} .</span></span>

<span data-ttu-id="93c4d-171">データの Web コントロールが SqlDataSource s を呼び出す場合`Update()`または`Delete()`元の値で渡す方法、します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-171">When the data Web control invokes the SqlDataSource s `Update()` or `Delete()` method, it passes in the original values.</span></span> <span data-ttu-id="93c4d-172">場合は、SqlDataSource s`ConflictDetection`プロパティに設定されている`CompareAllValues`、元の値は、コマンドに追加されます。</span><span class="sxs-lookup"><span data-stu-id="93c4d-172">If the SqlDataSource s `ConflictDetection` property is set to `CompareAllValues`, these original values are added to the command.</span></span> <span data-ttu-id="93c4d-173">`OldValuesParameterFormatString`プロパティはこれらの元の値パラメーターに使用する名前付けパターンを提供します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-173">The `OldValuesParameterFormatString` property provides the naming pattern used for these original value parameters.</span></span> <span data-ttu-id="93c4d-174">データ ソース構成ウィザードを使用して元\_{0} し名前を元のパラメーターごと、`UpdateCommand`と`DeleteCommand`プロパティおよび`UpdateParameters`と`DeleteParameters`コレクションに応じて。</span><span class="sxs-lookup"><span data-stu-id="93c4d-174">The Configure Data Source wizard uses original\_{0} and names each original parameter in the `UpdateCommand` and `DeleteCommand` properties and `UpdateParameters` and `DeleteParameters` collections accordingly.</span></span>

> [!NOTE]
> <span data-ttu-id="93c4d-175">使用していない機能を挿入する SqlDataSource コントロール s re お気軽を削除するため、`InsertCommand`プロパティとその`InsertParameters`コレクション。</span><span class="sxs-lookup"><span data-stu-id="93c4d-175">Since we re not using the SqlDataSource control s inserting capabilities, feel free to remove the `InsertCommand` property and its `InsertParameters` collection.</span></span>


## <a name="correctly-handlingnullvalues"></a><span data-ttu-id="93c4d-176">適切な処理`NULL`値</span><span class="sxs-lookup"><span data-stu-id="93c4d-176">Correctly Handling`NULL`Values</span></span>

<span data-ttu-id="93c4d-177">残念ながら、augmented`UPDATE`と`DELETE`ステートメント オプティミスティック同時実行制御を使用するときに、データ ソースの構成ウィザードによって自動的に生成しないで*いない*を含むレコードを操作`NULL`値。</span><span class="sxs-lookup"><span data-stu-id="93c4d-177">Unfortunately, the augmented `UPDATE` and `DELETE` statements autogenerated by the Configure Data Source wizard when using optimistic concurrency do *not* work with records that contain `NULL` values.</span></span> <span data-ttu-id="93c4d-178">その理由を表示するには、当社 SqlDataSource s を検討してください`UpdateCommand`:。</span><span class="sxs-lookup"><span data-stu-id="93c4d-178">To see why, consider our SqlDataSource s `UpdateCommand`:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample6.sql)]

<span data-ttu-id="93c4d-179">`UnitPrice`内の列、`Products`テーブルが持つことができます`NULL`値。</span><span class="sxs-lookup"><span data-stu-id="93c4d-179">The `UnitPrice` column in the `Products` table can have `NULL` values.</span></span> <span data-ttu-id="93c4d-180">特定のレコードがある場合、`NULL`値を`UnitPrice`では、`WHERE`句部分`[UnitPrice] = @original_UnitPrice`は*常に*ので False に評価される`NULL = NULL`常に False を返します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-180">If a particular record has a `NULL` value for `UnitPrice`, the `WHERE` clause portion `[UnitPrice] = @original_UnitPrice` will *always* evaluate to False because `NULL = NULL` always returns False.</span></span> <span data-ttu-id="93c4d-181">そのため、レコードが含まれている`NULL`値を編集または削除すると、できませんとして、`UPDATE`と`DELETE`ステートメント`WHERE`句 won t の戻り値の行を更新または削除します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-181">Therefore, records that contain `NULL` values cannot be edited or deleted, as the `UPDATE` and `DELETE` statements `WHERE` clauses won t return any rows to update or delete.</span></span>

> [!NOTE]
> <span data-ttu-id="93c4d-182">このバグが最初の 2004 年 6 月に Microsoft に報告[生成の不適切な SQL ステートメントを SqlDataSource](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937)が ASP.NET の次のバージョンで修正されるとスケジュールされているとします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-182">This bug was first reported to Microsoft in June of 2004 in [SqlDataSource Generates Incorrect SQL Statements](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) and is reportedly scheduled to be fixed in the next version of ASP.NET.</span></span>


<span data-ttu-id="93c4d-183">手動で更新する必要はこれを解決するには、`WHERE`の両方の句、`UpdateCommand`と`DeleteCommand`プロパティを**すべて**ことのある列`NULL`値。</span><span class="sxs-lookup"><span data-stu-id="93c4d-183">To fix this, we have to manually update the `WHERE` clauses in both the `UpdateCommand` and `DeleteCommand` properties for **all** columns that can have `NULL` values.</span></span> <span data-ttu-id="93c4d-184">一般に、変更`[ColumnName] = @original_ColumnName`に。</span><span class="sxs-lookup"><span data-stu-id="93c4d-184">In general, change `[ColumnName] = @original_ColumnName` to:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample7.sql)]

<span data-ttu-id="93c4d-185">この変更が [プロパティ] ウィンドウから抽出または DeleteQuery オプションを使用して、宣言型マークアップを使用して直接、または、UPDATE を通じて実行でき、カスタム SQL ステートメントまたはストアド プロシージャのオプションを構成するデータの指定でのタブを削除します。ウィザードのソース。</span><span class="sxs-lookup"><span data-stu-id="93c4d-185">This modification can be made directly through the declarative markup, via the UpdateQuery or DeleteQuery options from the Properties window, or through the UPDATE and DELETE tabs in the Specify a custom SQL statement or stored procedure option in the Configure Data Source wizard.</span></span> <span data-ttu-id="93c4d-186">このような変更を再度行う必要があります*すべて*内の列、`UpdateCommand`と`DeleteCommand`s`WHERE`句を含めることができる`NULL`値。</span><span class="sxs-lookup"><span data-stu-id="93c4d-186">Again, this modification must be made for *every* column in the `UpdateCommand` and `DeleteCommand` s `WHERE` clause that can contain `NULL` values.</span></span>

<span data-ttu-id="93c4d-187">この例に適用するこの結果、次の変更`UpdateCommand`と`DeleteCommand`値。</span><span class="sxs-lookup"><span data-stu-id="93c4d-187">Applying this to our example results in the following modified `UpdateCommand` and `DeleteCommand` values:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample8.sql)]

## <a name="step-2-adding-a-gridview-with-edit-and-delete-options"></a><span data-ttu-id="93c4d-188">手順 2: 追加の編集および削除オプションの GridView</span><span class="sxs-lookup"><span data-stu-id="93c4d-188">Step 2: Adding a GridView with Edit and Delete Options</span></span>

<span data-ttu-id="93c4d-189">オプティミスティック同時実行制御をサポートするように構成 SqlDataSource、によるはこの同時実行制御を利用したページにデータ Web コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-189">With the SqlDataSource configured to support optimistic concurrency, all that remains is to add a data Web control to the page that utilizes this concurrency control.</span></span> <span data-ttu-id="93c4d-190">このチュートリアルでは、s の両方の編集を提供する GridView の追加し、削除機能を使用できます。</span><span class="sxs-lookup"><span data-stu-id="93c4d-190">For this tutorial, let s add a GridView that provides both edit and delete functionality.</span></span> <span data-ttu-id="93c4d-191">これを実現するには、ツールボックスからデザイナーとセットに GridView をドラッグ、`ID`に`Products`です。</span><span class="sxs-lookup"><span data-stu-id="93c4d-191">To accomplish this, drag a GridView from the Toolbox onto the Designer and set its `ID` to `Products`.</span></span> <span data-ttu-id="93c4d-192">GridView s のスマート タグからバインドを`ProductsDataSourceWithOptimisticConcurrency`SqlDataSource コントロールを手順 1. で追加します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-192">From the GridView s smart tag, bind it to the `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource control added in Step 1.</span></span> <span data-ttu-id="93c4d-193">最後に、スマート タグから編集を有効にして削除を有効にするオプションを確認します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-193">Finally, check the Enable Editing and Enable Deleting options from the smart tag.</span></span>


<span data-ttu-id="93c4d-194">[![SqlDataSource GridView にバインドし、編集および削除を有効にします。](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="93c4d-194">[![Bind the GridView to the SqlDataSource and Enable Editing and Deleting](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image9.png)</span></span>

<span data-ttu-id="93c4d-195">**図 6**: GridView にバインド SqlDataSource と編集を有効にして削除 ([フルサイズのイメージを表示するをクリックして](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="93c4d-195">**Figure 6**: Bind the GridView to the SqlDataSource and Enable Editing and Deleting ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image10.png))</span></span>


<span data-ttu-id="93c4d-196">GridView を追加すると、削除することで、外観を設定、 `ProductID` BoundField、変更、 `ProductName` BoundField s`HeaderText`製品、および更新するプロパティ、 `UnitPrice` BoundField ようにその`HeaderText`プロパティは、単に価格です。</span><span class="sxs-lookup"><span data-stu-id="93c4d-196">After adding the GridView, configure its appearance by removing the `ProductID` BoundField, changing the `ProductName` BoundField s `HeaderText` property to Product, and updating the `UnitPrice` BoundField so that its `HeaderText` property is simply Price.</span></span> <span data-ttu-id="93c4d-197">含めるの RequiredFieldValidator 編集インターフェイスを拡張 d お理想的には、`ProductName`値との CompareValidator、`UnitPrice`値 (s、正しく書式設定された数値ことを確認してください)。</span><span class="sxs-lookup"><span data-stu-id="93c4d-197">Ideally, we d enhance the editing interface to include a RequiredFieldValidator for the `ProductName` value and a CompareValidator for the `UnitPrice` value (to ensure it s a properly formatted numeric value).</span></span> <span data-ttu-id="93c4d-198">参照してください、[データ変更インターフェイスのカスタマイズ](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md)編集インターフェイス GridView s のカスタマイズをより詳しくのためのチュートリアルです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-198">Refer to the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md) tutorial for a more in-depth look at customizing the GridView s editing interface.</span></span>

> [!NOTE]
> <span data-ttu-id="93c4d-199">ビューステートに GridView から SqlDataSource に渡された元の値は s ビュー ステートを有効にする必要があります GridView 格納します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-199">The GridView s view state must be enabled since the original values passed from the GridView to the SqlDataSource are stored in view state.</span></span>


<span data-ttu-id="93c4d-200">GridView に次の変更を加えたら、GridView と SqlDataSource の宣言型マークアップを次のようになります。</span><span class="sxs-lookup"><span data-stu-id="93c4d-200">After making these modifications to the GridView, the GridView and SqlDataSource declarative markup should look similar to the following:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample9.aspx)]

<span data-ttu-id="93c4d-201">アクションでオプティミスティック同時実行制御を表示するには、2 つのブラウザー ウィンドウを開くし、読み込み、`OptimisticConcurrency.aspx`両方のページです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-201">To see the optimistic concurrency control in action, open two browser windows and load the `OptimisticConcurrency.aspx` page in both.</span></span> <span data-ttu-id="93c4d-202">両方のブラウザーで最初の製品の編集ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-202">Click on the Edit buttons for the first product in both browsers.</span></span> <span data-ttu-id="93c4d-203">1 つのブラウザーで、製品名を変更し、[更新] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-203">In one browser, change the product name and click Update.</span></span> <span data-ttu-id="93c4d-204">ブラウザーがポストバックをおよび GridView はモードに戻ります、前の編集、編集したレコードに対して新しい製品名を表示します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-204">The browser will postback and the GridView will return to its pre-editing mode, showing the new product name for the record just edited.</span></span>

<span data-ttu-id="93c4d-205">2 番目のブラウザーのウィンドウで (ただし、元の値と製品名のままにして) 価格を変更し、[更新] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-205">In the second browser window, change the price (but leave the product name as its original value) and click Update.</span></span> <span data-ttu-id="93c4d-206">ポストバックでグリッドをあらかじめ編集モードを返しますが、価格の変更は記録されません。</span><span class="sxs-lookup"><span data-stu-id="93c4d-206">On postback, the grid returns to its pre-editing mode, but the change to the price is not recorded.</span></span> <span data-ttu-id="93c4d-207">2 番目のブラウザーは、1 つ目と同じ値に古い価格を含む新しい製品名を表示します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-207">The second browser shows the same value as the first one the new product name with the old price.</span></span> <span data-ttu-id="93c4d-208">2 番目のブラウザー ウィンドウで行った変更は失われました。</span><span class="sxs-lookup"><span data-stu-id="93c4d-208">The changes made in the second browser window were lost.</span></span> <span data-ttu-id="93c4d-209">さらに、変更が失われたサイレント モードではなく、例外または同時実行制御違反が発生したことを示すメッセージがないためです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-209">Moreover, the changes were lost rather quietly, as there was no exception or message indicating that a concurrency violation just occurred.</span></span>


<span data-ttu-id="93c4d-210">[![2 番目のブラウザーのウィンドウで変更は自動的に失われました](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="93c4d-210">[![The Changes in the Second Browser Window Were Silently Lost](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image11.png)</span></span>

<span data-ttu-id="93c4d-211">**図 7**: 2 番目のブラウザー ウィンドウ サイレント モードで失われた、変更 ([フルサイズのイメージを表示するをクリックして](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="93c4d-211">**Figure 7**: The Changes in the Second Browser Window Were Silently Lost ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image12.png))</span></span>


<span data-ttu-id="93c4d-212">なぜブラウザー s の 2 番目の変更はコミットされていなかったためがあるため、`UPDATE`ステートメント`WHERE`句のすべてのレコードをフィルター処理され、したがってしなかったすべての行に影響しません。</span><span class="sxs-lookup"><span data-stu-id="93c4d-212">The reason why the second browser s changes were not committed was because the `UPDATE` statement s `WHERE` clause filtered out all records and therefore did not affect any rows.</span></span> <span data-ttu-id="93c4d-213">Let s を見て、`UPDATE`ステートメントをもう一度。</span><span class="sxs-lookup"><span data-stu-id="93c4d-213">Let s look at the `UPDATE` statement again:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample10.sql)]

<span data-ttu-id="93c4d-214">元の製品名が指定された 2 番目のブラウザー ウィンドウには、レコードが更新され、ときに、`WHERE`句では t との一致を (最初のブラウザーによって変更された) してから、既存の製品名。</span><span class="sxs-lookup"><span data-stu-id="93c4d-214">When the second browser window updates the record, the original product name specified in the `WHERE` clause doesn t match up with the existing product name (since it was changed by the first browser).</span></span> <span data-ttu-id="93c4d-215">そのため、ステートメント`[ProductName] = @original_ProductName`は False を返しますと`UPDATE`いくつかのレコードには影響しません。</span><span class="sxs-lookup"><span data-stu-id="93c4d-215">Therefore, the statement `[ProductName] = @original_ProductName` returns False, and the `UPDATE` does not affect any records.</span></span>

> [!NOTE]
> <span data-ttu-id="93c4d-216">同様に動作を削除します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-216">Delete works in the same manner.</span></span> <span data-ttu-id="93c4d-217">2 つのブラウザー ウィンドウが開き、編集、1 つの特定の製品とその変更を保存して起動します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-217">With two browser windows open, start by editing a given product with one, and then saving its changes.</span></span> <span data-ttu-id="93c4d-218">1 つのブラウザーで、変更を保存した後、他の同じ製品の削除 ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-218">After saving the changes in the one browser, click the Delete button for the same product in the other.</span></span> <span data-ttu-id="93c4d-219">一致、元の値がないのため、`DELETE`ステートメント`WHERE`句、削除は失敗します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-219">Since the original values don t match up in the `DELETE` statement s `WHERE` clause, the delete silently fails.</span></span>


<span data-ttu-id="93c4d-220">エンド ユーザー s の観点から 2 番目のブラウザーのウィンドウで、[更新] ボタンをクリックした後、グリッド返します事前編集モードが、その変更は失われました。</span><span class="sxs-lookup"><span data-stu-id="93c4d-220">From the end user s perspective in the second browser window, after clicking the Update button the grid returns to the pre-editing mode, but their changes were lost.</span></span> <span data-ttu-id="93c4d-221">ただし、ある s なし、変更されなかった t スティックを視覚的なフィードバックです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-221">However, there s no visual feedback that their changes didn t stick.</span></span> <span data-ttu-id="93c4d-222">理想的には、ユーザーが変更されたが、同時実行制御違反が失われた場合は、d はその旨を通知、おそらくを維持する. グリッド編集モードで</span><span class="sxs-lookup"><span data-stu-id="93c4d-222">Ideally, if a user s changes are lost to a concurrency violation, we d notify them and, perhaps, keep the grid in edit mode.</span></span> <span data-ttu-id="93c4d-223">これを実現する方法について見て s を使用できます。</span><span class="sxs-lookup"><span data-stu-id="93c4d-223">Let s look at how to accomplish this.</span></span>

## <a name="step-3-determining-when-a-concurrency-violation-has-occurred"></a><span data-ttu-id="93c4d-224">手順 3: は、同時実行制御違反が発生した場合を決定します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-224">Step 3: Determining When a Concurrency Violation Has Occurred</span></span>

<span data-ttu-id="93c4d-225">同時実行制御違反は、いずれかが行われた変更を拒否するため、同時実行制御違反が発生したときにユーザーに警告する nice はなります。</span><span class="sxs-lookup"><span data-stu-id="93c4d-225">Since a concurrency violation rejects the changes one has made, it would be nice to alert the user when a concurrency violation has occurred.</span></span> <span data-ttu-id="93c4d-226">Let s がという名前のページの上部にラベル Web コントロールを追加して、警告、`ConcurrencyViolationMessage`が`Text`プロパティには、次のメッセージが表示されます。 更新または別のユーザーによって同時に更新されたレコードを削除しようとしました。</span><span class="sxs-lookup"><span data-stu-id="93c4d-226">To alert the user, let s add a Label Web control to the top of the page named `ConcurrencyViolationMessage` whose `Text` property displays the following message: You have attempted to update or delete a record that was simultaneously updated by another user.</span></span> <span data-ttu-id="93c4d-227">他のユーザーの変更の確認し、更新プログラムを再実行か削除してください。</span><span class="sxs-lookup"><span data-stu-id="93c4d-227">Please review the other user's changes and then redo your update or delete.</span></span> <span data-ttu-id="93c4d-228">ラベル コントロール s 設定`CssClass`が警告には、CSS クラスのプロパティで定義`Styles.css`赤、斜体、太字、および大きなフォントでテキストを表示します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-228">Set the Label control s `CssClass` property to Warning, which is a CSS class defined in `Styles.css` that displays text in a red, italic, bold, and large font.</span></span> <span data-ttu-id="93c4d-229">最後に、s のラベルを設定`Visible`と`EnableViewState`プロパティ`False`です。</span><span class="sxs-lookup"><span data-stu-id="93c4d-229">Finally, set the Label s `Visible` and `EnableViewState` properties to `False`.</span></span> <span data-ttu-id="93c4d-230">これは明示的に設定されているポストバックのみを除く、ラベルを非表示にその`Visible`プロパティを`True`です。</span><span class="sxs-lookup"><span data-stu-id="93c4d-230">This will hide the Label except for only those postbacks where we explicitly set its `Visible` property to `True`.</span></span>


<span data-ttu-id="93c4d-231">[![ラベル コントロールに、警告を表示するページを追加します。](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="93c4d-231">[![Add a Label Control to the Page to Display the Warning](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image13.png)</span></span>

<span data-ttu-id="93c4d-232">**図 8**: ラベル コントロールに、警告を表示するページを追加 ([フルサイズのイメージを表示するをクリックして](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="93c4d-232">**Figure 8**: Add a Label Control to the Page to Display the Warning ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image14.png))</span></span>


<span data-ttu-id="93c4d-233">更新または削除、GridView s を実行するときに`RowUpdated`と`RowDeleted`イベント ハンドラーがそのデータ ソース コントロールは、要求された更新または削除が実行後に起動します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-233">When performing an update or delete, the GridView s `RowUpdated` and `RowDeleted` event handlers fire after its data source control has performed the requested update or delete.</span></span> <span data-ttu-id="93c4d-234">これらのイベント ハンドラーからの操作によって影響を受けた行の数を判断できます。</span><span class="sxs-lookup"><span data-stu-id="93c4d-234">We can determine how many rows were affected by the operation from these event handlers.</span></span> <span data-ttu-id="93c4d-235">表示する場合は 0 行が影響を受けた、`ConcurrencyViolationMessage`ラベル。</span><span class="sxs-lookup"><span data-stu-id="93c4d-235">If zero rows were affected, we want to display the `ConcurrencyViolationMessage` Label.</span></span>

<span data-ttu-id="93c4d-236">両方のイベント ハンドラーを作成、`RowUpdated`と`RowDeleted`イベントし、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-236">Create an event handler for both the `RowUpdated` and `RowDeleted` events and add the following code:</span></span>


[!code-vb[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample11.vb)]

<span data-ttu-id="93c4d-237">確認の両方のイベント ハンドラー、`e.AffectedRows`プロパティと、0 の場合、設定、`ConcurrencyViolationMessage`ラベル s`Visible`プロパティを`True`です。</span><span class="sxs-lookup"><span data-stu-id="93c4d-237">In both event handlers we check the `e.AffectedRows` property and, if it equals 0, set the `ConcurrencyViolationMessage` Label s `Visible` property to `True`.</span></span> <span data-ttu-id="93c4d-238">`RowUpdated` 、イベント ハンドラーもよう指示し、GridView を設定して編集モードで維持、`KeepInEditMode`プロパティを true にします。</span><span class="sxs-lookup"><span data-stu-id="93c4d-238">In the `RowUpdated` event handler, we also instruct the GridView to stay in edit mode by setting the `KeepInEditMode` property to true.</span></span> <span data-ttu-id="93c4d-239">これにより、編集のインターフェイスにその他のユーザー データが読み込まれるように、グリッドにデータを再バインドする必要があります。</span><span class="sxs-lookup"><span data-stu-id="93c4d-239">In doing so, we need to rebind the data to the grid so that the other user s data is loaded into the editing interface.</span></span> <span data-ttu-id="93c4d-240">GridView s を呼び出すことによってこれを行う`DataBind()`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="93c4d-240">This is accomplished by calling the GridView s `DataBind()` method.</span></span>

<span data-ttu-id="93c4d-241">これら 2 つのイベント ハンドラーを使用して、図 9 に示すように、同時実行制御違反が発生するたびに、非常に大きなメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="93c4d-241">As Figure 9 shows, with these two event handlers, a very noticeable message is displayed whenever a concurrency violation occurs.</span></span>


<span data-ttu-id="93c4d-242">[![同時実行制御違反が発生した場合、メッセージが表示されます。](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="93c4d-242">[![A Message is Displayed in the Face of a Concurrency Violation](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image15.png)</span></span>

<span data-ttu-id="93c4d-243">**図 9**: 同時実行制御違反が発生した場合、メッセージが表示されます ([フルサイズのイメージを表示するをクリックして](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="93c4d-243">**Figure 9**: A Message is Displayed in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image16.png))</span></span>


## <a name="summary"></a><span data-ttu-id="93c4d-244">まとめ</span><span class="sxs-lookup"><span data-stu-id="93c4d-244">Summary</span></span>

<span data-ttu-id="93c4d-245">Web アプリケーションを作成するときに、複数、同時実行ユーザーが、同じデータを編集する同時実行制御オプションを検討することが重要です。</span><span class="sxs-lookup"><span data-stu-id="93c4d-245">When creating a web application where multiple, concurrent users may be editing the same data, it is important to consider concurrency control options.</span></span> <span data-ttu-id="93c4d-246">既定では、Web コントロールの ASP.NET データとデータ ソース コントロールを使用していないすべての同時実行制御。</span><span class="sxs-lookup"><span data-stu-id="93c4d-246">By default, the ASP.NET data Web controls and data source controls do not employ any concurrency control.</span></span> <span data-ttu-id="93c4d-247">このチュートリアルで説明したとおり、SqlDataSource でオプティミスティック同時実行制御を実装することは比較的迅速かつ簡単です。</span><span class="sxs-lookup"><span data-stu-id="93c4d-247">As we saw in this tutorial, implementing optimistic concurrency control with the SqlDataSource is relatively quick and easy.</span></span> <span data-ttu-id="93c4d-248">SqlDataSource 補完された、追加の作業の大半を処理する`WHERE`自動生成された句`UPDATE`と`DELETE`ステートメントがありますが、処理のいくつかの微妙な`NULL`で説明したように、列の値、適切な処理`NULL`セクションの値します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-248">The SqlDataSource handles most of the legwork for your adding augmented `WHERE` clauses to the autogenerated `UPDATE` and `DELETE` statements but there are a few subtleties in handling `NULL` value columns, as discussed in the Correctly Handling `NULL` Values section.</span></span>

<span data-ttu-id="93c4d-249">このチュートリアルでは、SqlDataSource 弊社の調査で終了します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-249">This tutorial concludes our examination of the SqlDataSource.</span></span> <span data-ttu-id="93c4d-250">残りのチュートリアルは、ObjectDataSource と階層化されたアーキテクチャを使用してデータを扱うに戻ります。</span><span class="sxs-lookup"><span data-stu-id="93c4d-250">Our remaining tutorials will return to working with data using the ObjectDataSource and tiered architecture.</span></span>

<span data-ttu-id="93c4d-251">満足プログラミング!</span><span class="sxs-lookup"><span data-stu-id="93c4d-251">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="93c4d-252">作成者について</span><span class="sxs-lookup"><span data-stu-id="93c4d-252">About the Author</span></span>

<span data-ttu-id="93c4d-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)、7 つ受け取りますブックとの創設者の作成者[4GuysFromRolla.com](http://www.4guysfromrolla.com)、1998 年からマイクロソフトの Web テクノロジで取り組んできました。</span><span class="sxs-lookup"><span data-stu-id="93c4d-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="93c4d-254">Scott は、コンサルタント、トレーナー、ライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="93c4d-254">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="93c4d-255">最新の著書[ *Sam 学べる自分で ASP.NET 2.0 が 24 時間以内に*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)です。</span><span class="sxs-lookup"><span data-stu-id="93c4d-255">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="93c4d-256">彼に到達できる[ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)彼のブログを使用して含まれているのか[ http://ScottOnWriting.NET](http://ScottOnWriting.NET)です。</span><span class="sxs-lookup"><span data-stu-id="93c4d-256">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="93c4d-257">前へ</span><span class="sxs-lookup"><span data-stu-id="93c4d-257">Previous</span></span>](inserting-updating-and-deleting-data-with-the-sqldatasource-vb.md)
