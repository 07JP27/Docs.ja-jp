---
uid: web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
title: SQL キャッシュ依存関係 (c#) を使用して |Microsoft ドキュメント
author: rick-anderson
description: 最も単純なキャッシュ方法では、キャッシュされたデータの一定の時間後に期限切れです。 しかし、この簡単な方法をキャッシュされたデータ maintai.
ms.author: aspnetcontent
manager: wpickett
ms.date: 05/30/2007
ms.topic: article
ms.assetid: 0e91842c-7f10-4aed-8c23-4ee3e2774014
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
msc.type: authoredcontent
ms.openlocfilehash: 8660fd979b5f18ed0182c8ae1e671f362f5dec7e
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/06/2018
ms.locfileid: "30877984"
---
<a name="using-sql-cache-dependencies-c"></a><span data-ttu-id="984f0-104">SQL キャッシュ依存関係 (c#) を使用します。</span><span class="sxs-lookup"><span data-stu-id="984f0-104">Using SQL Cache Dependencies (C#)</span></span>
====================
<span data-ttu-id="984f0-105">によって[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="984f0-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="984f0-106">[コードをダウンロードする](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_CS.zip)または[PDF のダウンロード](using-sql-cache-dependencies-cs/_static/datatutorial61cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="984f0-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_CS.zip) or [Download PDF](using-sql-cache-dependencies-cs/_static/datatutorial61cs1.pdf)</span></span>

> <span data-ttu-id="984f0-107">最も単純なキャッシュ方法では、キャッシュされたデータの一定の時間後に期限切れです。</span><span class="sxs-lookup"><span data-stu-id="984f0-107">The simplest caching strategy is to allow cached data to expire after a specified period of time.</span></span> <span data-ttu-id="984f0-108">ただし、この簡単な方法では、キャッシュされたデータでは、古いデータを長時間保持されているや最新のデータが短時間に期限が切れていますが、基になるデータ ソースとの関連付けは保持されません。</span><span class="sxs-lookup"><span data-stu-id="984f0-108">But this simple approach means that the cached data maintains no association with its underlying data source, resulting in stale data that is held too long or current data that is expired too soon.</span></span> <span data-ttu-id="984f0-109">その基になるデータが、SQL データベースに変更されたまでキャッシュされたデータが保持されるように、SqlCacheDependency クラスを使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="984f0-109">A better approach is to use the SqlCacheDependency class so that data remains cached until its underlying data has been modified in the SQL database.</span></span> <span data-ttu-id="984f0-110">方法は、このチュートリアルで説明します。</span><span class="sxs-lookup"><span data-stu-id="984f0-110">This tutorial shows you how.</span></span>


## <a name="introduction"></a><span data-ttu-id="984f0-111">はじめに</span><span class="sxs-lookup"><span data-stu-id="984f0-111">Introduction</span></span>

<span data-ttu-id="984f0-112">キャッシュの技術確認、 [、ObjectDataSource でデータをキャッシュ](caching-data-with-the-objectdatasource-cs.md)と[アーキテクチャでは、データをキャッシュ](caching-data-in-the-architecture-cs.md)チュートリアルでは、時間ベースの有効期限を使用を指定した後、キャッシュからデータを削除するには期間。</span><span class="sxs-lookup"><span data-stu-id="984f0-112">The caching techniques examined in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) and [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorials used a time-based expiry to evict the data from the cache after a specified period.</span></span> <span data-ttu-id="984f0-113">この方法は、データの陳腐化に対してキャッシュのパフォーマンスの向上を分散する最も簡単な方法です。</span><span class="sxs-lookup"><span data-stu-id="984f0-113">This approach is the simplest way to balance the performance gains of caching against data staleness.</span></span> <span data-ttu-id="984f0-114">時間の有効期限を選択して*x* 、ページの開発者 concedes 秒までの間のキャッシュ機能のみのパフォーマンスの利点をご利用いただけます*x*秒しますが、安心です自分のデータを最大値よりも長く古いできなくなります*x* (秒)。</span><span class="sxs-lookup"><span data-stu-id="984f0-114">By selecting a time expiry of *x* seconds, a page developer concedes to enjoy the performance benefits of caching for only *x* seconds, but can rest easy that her data will never be stale longer than a maximum of *x* seconds.</span></span> <span data-ttu-id="984f0-115">もちろん、静的なデータの*x*で確認されたに応じて、web アプリケーションの有効期間に拡張することができます、[アプリケーションの起動時にデータをキャッシュ](caching-data-at-application-startup-cs.md)チュートリアルです。</span><span class="sxs-lookup"><span data-stu-id="984f0-115">Of course, for static data, *x* can be extended to the lifetime of the web application, as was examined in the [Caching Data at Application Startup](caching-data-at-application-startup-cs.md) tutorial.</span></span>

<span data-ttu-id="984f0-116">データベースのデータをキャッシュするには、時間ベースの有効期限は、使いやすさに多くの場合、選択されているが、不適切なソリューションでは頻繁にします。</span><span class="sxs-lookup"><span data-stu-id="984f0-116">When caching database data, a time-based expiry is often chosen for its ease of use but is frequently an inadequate solution.</span></span> <span data-ttu-id="984f0-117">理想的には、データベースのデータは、基になるデータがデータベースに変更されてまでキャッシュされたまましかし、キャッシュを削除するとします。</span><span class="sxs-lookup"><span data-stu-id="984f0-117">Ideally, the database data would remain cached until the underlying data has been modified in the database; only then would the cache be evicted.</span></span> <span data-ttu-id="984f0-118">この方法は、キャッシュのパフォーマンス メリットを最大化され、古いデータの時間を最小限に抑えられます。</span><span class="sxs-lookup"><span data-stu-id="984f0-118">This approach maximizes the performance benefits of caching and minimizes the duration of stale data.</span></span> <span data-ttu-id="984f0-119">ただし、これらの利点がありますを活用するためには、基になるデータベースのデータが変更されており、キャッシュから対応する項目を削除を知っている場所にいくつかのシステムをする必要があります。</span><span class="sxs-lookup"><span data-stu-id="984f0-119">However, in order to enjoy these benefits there must be some system in place that knows when the underlying database data has been modified and evicts the corresponding items from the cache.</span></span> <span data-ttu-id="984f0-120">ASP.NET 2.0 では、前にページの開発者がこのシステムの実装を担当します。</span><span class="sxs-lookup"><span data-stu-id="984f0-120">Prior to ASP.NET 2.0, page developers were responsible for implementing this system.</span></span>

<span data-ttu-id="984f0-121">ASP.NET 2.0 には、 [ `SqlCacheDependency`クラス](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx)し、変更が発生すると、データベースにキャッシュされたアイテムを対応することを決定するために必要なインフラストラクチャを削除することができます。</span><span class="sxs-lookup"><span data-stu-id="984f0-121">ASP.NET 2.0 provides a [`SqlCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx) and the necessary infrastructure to determine when a change has occurred in the database so that the corresponding cached items can be evicted.</span></span> <span data-ttu-id="984f0-122">基になるデータが変更されたときを判断するための 2 つの方法があります: 通知とポーリングします。</span><span class="sxs-lookup"><span data-stu-id="984f0-122">There are two techniques for determining when the underlying data has changed: notification and polling.</span></span> <span data-ttu-id="984f0-123">通知とポーリングの違いを紹介した後を作成、インフラストラクチャ ポーリングをサポートし、使用する方法を調査するために必要な`SqlCacheDependency`宣言内のクラスをプログラムでのシナリオです。</span><span class="sxs-lookup"><span data-stu-id="984f0-123">After discussing the differences between notification and polling, we'll create the infrastructure necessary to support polling and then explore how to use the `SqlCacheDependency` class in declarative and programmatically scenarios.</span></span>

## <a name="understanding-notification-and-polling"></a><span data-ttu-id="984f0-124">Understanding 通知とポーリング</span><span class="sxs-lookup"><span data-stu-id="984f0-124">Understanding Notification and Polling</span></span>

<span data-ttu-id="984f0-125">データベース内のデータが変更されたときの決定に使用できる 2 つの方法があります: 通知とポーリングします。</span><span class="sxs-lookup"><span data-stu-id="984f0-125">There are two techniques that can be used to determine when the data in a database has been modified: notification and polling.</span></span> <span data-ttu-id="984f0-126">通知には、データベースが自動的にクエリが最後に実行されるため、特定のクエリの結果が変更されたときに、ASP.NET ランタイムがエラー、この時点で、クエリに関連付けられているキャッシュされたアイテムが削除されます。</span><span class="sxs-lookup"><span data-stu-id="984f0-126">With notification, the database automatically alerts the ASP.NET runtime when the results of a particular query have been changed since the query was last executed, at which point the cached items associated with the query are evicted.</span></span> <span data-ttu-id="984f0-127">、ポーリングでは、データベース サーバーは、特定のテーブルが前回更新されたときに関する情報を保持します。</span><span class="sxs-lookup"><span data-stu-id="984f0-127">With polling, the database server maintains information about when particular tables have last been updated.</span></span> <span data-ttu-id="984f0-128">ASP.NET ランタイムが変更されているテーブルをチェックするデータベースを定期的にポーリングをキャッシュに入力されたためです。</span><span class="sxs-lookup"><span data-stu-id="984f0-128">The ASP.NET runtime periodically polls the database to check what tables have changed since they were entered into the cache.</span></span> <span data-ttu-id="984f0-129">データが変更されたこれらのテーブルがある、関連するキャッシュ アイテムを削除します。</span><span class="sxs-lookup"><span data-stu-id="984f0-129">Those tables whose data has been modified have their associated cache items evicted.</span></span>

<span data-ttu-id="984f0-130">通知オプション ポーリングよりも少ないセットアップを必要より詳細なクエリ レベルではなく、テーブル レベルでの変更を追跡するためです。</span><span class="sxs-lookup"><span data-stu-id="984f0-130">The notification option requires less setup than polling and is more granular since it tracks changes at the query level rather than at the table level.</span></span> <span data-ttu-id="984f0-131">残念ながら、通知では、Microsoft SQL Server 2005 (つまり、Express 以外のエディション) の全エディションで使用できるのみです。</span><span class="sxs-lookup"><span data-stu-id="984f0-131">Unfortunately, notifications are only available in the full editions of Microsoft SQL Server 2005 (i.e., the non-Express editions).</span></span> <span data-ttu-id="984f0-132">ただし、すべてのバージョンの Microsoft SQL Server 2005 を 7.0 からのポーリング オプションを使用できます。</span><span class="sxs-lookup"><span data-stu-id="984f0-132">However, the polling option can be used for all versions of Microsoft SQL Server from 7.0 to 2005.</span></span> <span data-ttu-id="984f0-133">これらのチュートリアルでは、SQL Server 2005 Express edition を使用するための設定およびポーリング オプションを使用してに焦点を当てます。</span><span class="sxs-lookup"><span data-stu-id="984f0-133">Since these tutorials use the Express edition of SQL Server 2005, we will focus on setting up and using the polling option.</span></span> <span data-ttu-id="984f0-134">SQL Server 2005 の通知機能上のリソースには、このチュートリアルの最後に、さらに閲覧のセクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="984f0-134">Consult the Further Reading section at the end of this tutorial for further resources on SQL Server 2005 s notification capabilities.</span></span>

<span data-ttu-id="984f0-135">、ポーリングでという名前のテーブルを含めるにデータベースを構成する必要があります`AspNet_SqlCacheTablesForChangeNotification`- 3 つの列を持つ`tableName`、 `notificationCreated`、および`changeId`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-135">With polling, the database must be configured to include a table named `AspNet_SqlCacheTablesForChangeNotification` that has three columns - `tableName`, `notificationCreated`, and `changeId`.</span></span> <span data-ttu-id="984f0-136">このテーブルには、web アプリケーションで、SQL キャッシュ依存関係で使用する必要があるデータを持つ各テーブルの行が含まれています。</span><span class="sxs-lookup"><span data-stu-id="984f0-136">This table contains a row for each table that has data that might need to be used in a SQL cache dependency in the web application.</span></span> <span data-ttu-id="984f0-137">`tableName`列中にテーブルの名前を指定する`notificationCreated`行がテーブルに追加された日時を示します。</span><span class="sxs-lookup"><span data-stu-id="984f0-137">The `tableName` column specifies the name of the table while `notificationCreated` indicates the date and time the row was added to the table.</span></span> <span data-ttu-id="984f0-138">`changeId`型の列は、 `int` 0 の最初の値を保持しています。</span><span class="sxs-lookup"><span data-stu-id="984f0-138">The `changeId` column is of type `int` and has an initial value of 0.</span></span> <span data-ttu-id="984f0-139">その値は、テーブルを変更するたびにインクリメントされます。</span><span class="sxs-lookup"><span data-stu-id="984f0-139">Its value is incremented with each modification to the table.</span></span>

<span data-ttu-id="984f0-140">加え、`AspNet_SqlCacheTablesForChangeNotification`テーブル、データベースもする必要があります SQL キャッシュ依存関係に表示されるテーブルの各トリガーを含めます。</span><span class="sxs-lookup"><span data-stu-id="984f0-140">In addition to the `AspNet_SqlCacheTablesForChangeNotification` table, the database also needs to include triggers on each of the tables that may appear in a SQL cache dependency.</span></span> <span data-ttu-id="984f0-141">これらのトリガーは行が挿入、更新、または削除されるたびに実行され、表 s をインクリメント`changeId`値`AspNet_SqlCacheTablesForChangeNotification`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-141">These triggers are executed whenever a row is inserted, updated, or deleted and increment the table s `changeId` value in `AspNet_SqlCacheTablesForChangeNotification`.</span></span>

<span data-ttu-id="984f0-142">ASP.NET ランタイムが、現在は追跡`changeId`を使用してデータをキャッシュすると、テーブルの`SqlCacheDependency`オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="984f0-142">The ASP.NET runtime tracks the current `changeId` for a table when caching data using a `SqlCacheDependency` object.</span></span> <span data-ttu-id="984f0-143">データベースが定期的にチェックと任意`SqlCacheDependency`オブジェクト`changeId`、データベース内の値とは異なりますが、異なるされてから解放される`changeId`ことがありますが変更されたテーブルにデータがキャッシュされるため値を示します。</span><span class="sxs-lookup"><span data-stu-id="984f0-143">The database is periodically checked and any `SqlCacheDependency` objects whose `changeId` differs from the value in the database are evicted since a differing `changeId` value indicates that there has been a change to the table since the data was cached.</span></span>

## <a name="step-1-exploring-theaspnetregsqlexecommand-line-program"></a><span data-ttu-id="984f0-144">手順 1: 探索、`aspnet_regsql.exe`コマンド ライン プログラム</span><span class="sxs-lookup"><span data-stu-id="984f0-144">Step 1: Exploring the`aspnet_regsql.exe`Command Line Program</span></span>

<span data-ttu-id="984f0-145">ポーリング アプローチでは、データベースが上記で説明したインフラストラクチャを格納するセットアップをする必要があります定義済みのテーブル (`AspNet_SqlCacheTablesForChangeNotification`)、いくつかのストアド プロシージャ、および各 SQL キャッシュ依存関係が、web での使用可能性があるテーブルのトリガー。アプリケーション。</span><span class="sxs-lookup"><span data-stu-id="984f0-145">With the polling approach the database must be setup to contain the infrastructure described above: a predefined table (`AspNet_SqlCacheTablesForChangeNotification`), a handful of stored procedures, and triggers on each of the tables that may be used in SQL cache dependencies in the web application.</span></span> <span data-ttu-id="984f0-146">これらのテーブル、ストアド プロシージャ、およびトリガーは、コマンド ライン プログラムで作成できます`aspnet_regsql.exe`に存在する、`$WINDOWS$\Microsoft.NET\Framework\version`フォルダーです。</span><span class="sxs-lookup"><span data-stu-id="984f0-146">These tables, stored procedures, and triggers can be created through the command line program `aspnet_regsql.exe`, which is found in the `$WINDOWS$\Microsoft.NET\Framework\version` folder.</span></span> <span data-ttu-id="984f0-147">作成する、`AspNet_SqlCacheTablesForChangeNotification`テーブルと関連するストアド プロシージャ、コマンドラインから、次を実行します。</span><span class="sxs-lookup"><span data-stu-id="984f0-147">To create the `AspNet_SqlCacheTablesForChangeNotification` table and associated stored procedures, run the following from the command line:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample1.cmd)]

> [!NOTE]
> <span data-ttu-id="984f0-148">指定されたデータベース ログインがあります。 これらのコマンドを実行する、 [ `db_securityadmin` ](https://msdn.microsoft.com/library/ms188685.aspx)と[ `db_ddladmin` ](https://msdn.microsoft.com/library/ms190667.aspx)ロール。</span><span class="sxs-lookup"><span data-stu-id="984f0-148">To execute these commands the specified database login must be in the [`db_securityadmin`](https://msdn.microsoft.com/library/ms188685.aspx) and [`db_ddladmin`](https://msdn.microsoft.com/library/ms190667.aspx) roles.</span></span> <span data-ttu-id="984f0-149">データベースに送信する T-SQL を検査する、`aspnet_regsql.exe`コマンド ライン プログラムを参照してください[このブログ記事](http://scottonwriting.net/sowblog/posts/10709.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="984f0-149">To examine the T-SQL sent to the database by the `aspnet_regsql.exe` command line program, refer to [this blog entry](http://scottonwriting.net/sowblog/posts/10709.aspx).</span></span>


<span data-ttu-id="984f0-150">たとえば、Microsoft SQL Server データベースをポーリングするためのインフラストラクチャを追加するという名前の`pubs`という名前のデータベース サーバーで`ScottsServer`Windows 認証を使用して、適切なディレクトリに移動し、コマンド ライン コマンドを入力します。</span><span class="sxs-lookup"><span data-stu-id="984f0-150">For example, to add the infrastructure for polling to a Microsoft SQL Server database named `pubs` on a database server named `ScottsServer` using Windows Authentication, navigate to the appropriate directory and, from the command line, enter:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample2.cmd)]

<span data-ttu-id="984f0-151">データベース レベルのインフラストラクチャが追加した後、SQL キャッシュ依存関係で使用されるこれらのテーブルにトリガーを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="984f0-151">After the database-level infrastructure has been added, we need to add the triggers to those tables that will be used in SQL cache dependencies.</span></span> <span data-ttu-id="984f0-152">使用して、`aspnet_regsql.exe`コマンド ライン プログラムをもう一度が、テーブルを使用して名前を指定して、`-t`スイッチおよび使用する代わりに、`-ed`使用を切り替える`-et`、次のように。</span><span class="sxs-lookup"><span data-stu-id="984f0-152">Use the `aspnet_regsql.exe` command line program again, but specify the table name using the `-t` switch and instead of using the `-ed` switch use `-et`, like so:</span></span>


[!code-html[Main](using-sql-cache-dependencies-cs/samples/sample3.html)]

<span data-ttu-id="984f0-153">トリガーを追加する、`authors`と`titles`でテーブル、`pubs`上のデータベース`ScottsServer`を使用します。</span><span class="sxs-lookup"><span data-stu-id="984f0-153">To add the triggers to the `authors` and `titles` tables on the `pubs` database on `ScottsServer`, use:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample4.cmd)]

<span data-ttu-id="984f0-154">このチュートリアルでは追加、トリガーを`Products`、 `Categories`、および`Suppliers`テーブル。</span><span class="sxs-lookup"><span data-stu-id="984f0-154">For this tutorial add the triggers to the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="984f0-155">手順 3. で特定のコマンドライン構文に紹介します。</span><span class="sxs-lookup"><span data-stu-id="984f0-155">We'll look at the particular command line syntax in Step 3.</span></span>

## <a name="step-2-referencing-a-microsoft-sql-server-2005-express-edition-database-inappdata"></a><span data-ttu-id="984f0-156">手順 2: で Microsoft SQL Server 2005 Express Edition データベースを参照します。`App_Data`</span><span class="sxs-lookup"><span data-stu-id="984f0-156">Step 2: Referencing a Microsoft SQL Server 2005 Express Edition Database in`App_Data`</span></span>

<span data-ttu-id="984f0-157">`aspnet_regsql.exe`コマンド ライン プログラムでは、ポーリングのために必要なインフラストラクチャを追加するために、データベースとサーバー名が必要です。</span><span class="sxs-lookup"><span data-stu-id="984f0-157">The `aspnet_regsql.exe` command line program requires the database and server name in order to add the necessary polling infrastructure.</span></span> <span data-ttu-id="984f0-158">存在する Microsoft SQL Server 2005 Express のデータベースのデータベースとサーバーの名前は何ですが、`App_Data`フォルダーですか?</span><span class="sxs-lookup"><span data-stu-id="984f0-158">But what is the database and server name for a Microsoft SQL Server 2005 Express database that resides in the `App_Data` folder?</span></span> <span data-ttu-id="984f0-159">データベースとサーバーの名前とは何かを検出するのではなくすればにデータベースをアタッチする最も簡単な方法を見つけたら、`localhost\SQLExpress`データベース インスタンスとデータを使用して、名前の変更[SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="984f0-159">Rather than having to discover what the database and server names are, I ve found that the simplest approach is to attach the database to the `localhost\SQLExpress` database instance and rename the data using [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx).</span></span> <span data-ttu-id="984f0-160">場合は、コンピューターにインストールされている SQL Server 2005 の完全なバージョンの 1 つある場合は、し、可能性がありますが既にある SQL Server Management Studio がコンピューターにインストールされています。</span><span class="sxs-lookup"><span data-stu-id="984f0-160">If you have one of the full versions of SQL Server 2005 installed on your machine, then you likely already have SQL Server Management Studio installed on your computer.</span></span> <span data-ttu-id="984f0-161">無料をダウンロードすることができる場合は、Express edition がある場合のみ、 [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796)です。</span><span class="sxs-lookup"><span data-stu-id="984f0-161">If you only have the Express edition, you can download the free [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span></span>

<span data-ttu-id="984f0-162">Visual Studio を終了して開始します。</span><span class="sxs-lookup"><span data-stu-id="984f0-162">Start by closing Visual Studio.</span></span> <span data-ttu-id="984f0-163">次に、SQL Server Management Studio を開くしに接続する、`localhost\SQLExpress`サーバーが Windows 認証を使用します。</span><span class="sxs-lookup"><span data-stu-id="984f0-163">Next, open SQL Server Management Studio and choose to connect to the `localhost\SQLExpress` server using Windows Authentication.</span></span>


![Localhost \sqlexpress サーバーにアタッチします。](using-sql-cache-dependencies-cs/_static/image1.gif)

<span data-ttu-id="984f0-165">**図 1**: にアタッチ、`localhost\SQLExpress`サーバー</span><span class="sxs-lookup"><span data-stu-id="984f0-165">**Figure 1**: Attach to the `localhost\SQLExpress` Server</span></span>


<span data-ttu-id="984f0-166">サーバーに接続すると、Management Studio は、サーバーを表示して、データベース、セキュリティ、およびなどのサブフォルダーがあります。</span><span class="sxs-lookup"><span data-stu-id="984f0-166">After connecting to the server, Management Studio will show the server and have subfolders for the databases, security, and so forth.</span></span> <span data-ttu-id="984f0-167">データベース フォルダーを右クリックし、アタッチ オプションを選択します。</span><span class="sxs-lookup"><span data-stu-id="984f0-167">Right-click on the Databases folder and choose the Attach option.</span></span> <span data-ttu-id="984f0-168">データベースのアタッチ ダイアログが表示されます (図 2 を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="984f0-168">This will bring up the Attach Databases dialog box (see Figure 2).</span></span> <span data-ttu-id="984f0-169">[追加] ボタンをクリックし、選択、`NORTHWND.MDF`データベース フォルダーで、web アプリケーションの`App_Data`フォルダーです。</span><span class="sxs-lookup"><span data-stu-id="984f0-169">Click the Add button and select the `NORTHWND.MDF` database folder in your web application s `App_Data` folder.</span></span>


<span data-ttu-id="984f0-170">[![NORTHWND をアタッチします。App_Data フォルダーから MDF データベース](using-sql-cache-dependencies-cs/_static/image2.gif)](using-sql-cache-dependencies-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="984f0-170">[![Attach the NORTHWND.MDF Database from the App_Data Folder](using-sql-cache-dependencies-cs/_static/image2.gif)](using-sql-cache-dependencies-cs/_static/image1.png)</span></span>

<span data-ttu-id="984f0-171">**図 2**: アタッチ、`NORTHWND.MDF`からデータベース、`App_Data`フォルダー ([フルサイズのイメージを表示するをクリックして](using-sql-cache-dependencies-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="984f0-171">**Figure 2**: Attach the `NORTHWND.MDF` Database from the `App_Data` Folder ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image2.png))</span></span>


<span data-ttu-id="984f0-172">これは、データベース フォルダーにデータベースを追加します。</span><span class="sxs-lookup"><span data-stu-id="984f0-172">This will add the database to the Databases folder.</span></span> <span data-ttu-id="984f0-173">データベース名、データベース ファイルへの完全パスであるか、完全なパスの先頭に、 [GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier)です。</span><span class="sxs-lookup"><span data-stu-id="984f0-173">The database name might be the full path to the database file or the full path prepended with a [GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier).</span></span> <span data-ttu-id="984f0-174">Aspnet を使用する場合に、この時間のかかるデータベース名を入力しなくて済むようにする\_regsql.exe コマンド ライン ツールだけデータベースを右クリックしてよりわかりやすい名前に、データベースに接続されている名前を変更して、名前を変更します。</span><span class="sxs-lookup"><span data-stu-id="984f0-174">To avoid having to type in this lengthy database name when using the aspnet\_regsql.exe command line tool, rename the database to a more human-friendly name by right-clicking on database just attached and choosing Rename.</span></span> <span data-ttu-id="984f0-175">I ve DataTutorials にデータベースの名前を変更します。</span><span class="sxs-lookup"><span data-stu-id="984f0-175">I ve renamed my database to DataTutorials .</span></span>


![アタッチされたデータベースをよりわかりやすい名前に変更します。](using-sql-cache-dependencies-cs/_static/image3.gif)

<span data-ttu-id="984f0-177">**図 3**: アタッチされたデータベースをよりわかりやすい名前に変更</span><span class="sxs-lookup"><span data-stu-id="984f0-177">**Figure 3**: Rename the Attached Database to a More Human-Friendly Name</span></span>


## <a name="step-3-adding-the-polling-infrastructure-to-the-northwind-database"></a><span data-ttu-id="984f0-178">手順 3: Northwind データベースへポーリング インフラストラクチャを追加します。</span><span class="sxs-lookup"><span data-stu-id="984f0-178">Step 3: Adding the Polling Infrastructure to the Northwind Database</span></span>

<span data-ttu-id="984f0-179">添付したこと、`NORTHWND.MDF`からデータベース、`App_Data`ポーリング インフラストラクチャを追加する準備ができたらフォルダーです。</span><span class="sxs-lookup"><span data-stu-id="984f0-179">Now that we have attached the `NORTHWND.MDF` database from the `App_Data` folder, we re ready to add the polling infrastructure.</span></span> <span data-ttu-id="984f0-180">DataTutorials にデータベースの名前を変更していると仮定すると、次の 4 つのコマンドを実行します。</span><span class="sxs-lookup"><span data-stu-id="984f0-180">Assuming that you ve renamed the database to DataTutorials, run the following four commands:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample5.cmd)]

<span data-ttu-id="984f0-181">これら 4 つのコマンドを実行すると、Management Studio でデータベース名を右クリックし、タスク サブメニューに移動およびデタッチを選択します。</span><span class="sxs-lookup"><span data-stu-id="984f0-181">After running these four commands, right-click on the database name in Management Studio, go to the Tasks submenu, and choose Detach.</span></span> <span data-ttu-id="984f0-182">Management Studio を終了し、Visual Studio を閉じて再度開きます。</span><span class="sxs-lookup"><span data-stu-id="984f0-182">Then close Management Studio and reopen Visual Studio.</span></span>

<span data-ttu-id="984f0-183">Visual Studio が再度開くと後、サーバー エクスプ ローラーを使用してデータベースにドリルダウンします。</span><span class="sxs-lookup"><span data-stu-id="984f0-183">Once Visual Studio has reopened, drill into the database through the Server Explorer.</span></span> <span data-ttu-id="984f0-184">新しいテーブルに注意してください (`AspNet_SqlCacheTablesForChangeNotification`)、新しいストアド プロシージャ、およびトリガーで、 `Products`、 `Categories`、および`Suppliers`テーブル。</span><span class="sxs-lookup"><span data-stu-id="984f0-184">Note the new table (`AspNet_SqlCacheTablesForChangeNotification`), the new stored procedures, and the triggers on the `Products`, `Categories`, and `Suppliers` tables.</span></span>


![データベースが含まれています、ポーリングのために必要なインフラストラクチャには](using-sql-cache-dependencies-cs/_static/image4.gif)

<span data-ttu-id="984f0-186">**図 4**: データベースが含まれています、ポーリングのために必要なインフラストラクチャには</span><span class="sxs-lookup"><span data-stu-id="984f0-186">**Figure 4**: The Database Now Includes the Necessary Polling Infrastructure</span></span>


## <a name="step-4-configuring-the-polling-service"></a><span data-ttu-id="984f0-187">手順 4: ポーリング サービスの構成</span><span class="sxs-lookup"><span data-stu-id="984f0-187">Step 4: Configuring the Polling Service</span></span>

<span data-ttu-id="984f0-188">データベースに必要なテーブル、トリガー、およびストアド プロシージャを作成した後、最後はを通じて実行されるポーリング サービスを構成する`Web.config`ミリ秒単位でデータベースを使用してポーリング間隔を指定することによってです。</span><span class="sxs-lookup"><span data-stu-id="984f0-188">After creating the needed tables, triggers, and stored procedures in the database, the final step is to configure the polling service, which is done through `Web.config` by specifying the databases to use and the polling frequency in milliseconds.</span></span> <span data-ttu-id="984f0-189">次のマークアップは、1 秒ごとに、Northwind データベースをポーリングします。</span><span class="sxs-lookup"><span data-stu-id="984f0-189">The following markup polls the Northwind database once every second.</span></span>


[!code-xml[Main](using-sql-cache-dependencies-cs/samples/sample6.xml)]

<span data-ttu-id="984f0-190">`name`値で、`<add>`要素 (NorthwindDB) 人間が判読できる名前を特定のデータベースに関連付けます。</span><span class="sxs-lookup"><span data-stu-id="984f0-190">The `name` value in the `<add>` element ( NorthwindDB ) associates a human-readable name with a particular database.</span></span> <span data-ttu-id="984f0-191">SQL キャッシュ依存関係を使用する場合は、ここで定義された、キャッシュされたデータを基になっているテーブルだけでなく、データベース名を参照してくださいお必要があります。</span><span class="sxs-lookup"><span data-stu-id="984f0-191">When working with SQL cache dependencies, we'll need to refer to the database name defined here as well as the table that the cached data is based on.</span></span> <span data-ttu-id="984f0-192">使用する方法を見てみましょう、 `SqlCacheDependency` SQL キャッシュ依存関係をプログラムによって関連付けるクラスは手順 6. でデータをキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="984f0-192">We'll see how to use the `SqlCacheDependency` class to programmatically associate SQL cache dependencies with cached data in Step 6.</span></span>

<span data-ttu-id="984f0-193">ポーリング システムで定義されているデータベースに接続、SQL キャッシュ依存関係が確立されると、`<databases>`要素すべて`pollTime`(ミリ秒) を実行し、`AspNet_SqlCachePollingStoredProcedure`ストアド プロシージャです。</span><span class="sxs-lookup"><span data-stu-id="984f0-193">Once a SQL cache dependency has been established, the polling system will connect to the databases defined in the `<databases>` elements every `pollTime` milliseconds and execute the `AspNet_SqlCachePollingStoredProcedure` stored procedure.</span></span> <span data-ttu-id="984f0-194">手順 3 を使用してこのストアド プロシージャで追加されたバックアップを作成、`aspnet_regsql.exe`コマンド ライン ツールに返されます、`tableName`と`changeId`内の各レコード値`AspNet_SqlCacheTablesForChangeNotification`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-194">This stored procedure - which was added back in Step 3 using the `aspnet_regsql.exe` command line tool - returns the `tableName` and `changeId` values for each record in `AspNet_SqlCacheTablesForChangeNotification`.</span></span> <span data-ttu-id="984f0-195">古い SQL キャッシュ依存関係は、キャッシュから削除されます。</span><span class="sxs-lookup"><span data-stu-id="984f0-195">Outdated SQL cache dependencies are evicted from the cache.</span></span>

<span data-ttu-id="984f0-196">`pollTime`設定パフォーマンスとデータの陳腐化の間のトレードオフが導入されています。</span><span class="sxs-lookup"><span data-stu-id="984f0-196">The `pollTime` setting introduces a tradeoff between performance and data staleness.</span></span> <span data-ttu-id="984f0-197">小さな`pollTime`値には、データベースへの要求の数が増加しますより迅速にキャッシュから古いデータを削除します。</span><span class="sxs-lookup"><span data-stu-id="984f0-197">A small `pollTime` value increases the number of requests to the database, but more quickly evicts stale data from the cache.</span></span> <span data-ttu-id="984f0-198">大規模な`pollTime`値は、データベース要求の数を削減しますが、バックエンドのデータが変更されたときと、関連するキャッシュ アイテムを削除する時期の間の遅延が増加します。</span><span class="sxs-lookup"><span data-stu-id="984f0-198">A larger `pollTime` value reduces the number of database requests, but increases the delay between when the backend data changes and when the related cache items are evicted.</span></span> <span data-ttu-id="984f0-199">幸いにも、データベースの要求は単純なストアド プロシージャを実行単純で軽量なテーブルから少数の行を返す s。</span><span class="sxs-lookup"><span data-stu-id="984f0-199">Fortunately, the database request is executing a simple stored procedure that s returning just a few rows from a simple, lightweight table.</span></span> <span data-ttu-id="984f0-200">別のテスト操作を行いますが、`pollTime`データベース アプリケーションのアクセスとデータの陳腐化の最適なバランスを検索する値。</span><span class="sxs-lookup"><span data-stu-id="984f0-200">But do experiment with different `pollTime` values to find an ideal balance between database access and data staleness for your application.</span></span> <span data-ttu-id="984f0-201">最小`pollTime`指定できる値は 500 です。</span><span class="sxs-lookup"><span data-stu-id="984f0-201">The smallest `pollTime` value allowed is 500.</span></span>

> [!NOTE]
> <span data-ttu-id="984f0-202">上記の例は、1 つ`pollTime`値で、`<sqlCacheDependency>`要素が必要に応じてを指定できます、`pollTime`値で、`<add>`要素。</span><span class="sxs-lookup"><span data-stu-id="984f0-202">The above example provides a single `pollTime` value in the `<sqlCacheDependency>` element, but you can optionally specify the `pollTime` value in the `<add>` element.</span></span> <span data-ttu-id="984f0-203">これは、機能は、指定されたデータベースが複数存在し、データベースごとのポーリング間隔をカスタマイズする場合に便利です。</span><span class="sxs-lookup"><span data-stu-id="984f0-203">This is useful if you have multiple databases specified and want to customize the polling frequency per database.</span></span>


## <a name="step-5-declaratively-working-with-sql-cache-dependencies"></a><span data-ttu-id="984f0-204">手順 5: は、宣言によって SQL キャッシュ依存関係の操作</span><span class="sxs-lookup"><span data-stu-id="984f0-204">Step 5: Declaratively Working with SQL Cache Dependencies</span></span>

<span data-ttu-id="984f0-205">手順 1 ~ 4 では、必要なデータベース インフラストラクチャをセットアップして、ポーリング システムを構成する方法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="984f0-205">In Steps 1 through 4 we looked at how to setup the necessary database infrastructure and configure the polling system.</span></span> <span data-ttu-id="984f0-206">このインフラストラクチャを導入するには、プログラムまたは宣言型のいずれかの手法を使用して、関連の SQL キャッシュ依存と共に項目データ キャッシュに追加おことようになりましたできます。</span><span class="sxs-lookup"><span data-stu-id="984f0-206">With this infrastructure in place, we can now add items to the data cache with an associated SQL cache dependency using either programmatic or declarative techniques.</span></span> <span data-ttu-id="984f0-207">この手順では SQL キャッシュ依存関係を宣言して使用する方法について確認します。</span><span class="sxs-lookup"><span data-stu-id="984f0-207">In this step we'll examine how to declaratively work with SQL cache dependencies.</span></span> <span data-ttu-id="984f0-208">手順 6. でプログラムによる方法について見ていきます。</span><span class="sxs-lookup"><span data-stu-id="984f0-208">In Step 6 we'll look at the programmatic approach.</span></span>

<span data-ttu-id="984f0-209">[、ObjectDataSource でデータをキャッシュ](caching-data-with-the-objectdatasource-cs.md)チュートリアルは、ObjectDataSource の宣言のキャッシュ機能を探索します。</span><span class="sxs-lookup"><span data-stu-id="984f0-209">The [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) tutorial explored the declarative caching capabilities of the ObjectDataSource.</span></span> <span data-ttu-id="984f0-210">設定するだけで、`EnableCaching`プロパティを`true`と`CacheDuration`プロパティがある時間間隔を、ObjectDataSource を指定した期間その基になるオブジェクトから返されるデータが自動的にはキャッシュされます。</span><span class="sxs-lookup"><span data-stu-id="984f0-210">By simply setting the `EnableCaching` property to `true` and the `CacheDuration` property to some time interval, the ObjectDataSource will automatically cache the data returned from its underlying object for the specified interval.</span></span> <span data-ttu-id="984f0-211">ObjectDataSource では、1 つまたは複数の SQL キャッシュ依存関係も使用できます。</span><span class="sxs-lookup"><span data-stu-id="984f0-211">The ObjectDataSource can also use one or more SQL cache dependencies.</span></span>

<span data-ttu-id="984f0-212">SQL キャッシュ依存関係を宣言して使用を示すためには、開く、 `SqlCacheDependencies.aspx`  ページで、`Caching`フォルダーと、ツールボックスからデザイナーにドラッグする GridView。</span><span class="sxs-lookup"><span data-stu-id="984f0-212">To demonstrate using SQL cache dependencies declaratively, open the `SqlCacheDependencies.aspx` page in the `Caching` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="984f0-213">集合 GridView s`ID`に`ProductsDeclarative`し、そのスマート タグからという名前の新しい ObjectDataSource にバインドする選択`ProductsDataSourceDeclarative`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-213">Set the GridView s `ID` to `ProductsDeclarative` and, from its smart tag, choose to bind it to a new ObjectDataSource named `ProductsDataSourceDeclarative`.</span></span>


<span data-ttu-id="984f0-214">[![ProductsDataSourceDeclarative をという名前の新しい ObjectDataSource を作成します。](using-sql-cache-dependencies-cs/_static/image5.gif)](using-sql-cache-dependencies-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="984f0-214">[![Create a New ObjectDataSource Named ProductsDataSourceDeclarative](using-sql-cache-dependencies-cs/_static/image5.gif)](using-sql-cache-dependencies-cs/_static/image3.png)</span></span>

<span data-ttu-id="984f0-215">**図 5**: 名前付き新しい ObjectDataSource 作成`ProductsDataSourceDeclarative`([フルサイズのイメージを表示するをクリックして](using-sql-cache-dependencies-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="984f0-215">**Figure 5**: Create a New ObjectDataSource Named `ProductsDataSourceDeclarative` ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image4.png))</span></span>


<span data-ttu-id="984f0-216">構成を使用する ObjectDataSource、`ProductsBLL`クラスし、ドロップダウン リストの選択 タブで設定を`GetProducts()`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-216">Configure the ObjectDataSource to use the `ProductsBLL` class and set the drop-down list in the SELECT tab to `GetProducts()`.</span></span> <span data-ttu-id="984f0-217">更新プログラム タブで、選択、 `UpdateProduct` - 3 つの入力パラメーターを持つオーバー ロード`productName`、 `unitPrice`、および`productID`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-217">In the UPDATE tab, choose the `UpdateProduct` overload with three input parameters - `productName`, `unitPrice`, and `productID`.</span></span> <span data-ttu-id="984f0-218">挿入および削除の各タブで (なし) ドロップダウン リストを設定します。</span><span class="sxs-lookup"><span data-stu-id="984f0-218">Set the drop-down lists to (None) in the INSERT and DELETE tabs.</span></span>


<span data-ttu-id="984f0-219">[![次の 3 つの入力パラメーターを持つ UpdateProduct オーバー ロードを使用します。](using-sql-cache-dependencies-cs/_static/image6.gif)](using-sql-cache-dependencies-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="984f0-219">[![Use the UpdateProduct Overload with Three Input Parameters](using-sql-cache-dependencies-cs/_static/image6.gif)](using-sql-cache-dependencies-cs/_static/image5.png)</span></span>

<span data-ttu-id="984f0-220">**図 6**: UpdateProduct のオーバー ロードを使用して、次の 3 つの入力パラメーターを持つ ([フルサイズのイメージを表示するをクリックして](using-sql-cache-dependencies-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="984f0-220">**Figure 6**: Use the UpdateProduct Overload with Three Input Parameters ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image6.png))</span></span>


<span data-ttu-id="984f0-221">[![挿入および削除のタブの (なし) ドロップダウン リストを設定します。](using-sql-cache-dependencies-cs/_static/image7.gif)](using-sql-cache-dependencies-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="984f0-221">[![Set the Drop-Down List to (None) for the INSERT and DELETE Tabs](using-sql-cache-dependencies-cs/_static/image7.gif)](using-sql-cache-dependencies-cs/_static/image7.png)</span></span>

<span data-ttu-id="984f0-222">**図 7**: (None) にドロップ ダウン リストを挿入および削除のタブの設定 ([フルサイズのイメージを表示するをクリックして](using-sql-cache-dependencies-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="984f0-222">**Figure 7**: Set the Drop-Down List to (None) for the INSERT and DELETE Tabs ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image8.png))</span></span>


<span data-ttu-id="984f0-223">データ ソース構成ウィザードを完了すると、Visual Studio と作成されます BoundFields CheckBoxFields gridview の各データ フィールドの。</span><span class="sxs-lookup"><span data-stu-id="984f0-223">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="984f0-224">すべてのフィールドを削除するが、 `ProductName`、`CategoryName`と`UnitPrice`、し、必要に応じて、これらのフィールドを書式設定します。</span><span class="sxs-lookup"><span data-stu-id="984f0-224">Remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="984f0-225">GridView s のスマート タグからページングを有効にする、並べ替えを有効にするには、および編集を有効にするチェック ボックスを確認します。</span><span class="sxs-lookup"><span data-stu-id="984f0-225">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="984f0-226">Visual Studio には、ObjectDataSource s は設定`OldValuesParameterFormatString`プロパティを`original_{0}`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-226">Visual Studio will set the ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="984f0-227">GridView s の編集機能適切に機能するためには、宣言構文またはその既定値に戻すセット全体からこのプロパティを削除するか`{0}`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-227">In order for the GridView s edit feature to work properly, either remove this property entirely from the declarative syntax or set it back to its default value, `{0}`.</span></span>

<span data-ttu-id="984f0-228">最後に、GridView とセット上のラベルの Web コントロールを追加、`ID`プロパティを`ODSEvents`とその`EnableViewState`プロパティを`false`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-228">Finally, add a Label Web control above the GridView and set its `ID` property to `ODSEvents` and its `EnableViewState` property to `false`.</span></span> <span data-ttu-id="984f0-229">これらの変更を加えたら、ページ s の宣言型マークアップは、次のようになります。</span><span class="sxs-lookup"><span data-stu-id="984f0-229">After making these changes, your page s declarative markup should look similar to the following.</span></span> <span data-ttu-id="984f0-230">注されるさまざまな見た目のカスタマイズは不要な SQL キャッシュ依存関係の機能を示す GridView フィールドを作成しています。</span><span class="sxs-lookup"><span data-stu-id="984f0-230">Note that I ve made a number of aesthetic customizations to the GridView fields that are not necessary to demonstrate the SQL cache dependency functionality.</span></span>


[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample7.aspx)]

<span data-ttu-id="984f0-231">次に、ObjectDataSource s のイベント ハンドラーを作成`Selecting`イベントで、次のコードを追加、および。</span><span class="sxs-lookup"><span data-stu-id="984f0-231">Next, create an event handler for the ObjectDataSource s `Selecting` event and in it add the following code:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample8.cs)]

<span data-ttu-id="984f0-232">注意してください、ObjectDataSource の`Selecting`イベントは、その基になるオブジェクトからデータを取得する場合にのみ発生します。</span><span class="sxs-lookup"><span data-stu-id="984f0-232">Recall that the ObjectDataSource s `Selecting` event fires only when retrieving data from its underlying object.</span></span> <span data-ttu-id="984f0-233">場合は、ObjectDataSource 独自のキャッシュからデータにアクセスする、このイベントは起動しません。</span><span class="sxs-lookup"><span data-stu-id="984f0-233">If the ObjectDataSource accesses the data from its own cache, this event is not fired.</span></span>

<span data-ttu-id="984f0-234">ここで、ブラウザーからこのページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="984f0-234">Now, visit this page through a browser.</span></span> <span data-ttu-id="984f0-235">以降お ve まだキャッシュを実装する任意、ページ、並べ替え、または、グリッド ページを編集するたびにする必要があります、テキスト、表示するイベントが発生した場合、図 8 に示すよう。</span><span class="sxs-lookup"><span data-stu-id="984f0-235">Since we ve yet to implement any caching, each time you page, sort, or edit the grid the page should display the text, �Selecting event fired, as Figure 8 shows.</span></span>


<span data-ttu-id="984f0-236">[![GridView をページングすると、編集、または Sorted、ObjectDataSource s を選択するとイベントが発生させる](using-sql-cache-dependencies-cs/_static/image8.gif)](using-sql-cache-dependencies-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="984f0-236">[![The ObjectDataSource s Selecting Event Fires Each Time the GridView is Paged, Edited, or Sorted](using-sql-cache-dependencies-cs/_static/image8.gif)](using-sql-cache-dependencies-cs/_static/image9.png)</span></span>

<span data-ttu-id="984f0-237">**図 8**:、ObjectDataSource s`Selecting`イベント発生の各時間が GridView でページングが、編集、または Sorted ([フルサイズのイメージを表示するをクリックして](using-sql-cache-dependencies-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="984f0-237">**Figure 8**: The ObjectDataSource s `Selecting` Event Fires Each Time the GridView is Paged, Edited, or Sorted ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image10.png))</span></span>


<span data-ttu-id="984f0-238">説明したとおり、 [、ObjectDataSource でデータをキャッシュ](caching-data-with-the-objectdatasource-cs.md)チュートリアルでは、設定、`EnableCaching`プロパティを`true`ObjectDataSource によって指定された期間に対して、データをキャッシュすると、その`CacheDuration`プロパティです。</span><span class="sxs-lookup"><span data-stu-id="984f0-238">As we saw in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) tutorial, setting the `EnableCaching` property to `true` causes the ObjectDataSource to cache its data for the duration specified by its `CacheDuration` property.</span></span> <span data-ttu-id="984f0-239">ObjectDataSource をも、 [ `SqlCacheDependency`プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx)パターンを使用して、キャッシュされたデータに 1 つまたは複数の SQL キャッシュ依存関係を追加します。</span><span class="sxs-lookup"><span data-stu-id="984f0-239">The ObjectDataSource also has a [`SqlCacheDependency` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx), which adds one or more SQL cache dependencies to the cached data using the pattern:</span></span>


[!code-css[Main](using-sql-cache-dependencies-cs/samples/sample9.css)]

<span data-ttu-id="984f0-240">ここで*databaseName*で指定されているデータベースの名前を指定します、`name`の属性、`<add>`内の要素`Web.config`、および*tableName*データベース テーブルの名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="984f0-240">Where *databaseName* is the name of the database as specified in the `name` attribute of the `<add>` element in `Web.config`, and *tableName* is the name of the database table.</span></span> <span data-ttu-id="984f0-241">たとえば、データを無期限にキャッシュする ObjectDataSource を作成するに基づいて Northwind s に対して、SQL キャッシュ依存関係`Products`テーブルで、設定、ObjectDataSource s`EnableCaching`プロパティを`true`とその`SqlCacheDependency`プロパティをNorthwindDB:Products です。</span><span class="sxs-lookup"><span data-stu-id="984f0-241">For example, to create an ObjectDataSource that caches data indefinitely based on a SQL cache dependency against the Northwind s `Products` table, set the ObjectDataSource s `EnableCaching` property to `true` and its `SqlCacheDependency` property to NorthwindDB:Products .</span></span>

> [!NOTE]
> <span data-ttu-id="984f0-242">SQL キャッシュ依存関係を使用することができます*と*を設定して時間ベースの有効期限`EnableCaching`に`true`、`CacheDuration`時間間隔と`SqlCacheDependency`データベースとテーブル名にします。</span><span class="sxs-lookup"><span data-stu-id="984f0-242">You can use a SQL cache dependency *and* a time-based expiry by setting `EnableCaching` to `true`, `CacheDuration` to the time interval, and `SqlCacheDependency` to the database and table name(s).</span></span> <span data-ttu-id="984f0-243">時間ベースの有効期限に達したときに、またはポーリング システム ノート、基になるデータベースのデータが変更されたこと、どちらかになるときに、ObjectDataSource はそのデータを削除します。</span><span class="sxs-lookup"><span data-stu-id="984f0-243">The ObjectDataSource will evict its data when the time-based expiry is reached or when the polling system notes that the underlying database data has changed, whichever happens first.</span></span>


<span data-ttu-id="984f0-244">GridView `SqlCacheDependencies.aspx` - 2 つのテーブルからデータが表示されます`Products`と`Categories`(製品 s`CategoryName`を介して取得されたフィールドは、`JOIN`で`Categories`)。</span><span class="sxs-lookup"><span data-stu-id="984f0-244">The GridView in `SqlCacheDependencies.aspx` displays data from two tables - `Products` and `Categories` (the product s `CategoryName` field is retrieved via a `JOIN` on `Categories`).</span></span> <span data-ttu-id="984f0-245">そのため、2 つの SQL キャッシュ依存関係を指定する: NorthwindDB:Products です。NorthwindDB:Categories です。</span><span class="sxs-lookup"><span data-stu-id="984f0-245">Therefore, we want to specify two SQL cache dependencies: NorthwindDB:Products;NorthwindDB:Categories .</span></span>


<span data-ttu-id="984f0-246">[![製品およびカテゴリを SQL キャッシュ依存関係を使用するキャッシュをサポートするために、ObjectDataSource を構成します。](using-sql-cache-dependencies-cs/_static/image9.gif)](using-sql-cache-dependencies-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="984f0-246">[![Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on Products and Categories](using-sql-cache-dependencies-cs/_static/image9.gif)](using-sql-cache-dependencies-cs/_static/image11.png)</span></span>

<span data-ttu-id="984f0-247">**図 9**: 上の構成サポートのキャッシュを使用して SQL キャッシュ依存関係を ObjectDataSource`Products`と`Categories`([フルサイズのイメージを表示するをクリックして](using-sql-cache-dependencies-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="984f0-247">**Figure 9**: Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on `Products` and `Categories` ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image12.png))</span></span>


<span data-ttu-id="984f0-248">キャッシュをサポートする ObjectDataSource を構成すると、ブラウザーを使ってページを再表示します。</span><span class="sxs-lookup"><span data-stu-id="984f0-248">After configuring the ObjectDataSource to support caching, revisit the page through a browser.</span></span> <span data-ttu-id="984f0-249">テキストを選択するとイベントが起動される最初のページ アクセスで表示する必要がありますが、必要がありますと解消ページング、並べ替え、または編集 または キャンセル ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="984f0-249">Again, the text �Selecting event fired should appear on the first page visit, but should go away when paging, sorting, or clicking the Edit or Cancel buttons.</span></span> <span data-ttu-id="984f0-250">これは、データがキャッシュに読み込む、ObjectDataSource s、後に残っているのでがあるまで、`Products`または`Categories`テーブルが変更されるものや、GridView 経由でデータを更新します。</span><span class="sxs-lookup"><span data-stu-id="984f0-250">This is because after the data is loaded into the ObjectDataSource s cache, it remains there until the `Products` or `Categories` tables are modified or the data is updated through the GridView.</span></span>

<span data-ttu-id="984f0-251">テキストが新しいブラウザー ウィンドウを開き、編集、挿入、および削除のセクションで基本チュートリアルに移動、グリッドのページングとするイベントがないことに注意が呼び出された後 (`~/EditInsertDelete/Basics.aspx`)。</span><span class="sxs-lookup"><span data-stu-id="984f0-251">After paging through the grid and noting the lack of the �Selecting event fired text, open a new browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="984f0-252">名前または製品の価格を更新します。</span><span class="sxs-lookup"><span data-stu-id="984f0-252">Update the name or price of a product.</span></span> <span data-ttu-id="984f0-253">次からの最初のブラウザーのウィンドウに表示データの別のページ、グリッドの並べ替えまたは行の編集 をクリックします。</span><span class="sxs-lookup"><span data-stu-id="984f0-253">Then, from to the first browser window, view a different page of data, sort the grid, or click a row s Edit button.</span></span> <span data-ttu-id="984f0-254">データされた基になるデータベースの変更 (図 10 を参照してください)、今回は、発生するイベントは再び表示されます。</span><span class="sxs-lookup"><span data-stu-id="984f0-254">This time, the �Selecting event fired should reappear, as the underlying database data has been modified (see Figure 10).</span></span> <span data-ttu-id="984f0-255">テキストが表示されない場合、しばらく待ってからもう一度やり直してください。</span><span class="sxs-lookup"><span data-stu-id="984f0-255">If the text does not appear, wait a few moments and try again.</span></span> <span data-ttu-id="984f0-256">ポーリング サービスがへの変更をチェックすることに注意してください、`Products`テーブルすべて`pollTime`ミリ秒、基になるデータが更新されたときと、キャッシュされたデータを削除する時期の遅延があるようにします。</span><span class="sxs-lookup"><span data-stu-id="984f0-256">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>


<span data-ttu-id="984f0-257">[![Products テーブルの変更にキャッシュされている製品のデータを削除します](using-sql-cache-dependencies-cs/_static/image10.gif)](using-sql-cache-dependencies-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="984f0-257">[![Modifying the Products Table Evicts the Cached Product Data](using-sql-cache-dependencies-cs/_static/image10.gif)](using-sql-cache-dependencies-cs/_static/image13.png)</span></span>

<span data-ttu-id="984f0-258">**図 10**: Products テーブルを変更する製品のキャッシュ データを削除します ([フルサイズのイメージを表示するをクリックして](using-sql-cache-dependencies-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="984f0-258">**Figure 10**: Modifying the Products Table Evicts the Cached Product Data ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image14.png))</span></span>


## <a name="step-6-programmatically-working-with-thesqlcachedependencyclass"></a><span data-ttu-id="984f0-259">手順 6: をプログラムで使用、`SqlCacheDependency`クラス</span><span class="sxs-lookup"><span data-stu-id="984f0-259">Step 6: Programmatically Working with the`SqlCacheDependency`Class</span></span>

<span data-ttu-id="984f0-260">[アーキテクチャでは、データをキャッシュ](caching-data-in-the-architecture-cs.md)チュートリアルを指定したキャッシュは、ObjectDataSource を密に結合ではなく、アーキテクチャの別のキャッシュ レイヤーを使用する利点を調べる。</span><span class="sxs-lookup"><span data-stu-id="984f0-260">The [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorial looked at the benefits of using a separate Caching Layer in the architecture as opposed to tightly coupling the caching with the ObjectDataSource.</span></span> <span data-ttu-id="984f0-261">そのチュートリアルで作成しました、`ProductsCL`クラスをプログラムでのデータ キャッシュ機能を示すです。</span><span class="sxs-lookup"><span data-stu-id="984f0-261">In that tutorial we created a `ProductsCL` class to demonstrate programmatically working with the data cache.</span></span> <span data-ttu-id="984f0-262">キャッシュ レイヤーでの SQL キャッシュ依存関係を利用するを使用して、`SqlCacheDependency`クラスです。</span><span class="sxs-lookup"><span data-stu-id="984f0-262">To utilize SQL cache dependencies in the Caching Layer, use the `SqlCacheDependency` class.</span></span>

<span data-ttu-id="984f0-263">ポーリング システムで、`SqlCacheDependency`オブジェクトは、特定のデータベースとテーブルのペアを関連付ける必要があります。</span><span class="sxs-lookup"><span data-stu-id="984f0-263">With the polling system, a `SqlCacheDependency` object must be associated with a particular database and table pair.</span></span> <span data-ttu-id="984f0-264">たとえば、次のコードを作成、`SqlCacheDependency`オブジェクトは、Northwind データベース %s に基づく`Products`テーブル。</span><span class="sxs-lookup"><span data-stu-id="984f0-264">The following code, for example, creates a `SqlCacheDependency` object based on the Northwind database s `Products` table:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample10.cs)]

<span data-ttu-id="984f0-265">2 つの入力パラメーター、 `SqlCacheDependency` s のコンス トラクターは、それぞれデータベースとテーブルの名前。</span><span class="sxs-lookup"><span data-stu-id="984f0-265">The two input parameters to the `SqlCacheDependency` s constructor are the database and table names, respectively.</span></span> <span data-ttu-id="984f0-266">ObjectDataSource s 使用するような`SqlCacheDependency`プロパティは、使用するデータベース名で指定された値と同じです、`name`の属性、`<add>`内の要素`Web.config`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-266">Like with the ObjectDataSource s `SqlCacheDependency` property, the database name used is the same as the value specified in the `name` attribute of the `<add>` element in `Web.config`.</span></span> <span data-ttu-id="984f0-267">テーブル名は、データベース テーブルの実際の名前です。</span><span class="sxs-lookup"><span data-stu-id="984f0-267">The table name is the actual name of the database table.</span></span>

<span data-ttu-id="984f0-268">関連付けるには、`SqlCacheDependency`データ キャッシュに追加された項目を含むのいずれかの操作を使用して、`Insert`依存関係を受け入れるメソッドのオーバー ロードします。</span><span class="sxs-lookup"><span data-stu-id="984f0-268">To associate a `SqlCacheDependency` with an item added to the data cache, use one of the `Insert` method overloads that accepts a dependency.</span></span> <span data-ttu-id="984f0-269">次のコードを追加*値*に無期限の期間のデータ キャッシュに関連付けます、`SqlCacheDependency`上、`Products`テーブル。</span><span class="sxs-lookup"><span data-stu-id="984f0-269">The following code adds *value* to the data cache for an indefinite duration, but associates it with a `SqlCacheDependency` on the `Products` table.</span></span> <span data-ttu-id="984f0-270">要するに、*値*メモリ制約によってそれが削除されるまで、またはをポーリング システムが検出されたため、キャッシュに残りますが、`Products`テーブルがキャッシュされてから変更します。</span><span class="sxs-lookup"><span data-stu-id="984f0-270">In short, *value* will remain in the cache until it is evicted due to memory constraints or because the polling system has detected that the `Products` table has changed since it was cached.</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample11.cs)]

<span data-ttu-id="984f0-271">キャッシュ レイヤー s`ProductsCL`クラスが現在のデータをキャッシュ、 `Products` 60 秒間の時間ベースの有効期限を使用するテーブルします。</span><span class="sxs-lookup"><span data-stu-id="984f0-271">The Caching Layer s `ProductsCL` class currently caches data from the `Products` table using a time-based expiry of 60 seconds.</span></span> <span data-ttu-id="984f0-272">S SQL キャッシュ依存関係を代わりに使用するように、このクラスを更新できるようにします。</span><span class="sxs-lookup"><span data-stu-id="984f0-272">Let s update this class so that it uses SQL cache dependencies instead.</span></span> <span data-ttu-id="984f0-273">`ProductsCL`クラスの`AddCacheItem`データをキャッシュに追加するのには、メソッドには現在、次のコードが含まれています。</span><span class="sxs-lookup"><span data-stu-id="984f0-273">The `ProductsCL` class s `AddCacheItem` method, which is responsible for adding the data to the cache, currently contains the following code:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample12.cs)]

<span data-ttu-id="984f0-274">使用するには、このコードを更新、`SqlCacheDependency`オブジェクトの代わりに、`MasterCacheKeyArray`依存関係をキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="984f0-274">Update this code to use a `SqlCacheDependency` object instead of the `MasterCacheKeyArray` cache dependency:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample13.cs)]

<span data-ttu-id="984f0-275">この機能をテストするには、GridView、ページを追加、既存の下に`ProductsDeclarative`GridView です。</span><span class="sxs-lookup"><span data-stu-id="984f0-275">To test this functionality, add a GridView to the page beneath the existing `ProductsDeclarative` GridView.</span></span> <span data-ttu-id="984f0-276">この新しい GridView s 設定`ID`に`ProductsProgrammatic`と、という名前の新しい ObjectDataSource へのバインドのスマート タグから`ProductsDataSourceProgrammatic`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-276">Set this new GridView s `ID` to `ProductsProgrammatic` and, through its smart tag, bind it to a new ObjectDataSource named `ProductsDataSourceProgrammatic`.</span></span> <span data-ttu-id="984f0-277">構成を使用する ObjectDataSource、`ProductsCL`クラス、ドロップダウン リストの選択とに更新 タブの設定`GetProducts`と`UpdateProduct`、それぞれします。</span><span class="sxs-lookup"><span data-stu-id="984f0-277">Configure the ObjectDataSource to use the `ProductsCL` class, setting the drop-down lists in the SELECT and UPDATE tabs to `GetProducts` and `UpdateProduct`, respectively.</span></span>


<span data-ttu-id="984f0-278">[![構成、ObjectDataSource ProductsCL クラスを使用するには](using-sql-cache-dependencies-cs/_static/image11.gif)](using-sql-cache-dependencies-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="984f0-278">[![Configure the ObjectDataSource to Use the ProductsCL Class](using-sql-cache-dependencies-cs/_static/image11.gif)](using-sql-cache-dependencies-cs/_static/image15.png)</span></span>

<span data-ttu-id="984f0-279">**図 11**: 構成を使用する ObjectDataSource、`ProductsCL`クラス ([フルサイズのイメージを表示するをクリックして](using-sql-cache-dependencies-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="984f0-279">**Figure 11**: Configure the ObjectDataSource to Use the `ProductsCL` Class ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image16.png))</span></span>


<span data-ttu-id="984f0-280">[![GetProducts メソッドを選択 タブのドロップダウン リストから選択します。](using-sql-cache-dependencies-cs/_static/image12.gif)](using-sql-cache-dependencies-cs/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="984f0-280">[![Select the GetProducts Method from the SELECT Tab s Drop-Down List](using-sql-cache-dependencies-cs/_static/image12.gif)](using-sql-cache-dependencies-cs/_static/image17.png)</span></span>

<span data-ttu-id="984f0-281">**図 12**: 選択、 `GetProducts`  タブの選択のドロップダウン リストからメソッド ([フルサイズのイメージを表示するをクリックして](using-sql-cache-dependencies-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="984f0-281">**Figure 12**: Select the `GetProducts` Method from the SELECT Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image18.png))</span></span>


<span data-ttu-id="984f0-282">[![更新プログラム タブのドロップダウン リストから UpdateProduct 方法を選択します。](using-sql-cache-dependencies-cs/_static/image13.gif)](using-sql-cache-dependencies-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="984f0-282">[![Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List](using-sql-cache-dependencies-cs/_static/image13.gif)](using-sql-cache-dependencies-cs/_static/image19.png)</span></span>

<span data-ttu-id="984f0-283">**図 13**: 更新 タブのドロップダウン リストから UpdateProduct 方法を選択 ([フルサイズのイメージを表示するをクリックして](using-sql-cache-dependencies-cs/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="984f0-283">**Figure 13**: Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image20.png))</span></span>


<span data-ttu-id="984f0-284">データ ソース構成ウィザードを完了すると、Visual Studio と作成されます BoundFields CheckBoxFields gridview の各データ フィールドの。</span><span class="sxs-lookup"><span data-stu-id="984f0-284">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="984f0-285">このページに追加された最初の GridView にすべてのフィールドを削除するようが`ProductName`、 `CategoryName`、および`UnitPrice`、し、必要に応じて、これらのフィールドを書式設定します。</span><span class="sxs-lookup"><span data-stu-id="984f0-285">Like with the first GridView added to this page, remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="984f0-286">GridView s のスマート タグからページングを有効にする、並べ替えを有効にするには、および編集を有効にするチェック ボックスを確認します。</span><span class="sxs-lookup"><span data-stu-id="984f0-286">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="984f0-287">同様、 `ProductsDataSourceDeclarative` ObjectDataSource、Visual Studio は設定、 `ProductsDataSourceProgrammatic` ObjectDataSource s`OldValuesParameterFormatString`プロパティを`original_{0}`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-287">As with the `ProductsDataSourceDeclarative` ObjectDataSource, Visual Studio will set the `ProductsDataSourceProgrammatic` ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="984f0-288">GridView s の編集機能を適切に機能は、このプロパティを設定するためにバックアップ`{0}`(または宣言構文から、プロパティの割り当てを完全に削除) します。</span><span class="sxs-lookup"><span data-stu-id="984f0-288">In order for the GridView s edit feature to work properly, set this property back to `{0}` (or remove the property assignment from the declarative syntax altogether).</span></span>

<span data-ttu-id="984f0-289">これらのタスクを完了すると、結果として得られる GridView と ObjectDataSource 宣言型マークアップは、次のようになります。</span><span class="sxs-lookup"><span data-stu-id="984f0-289">After completing these tasks, the resulting GridView and ObjectDataSource declarative markup should look like the following:</span></span>


[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample14.aspx)]

<span data-ttu-id="984f0-290">SQL をテストするキャッシュ レイヤーでキャッシュの依存関係にブレークポイントを設定、`ProductCL`クラスの`AddCacheItem`メソッドと、デバッグを開始します。</span><span class="sxs-lookup"><span data-stu-id="984f0-290">To test the SQL cache dependency in the Caching Layer set a breakpoint in the `ProductCL` class s `AddCacheItem` method and then start debugging.</span></span> <span data-ttu-id="984f0-291">アクセスするときに`SqlCacheDependencies.aspx`データは最初に要求され、キャッシュに格納と、ブレークポイントをヒットする必要があります。</span><span class="sxs-lookup"><span data-stu-id="984f0-291">When you first visit `SqlCacheDependencies.aspx`, the breakpoint should be hit as the data is requested for the first time and placed into the cache.</span></span> <span data-ttu-id="984f0-292">次に、GridView で別のページに移動するか、並べ替える列のいずれか。</span><span class="sxs-lookup"><span data-stu-id="984f0-292">Next, move to another page in the GridView or sort one of the columns.</span></span> <span data-ttu-id="984f0-293">これが原因で、そのデータを再クエリする GridView がされてから、キャッシュにデータを検出する必要があります、`Products`データベース テーブルが変更されていません。</span><span class="sxs-lookup"><span data-stu-id="984f0-293">This causes the GridView to requery its data, but the data should be found in the cache since the `Products` database table has not been modified.</span></span> <span data-ttu-id="984f0-294">データが繰り返しが見つからない場合、キャッシュのための十分なメモリが使用可能なコンピューターのことを確認してからやり直してください。</span><span class="sxs-lookup"><span data-stu-id="984f0-294">If the data is repeatedly not found in the cache, make sure there is sufficient memory available on your computer and try again.</span></span>

<span data-ttu-id="984f0-295">ページング GridView のいくつかのページを後に 2 番目のブラウザー ウィンドウを開き、編集、挿入、および削除のセクションで基本チュートリアルへ移動 (`~/EditInsertDelete/Basics.aspx`)。</span><span class="sxs-lookup"><span data-stu-id="984f0-295">After paging through a few pages of the GridView, open a second browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="984f0-296">Products テーブルからレコードを更新し、次に、最初のブラウザー ウィンドウから、新しいページを表示または並べ替えのヘッダーのいずれかをクリックします。</span><span class="sxs-lookup"><span data-stu-id="984f0-296">Update a record from the Products table and then, from the first browser window, view a new page or click on one of the sorting headers.</span></span>

<span data-ttu-id="984f0-297">このシナリオでは、次の 2 つのいずれかが表示されます。 キャッシュされたデータがデータベース内の変更により削除されることを示す、いずれかのブレークポイントにヒットします。または、ブレークポイントがヒットしない、つまり`SqlCacheDependencies.aspx`が古いデータを表示されているようになりました。</span><span class="sxs-lookup"><span data-stu-id="984f0-297">In this scenario you will see one of two things: either the breakpoint will be hit, indicating that the cached data was evicted due to the change in the database; or, the breakpoint will not be hit, meaning that `SqlCacheDependencies.aspx` is now showing stale data.</span></span> <span data-ttu-id="984f0-298">ブレークポイントはヒットしませんが、データの変更によって、ポーリング サービスがまだ起動されないので、可能性があります。</span><span class="sxs-lookup"><span data-stu-id="984f0-298">If the breakpoint is not hit, it is likely because the polling service has not yet fired since the data was changed.</span></span> <span data-ttu-id="984f0-299">ポーリング サービスがへの変更をチェックすることに注意してください、`Products`テーブルすべて`pollTime`ミリ秒、基になるデータが更新されたときと、キャッシュされたデータを削除する時期の遅延があるようにします。</span><span class="sxs-lookup"><span data-stu-id="984f0-299">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>

> [!NOTE]
> <span data-ttu-id="984f0-300">この遅延が GridView でを使用して、製品のいずれかの編集時に表示される可能性が高く`SqlCacheDependencies.aspx`です。</span><span class="sxs-lookup"><span data-stu-id="984f0-300">This delay is more likely to appear when editing one of the products through the GridView in `SqlCacheDependencies.aspx`.</span></span> <span data-ttu-id="984f0-301">[アーキテクチャでは、データをキャッシュ](caching-data-in-the-architecture-cs.md)チュートリアルが追加されました、`MasterCacheKeyArray`キャッシュ データから編集されていることを確認する依存関係、`ProductsCL`クラスの`UpdateProduct`メソッドは、キャッシュから削除されました。</span><span class="sxs-lookup"><span data-stu-id="984f0-301">In the [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorial we added the `MasterCacheKeyArray` cache dependency to ensure that the data being edited through the `ProductsCL` class s `UpdateProduct` method was evicted from the cache.</span></span> <span data-ttu-id="984f0-302">ただし、置き換えましたこのキャッシュの依存関係を変更する場合、`AddCacheItem`この手順の前半のメソッドとそのため、`ProductsCL`ポーリング システム ノートへの変更になるまでにキャッシュされたデータを表示するクラスは引き続き、`Products`テーブル。</span><span class="sxs-lookup"><span data-stu-id="984f0-302">However, we replaced this cache dependency when modifying the `AddCacheItem` method earlier in this step and therefore the `ProductsCL` class will continue to show the cached data until the polling system notes the change to the `Products` table.</span></span> <span data-ttu-id="984f0-303">再導入する方法をお見せ、`MasterCacheKeyArray`手順 7. で依存関係をキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="984f0-303">We'll see how to reintroduce the `MasterCacheKeyArray` cache dependency in Step 7.</span></span>


## <a name="step-7-associating-multiple-dependencies-with-a-cached-item"></a><span data-ttu-id="984f0-304">手順 7: キャッシュされたアイテムと複数の依存関係の関連付け</span><span class="sxs-lookup"><span data-stu-id="984f0-304">Step 7: Associating Multiple Dependencies with a Cached Item</span></span>

<span data-ttu-id="984f0-305">注意してください、`MasterCacheKeyArray`キャッシュの依存関係がいることを確認するために使用*すべて*内に関連付けられている任意の 1 つの項目が更新されたときに、製品関連のデータをキャッシュから削除します。</span><span class="sxs-lookup"><span data-stu-id="984f0-305">Recall that the `MasterCacheKeyArray` cache dependency is used to ensure that *all* product-related data is evicted from the cache when any single item associated within it is updated.</span></span> <span data-ttu-id="984f0-306">たとえば、`GetProductsByCategoryID(categoryID)`メソッド キャッシュ`ProductsDataTables`インスタンスごとに一意な*categoryID*値。</span><span class="sxs-lookup"><span data-stu-id="984f0-306">For example, the `GetProductsByCategoryID(categoryID)` method caches `ProductsDataTables` instances for each unique *categoryID* value.</span></span> <span data-ttu-id="984f0-307">これらのオブジェクトが削除される場合、`MasterCacheKeyArray`キャッシュの依存関係、他のユーザーがも削除されることを確認します。</span><span class="sxs-lookup"><span data-stu-id="984f0-307">If one of these objects is evicted, the `MasterCacheKeyArray` cache dependency ensures that the others are also removed.</span></span> <span data-ttu-id="984f0-308">このキャッシュの依存関係なく、キャッシュされたデータが変更されたときに、可能性がその他の製品のキャッシュされたデータが古くなる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="984f0-308">Without this cache dependency, when the cached data is modified the possibility exists that other cached product data may be out of date.</span></span> <span data-ttu-id="984f0-309">その結果に維持するということが重要、 `MasterCacheKeyArray` SQL キャッシュ依存関係を使用する場合は、依存関係をキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="984f0-309">Consequently, it s important that we maintain the `MasterCacheKeyArray` cache dependency when using SQL cache dependencies.</span></span> <span data-ttu-id="984f0-310">ただし、データはキャッシュ s`Insert`メソッドだけでは、単一の依存関係オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="984f0-310">However, the data cache s `Insert` method only allows for a single dependency object.</span></span>

<span data-ttu-id="984f0-311">さらに、SQL キャッシュ依存関係を操作するときに依存関係として複数のデータベース テーブルを関連付けることがあります。</span><span class="sxs-lookup"><span data-stu-id="984f0-311">Furthermore, when working with SQL cache dependencies we may need to associate multiple database tables as dependencies.</span></span> <span data-ttu-id="984f0-312">たとえば、`ProductsDataTable`でキャッシュされた、`ProductsCL`クラスには、各製品カテゴリと仕入先名が含まれていますが、`AddCacheItem`メソッドのみを使用して、依存関係の`Products`します。</span><span class="sxs-lookup"><span data-stu-id="984f0-312">For example, the `ProductsDataTable` cached in the `ProductsCL` class contains the category and supplier names for each product, but the `AddCacheItem` method only uses a dependency on `Products`.</span></span> <span data-ttu-id="984f0-313">このような状況で、ユーザーがカテゴリや供給業者の名前を更新する場合にキャッシュされている製品のデータはキャッシュに残りとが最新でいます。</span><span class="sxs-lookup"><span data-stu-id="984f0-313">In this situation, if the user updates the name of a category or supplier, the cached product data will remain in the cache and be out of date.</span></span> <span data-ttu-id="984f0-314">キャッシュされている製品のデータに依存するようにするため、だけでなく、`Products`テーブルが、`Categories`と`Suppliers`テーブルもします。</span><span class="sxs-lookup"><span data-stu-id="984f0-314">Therefore, we want to make the cached product data dependent on not only the `Products` table, but on the `Categories` and `Suppliers` tables as well.</span></span>

<span data-ttu-id="984f0-315">[ `AggregateCacheDependency`クラス](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx)キャッシュ項目に複数の依存関係を関連付けるための手段を提供します。</span><span class="sxs-lookup"><span data-stu-id="984f0-315">The [`AggregateCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx) provides a means for associating multiple dependencies with a cache item.</span></span> <span data-ttu-id="984f0-316">まずを作成して、`AggregateCacheDependency`インスタンス。</span><span class="sxs-lookup"><span data-stu-id="984f0-316">Start by creating an `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="984f0-317">使用して依存関係のセットを次に、追加、 `AggregateCacheDependency` s`Add`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="984f0-317">Next, add the set of dependencies using the `AggregateCacheDependency` s `Add` method.</span></span> <span data-ttu-id="984f0-318">その後、データ キャッシュにアイテムを挿入するときに渡す、`AggregateCacheDependency`インスタンス。</span><span class="sxs-lookup"><span data-stu-id="984f0-318">When inserting the item into the data cache thereafter, pass in the `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="984f0-319">ときに*任意*の`AggregateCacheDependency`インスタンスの依存関係が変更、キャッシュされた項目は削除されます。</span><span class="sxs-lookup"><span data-stu-id="984f0-319">When *any* of the `AggregateCacheDependency` instance s dependencies change, the cached item will be evicted.</span></span>

<span data-ttu-id="984f0-320">更新されたコードを次に示します、`ProductsCL`クラスの`AddCacheItem`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="984f0-320">The following shows the updated code for the `ProductsCL` class s `AddCacheItem` method.</span></span> <span data-ttu-id="984f0-321">メソッドを作成、`MasterCacheKeyArray`キャッシュ依存関係と共に`SqlCacheDependency`オブジェクトに対する、 `Products`、 `Categories`、および`Suppliers`テーブル。</span><span class="sxs-lookup"><span data-stu-id="984f0-321">The method creates the `MasterCacheKeyArray` cache dependency along with `SqlCacheDependency` objects for the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="984f0-322">これらはすべてを組み合わせて 1 つ`AggregateCacheDependency`という名前のオブジェクト`aggregateDependencies`に渡されたし、`Insert`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="984f0-322">These are all combined into one `AggregateCacheDependency` object named `aggregateDependencies`, which is then passed into the `Insert` method.</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample15.cs)]

<span data-ttu-id="984f0-323">この新しいコードをテストします。ように変わります、 `Products`、 `Categories`、または`Suppliers`テーブルが削除するキャッシュされたデータに発生します。</span><span class="sxs-lookup"><span data-stu-id="984f0-323">Test this new code out. Now changes to the `Products`, `Categories`, or `Suppliers` tables cause the cached data to be evicted.</span></span> <span data-ttu-id="984f0-324">さらに、`ProductsCL`クラス s `UpdateProduct` GridView を使用して製品を編集するときに呼び出される、メソッドが削除、`MasterCacheKeyArray`これにより、キャッシュされた依存関係をキャッシュ`ProductsDataTable`削除して、次回の再取得するデータ要求。</span><span class="sxs-lookup"><span data-stu-id="984f0-324">Moreover, the `ProductsCL` class s `UpdateProduct` method, which is called when editing a product through the GridView, evicts the `MasterCacheKeyArray` cache dependency, which causes the cached `ProductsDataTable` to be evicted and the data to be re-retrieved on the next request.</span></span>

> [!NOTE]
> <span data-ttu-id="984f0-325">SQL キャッシュ依存関係はでも使用できます[出力キャッシュ](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="984f0-325">SQL cache dependencies can also be used with [output caching](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx).</span></span> <span data-ttu-id="984f0-326">この機能のデモについてを参照してください: [SQL Server で ASP.NET 出力キャッシュを使用して](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx)です。</span><span class="sxs-lookup"><span data-stu-id="984f0-326">For a demonstration of this functionality, see: [Using ASP.NET Output Caching with SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx).</span></span>


## <a name="summary"></a><span data-ttu-id="984f0-327">まとめ</span><span class="sxs-lookup"><span data-stu-id="984f0-327">Summary</span></span>

<span data-ttu-id="984f0-328">データベースのデータをキャッシュする場合、データは理想的にはまでキャッシュに、データベースで変更されているです。</span><span class="sxs-lookup"><span data-stu-id="984f0-328">When caching database data, the data will ideally remain in the cache until it is modified in the database.</span></span> <span data-ttu-id="984f0-329">ASP.NET 2.0 では、SQL キャッシュ依存関係を作成して宣言とプログラムの両方のシナリオで使用します。</span><span class="sxs-lookup"><span data-stu-id="984f0-329">With ASP.NET 2.0, SQL cache dependencies can be created and used in both declarative and programmatic scenarios.</span></span> <span data-ttu-id="984f0-330">このアプローチの課題の 1 つは、データが変更されたときを検出するのにです。</span><span class="sxs-lookup"><span data-stu-id="984f0-330">One of the challenges with this approach is in discovering when the data has been modified.</span></span> <span data-ttu-id="984f0-331">Microsoft SQL Server 2005 の完全なバージョンでは、クエリ結果が変更されたときに、アプリケーションに警告できます通知機能を提供します。</span><span class="sxs-lookup"><span data-stu-id="984f0-331">The full versions of Microsoft SQL Server 2005 provide notification capabilities that can alert an application when a query result has changed.</span></span> <span data-ttu-id="984f0-332">Express エディションの SQL Server 2005 と SQL Server の以前のバージョンでは、ポーリング システムを代わりに使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="984f0-332">For the Express Edition of SQL Server 2005 and older versions of SQL Server, a polling system must be used instead.</span></span> <span data-ttu-id="984f0-333">さいわい、ポーリングのために必要なインフラストラクチャを設定することは簡単です。</span><span class="sxs-lookup"><span data-stu-id="984f0-333">Fortunately, setting up the necessary polling infrastructure is fairly straightforward.</span></span>

<span data-ttu-id="984f0-334">満足プログラミング!</span><span class="sxs-lookup"><span data-stu-id="984f0-334">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="984f0-335">関連項目</span><span class="sxs-lookup"><span data-stu-id="984f0-335">Further Reading</span></span>

<span data-ttu-id="984f0-336">このチュートリアルで説明したトピックの詳細については、次の情報を参照してください。</span><span class="sxs-lookup"><span data-stu-id="984f0-336">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="984f0-337">Microsoft SQL Server 2005 のクエリ通知の使用</span><span class="sxs-lookup"><span data-stu-id="984f0-337">Using Query Notifications in Microsoft SQL Server 2005</span></span>](https://msdn.microsoft.com/library/ms175110.aspx)
- [<span data-ttu-id="984f0-338">クエリ通知を作成します。</span><span class="sxs-lookup"><span data-stu-id="984f0-338">Creating a Query Notification</span></span>](https://msdn.microsoft.com/library/ms188669.aspx)
- <span data-ttu-id="984f0-339">[ASP.NET でのキャッシュ、`SqlCacheDependency`クラス](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="984f0-339">[Caching in ASP.NET with the `SqlCacheDependency` Class](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span></span>
- <span data-ttu-id="984f0-340">[ASP.NET SQL Server の登録ツール (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="984f0-340">[ASP.NET SQL Server Registration Tool (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span></span>
- [<span data-ttu-id="984f0-341">概要 `SqlCacheDependency`</span><span class="sxs-lookup"><span data-stu-id="984f0-341">Overview of `SqlCacheDependency`</span></span>](http://www.aspnetresources.com/blog/sql_cache_depedency_overview.aspx)

## <a name="about-the-author"></a><span data-ttu-id="984f0-342">作成者について</span><span class="sxs-lookup"><span data-stu-id="984f0-342">About the Author</span></span>

<span data-ttu-id="984f0-343">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)、7 つ受け取りますブックとの創設者の作成者[4GuysFromRolla.com](http://www.4guysfromrolla.com)、1998 年からマイクロソフトの Web テクノロジで取り組んできました。</span><span class="sxs-lookup"><span data-stu-id="984f0-343">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="984f0-344">Scott は、コンサルタント、トレーナー、ライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="984f0-344">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="984f0-345">最新の著書[ *Sam 学べる自分で ASP.NET 2.0 が 24 時間以内に*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)です。</span><span class="sxs-lookup"><span data-stu-id="984f0-345">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="984f0-346">彼に到達できる[ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)彼のブログを使用して含まれているのか[ http://ScottOnWriting.NET](http://ScottOnWriting.NET)です。</span><span class="sxs-lookup"><span data-stu-id="984f0-346">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="984f0-347">感謝の特別な</span><span class="sxs-lookup"><span data-stu-id="984f0-347">Special Thanks To</span></span>

<span data-ttu-id="984f0-348">このチュートリアルの系列は既に多くの便利なレビュー担当者によって確認済みです。</span><span class="sxs-lookup"><span data-stu-id="984f0-348">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="984f0-349">このチュートリアルの潜在顧客レビュー担当者には、Marko Rangel、Teresa マーフィー Hilton Giesenow がされていました。</span><span class="sxs-lookup"><span data-stu-id="984f0-349">Lead reviewers for this tutorial were Marko Rangel, Teresa Murphy, and Hilton Giesenow.</span></span> <span data-ttu-id="984f0-350">今後、MSDN の記事を確認することに関心のあるですか。</span><span class="sxs-lookup"><span data-stu-id="984f0-350">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="984f0-351">場合は、ドロップ me 一度に 1 行ずつ[mitchell@4GuysFromRolla.comです。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="984f0-351">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="984f0-352">[前へ](caching-data-at-application-startup-cs.md)
> [次へ](caching-data-with-the-objectdatasource-vb.md)</span><span class="sxs-lookup"><span data-stu-id="984f0-352">[Previous](caching-data-at-application-startup-cs.md)
[Next](caching-data-with-the-objectdatasource-vb.md)</span></span>
