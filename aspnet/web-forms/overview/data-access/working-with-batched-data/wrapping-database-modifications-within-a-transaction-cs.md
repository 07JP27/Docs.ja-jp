---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
title: データベースの変更 (c#)、トランザクション内での折り返し |Microsoft ドキュメント
author: rick-anderson
description: このチュートリアルでは、更新、削除、およびデータのバッチの挿入を参照する 4 つのうちの最初です。 このチュートリアルでは、データベース トランザクションを使用する方法を学習しました.
ms.author: aspnetcontent
manager: wpickett
ms.date: 06/26/2007
ms.topic: article
ms.assetid: b45fede3-c53a-4ea1-824b-20200808dbae
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
msc.type: authoredcontent
ms.openlocfilehash: a3f8ec2de7b9259e4bb83f4346bde8abfd643fb4
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/06/2018
ms.locfileid: "30888956"
---
<a name="wrapping-database-modifications-within-a-transaction-c"></a><span data-ttu-id="0e493-104">(C#)、トランザクション内での折り返しデータベースの変更</span><span class="sxs-lookup"><span data-stu-id="0e493-104">Wrapping Database Modifications within a Transaction (C#)</span></span>
====================
<span data-ttu-id="0e493-105">によって[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="0e493-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="0e493-106">[コードをダウンロードする](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip)または[PDF のダウンロード](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="0e493-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span></span>

> <span data-ttu-id="0e493-107">このチュートリアルでは、更新、削除、およびデータのバッチの挿入を参照する 4 つのうちの最初です。</span><span class="sxs-lookup"><span data-stu-id="0e493-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="0e493-108">このチュートリアルでは、データベース トランザクションが確実にすべての手順が成功したか、またはすべてのステップが失敗する、アトミックな操作として実行するバッチの変更を許可する方法お学習します。</span><span class="sxs-lookup"><span data-stu-id="0e493-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>


## <a name="introduction"></a><span data-ttu-id="0e493-109">はじめに</span><span class="sxs-lookup"><span data-stu-id="0e493-109">Introduction</span></span>

<span data-ttu-id="0e493-110">以降で説明したように、 [、概要の挿入、更新、およびデータの削除](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md)チュートリアルでは、GridView 組み込みのサポートを提供行レベルの編集および削除します。</span><span class="sxs-lookup"><span data-stu-id="0e493-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="0e493-111">マウスの数回のクリックでコンテンツを編集して、行ごとに削除する限り、行のコードを記述することがなく、豊富なデータ変更のインターフェイスを作成することができます。</span><span class="sxs-lookup"><span data-stu-id="0e493-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="0e493-112">ただし、特定のシナリオでこれでは不十分と編集、またはレコードのバッチを削除する機能をユーザーに提供する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0e493-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="0e493-113">たとえば、web ベースの電子メール クライアントの最もグリッドを使用して、各メッセージを一覧表示する行ごとに電子メールの情報 (件名、送信者など) と共に チェック ボックスが含まれています。</span><span class="sxs-lookup"><span data-stu-id="0e493-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="0e493-114">このインターフェイスは、それらのチェックと、選択したメッセージの削除ボタンをクリックし、複数のメッセージを削除するユーザーを許可します。</span><span class="sxs-lookup"><span data-stu-id="0e493-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="0e493-115">編集インターフェイス バッチとは、ユーザーは、多くの異なるレコードよくを編集する場合に最適です。</span><span class="sxs-lookup"><span data-stu-id="0e493-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="0e493-116">ユーザーがクリックするのではなく編集、その変更を加えを変更する必要がある各レコードの更新 をクリックして、編集インターフェイス バッチが編集インターフェイスで各の行を表示します。</span><span class="sxs-lookup"><span data-stu-id="0e493-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="0e493-117">ユーザーでは、簡単に変更する必要がある行のセットを変更でき、更新プログラムのすべてのボタンをクリックしてこれらの変更を保存することができます。</span><span class="sxs-lookup"><span data-stu-id="0e493-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="0e493-118">このチュートリアルのセットに挿入する、編集、およびデータのバッチを削除するためのインターフェイスを作成する方法について確認します。</span><span class="sxs-lookup"><span data-stu-id="0e493-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="0e493-119">バッチ操作を実行するときにそれを決定するかどうかが考えられるいくつかの操作が成功するバッチの中に他の重要な失敗します。</span><span class="sxs-lookup"><span data-stu-id="0e493-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="0e493-120">インターフェイスの場合は最初、選択したレコードは正常に削除されますが、もう 1 つ失敗すると、たとえば、外部キー制約違反のための動作を削除するバッチを考慮しますか。</span><span class="sxs-lookup"><span data-stu-id="0e493-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="0e493-121">最初のレコードの削除ロールバックするかまたは最初のレコードが削除されたままで使用可能ですか。</span><span class="sxs-lookup"><span data-stu-id="0e493-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="0e493-122">バッチ操作として扱われる場合、[アトミック操作](http://en.wikipedia.org/wiki/Atomic_operation)、いずれかの場所か、すべてのステップが成功またはのすべてのステップが失敗すると、し、データ アクセス層をサポートするように拡張する必要があります[データベーストランザクション](http://en.wikipedia.org/wiki/Database_transaction)です。</span><span class="sxs-lookup"><span data-stu-id="0e493-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="0e493-123">データベースのトランザクションで、一連の原子性は保証`INSERT`、 `UPDATE`、および`DELETE`ステートメントがトランザクションの包括的な下で実行し、ほとんどすべての最新のデータベース システムでサポートされている機能であり、します。</span><span class="sxs-lookup"><span data-stu-id="0e493-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="0e493-124">このチュートリアルでは、データベース トランザクションを使用する、DAL を拡張する方法を紹介します。</span><span class="sxs-lookup"><span data-stu-id="0e493-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="0e493-125">以降のチュートリアルでは、挿入、更新、およびインターフェイスを削除するバッチの実装の web ページを確認します。</span><span class="sxs-lookup"><span data-stu-id="0e493-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="0e493-126">開始 s を let!</span><span class="sxs-lookup"><span data-stu-id="0e493-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="0e493-127">バッチのトランザクション内のデータを変更するときに常に原子性は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="0e493-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="0e493-128">一部のシナリオでいくつかのデータ変更が正常に許容される場合があり、ときなど、失敗、同じバッチ内の他、web ベースの電子メール クライアントからの電子メールの設定を削除します。</span><span class="sxs-lookup"><span data-stu-id="0e493-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="0e493-129">S を削除してデータベース エラー中間にある、処理する場合、s がエラーなしで処理されるこれらのレコードが削除されたまま、許容できる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="0e493-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="0e493-130">このような場合、DAL はデータベース トランザクションをサポートするように変更するのには必要ありません。</span><span class="sxs-lookup"><span data-stu-id="0e493-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="0e493-131">その他のバッチ操作シナリオ、ただし、原子性が不可欠があります。</span><span class="sxs-lookup"><span data-stu-id="0e493-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="0e493-132">顧客では、1 つの銀行口座間彼女資金を移動すると、は、2 つの操作を実行する必要があります。 資金を最初のアカウントから差し引かれます、、2 番目に追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0e493-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="0e493-133">銀行可能性がありますいない気にすることは成功の最初の手順が、2 番目のステップが失敗する、ときに、お客様は当然不安を感じているになります。</span><span class="sxs-lookup"><span data-stu-id="0e493-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="0e493-134">お勧めこのチュートリアルを使用してバッチの挿入でそれらを使用して、更新、および次の 3 つのチュートリアルで構築するインターフェイスを削除する予定がない場合でも、データベース トランザクションをサポートするために DAL の機能強化を実装するためです。</span><span class="sxs-lookup"><span data-stu-id="0e493-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>


## <a name="an-overview-of-transactions"></a><span data-ttu-id="0e493-135">トランザクションの概要</span><span class="sxs-lookup"><span data-stu-id="0e493-135">An Overview of Transactions</span></span>

<span data-ttu-id="0e493-136">ほとんどのデータベースがサポートされるよう*トランザクション*作業の 1 つの論理単位にグループ化する複数のデータベース コマンドを有効にします。</span><span class="sxs-lookup"><span data-stu-id="0e493-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="0e493-137">トランザクションを構成するデータベースのコマンドはアトミック、いずれかのすべてのコマンドが失敗したり、すべてが成功することは保証します。</span><span class="sxs-lookup"><span data-stu-id="0e493-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="0e493-138">一般に、トランザクションは、次のパターンを使用して SQL ステートメントを通じて実装されます。</span><span class="sxs-lookup"><span data-stu-id="0e493-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="0e493-139">トランザクションの開始を示します。</span><span class="sxs-lookup"><span data-stu-id="0e493-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="0e493-140">トランザクションを構成する SQL ステートメントを実行します。</span><span class="sxs-lookup"><span data-stu-id="0e493-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="0e493-141">手順 2、ロールバック、トランザクションのステートメントのいずれかでエラーがある場合</span><span class="sxs-lookup"><span data-stu-id="0e493-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="0e493-142">エラーなしですべての手順 2 からステートメント完了、トランザクションをコミットします。</span><span class="sxs-lookup"><span data-stu-id="0e493-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="0e493-143">を作成するための SQL ステートメントのコミット、およびストアド プロシージャの SQL スクリプトを記述または作成するときに、トランザクションを手動で入力することができますをロールバック、またはプログラムで ADO.NET またはクラスでは、のいずれかを使用することを意味します、 [ `System.Transactions`名前空間](https://msdn.microsoft.com/library/system.transactions.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="0e493-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="0e493-144">見ていきますのみ、このチュートリアルでは、ADO.NET を使用してトランザクションを管理します。</span><span class="sxs-lookup"><span data-stu-id="0e493-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="0e493-145">今後のチュートリアルでは、時に作成、ロールバック、およびトランザクションをコミットするための SQL ステートメントについて見ていきます、データ アクセス レイヤーでストアド プロシージャを使用する方法について取り上げます。</span><span class="sxs-lookup"><span data-stu-id="0e493-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="0e493-146">その間を参照してください[SQL Server ストアド プロシージャでのトランザクションの管理](http://www.4guysfromrolla.com/webtech/080305-1.shtml)詳細についてはします。</span><span class="sxs-lookup"><span data-stu-id="0e493-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="0e493-147">[ `TransactionScope`クラス](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx)で、`System.Transactions`名前空間により、開発者は、トランザクションのスコープ内で、一連のステートメントをプログラムでラップして、複数の関連する複雑なトランザクションのサポートが含まれています2 つの異なるデータベースまたはでも異種の種類の Microsoft SQL Server データベース、Oracle データベース、および Web サービスなどのデータ ストアなどのソース。</span><span class="sxs-lookup"><span data-stu-id="0e493-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="0e493-148">トランザクションを使用する ADO.NET の代わりに、このチュートリアルを決めたら、`TransactionScope`クラス ADO.NET をデータベース トランザクションとは、多くの場合、絞り込んだがはるかに少ないリソースを消費します。</span><span class="sxs-lookup"><span data-stu-id="0e493-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="0e493-149">さらに、特定のシナリオで、`TransactionScope`クラスは、Microsoft 分散トランザクション コーディネーター (MSDTC) を使用します。</span><span class="sxs-lookup"><span data-stu-id="0e493-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="0e493-150">構成、実装、およびパフォーマンスの問題周囲の MSDTC ではなく特殊および高度なトピックと、これらのチュートリアルの対象外です。</span><span class="sxs-lookup"><span data-stu-id="0e493-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>


<span data-ttu-id="0e493-151">呼び出すことによってトランザクションが開始された ADO.NET での SqlClient プロバイダーを使用する場合、 [ `SqlConnection`クラス](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx)s [ `BeginTransaction`メソッド](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx)、返された、 [ `SqlTransaction`オブジェクト](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="0e493-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="0e493-152">構成のトランザクションが内に配置するデータ変更ステートメント、`try...catch`ブロックします。</span><span class="sxs-lookup"><span data-stu-id="0e493-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="0e493-153">内のステートメントでエラーが発生した場合、`try`への転送の実行をブロック、 `catch` 、トランザクションをロールバックを使用して、ブロック、`SqlTransaction`オブジェクト s [ `Rollback`メソッド](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="0e493-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="0e493-154">すべてのステートメントへの呼び出しで完全に成功する場合、`SqlTransaction`オブジェクト s [ `Commit`メソッド](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx)の最後に、`try`ブロックがトランザクションをコミットします。</span><span class="sxs-lookup"><span data-stu-id="0e493-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="0e493-155">次のコード スニペットは、このパターンを示しています。</span><span class="sxs-lookup"><span data-stu-id="0e493-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="0e493-156">参照してください[トランザクションでデータベースの整合性を維持する](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)構文と ADO.NET を使用してトランザクションを使用しての例を示します。</span><span class="sxs-lookup"><span data-stu-id="0e493-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample1.cs)]

<span data-ttu-id="0e493-157">既定では、型指定されたデータセットに Tableadapter は、トランザクションを使用しません。</span><span class="sxs-lookup"><span data-stu-id="0e493-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="0e493-158">トランザクションのサポートを提供するには、一連のトランザクションのスコープ内でデータ変更ステートメントを実行する上記のパターンを使用する追加のメソッドを含む TableAdapter のクラスを拡張するために必要があります。</span><span class="sxs-lookup"><span data-stu-id="0e493-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="0e493-159">手順 2 は、部分クラスを使用して、これらのメソッドを追加する方法が表示されます。</span><span class="sxs-lookup"><span data-stu-id="0e493-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="0e493-160">手順 1: データのバッチ化された Web ページで、作業を作成します。</span><span class="sxs-lookup"><span data-stu-id="0e493-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="0e493-161">データベース トランザクションをサポートするために DAL を強化する方法の探索を開始して、前にまず、このチュートリアルが必要な ASP.NET web ページ、次の 3 つを作成するのにはしばらく s を使用できます。</span><span class="sxs-lookup"><span data-stu-id="0e493-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="0e493-162">という名前の新しいフォルダーを追加することによって開始`BatchData`し、次の ASP.NET ページで各ページの関連付けを追加、`Site.master`マスター ページ。</span><span class="sxs-lookup"><span data-stu-id="0e493-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`


![SqlDataSource に関連するチュートリアルについては、ASP.NET ページを追加します。](wrapping-database-modifications-within-a-transaction-cs/_static/image1.gif)

<span data-ttu-id="0e493-164">**図 1**: SqlDataSource に関連するチュートリアルについては、ASP.NET ページを追加します。</span><span class="sxs-lookup"><span data-stu-id="0e493-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>


<span data-ttu-id="0e493-165">同様に、他のフォルダー`Default.aspx`を使用して、`SectionLevelTutorialListing.ascx`ユーザー コントロールをそのセクション内でチュートリアルを一覧表示します。</span><span class="sxs-lookup"><span data-stu-id="0e493-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="0e493-166">そのため、このユーザー コントロールを追加`Default.aspx`をページのデザイン ビューに、ソリューション エクスプ ローラーからドラッグしています。</span><span class="sxs-lookup"><span data-stu-id="0e493-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>


<span data-ttu-id="0e493-167">[![Default.aspx に SectionLevelTutorialListing.ascx ユーザー コントロールを追加します。](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="0e493-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span></span>

<span data-ttu-id="0e493-168">**図 2**: 追加、`SectionLevelTutorialListing.ascx`ユーザー コントロールを`Default.aspx`([フルサイズのイメージを表示するをクリックして](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="0e493-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span></span>


<span data-ttu-id="0e493-169">最後に、これら 4 つのページを追加するエントリとして、`Web.sitemap`ファイル。</span><span class="sxs-lookup"><span data-stu-id="0e493-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="0e493-170">具体的には、次のマークアップを追加、カスタマイズした後、サイト マップ`<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="0e493-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>


[!code-xml[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample2.xml)]

<span data-ttu-id="0e493-171">更新した後に`Web.sitemap`ブラウザーを使って、チュートリアルの web サイトを表示します。</span><span class="sxs-lookup"><span data-stu-id="0e493-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="0e493-172">左側のメニューには、バッチ化されたデータのチュートリアルを使用した作業項目が含まれています。</span><span class="sxs-lookup"><span data-stu-id="0e493-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>


![サイト マップではバッチ化されたデータのチュートリアルを使用した作業のエントリが含まれるようになりました](wrapping-database-modifications-within-a-transaction-cs/_static/image3.gif)

<span data-ttu-id="0e493-174">**図 3**: サイト マップではバッチ化されたデータのチュートリアルを使用した作業のエントリが含まれるようになりました</span><span class="sxs-lookup"><span data-stu-id="0e493-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>


## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="0e493-175">手順 2: データベース トランザクションをサポートするために、データ アクセス層の更新</span><span class="sxs-lookup"><span data-stu-id="0e493-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="0e493-176">最初のチュートリアルで説明したよう[データ アクセス レイヤーを作成する](../introduction/creating-a-data-access-layer-cs.md)、当社の DAL で型指定されたデータセットはデータ テーブルと Tableadapter ので構成されます。</span><span class="sxs-lookup"><span data-stu-id="0e493-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="0e493-177">データ テーブルは、Tableadapter は、データをテーブルにするには、Datatable、およびなどに加えられた変更と、データベースを更新するにはデータベースからデータを読み取るための機能を提供中にデータを保持します。</span><span class="sxs-lookup"><span data-stu-id="0e493-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="0e493-178">Tableadapter がすればと呼ばれるバッチ更新と DB ダイレクト、データの更新の 2 つのパターンを提供することに注意してください。</span><span class="sxs-lookup"><span data-stu-id="0e493-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="0e493-179">バッチ更新パターンでは、TableAdapter はデータセット、データ テーブル、または Datarow のコレクションに渡されます。</span><span class="sxs-lookup"><span data-stu-id="0e493-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="0e493-180">このデータが列挙し、各挿入、変更、または行を削除、 `InsertCommand`、 `UpdateCommand`、または`DeleteCommand`を実行します。</span><span class="sxs-lookup"><span data-stu-id="0e493-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="0e493-181">DB ダイレクトのパターンを持つ、TableAdapter は、挿入、更新、または 1 つのレコードを削除するために必要な列の値を代わりに渡されます。</span><span class="sxs-lookup"><span data-stu-id="0e493-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="0e493-182">DB 直接的なパターン メソッドは、適切な実行をそれらの渡された値を使用して`InsertCommand`、 `UpdateCommand`、または`DeleteCommand`ステートメントです。</span><span class="sxs-lookup"><span data-stu-id="0e493-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="0e493-183">使用した更新パターンに関係なく、Tableadapter の自動生成されたメソッドは、トランザクションを使用しません。</span><span class="sxs-lookup"><span data-stu-id="0e493-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="0e493-184">既定では、各 insert、update、または、TableAdapter によって実行される delete が 1 つの独立した操作として扱われます。</span><span class="sxs-lookup"><span data-stu-id="0e493-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="0e493-185">たとえば、DB ダイレクト パターンを使用する、BLL の一部のコードで 10 個のレコードをデータベースに挿入想像してください。</span><span class="sxs-lookup"><span data-stu-id="0e493-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="0e493-186">このコードは、tableadapter を呼び出します`Insert`メソッドでその 10 倍です。</span><span class="sxs-lookup"><span data-stu-id="0e493-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="0e493-187">最初の 5 つの挿入が成功すると、6 番目の 1 つ例外が発生した場合は、データベース内の最初の 5 つ挿入したレコードが残っていません。</span><span class="sxs-lookup"><span data-stu-id="0e493-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="0e493-188">同様に、バッチ更新パターンを介して挿入操作を実行する場合に、更新、および削除、挿入を変更し、削除、DataTable の行最初のいくつかの変更が成功しましたが、後で、1 には、以前、これらの変更、エラーが発生しましたを。完了しましたが、データベースに残っていません。</span><span class="sxs-lookup"><span data-stu-id="0e493-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="0e493-189">特定のシナリオで一連の変更で原子性を確保することができます。</span><span class="sxs-lookup"><span data-stu-id="0e493-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="0e493-190">これを実行する新しいメソッドを追加することにより、TableAdapter を手動で拡張する必要がありますを実現する、 `InsertCommand`、 `UpdateCommand`、および`DeleteCommand`トランザクションの傘下に s。</span><span class="sxs-lookup"><span data-stu-id="0e493-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="0e493-191">[データ アクセス レイヤーを作成する](../introduction/creating-a-data-access-layer-cs.md)を使用してきました[部分クラス](http://en.wikipedia.org/wiki/Partial_type)型指定されたデータセット内のデータ テーブルの機能を拡張します。</span><span class="sxs-lookup"><span data-stu-id="0e493-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="0e493-192">この方法は、Tableadapter にも使用できます。</span><span class="sxs-lookup"><span data-stu-id="0e493-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="0e493-193">型指定されたデータセット`Northwind.xsd`内にある、`App_Code`フォルダーの`DAL`サブフォルダーです。</span><span class="sxs-lookup"><span data-stu-id="0e493-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="0e493-194">内のサブフォルダーを作成、`DAL`という名前のフォルダー`TransactionSupport`という新しいクラス ファイルを追加および`ProductsTableAdapter.TransactionSupport.cs`(図 4 を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="0e493-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.cs` (see Figure 4).</span></span> <span data-ttu-id="0e493-195">このファイルは、の実装の一部を保持する、`ProductsTableAdapter`にトランザクションを使用してデータの変更を実行するためのメソッドが含まれています。</span><span class="sxs-lookup"><span data-stu-id="0e493-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>


![TransactionSupport をという名前のフォルダーと ProductsTableAdapter.TransactionSupport.cs をという名前のクラス ファイルを追加します。](wrapping-database-modifications-within-a-transaction-cs/_static/image4.gif)

<span data-ttu-id="0e493-197">**図 4**: という名前のフォルダーを追加`TransactionSupport`とという名前のクラス ファイル `ProductsTableAdapter.TransactionSupport.cs`</span><span class="sxs-lookup"><span data-stu-id="0e493-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.cs`</span></span>


<span data-ttu-id="0e493-198">次のコードを入力してください、`ProductsTableAdapter.TransactionSupport.cs`ファイル。</span><span class="sxs-lookup"><span data-stu-id="0e493-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.cs` file:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample3.cs)]

<span data-ttu-id="0e493-199">`partial`をコンパイラに追加する内で追加されたメンバーであることを示すクラスの宣言でキーワード、`ProductsTableAdapter`クラス内で、`NorthwindTableAdapters`名前空間。</span><span class="sxs-lookup"><span data-stu-id="0e493-199">The `partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="0e493-200">注、`using System.Data.SqlClient`ファイルの上部にあるステートメントです。</span><span class="sxs-lookup"><span data-stu-id="0e493-200">Note the `using System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="0e493-201">TableAdapter は、SqlClient プロバイダーを使用する構成された、以降内部的に使用して、 [ `SqlDataAdapter` ](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx)データベースにそのコマンドを実行するオブジェクト。</span><span class="sxs-lookup"><span data-stu-id="0e493-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="0e493-202">そのため、使用する必要があります、`SqlTransaction`トランザクションを開始するクラスとそのコミットまたはロールバックするためにします。</span><span class="sxs-lookup"><span data-stu-id="0e493-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="0e493-203">Microsoft SQL Server 以外のデータ ストアを使用している場合は、適切なプロバイダーを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0e493-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="0e493-204">これらのメソッドは、ロールバックを開始するために必要な構成要素を提供し、トランザクションをコミットします。</span><span class="sxs-lookup"><span data-stu-id="0e493-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="0e493-205">マークされている`public`、内から使用することを有効にすると、 `ProductsTableAdapter`DAL に別のクラスまたは BLL など、アーキテクチャの別のレイヤーからです。</span><span class="sxs-lookup"><span data-stu-id="0e493-205">They are marked `public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="0e493-206">`BeginTransaction` 内部の tableadapter を開きます`SqlConnection`(必要な場合)、トランザクションを開始し、それを`Transaction`プロパティ、トランザクションを内部に添付`SqlDataAdapter`s`SqlCommand`オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="0e493-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="0e493-207">`CommitTransaction` および`RollbackTransaction`を呼び出す、`Transaction`オブジェクト s`Commit`と`Rollback`メソッド、それぞれ、閉じてから、内部`Connection`オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="0e493-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="0e493-208">手順 3: トランザクションの傘下にデータを更新および削除メソッドの追加</span><span class="sxs-lookup"><span data-stu-id="0e493-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="0e493-209">これらのメソッドは完全なメソッドを追加お re 準備ができて`ProductsDataTable`または BLL 一連のトランザクションの傘下にコマンドを実行します。</span><span class="sxs-lookup"><span data-stu-id="0e493-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="0e493-210">次のメソッドは、バッチ更新パターンを使用して、更新、`ProductsDataTable`インスタンスのトランザクションを使用します。</span><span class="sxs-lookup"><span data-stu-id="0e493-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="0e493-211">呼び出してトランザクションを開始、`BeginTransaction`メソッドおよび、使用、`try...catch`データ変更ステートメントを発行するブロック。</span><span class="sxs-lookup"><span data-stu-id="0e493-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `try...catch` block to issue the data modification statements.</span></span> <span data-ttu-id="0e493-212">場合への呼び出し、`Adapter`オブジェクト s`Update`例外でメソッドの結果、実行に転送して、`catch`ここで、トランザクションはロールバックされますブロックと再スローされる例外。</span><span class="sxs-lookup"><span data-stu-id="0e493-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="0e493-213">注意してください、`Update`メソッドは、指定された行を列挙することで、バッチ更新パターンを実装`ProductsDataTable`、必要なを実行して`InsertCommand`、 `UpdateCommand`、および`DeleteCommand`s。</span><span class="sxs-lookup"><span data-stu-id="0e493-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="0e493-214">いずれかのエラーこれらのコマンドの結果で場合、トランザクションがロールバック、トランザクションの有効期間中に行われた以前の変更を元に戻します。</span><span class="sxs-lookup"><span data-stu-id="0e493-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="0e493-215">必要があります、`Update`エラーなしステートメントが完了すると、その完全な形でトランザクションをコミットします。</span><span class="sxs-lookup"><span data-stu-id="0e493-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample4.cs)]

<span data-ttu-id="0e493-216">追加、`UpdateWithTransaction`メソッドを`ProductsTableAdapter`で部分クラスを通じてクラス`ProductsTableAdapter.TransactionSupport.cs`です。</span><span class="sxs-lookup"><span data-stu-id="0e493-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.cs`.</span></span> <span data-ttu-id="0e493-217">また、このメソッドは、ビジネス ロジック層 s に追加できませんでした`ProductsBLL`多少構文の変更を持つクラス。</span><span class="sxs-lookup"><span data-stu-id="0e493-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="0e493-218">キーワードでは、これには`this.BeginTransaction()`、 `this.CommitTransaction()`、および`this.RollbackTransaction()`で置き換える必要があります`Adapter`(ことに注意してください`Adapter`では、プロパティの名前を指定`ProductsBLL`型の`ProductsTableAdapter`)。</span><span class="sxs-lookup"><span data-stu-id="0e493-218">Namely, the keyword this in `this.BeginTransaction()`, `this.CommitTransaction()`, and `this.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="0e493-219">`UpdateWithTransaction`メソッドは、バッチ更新パターンを使用しますが、一連の DB 直接呼び出しは、メソッドを次に示すように、トランザクションのスコープ内でも使用できます。</span><span class="sxs-lookup"><span data-stu-id="0e493-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="0e493-220">`DeleteProductsWithTransaction`メソッドが入力として受け取ります、`List<T>`型の`int`、これは、`ProductID`削除します。</span><span class="sxs-lookup"><span data-stu-id="0e493-220">The `DeleteProductsWithTransaction` method accepts as input a `List<T>` of type `int`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="0e493-221">メソッドへの呼び出しを使用してトランザクションを開始する`BeginTransaction`し、、`try`ブロックは、DB ダイレクト パターンを呼び出して、指定されたリストを反復処理`Delete`ごとメソッド`ProductID`値。</span><span class="sxs-lookup"><span data-stu-id="0e493-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="0e493-222">呼び出しのいずれかの`Delete`失敗した場合に制御が移ります、`catch`トランザクションのロールバックをブロックし、再スローされる例外。</span><span class="sxs-lookup"><span data-stu-id="0e493-222">If any of the calls to `Delete` fails, control is transferred to the `catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="0e493-223">すべての呼び出し場合`Delete`トランザクションがコミットが成功します。</span><span class="sxs-lookup"><span data-stu-id="0e493-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="0e493-224">このメソッドを追加、`ProductsBLL`クラスです。</span><span class="sxs-lookup"><span data-stu-id="0e493-224">Add this method to the `ProductsBLL` class.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample5.cs)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="0e493-225">複数の Tableadapter の間でトランザクションを適用します。</span><span class="sxs-lookup"><span data-stu-id="0e493-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="0e493-226">に対して複数のステートメントでは、このチュートリアルで確認トランザクションに関連するコード、`ProductsTableAdapter`分割不可能な操作として扱われます。</span><span class="sxs-lookup"><span data-stu-id="0e493-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="0e493-227">原子的に実行する別のデータベース テーブルに複数の変更が必要な場合ですか。</span><span class="sxs-lookup"><span data-stu-id="0e493-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="0e493-228">インスタンスのカテゴリを削除するときに可能性があります最初するその他のいくつかのカテゴリに現在の製品を再割り当ています。</span><span class="sxs-lookup"><span data-stu-id="0e493-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="0e493-229">分割不可能な操作として製品を再割り当てして、カテゴリを削除する 2 つの手順を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0e493-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="0e493-230">`ProductsTableAdapter`を変更する方法のみが含まれています、`Products`テーブルおよび`CategoriesTableAdapter`を変更する方法のみが含まれています、`Categories`テーブル。</span><span class="sxs-lookup"><span data-stu-id="0e493-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="0e493-231">トランザクションはどのように両方の Tableadapter を取り込むことができますか。</span><span class="sxs-lookup"><span data-stu-id="0e493-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="0e493-232">メソッドを追加するのには、1 つのオプション、`CategoriesTableAdapter`という`DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)`製品を再割り当てして、ストアド プロシージャ内で定義されたトランザクションのスコープ内のカテゴリを削除するストアド プロシージャを呼び出してそのメソッドがあるとします。</span><span class="sxs-lookup"><span data-stu-id="0e493-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="0e493-233">今後のチュートリアルでは、開始、コミットする方法、およびストアド プロシージャでのトランザクションをロールバックお見ていきます。</span><span class="sxs-lookup"><span data-stu-id="0e493-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="0e493-234">含む DAL でヘルパー クラスを作成することもできます、`DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="0e493-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="0e493-235">このメソッドのインスタンスを作成、`CategoriesTableAdapter`と`ProductsTableAdapter`2 つの Tableadapter に設定し、`Connection`プロパティを同じ`SqlConnection`インスタンス。</span><span class="sxs-lookup"><span data-stu-id="0e493-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="0e493-236">At その時点では、次の 2 つの Tableadapter のいずれかを呼び出してトランザクションを開始する`BeginTransaction`です。</span><span class="sxs-lookup"><span data-stu-id="0e493-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="0e493-237">製品を再割り当てすると、カテゴリを削除する Tableadapter のメソッドで呼び出される、`try...catch`コミットまたはロールバックに必要なトランザクションをブロックします。</span><span class="sxs-lookup"><span data-stu-id="0e493-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `try...catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="0e493-238">手順 4: 追加、`UpdateWithTransaction`ビジネス ロジック層メソッド</span><span class="sxs-lookup"><span data-stu-id="0e493-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="0e493-239">手順 3 では追加、`UpdateWithTransaction`メソッドを`ProductsTableAdapter`DAL にします。</span><span class="sxs-lookup"><span data-stu-id="0e493-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="0e493-240">対応するメソッド、BLL に追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0e493-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="0e493-241">プレゼンテーション層が、DAL を呼び出すまで直接呼び出し中に、`UpdateWithTransaction`メソッド、これらのチュートリアルは、プレゼンテーション層の DAL の影響を受けないようにする、レイヤー アーキテクチャを定義する strived がします。</span><span class="sxs-lookup"><span data-stu-id="0e493-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="0e493-242">そのため、この方法を引き続き behooves します。</span><span class="sxs-lookup"><span data-stu-id="0e493-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="0e493-243">開く、`ProductsBLL`クラス ファイルをという名前のメソッドを追加`UpdateWithTransaction`その単に呼び出し、対応する DAL メソッドまでです。</span><span class="sxs-lookup"><span data-stu-id="0e493-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="0e493-244">2 つの新しいメソッドはず`ProductsBLL`: `UpdateWithTransaction`、追加して`DeleteProductsWithTransaction`、手順 3. で追加されました。</span><span class="sxs-lookup"><span data-stu-id="0e493-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample6.cs)]

> [!NOTE]
> <span data-ttu-id="0e493-245">これらのメソッドを含めないでください、`DataObjectMethodAttribute`の他のほとんどのメソッドに割り当てられている属性、`ProductsBLL`クラスため ASP.NET ページの分離コード クラスから直接、これらのメソッドが起動します。</span><span class="sxs-lookup"><span data-stu-id="0e493-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="0e493-246">注意してください`DataObjectMethodAttribute`どのような方法が表示されます、ObjectDataSource s で構成するデータ ソース ウィザード (SELECT、UPDATE、INSERT、または DELETE) は、どのようなタブの下にフラグを設定するために使用します。</span><span class="sxs-lookup"><span data-stu-id="0e493-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="0e493-247">GridView に編集または削除するバッチの組み込みサポートがないため、宣言型コードを必要としないアプローチを使用するのではなく、プログラムによってこれらのメソッドを呼び出すお必要があります。</span><span class="sxs-lookup"><span data-stu-id="0e493-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>


## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="0e493-248">手順 5: は、プレゼンテーション層からデータベースのデータをアトミックに更新</span><span class="sxs-lookup"><span data-stu-id="0e493-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="0e493-249">Let s を GridView のすべての製品を一覧表示し、ボタン Web を含むユーザー インターフェイスを作成するトランザクションがレコードのバッチを更新するときに及ぼす影響を示すためをクリックすると、制御、製品を再割り当て`CategoryID`値。</span><span class="sxs-lookup"><span data-stu-id="0e493-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="0e493-250">具体的には、カテゴリの再割り当てが進行状況の最初のいくつかの製品は有効な割り当てられるように`CategoryID`意図的にも値が存在しない`CategoryID`値。</span><span class="sxs-lookup"><span data-stu-id="0e493-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="0e493-251">製品で、データベースを更新しようかどうか持つ`CategoryID`s の既存のカテゴリと一致しません`CategoryID`、外部キー制約違反が発生し、例外が発生します。</span><span class="sxs-lookup"><span data-stu-id="0e493-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="0e493-252">この例を見てみましょうとなるのトランザクションの外部キー制約違反から発生する例外を使用すると、前の有効な`CategoryID`変更をロールバックできます。</span><span class="sxs-lookup"><span data-stu-id="0e493-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="0e493-253">トランザクションを使用していない場合はただし、最初のカテゴリへの変更は残ります。</span><span class="sxs-lookup"><span data-stu-id="0e493-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="0e493-254">開いて開始、 `Transactions.aspx`  ページで、`BatchData`フォルダーと、ツールボックスからデザイナーにドラッグする GridView。</span><span class="sxs-lookup"><span data-stu-id="0e493-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="0e493-255">設定の`ID`に`Products`と、という名前の新しい ObjectDataSource へのバインドのスマート タグから`ProductsDataSource`です。</span><span class="sxs-lookup"><span data-stu-id="0e493-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="0e493-256">構成からそのデータをプルする ObjectDataSource、`ProductsBLL`クラスの`GetProducts`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="0e493-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="0e493-257">これは、読み取り専用の GridView、ので、UPDATE、INSERT でのドロップダウン リストの設定し (なし) にタブを削除してする完了 をクリックします。</span><span class="sxs-lookup"><span data-stu-id="0e493-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>


<span data-ttu-id="0e493-258">[![図 5: ProductsBLL クラスの GetProducts メソッドを使用して、ObjectDataSource を構成します。](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="0e493-258">[![Figure 5: Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span></span>

<span data-ttu-id="0e493-259">**図 5**: 図 5: 構成を使用する ObjectDataSource、`ProductsBLL`クラス s`GetProducts`メソッド ([フルサイズのイメージを表示するをクリックして](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="0e493-259">**Figure 5**: Figure 5: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span></span>


<span data-ttu-id="0e493-260">[![UPDATE、INSERT のドロップダウン リストを設定し、(なし) タブを削除します。](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="0e493-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span></span>

<span data-ttu-id="0e493-261">**図 6**: (なし) に、UPDATE、INSERT、および削除のタブで、ドロップダウン リストを設定 ([フルサイズのイメージを表示するをクリックして](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="0e493-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span></span>


<span data-ttu-id="0e493-262">データ ソース構成ウィザードを完了すると、Visual Studio は、BoundFields と製品データ フィールドの CheckBoxField に作成されます。</span><span class="sxs-lookup"><span data-stu-id="0e493-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="0e493-263">これらのフィールドを除くすべて削除`ProductID`、 `ProductName`、`CategoryID`と`CategoryName`の名前を変更し、`ProductName`と`CategoryName`BoundFields`HeaderText`製品および分類プロパティをそれぞれします。</span><span class="sxs-lookup"><span data-stu-id="0e493-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="0e493-264">スマート タグからページングを有効にするオプションをオンにします。</span><span class="sxs-lookup"><span data-stu-id="0e493-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="0e493-265">このような変更を加えたら、GridView と ObjectDataSource s の宣言型マークアップは、次のようになります。</span><span class="sxs-lookup"><span data-stu-id="0e493-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample7.aspx)]

<span data-ttu-id="0e493-266">次に、GridView 上の 3 つのボタンの Web コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="0e493-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="0e493-267">グリッドの更新、変更のカテゴリ (で TRANSACTION)、2 番目の s および変更のカテゴリ (トランザクションなし) に 3 つ目の 1 つの s を最初のボタンのテキスト プロパティを設定します。</span><span class="sxs-lookup"><span data-stu-id="0e493-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample8.aspx)]

<span data-ttu-id="0e493-268">この時点で Visual Studio でデザイン ビューは、スクリーン ショット図 7 に示すようになります。</span><span class="sxs-lookup"><span data-stu-id="0e493-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>


<span data-ttu-id="0e493-269">[![ページには、GridView と、次の 3 つのボタン Web コントロールが含まれています。](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="0e493-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span></span>

<span data-ttu-id="0e493-270">**図 7**: ページには、GridView と、次の 3 つのボタン Web コントロールが含まれています ([フルサイズのイメージを表示するをクリックして](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="0e493-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span></span>


<span data-ttu-id="0e493-271">次の 3 つのボタン s の各イベント ハンドラーを作成`Click`イベントと、次のコードを使用します。</span><span class="sxs-lookup"><span data-stu-id="0e493-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample9.cs)]

<span data-ttu-id="0e493-272">更新ボタン s`Click`イベント ハンドラーは、呼び出すことによって GridView にデータをバインドするだけで、 `Products` GridView の`DataBind`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="0e493-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="0e493-273">2 つ目のイベント ハンドラーは、製品を再割り当て`CategoryID`s と、新しいトランザクション メソッド データベースを実行する BLL から更新トランザクションの傘下に使用します。</span><span class="sxs-lookup"><span data-stu-id="0e493-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="0e493-274">なお s の各製品`CategoryID`と同じ値に設定されている任意の`ProductID`します。</span><span class="sxs-lookup"><span data-stu-id="0e493-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="0e493-275">これはうまく機能、最初のいくつかの製品では、これらの製品があるため`ProductID`有効なにマップに値`CategoryID`s。</span><span class="sxs-lookup"><span data-stu-id="0e493-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="0e493-276">1 回、`ProductID`肥大 s スタートのこの偶然の一致の重なり`ProductID`s および`CategoryID`s が適用されなくなった。</span><span class="sxs-lookup"><span data-stu-id="0e493-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="0e493-277">3 番目`Click`イベント ハンドラーは、製品、更新`CategoryID`、同じ方法を使用して、データベースに、更新を送信するが、 `ProductsTableAdapter` s 既定`Update`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="0e493-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="0e493-278">これは、`Update`メソッドは、一連のトランザクション内でのコマンドをラップしません、それらの変更が最初の発生の外部キー制約違反エラーの前に行われたようにが保持されます。</span><span class="sxs-lookup"><span data-stu-id="0e493-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="0e493-279">この動作を示すためには、ブラウザーからこのページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="0e493-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="0e493-280">最初に図 8 に示すようにデータの最初のページが表示されます。</span><span class="sxs-lookup"><span data-stu-id="0e493-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="0e493-281">次に、変更のカテゴリ (でトランザクション) をクリックします。</span><span class="sxs-lookup"><span data-stu-id="0e493-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="0e493-282">ポストバックを発生させるし、すべての製品を更新しようとしています。 これは`CategoryID`、値が、外部キー制約違反になります (図 9 を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="0e493-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>


<span data-ttu-id="0e493-283">[![ページング可能な GridView に製品が表示されます。](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="0e493-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span></span>

<span data-ttu-id="0e493-284">**図 8**: ページング可能な GridView に、製品が表示されます ([フルサイズのイメージを表示するをクリックして](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="0e493-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span></span>


<span data-ttu-id="0e493-285">[![外部キー制約に違反カテゴリ結果を再割り当てします。](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="0e493-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span></span>

<span data-ttu-id="0e493-286">**図 9**: 外部キー制約の違反でカテゴリの結果を再割り当て ([フルサイズのイメージを表示するをクリックして](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="0e493-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span></span>


<span data-ttu-id="0e493-287">ブラウザーの 戻る ボタンをクリックして、グリッドの更新 ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="0e493-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="0e493-288">データの更新時に図 8 に示すように、まったく同じ出力が表示されます。</span><span class="sxs-lookup"><span data-stu-id="0e493-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="0e493-289">でもは、製品の一部が`CategoryID`s が法的に変更された値と、データベースの更新、それらがロールバックされた外部キー制約違反が発生しました。</span><span class="sxs-lookup"><span data-stu-id="0e493-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="0e493-290">今すぐ変更のカテゴリ (トランザクションなし) ボタンをクリックしてください。</span><span class="sxs-lookup"><span data-stu-id="0e493-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="0e493-291">これは、同じ外部キー制約違反エラーになります (図 9 を参照)、これらの製品が持つ`CategoryID`に有効な値が変更された値はロールバックされません。</span><span class="sxs-lookup"><span data-stu-id="0e493-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="0e493-292">ブラウザーの戻るボタンをクリックし、グリッドの更新ボタンに達してください。</span><span class="sxs-lookup"><span data-stu-id="0e493-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="0e493-293">図 10 に示す、`CategoryID`最初の 8 つの製品の s を再割り当てされています。</span><span class="sxs-lookup"><span data-stu-id="0e493-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="0e493-294">たとえば、図 8 に変更が、 `CategoryID` 1 が 2 に、図 10 it s されて再割り当ています。</span><span class="sxs-lookup"><span data-stu-id="0e493-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>


<span data-ttu-id="0e493-295">[![一部の製品 CategoryID インポートされなかった値を更新中に他のユーザー](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="0e493-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span></span>

<span data-ttu-id="0e493-296">**図 10**: 一部の製品`CategoryID`インポートされなかった値を更新中に他のユーザーが ([フルサイズのイメージを表示するをクリックして](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="0e493-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span></span>


## <a name="summary"></a><span data-ttu-id="0e493-297">まとめ</span><span class="sxs-lookup"><span data-stu-id="0e493-297">Summary</span></span>

<span data-ttu-id="0e493-298">既定では、TableAdapter のメソッドでは、トランザクションのスコープ内で実行されるデータベース ステートメントをラップしないでくださいが簡単な作業で追加できるメソッドを作成する、commit、およびトランザクションをロールバックします。</span><span class="sxs-lookup"><span data-stu-id="0e493-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="0e493-299">このチュートリアルでのような 3 つのメソッドを作成しました、`ProductsTableAdapter`クラス: `BeginTransaction`、 `CommitTransaction`、および`RollbackTransaction`です。</span><span class="sxs-lookup"><span data-stu-id="0e493-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="0e493-300">これらのメソッドと共に使用する方法を説明しました、`try...catch`一連のデータ変更ステートメントをアトミックにブロックします。</span><span class="sxs-lookup"><span data-stu-id="0e493-300">We saw how to use these methods along with a `try...catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="0e493-301">具体的には、作成した、`UpdateWithTransaction`メソッドで、 `ProductsTableAdapter`、バッチ更新パターンを使用して、指定された行数に必要な変更を実行する`ProductsDataTable`です。</span><span class="sxs-lookup"><span data-stu-id="0e493-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="0e493-302">追加されています、`DeleteProductsWithTransaction`メソッドを`ProductsBLL`を受け入れると、BLL 内のクラス、`List`の`ProductID`DB ダイレクト パターン メソッドを呼び出して、入力として値を`Delete`各`ProductID`です。</span><span class="sxs-lookup"><span data-stu-id="0e493-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="0e493-303">両方のメソッドの開始、トランザクションを作成し、内のデータ変更ステートメントを実行、`try...catch`ブロックします。</span><span class="sxs-lookup"><span data-stu-id="0e493-303">Both methods start by creating a transaction and then executing the data modification statements within a `try...catch` block.</span></span> <span data-ttu-id="0e493-304">例外が発生する場合、トランザクションがロールバック、それ以外の場合とコミットされます。</span><span class="sxs-lookup"><span data-stu-id="0e493-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="0e493-305">手順 5 では、トランザクションを使用していなかったバッチ更新とトランザクションのバッチ更新の影響を示します。</span><span class="sxs-lookup"><span data-stu-id="0e493-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="0e493-306">次の 3 つのチュートリアルでは、このチュートリアルに配置されている基盤に構築し、バッチ更新、削除、および挿入を実行するためのユーザー インターフェイスを作成おします。</span><span class="sxs-lookup"><span data-stu-id="0e493-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="0e493-307">満足プログラミング!</span><span class="sxs-lookup"><span data-stu-id="0e493-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="0e493-308">関連項目</span><span class="sxs-lookup"><span data-stu-id="0e493-308">Further Reading</span></span>

<span data-ttu-id="0e493-309">このチュートリアルで説明したトピックの詳細については、次の情報を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0e493-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="0e493-310">トランザクションでデータベースの整合性を維持します。</span><span class="sxs-lookup"><span data-stu-id="0e493-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="0e493-311">ストアド プロシージャを SQL Server のトランザクションを管理します。</span><span class="sxs-lookup"><span data-stu-id="0e493-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="0e493-312">トランザクションが簡単に作成します。 `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="0e493-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="0e493-313">TransactionScope と Dataadapter</span><span class="sxs-lookup"><span data-stu-id="0e493-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="0e493-314">.NET での Oracle データベースのトランザクションの使用</span><span class="sxs-lookup"><span data-stu-id="0e493-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="0e493-315">作成者について</span><span class="sxs-lookup"><span data-stu-id="0e493-315">About the Author</span></span>

<span data-ttu-id="0e493-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)、7 つ受け取りますブックとの創設者の作成者[4GuysFromRolla.com](http://www.4guysfromrolla.com)、1998 年からマイクロソフトの Web テクノロジで取り組んできました。</span><span class="sxs-lookup"><span data-stu-id="0e493-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="0e493-317">Scott は、コンサルタント、トレーナー、ライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="0e493-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="0e493-318">最新の著書[ *Sam 学べる自分で ASP.NET 2.0 が 24 時間以内に*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)です。</span><span class="sxs-lookup"><span data-stu-id="0e493-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="0e493-319">彼に到達できる[ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)彼のブログを使用して含まれているのか[ http://ScottOnWriting.NET](http://ScottOnWriting.NET)です。</span><span class="sxs-lookup"><span data-stu-id="0e493-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="0e493-320">感謝の特別な</span><span class="sxs-lookup"><span data-stu-id="0e493-320">Special Thanks To</span></span>

<span data-ttu-id="0e493-321">このチュートリアルの系列は既に多くの便利なレビュー担当者によって確認済みです。</span><span class="sxs-lookup"><span data-stu-id="0e493-321">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="0e493-322">このチュートリアルの潜在顧客レビュー担当者には、Dave ガードナー、Hilton Giesenow Teresa マーフィーがされていました。</span><span class="sxs-lookup"><span data-stu-id="0e493-322">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="0e493-323">今後、MSDN の記事を確認することに関心のあるですか。</span><span class="sxs-lookup"><span data-stu-id="0e493-323">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="0e493-324">場合は、ドロップ me 一度に 1 行ずつ[mitchell@4GuysFromRolla.comです。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="0e493-324">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="0e493-325">次へ</span><span class="sxs-lookup"><span data-stu-id="0e493-325">Next</span></span>](batch-updating-cs.md)
