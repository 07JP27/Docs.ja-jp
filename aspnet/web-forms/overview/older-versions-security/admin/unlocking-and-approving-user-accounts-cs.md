---
uid: web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
title: ロックを解除して、ユーザー アカウント (c#) の承認 |Microsoft ドキュメント
author: rick-anderson
description: このチュートリアルは、管理する管理者用 web ページを構築する方法を示しています。 ユーザーのロックアウトとステータスを承認します。 表示されています。 新しいユーザー o を承認する方法.
ms.author: aspnetcontent
manager: wpickett
ms.date: 04/01/2008
ms.topic: article
ms.assetid: 5346aab1-9974-489f-a065-ae3883b8a350
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
msc.type: authoredcontent
ms.openlocfilehash: 8b3d69e96513192bc73a2a6a7cbb4c6e33eb610b
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/06/2018
ms.locfileid: "30891400"
---
<a name="unlocking-and-approving-user-accounts-c"></a><span data-ttu-id="18ea3-104">ユーザー アカウントのロック解除および承認を行う (c#)</span><span class="sxs-lookup"><span data-stu-id="18ea3-104">Unlocking and Approving User Accounts (C#)</span></span>
====================
<span data-ttu-id="18ea3-105">によって[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="18ea3-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="18ea3-106">[コードをダウンロードする](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip)または[PDF のダウンロード](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="18ea3-106">[Download Code](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip) or [Download PDF](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span></span>

> <span data-ttu-id="18ea3-107">このチュートリアルは、管理する管理者用 web ページを構築する方法を示しています。 ユーザーのロックアウトとステータスを承認します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-107">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="18ea3-108">ユーザーの電子メール アドレスが検証されてからにのみ、新しいユーザーを承認する方法も表示されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-108">We will also see how to approve new users only after they have verified their email address.</span></span>


## <a name="introduction"></a><span data-ttu-id="18ea3-109">はじめに</span><span class="sxs-lookup"><span data-stu-id="18ea3-109">Introduction</span></span>

<span data-ttu-id="18ea3-110">と共に、ユーザー名、パスワード、および電子メールの場合は、各ユーザー アカウントが、ユーザーがサイトにログインできるかどうかを指定する 2 つの状態フィールド: ロックされており、承認します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-110">Along with a username, password, and email, each user account has two status fields that dictate whether the user can log into the site: locked out and approved.</span></span> <span data-ttu-id="18ea3-111">自動的に、資格情報が無効 (既定の設定は、ユーザーを 10 分以内に 5 つの無効なログイン試行後をロックアウト) 指定された分数内で指定された回数を指定する場合に、ユーザーのロックアウトが作成。</span><span class="sxs-lookup"><span data-stu-id="18ea3-111">A user is automatically locked out if they provide invalid credentials a specified number of times within a specified number of minutes (the default settings lock a user out after 5 invalid login attempts within 10 minutes).</span></span> <span data-ttu-id="18ea3-112">承認済みの状態は、何らかのアクションが、新しいユーザーが、サイトにログオンする前に経過する必要のシナリオで役立ちます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-112">The approved status is useful in scenarios where some action must transpire before a new user is able to log on to the site.</span></span> <span data-ttu-id="18ea3-113">たとえば、ユーザーは、まず、電子メール アドレスを確認または管理者がログインする前に承認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="18ea3-113">For example, a user might need to first verify their email address or be approved by an administrator before being able to login.</span></span>

<span data-ttu-id="18ea3-114">ロックされた out または承認されていないユーザーがログインできないのはのみ自然にこれらのステータスのリセット方法不思議に思えるかもしれません。</span><span class="sxs-lookup"><span data-stu-id="18ea3-114">Because a locked out or unapproved user cannot login, it's only natural to wonder how these statuses can be reset.</span></span> <span data-ttu-id="18ea3-115">ASP.NET が組み込みの機能をすべてを含んでいないか、ユーザーを管理するための Web コントロールがロックされており、これらの決定は、サイトごとに処理する必要があるために、一部のステータスを承認します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-115">ASP.NET does not include any built-in functionality or Web controls for managing users' locked out and approved statuses, in part because these decisions need to be handled on a site-by-site basis.</span></span> <span data-ttu-id="18ea3-116">一部のサイトでは、すべての新しいユーザー アカウント (既定の動作) を自動的に承認があります。</span><span class="sxs-lookup"><span data-stu-id="18ea3-116">Some sites might automatically approve all new user accounts (the default behavior).</span></span> <span data-ttu-id="18ea3-117">管理者がある他のユーザーを新しいアカウントを承認またはサインアップするときに指定した電子メール アドレスに送信されるリンクにアクセスするまでにユーザーを承認されません。</span><span class="sxs-lookup"><span data-stu-id="18ea3-117">Others have an administrator approve new accounts or do not approve users until they visit a link sent to the email address provided when they signed up.</span></span> <span data-ttu-id="18ea3-118">同様に、管理者がその状態をリセットするまで、ユーザーが一部のサイトがロックされることが、自分のアカウントのロックを解除するアクセスできる他のサイトでは、URL を使用してロックアウトされたユーザーに電子メールを送信中にします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-118">Likewise, some sites may lock out users until an administrator resets their status, while other sites send an email to the locked out user with a URL they can visit to unlock their account.</span></span>

<span data-ttu-id="18ea3-119">このチュートリアルは、管理する管理者用 web ページを構築する方法を示しています。 ユーザーのロックアウトとステータスを承認します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-119">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="18ea3-120">ユーザーの電子メール アドレスが検証されてからにのみ、新しいユーザーを承認する方法も表示されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-120">We will also see how to approve new users only after they have verified their email address.</span></span>

## <a name="step-1-managing-users-locked-out-and-approved-statuses"></a><span data-ttu-id="18ea3-121">手順 1: 管理ユーザーのロックアウトし、承認の状態</span><span class="sxs-lookup"><span data-stu-id="18ea3-121">Step 1: Managing Users' Locked Out and Approved Statuses</span></span>

<span data-ttu-id="18ea3-122"><a id="Tutorial12"> </a> [*多くから 1 つのユーザー アカウントを選択するインターフェイスを構築*](building-an-interface-to-select-one-user-account-from-many-cs.md)チュートリアル、ページ内の各ユーザー アカウントを一覧表示するページを構築して GridView をフィルター処理します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-122">In the <a id="Tutorial12"></a>[*Building an Interface to Select One User Account from Many*](building-an-interface-to-select-one-user-account-from-many-cs.md) tutorial we constructed a page that listed each user account in a paged, filtered GridView.</span></span> <span data-ttu-id="18ea3-123">グリッドには、各ユーザーの名前と電子メール、その承認済みロックアウト状態を現在オンラインいるかどうかおよびユーザーに関するコメントが一覧表示します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-123">The grid lists each user's name and email, their approved and locked out statuses, whether they're currently online, and any comments about the user.</span></span> <span data-ttu-id="18ea3-124">管理ユーザーの承認し、ステータスをロックアウトすることもこのグリッド編集可能です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-124">To manage users' approved and locked out statuses, we could make this grid editable.</span></span> <span data-ttu-id="18ea3-125">ユーザーの承認済みの状態を変更するには、管理者は最初にユーザー アカウントを見つけてチェックまたは承認済みのチェック ボックスをオフにする、対応する GridView の行を編集します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-125">To change a user's approved status, the administrator would first locate the user account and then edit the corresponding GridView row, checking or unchecking the approved checkbox.</span></span> <span data-ttu-id="18ea3-126">また、でした管理するには、個別の ASP.NET ページから承認済みとロックアウト状態です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-126">Alternatively, we could manage the approved and locked out statuses through a separate ASP.NET page.</span></span>

<span data-ttu-id="18ea3-127">このチュートリアルでは 2 つの ASP.NET ページを使用してみましょう。`ManageUsers.aspx`と`UserInformation.aspx`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-127">For this tutorial let's use two ASP.NET pages: `ManageUsers.aspx` and `UserInformation.aspx`.</span></span> <span data-ttu-id="18ea3-128">という考え方です`ManageUsers.aspx`システムでは、ユーザー アカウントを一覧表示中に`UserInformation.aspx`により、管理者は、承認されたロックアウトの状態を特定のユーザーを管理します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-128">The idea here is that `ManageUsers.aspx` lists the user accounts in the system, while `UserInformation.aspx` enables the administrator to manage the approved and locked out statuses for a specific user.</span></span> <span data-ttu-id="18ea3-129">GridView を拡張するために、最初の注文のビジネスは、`ManageUsers.aspx`に含める、内では、リンクの列として表示されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-129">Our first order of business is to augment the GridView in `ManageUsers.aspx` to include a HyperLinkField, which renders as a column of links.</span></span> <span data-ttu-id="18ea3-130">指す各リンクを選びました`UserInformation.aspx?user=UserName`ここで、 *UserName*を編集するユーザーの名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-130">We want each link to point to `UserInformation.aspx?user=UserName`, where *UserName* is the name of the user to edit.</span></span>

> [!NOTE]
> <span data-ttu-id="18ea3-131">コードをダウンロードしている場合、 <a id="Tutorial13"> </a> [ *Recovering とパスワードの変更*](recovering-and-changing-passwords-cs.md)お気付きするチュートリアル、`ManageUsers.aspx`ページは、一連の既に含まれています"。"リンクを管理し、`UserInformation.aspx`ページは、選択したユーザーのパスワードを変更するためのインターフェイスを提供します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-131">If you downloaded the code for the <a id="Tutorial13"></a>[*Recovering and Changing Passwords*](recovering-and-changing-passwords-cs.md) tutorial you may have noticed that the `ManageUsers.aspx` page already contains a set of "Manage" links and the `UserInformation.aspx` page provides an interface for changing the selected user's password.</span></span> <span data-ttu-id="18ea3-132">メンバーシップ API を回避する方法と、ユーザーのパスワードを変更する SQL Server データベースと直接動作で機能したため、このチュートリアルに関連付けられているコードにこの機能をレプリケートしないようにしました。</span><span class="sxs-lookup"><span data-stu-id="18ea3-132">I decided not to replicate that functionality in the code associated with this tutorial because it worked by circumventing the Membership API and operating directly with the SQL Server database to change a user's password.</span></span> <span data-ttu-id="18ea3-133">このチュートリアルを最初から開始、`UserInformation.aspx`ページ。</span><span class="sxs-lookup"><span data-stu-id="18ea3-133">This tutorial starts from scratch with the `UserInformation.aspx` page.</span></span>


### <a name="adding-manage-links-to-theuseraccountsgridview"></a><span data-ttu-id="18ea3-134">追加する"Manage"へのリンク、`UserAccounts`GridView</span><span class="sxs-lookup"><span data-stu-id="18ea3-134">Adding "Manage" Links to the`UserAccounts`GridView</span></span>

<span data-ttu-id="18ea3-135">開く、`ManageUsers.aspx`ページおよびを内の追加、 `UserAccounts` GridView です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-135">Open the `ManageUsers.aspx` page and add a HyperLinkField to the `UserAccounts` GridView.</span></span> <span data-ttu-id="18ea3-136">セット内の`Text`プロパティを"Manage"に、その`DataNavigateUrlFields`と`DataNavigateUrlFormatString`プロパティを`UserName`と"UserInformation.aspx?user={0}"、それぞれします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-136">Set the HyperLinkField's `Text` property to "Manage" and its `DataNavigateUrlFields` and `DataNavigateUrlFormatString` properties to `UserName` and "UserInformation.aspx?user={0}", respectively.</span></span> <span data-ttu-id="18ea3-137">これらの設定を構成、内など、ハイパーリンクのすべての表示テキスト"Manage"が、適切な各リンクに渡します*ユーザー名*に、クエリ文字列値です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-137">These settings configure the HyperLinkField such that all of the hyperlinks display the text "Manage", but each link passes in the appropriate *UserName* value into the querystring.</span></span>

<span data-ttu-id="18ea3-138">GridView に、内を追加した後すぐを表示、`ManageUsers.aspx`ブラウザーを使用してページ。</span><span class="sxs-lookup"><span data-stu-id="18ea3-138">After adding the HyperLinkField to the GridView, take a moment to view the `ManageUsers.aspx` page through a browser.</span></span> <span data-ttu-id="18ea3-139">図 1 に示す各 GridView の行が"Manage"リンクには含まれています。</span><span class="sxs-lookup"><span data-stu-id="18ea3-139">As Figure 1 shows, each GridView row now includes a "Manage" link.</span></span> <span data-ttu-id="18ea3-140">ブルースを"Manage"リンクを指す`UserInformation.aspx?user=Bruce`"Manage"Dave のリンクに対し、`UserInformation.aspx?user=Dave`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-140">The "Manage" link for Bruce points to `UserInformation.aspx?user=Bruce`, whereas the "Manage" link for Dave points to `UserInformation.aspx?user=Dave`.</span></span>


<span data-ttu-id="18ea3-141">[![内に追加します。](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="18ea3-141">[![The HyperLinkField Adds a](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span></span>

<span data-ttu-id="18ea3-142">**図 1**: 内の各ユーザー アカウントを"Manage"リンクを追加 ([フルサイズのイメージを表示するをクリックして](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="18ea3-142">**Figure 1**: The HyperLinkField Adds a "Manage" Link for Each User Account  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span></span>


<span data-ttu-id="18ea3-143">ユーザー インターフェイスを作成し、コードには、`UserInformation.aspx`トークみましょう時点が最初のページについてユーザーをプログラムで変更する方法のロックアウトし、ステータスを承認します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-143">We will create the user interface and code for the `UserInformation.aspx` page in a moment, but first let's talk about how to programmatically change a user's locked out and approved statuses.</span></span> <span data-ttu-id="18ea3-144">[ `MembershipUser`クラス](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx)が[ `IsLockedOut` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx)と[`IsApproved`プロパティ](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-144">The [`MembershipUser` class](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx) has [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx) and [`IsApproved` properties](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx).</span></span> <span data-ttu-id="18ea3-145">`IsLockedOut`プロパティは読み取り専用です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-145">The `IsLockedOut` property is read-only.</span></span> <span data-ttu-id="18ea3-146">プログラムからユーザーをロックアウトするメカニズムはありません。ユーザーのロックを解除するには、`MembershipUser`クラスの[`UnlockUser`メソッド](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-146">There is no mechanism to programmatically lock out a user; to unlock a user, use the `MembershipUser` class's [`UnlockUser` method](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).</span></span> <span data-ttu-id="18ea3-147">`IsApproved`プロパティは読み取り可能な値を設定します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-147">The `IsApproved` property is readable and writeable.</span></span> <span data-ttu-id="18ea3-148">このプロパティに任意の変更を保存する必要がありますを呼び出して、`Membership`クラスの[`UpdateUser`メソッド](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx)、変更を渡して、`MembershipUser`オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="18ea3-148">To save any changes to this property, we need to call the `Membership` class's [`UpdateUser` method](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx), passing in the modified `MembershipUser` object.</span></span>

<span data-ttu-id="18ea3-149">`IsApproved`プロパティが読み取り/書き込み可能で、CheckBox コントロールは、このプロパティを構成するための最適なユーザー インターフェイス要素では可能性があります。</span><span class="sxs-lookup"><span data-stu-id="18ea3-149">Because the `IsApproved` property is readable and writeable, a CheckBox control is probably the best user interface element for configuring this property.</span></span> <span data-ttu-id="18ea3-150">ただし、チェック ボックスは適していません、`IsLockedOut`プロパティのため、管理者は、ユーザーをロックアウトことはできません、彼女がのみロックを解除ユーザー。</span><span class="sxs-lookup"><span data-stu-id="18ea3-150">However, a CheckBox will not work for the `IsLockedOut` property because an administrator cannot lock out a user, she may only unlock a user.</span></span> <span data-ttu-id="18ea3-151">ための適切なユーザー インターフェイス、`IsLockedOut`プロパティはボタンをクリックすると、ユーザー アカウントのロックを解除します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-151">A suitable user interface for the `IsLockedOut` property is a Button that, when clicked, unlocks the user account.</span></span> <span data-ttu-id="18ea3-152">このボタンは、ユーザーがロックアウトされた場合にのみ有効です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-152">This Button should only be enabled if the user is locked out.</span></span>

### <a name="creating-theuserinformationaspxpage"></a><span data-ttu-id="18ea3-153">作成する、`UserInformation.aspx`ページ</span><span class="sxs-lookup"><span data-stu-id="18ea3-153">Creating the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="18ea3-154">ユーザー インターフェイスを実装する準備が整いました`UserInformation.aspx`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-154">We are now ready to implement the user interface in `UserInformation.aspx`.</span></span> <span data-ttu-id="18ea3-155">このページを開き、次の Web コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-155">Open this page and add the following Web controls:</span></span>

- <span data-ttu-id="18ea3-156">クリックすると、ハイパーリンク コントロールによって、管理者が返されます、`ManageUsers.aspx`ページ。</span><span class="sxs-lookup"><span data-stu-id="18ea3-156">A HyperLink control that, when clicked, returns the administrator to the `ManageUsers.aspx` page.</span></span>
- <span data-ttu-id="18ea3-157">選択したユーザーの名前を表示するためのラベルの Web コントロールです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-157">A Label Web control for displaying the selected user's name.</span></span> <span data-ttu-id="18ea3-158">このラベルの設定`ID`に`UserNameLabel`をクリアし、`Text`プロパティです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-158">Set this Label's `ID` to `UserNameLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="18ea3-159">という名前のチェック ボックス コントロール`IsApproved`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-159">A CheckBox control named `IsApproved`.</span></span> <span data-ttu-id="18ea3-160">設定の`AutoPostBack`プロパティを`true`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-160">Set its `AutoPostBack` property to `true`.</span></span>
- <span data-ttu-id="18ea3-161">ユーザーを表示するためのラベル コントロールでは日付最後のロックアウトします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-161">A Label control for displaying the user's last locked out date.</span></span> <span data-ttu-id="18ea3-162">このラベルの名前を付けます`LastLockedOutDateLabel`をクリアし、`Text`プロパティです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-162">Name this Label `LastLockedOutDateLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="18ea3-163">ユーザーのロックを解除するためのボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-163">A Button for unlocking the user.</span></span> <span data-ttu-id="18ea3-164">このボタンの名前を付けます`UnlockUserButton`設定とその`Text`「ユーザーのロック解除」プロパティです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-164">Name this Button `UnlockUserButton` and set its `Text` property to "Unlock User".</span></span>
- <span data-ttu-id="18ea3-165">「ユーザーの承認済みの状態が更新されました」など、ステータス メッセージを表示するためのラベル コントロール</span><span class="sxs-lookup"><span data-stu-id="18ea3-165">A Label control for displaying status messages, such as, "The user's approved status has been updated."</span></span> <span data-ttu-id="18ea3-166">このコントロールの名前を付けます`StatusMessage`をクリア、その`Text`プロパティ、およびセットその`CssClass`プロパティを`Important`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-166">Name this control `StatusMessage`, clear out its `Text` property, and set its `CssClass` property to `Important`.</span></span> <span data-ttu-id="18ea3-167">(、`Important`で CSS クラスが定義されている、`Styles.css`スタイル シート ファイルを大規模な赤いフォントで、対応するテキストを表示します)。</span><span class="sxs-lookup"><span data-stu-id="18ea3-167">(The `Important` CSS class is defined in the `Styles.css` stylesheet file; it displays the corresponding text in a large, red font.)</span></span>

<span data-ttu-id="18ea3-168">これらのコントロールを追加すると、Visual Studio でデザイン ビューは図 2 でスクリーン ショットのようになります。</span><span class="sxs-lookup"><span data-stu-id="18ea3-168">After adding these controls, the Design view in Visual Studio should look similar to the screen shot in Figure 2.</span></span>


<span data-ttu-id="18ea3-169">[![UserInformation.aspx のユーザー インターフェイスを作成します。](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="18ea3-169">[![Create the User Interface for UserInformation.aspx](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span></span>

<span data-ttu-id="18ea3-170">**図 2**: ユーザー インターフェイスを作成します`UserInformation.aspx`([フルサイズのイメージを表示するをクリックして](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="18ea3-170">**Figure 2**: Create the User Interface for `UserInformation.aspx` ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span></span>


<span data-ttu-id="18ea3-171">完全なユーザー インターフェイスと、次のタスクを設定、 `IsApproved`  チェック ボックスおよびその他のコントロールは、選択したユーザーの情報に基づいています。</span><span class="sxs-lookup"><span data-stu-id="18ea3-171">With the user interface complete, our next task is to set the `IsApproved` CheckBox and other controls based on the selected user's information.</span></span> <span data-ttu-id="18ea3-172">ページのイベント ハンドラーを作成`Load`イベントし、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-172">Create an event handler for the page's `Load` event and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample1.cs)]

<span data-ttu-id="18ea3-173">上記のコードは、これは、ページおよび以降のポストバックいないに初めてアクセスであることを確認して起動します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-173">The above code starts by ensuring that this is the first visit to the page and not a subsequent postback.</span></span> <span data-ttu-id="18ea3-174">を通じて渡されるユーザー名を読み取り、 `user` querystring フィールドを使用してそのユーザー アカウントに関する情報を取得し、`Membership.GetUser(username)`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-174">It then reads the username passed through the `user` querystring field and retrieves information about that user account via the `Membership.GetUser(username)` method.</span></span> <span data-ttu-id="18ea3-175">クエリ文字列を通じてユーザー名が指定されていないか、管理者に送信される場合は、指定したユーザーが見つかりませんでした、`ManageUsers.aspx`ページ。</span><span class="sxs-lookup"><span data-stu-id="18ea3-175">If no username was supplied through the querystring, or if the specified user could not be found, the administrator is sent back to the `ManageUsers.aspx` page.</span></span>

<span data-ttu-id="18ea3-176">`MembershipUser`オブジェクトの`UserName`に値が表示されます、`UserNameLabel`と`IsApproved`チェック ボックスがに基づいて、`IsApproved`プロパティの値。</span><span class="sxs-lookup"><span data-stu-id="18ea3-176">The `MembershipUser` object's `UserName` value is then displayed in the `UserNameLabel` and the `IsApproved` CheckBox is checked based on the `IsApproved` property value.</span></span>

<span data-ttu-id="18ea3-177">`MembershipUser`オブジェクトの[`LastLockoutDate`プロパティ](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx)を返します、`DateTime`ロックされている場合、ユーザーが最後を示す値。ユーザーがロックアウトされていることはない場合、に、返される値は、メンバーシップ プロバイダーによって異なります。</span><span class="sxs-lookup"><span data-stu-id="18ea3-177">The `MembershipUser` object's [`LastLockoutDate` property](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx) returns a `DateTime` value indicating when the user was last locked out. If the user has never been locked out, the value returned depends on the Membership provider.</span></span> <span data-ttu-id="18ea3-178">新しいアカウントの作成時に、`SqlMembershipProvider`設定、`aspnet_Membership`テーブルの`LastLockoutDate`フィールドを`1754-01-01 12:00:00 AM`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-178">When a new account is created, the `SqlMembershipProvider` sets the `aspnet_Membership` table's `LastLockoutDate` field to `1754-01-01 12:00:00 AM`.</span></span> <span data-ttu-id="18ea3-179">上記のコードで空の文字列が表示されます、`LastLockoutDateLabel`場合、`LastLockoutDate`プロパティが 1 年前に発生 2000、それ以外の日付部分、`LastLockoutDate`ラベルでプロパティを表示します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-179">The above code displays an empty string in the `LastLockoutDateLabel` if the `LastLockoutDate` property occurs before year 2000; otherwise, the date portion of the `LastLockoutDate` property is displayed in the Label.</span></span> <span data-ttu-id="18ea3-180">`UnlockUserButton'` S`Enabled`プロパティに設定、ユーザーの状態、つまりことは、このボタンのみ有効となる、ユーザーがロックアウトされた場合はロックアウトされます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-180">The `UnlockUserButton'` s `Enabled` property is set to the user's locked out status, meaning that this Button will only be enabled if the user is locked out.</span></span>

<span data-ttu-id="18ea3-181">テストをとって、`UserInformation.aspx`ブラウザーを使用してページ。</span><span class="sxs-lookup"><span data-stu-id="18ea3-181">Take a moment to test the `UserInformation.aspx` page through a browser.</span></span> <span data-ttu-id="18ea3-182">もちろんで開始する必要がありますが、`ManageUsers.aspx`を管理するユーザー アカウントを選択します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-182">You will, of course, need to start at `ManageUsers.aspx` and select a user account to manage.</span></span> <span data-ttu-id="18ea3-183">到着時に`UserInformation.aspx`、なお、`IsApproved`のみチェック ボックスをユーザーが承認された場合。</span><span class="sxs-lookup"><span data-stu-id="18ea3-183">Upon arriving at `UserInformation.aspx`, note that the `IsApproved` CheckBox is only checked if the user is approved.</span></span> <span data-ttu-id="18ea3-184">ユーザーがロックアウトされていること場合、最後の日付がロックアウトが表示されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-184">If the user has ever been locked out, their last locked out date is displayed.</span></span> <span data-ttu-id="18ea3-185">ユーザーのロックを解除 ボタンは、ユーザーは現在ロックアウトされている場合にのみ有効です。オンまたはオフにして、`IsApproved`チェック ボックスまたは ユーザーのロックを解除 ボタンをクリックとポストバックしますが、変更は行われません、ユーザー アカウントにきたところためこれらのイベントのイベント ハンドラーを作成します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-185">The Unlock User button is enabled only if the user is currently locked out. Checking or unchecking the `IsApproved` CheckBox or clicking the Unlock User button causes a postback, but no modifications are made to the user account because we've yet to create event handlers for these events.</span></span>

<span data-ttu-id="18ea3-186">Visual Studio に戻るし、イベント ハンドラーを作成、`IsApproved`チェック ボックスの`CheckedChanged`イベントおよび`UnlockUser`ボタンの`Click`イベント。</span><span class="sxs-lookup"><span data-stu-id="18ea3-186">Return to Visual Studio and create event handlers for the `IsApproved` CheckBox's `CheckedChanged` event and the `UnlockUser` Button's `Click` event.</span></span> <span data-ttu-id="18ea3-187">`CheckedChanged` 、イベント ハンドラーを設定、ユーザーの`IsApproved`プロパティを`Checked`プロパティのチェック ボックスの呼び出しに変更を保存し`Membership.UpdateUser`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-187">In the `CheckedChanged` event handler, set the user's `IsApproved` property to the `Checked` property of the CheckBox and then save the changes via a call to `Membership.UpdateUser`.</span></span> <span data-ttu-id="18ea3-188">`Click`イベント ハンドラー、単に呼び出し、`MembershipUser`オブジェクトの`UnlockUser`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-188">In the `Click` event handler, simply call the `MembershipUser` object's `UnlockUser` method.</span></span> <span data-ttu-id="18ea3-189">両方のイベント ハンドラー内で適切なメッセージを表示する、`StatusMessage`ラベル。</span><span class="sxs-lookup"><span data-stu-id="18ea3-189">In both event handlers, display a suitable message in the `StatusMessage` Label.</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample2.cs)]

### <a name="testing-theuserinformationaspxpage"></a><span data-ttu-id="18ea3-190">テスト、`UserInformation.aspx`ページ</span><span class="sxs-lookup"><span data-stu-id="18ea3-190">Testing the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="18ea3-191">場所でこれらのイベント ハンドラーで、ページを再検討し、承認されていないユーザーです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-191">With these event handlers in place, revisit the page and unapproved a user.</span></span> <span data-ttu-id="18ea3-192">図 3 では、メッセージのことを示すページで、ユーザーの概要が表示されます`IsApproved`プロパティが正常に変更します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-192">As Figure 3 shows, you should see a brief message on the page indicating that the user's `IsApproved` property was successfully modified.</span></span>


<span data-ttu-id="18ea3-193">[![クリスは未承認されました](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="18ea3-193">[![Chris has been Unapproved](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span></span>

<span data-ttu-id="18ea3-194">**図 3**: クリスが未承認されました ([フルサイズのイメージを表示するをクリックして](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="18ea3-194">**Figure 3**: Chris has been Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span></span>


<span data-ttu-id="18ea3-195">次に、ログアウトしようとしてアカウントを持つユーザーとしてログイン許可されませんでしただけです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-195">Next, logout and try to login as the user whose account was just unapproved.</span></span> <span data-ttu-id="18ea3-196">ユーザーが承認されていないため、ログインできません。</span><span class="sxs-lookup"><span data-stu-id="18ea3-196">Because the user is not approved, they cannot login.</span></span> <span data-ttu-id="18ea3-197">既定では、ログイン コントロールでは、理由に関係なく、ユーザーがログインできない場合に、同じメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-197">By default, the Login control displays the same message if the user cannot login, regardless of the reason.</span></span> <span data-ttu-id="18ea3-198">しかし、 <a id="Tutorial6"> </a> [*を検証するユーザーの資格情報に対してメンバーシップ ユーザー ストアでは、* ](../membership/validating-user-credentials-against-the-membership-user-store-cs.md)チュートリアルより適切なメッセージを表示するログイン コントロールの強化について説明しました。</span><span class="sxs-lookup"><span data-stu-id="18ea3-198">But in the <a id="Tutorial6"></a>[*Validating User Credentials Against the Membership User Store*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md) tutorial we looked at enhancing the Login control to display a more appropriate message.</span></span> <span data-ttu-id="18ea3-199">図 4 に示す、Chris に自分のアカウントがまだ承認されていないため彼はログインできませんを説明するメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-199">As Figure 4 shows, Chris is shown a message explaining that he cannot login because his account is not yet approved.</span></span>


<span data-ttu-id="18ea3-200">[![Chris できませんログインのため His アカウントがある承認されていません。](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="18ea3-200">[![Chris Cannot Login Because His Account is Unapproved](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span></span>

<span data-ttu-id="18ea3-201">**図 4**: Chris できませんログインのため His アカウントがある承認されていない ([フルサイズのイメージを表示するをクリックして](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="18ea3-201">**Figure 4**: Chris Cannot Login Because His Account is Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span></span>


<span data-ttu-id="18ea3-202">ロックアウトの機能をテストするには、承認されたユーザーとしてログインしますが、正しくないパスワードを使用して試みます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-202">To test the locked out functionality, attempt to login as an approved user, but use an incorrect password.</span></span> <span data-ttu-id="18ea3-203">このプロセスに必要な回数、ユーザーのアカウントがロックアウトされてまでを繰り返します。ログイン コントロールは、カスタムの表示も更新されたメッセージの場合はロックアウトされたアカウントからログインを試行します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-203">Repeat this process the necessary number of times until the user's account has been locked out. The Login control was also updated to show a custom message if attempting to login from a locked out account.</span></span> <span data-ttu-id="18ea3-204">ログイン ページで、次のメッセージの表示を開始すると、アカウントがロックアウトされていることがわかって:"自分のアカウントがロックアウトされて無効なログイン失敗の回数が多すぎます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-204">You know that an account has been locked out once you start seeing the following message at the login page: "Your account has been locked out because of too many invalid login attempts.</span></span> <span data-ttu-id="18ea3-205">管理者に問い合わせてくださいには、アカウントのロックを解除します。"</span><span class="sxs-lookup"><span data-stu-id="18ea3-205">Please contact the administrator to have your account unlocked."</span></span>

<span data-ttu-id="18ea3-206">戻り、`ManageUsers.aspx`ページし、ロックアウトされたユーザーの管理 リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-206">Return to the `ManageUsers.aspx` page and click the Manage link for the locked out user.</span></span> <span data-ttu-id="18ea3-207">図 5 に示すように値を表示する必要があります、`LastLockedOutDateLabel`ユーザーのロックを解除 ボタンを有効にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="18ea3-207">As Figure 5 shows, you should see a value in the `LastLockedOutDateLabel` the Unlock User button should be enabled.</span></span> <span data-ttu-id="18ea3-208">ユーザー アカウントのロックを解除するユーザーのロックを解除 ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-208">Click the Unlock User button to unlock the user account.</span></span> <span data-ttu-id="18ea3-209">ユーザーのロックを解除すると再度ログインできるようされます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-209">Once you have unlocked the user, they will be able to login again.</span></span>


<span data-ttu-id="18ea3-210">[![Dave がシステムからロックアウトされています。](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="18ea3-210">[![Dave Has Been Locked Out of the System](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span></span>

<span data-ttu-id="18ea3-211">**図 5**: Dave がされたロックをシステムの ([フルサイズのイメージを表示するをクリックして](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="18ea3-211">**Figure 5**: Dave Has Been Locked Out of the System  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span></span>


## <a name="step-2-specifying-new-users-approved-status"></a><span data-ttu-id="18ea3-212">手順 2: 新しいユーザーを指定する状態を承認</span><span class="sxs-lookup"><span data-stu-id="18ea3-212">Step 2: Specifying New Users' Approved Status</span></span>

<span data-ttu-id="18ea3-213">承認済みの状態は、いくつか実行するアクションを新しいユーザーがログインして、サイトのユーザーに固有の機能にアクセスできるようにする前にしようとする場合に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-213">The approved status is useful in scenarios where you want some action to be performed before a new user is able to login and access the user-specific features of the site.</span></span> <span data-ttu-id="18ea3-214">など、ログインやサインアップ ページを除く、すべてのページが認証されたユーザーのみからアクセスできるプライベート web サイト実行する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="18ea3-214">For example, you may be running a private website where all pages, except for the login and signup pages, are accessible only to authenticated users.</span></span> <span data-ttu-id="18ea3-215">サインアップ ページを検索し、アカウントが作成される知らない人が、web サイトに達するとどうなりますか。</span><span class="sxs-lookup"><span data-stu-id="18ea3-215">But what happens if a stranger reaches your website, finds the signup page, and creates an account?</span></span> <span data-ttu-id="18ea3-216">これを防ぐには、サインアップ ページを移動する可能性があります、`Administration`フォルダーで、管理者は、各アカウントを手動で作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="18ea3-216">To prevent this from happening you could move the signup page to an `Administration` folder, and require that an administrator manually create each account.</span></span> <span data-ttu-id="18ea3-217">代わりに、だれでもサインアップを許可することが管理者ユーザー アカウントに承認されるまで、サイトへのアクセスを禁止できます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-217">Alternatively, you could allow anyone to signup, but prohibit site access until an administrator approves the user account.</span></span>

<span data-ttu-id="18ea3-218">既定では、CreateUserWizard コントロールは、新しいアカウントを承認します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-218">By default, the CreateUserWizard control approves new accounts.</span></span> <span data-ttu-id="18ea3-219">使用して、コントロールの動作を構成する[`DisableCreatedUser`プロパティ](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-219">You can configure this behavior using the control's [`DisableCreatedUser` property](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx).</span></span> <span data-ttu-id="18ea3-220">このプロパティを設定`true`に新しいユーザー アカウントを承認されません。</span><span class="sxs-lookup"><span data-stu-id="18ea3-220">Set this property to `true` to not approve new user accounts.</span></span>

> [!NOTE]
> <span data-ttu-id="18ea3-221">既定では CreateUserWizard コントロールは、自動的に新しいユーザー アカウントをログオンします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-221">By default the CreateUserWizard control automatically logs on the new user account.</span></span> <span data-ttu-id="18ea3-222">この動作は、コントロールのによって決まります[`LoginCreatedUser`プロパティ](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-222">This behavior is dictated by the control's [`LoginCreatedUser` property](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx).</span></span> <span data-ttu-id="18ea3-223">未承認のユーザーが、サイトにログインできないためと`DisableCreatedUser`は`true`の値に関係なく、サイトに新しいユーザー アカウントがログインしていない、`LoginCreatedUser`プロパティです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-223">Because unapproved users cannot login to the site, when `DisableCreatedUser` is `true` the new user account is not logged into the site, regardless of the value of the `LoginCreatedUser` property.</span></span>


<span data-ttu-id="18ea3-224">プログラムで使用して、新しいユーザー アカウントを作成する場合、`Membership.CreateUser`未承認のユーザー アカウントを作成する、メソッドを使用して、新しいユーザーを許容するオーバー ロードのいずれかの`IsApproved`入力パラメーターとしてプロパティ値。</span><span class="sxs-lookup"><span data-stu-id="18ea3-224">If you are programmatically creating new user accounts via the `Membership.CreateUser` method, to create an unapproved user account use one of the overloads that accept the new user's `IsApproved` property value as an input parameter.</span></span>

## <a name="step-3-approving-users-by-verifying-their-email-address"></a><span data-ttu-id="18ea3-225">手順 3: ユーザーの電子メール アドレスを確認することでユーザーを承認します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-225">Step 3: Approving Users By Verifying their Email Address</span></span>

<span data-ttu-id="18ea3-226">登録するときに指定できるよう、電子メール アドレスを確認するまで、ユーザー アカウントをサポートする多くの web サイトは新しいユーザーを許可しないでください。</span><span class="sxs-lookup"><span data-stu-id="18ea3-226">Many websites that support user accounts do not approve new users until they verify the email address they supplied when registering.</span></span> <span data-ttu-id="18ea3-227">この検証プロセスは、通常、検証済みの一意の電子メール アドレスを必要とし、サインアップ プロセスで余分な手順を追加、bot、迷惑メール、およびその他の ne'er-do-wells を阻止するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-227">This verification process is commonly used to thwart bots, spammers, and other ne'er-do-wells as it requires a unique, verified email address and adds an extra step in the signup process.</span></span> <span data-ttu-id="18ea3-228">このモデルでは、新しいユーザーがサインアップする時に送信される電子メール メッセージの検証 ページへのリンクが含まれていますが、します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-228">With this model, when a new user signs up they are sent an email message that includes a link to a verification page.</span></span> <span data-ttu-id="18ea3-229">リンクにアクセスして、ユーザーは電子メールを受信して、そのため、メール アドレス指定する有効ではことを実証されました。</span><span class="sxs-lookup"><span data-stu-id="18ea3-229">By visiting the link the user has proven that they received the email and, therefore, that the email address provided is valid.</span></span> <span data-ttu-id="18ea3-230">検証ページは、ユーザーを承認します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-230">The verification page is responsible for approving the user.</span></span> <span data-ttu-id="18ea3-231">これが発生する自動的に、これにより、このページに到達するすべてのユーザーを承認またはユーザーなどの追加情報がいくつかの提供後にのみ、 [CAPTCHA](http://en.wikipedia.org/wiki/Captcha)です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-231">This may happen automatically, thereby approving any user who reaches this page, or only after the user provides some additional information, such as a [CAPTCHA](http://en.wikipedia.org/wiki/Captcha).</span></span>

<span data-ttu-id="18ea3-232">このワークフローに合わせてには、新しいユーザーが承認されていないように、まず、アカウントの作成 ページを更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="18ea3-232">To accommodate this workflow, we need to first update the account creation page so that new users are unapproved.</span></span> <span data-ttu-id="18ea3-233">開く、 `EnhancedCreateUserWizard.aspx`  ページで、`Membership`フォルダーと CreateUserWizard コントロールをセット`DisableCreatedUser`プロパティを`true`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-233">Open the `EnhancedCreateUserWizard.aspx` page in the `Membership` folder and set the CreateUserWizard control's `DisableCreatedUser` property to `true`.</span></span>

<span data-ttu-id="18ea3-234">次に、そのアカウントを検証する方法について記載された新しいユーザーに電子メールを送信する CreateUserWizard コントロールを構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="18ea3-234">Next, we need to configure the CreateUserWizard control to send an email to the new user with instructions on how to verify their account.</span></span> <span data-ttu-id="18ea3-235">電子メールのリンクを含めるお具体的には、`Verification.aspx`ページ (きたところを作成)、新しいユーザーに渡して、`UserId`クエリ文字列を通じてします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-235">In particular, we will include a link in the email to the `Verification.aspx` page (which we've yet to create), passing in the new user's `UserId` through the querystring.</span></span> <span data-ttu-id="18ea3-236">`Verification.aspx`  ページを指定したユーザーを検索し、承認にマークします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-236">The `Verification.aspx` page will lookup the specified user and mark them approved.</span></span>

### <a name="sending-a-verification-email-to-new-users"></a><span data-ttu-id="18ea3-237">新しいユーザーに確認の電子メールを送信します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-237">Sending a Verification Email to New Users</span></span>

<span data-ttu-id="18ea3-238">CreateUserWizard コントロールから電子メールを送信する次のように構成します。 その`MailDefinition`プロパティ適切にします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-238">To send an email from the CreateUserWizard control, configure its `MailDefinition` property appropriately.</span></span> <span data-ttu-id="18ea3-239">説明したように、 <a id="Tutorial13"> </a>[前のチュートリアル](recovering-and-changing-passwords-cs.md)、ChangePassword と PasswordRecovery コントロールに含まれる、 [ `MailDefinition`プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx)と同じ方法で動作します。CreateUserWizard コントロールのです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-239">As discussed in the <a id="Tutorial13"></a>[previous tutorial](recovering-and-changing-passwords-cs.md), the ChangePassword and PasswordRecovery controls include a [`MailDefinition` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx) that works in the same manner as the CreateUserWizard control's.</span></span>

> [!NOTE]
> <span data-ttu-id="18ea3-240">使用する、`MailDefinition`でメールの配信を指定する必要があります。 プロパティのオプション`Web.config`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-240">To use the `MailDefinition` property you need to specify mail delivery options in `Web.config`.</span></span> <span data-ttu-id="18ea3-241">詳細についてを参照してください[ASP.NET で電子メールを送信する](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-241">For more information, refer to [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx).</span></span>


<span data-ttu-id="18ea3-242">まず、という名前の新しい電子メール テンプレートを作成して`CreateUserWizard.txt`で、`EmailTemplates`フォルダーです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-242">Start by creating a new email template named `CreateUserWizard.txt` in the `EmailTemplates` folder.</span></span> <span data-ttu-id="18ea3-243">テンプレートの次のテキストを使用します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-243">Use the following text for the template:</span></span>

[!code-aspx[Main](unlocking-and-approving-user-accounts-cs/samples/sample3.aspx)]

<span data-ttu-id="18ea3-244">設定、 `MailDefinition'` s`BodyFileName`プロパティを"~/EmailTemplates/CreateUserWizard.txt"およびその`Subject`プロパティを"My web サイトへようこそ!</span><span class="sxs-lookup"><span data-stu-id="18ea3-244">Set the `MailDefinition'` s `BodyFileName` property to "~/EmailTemplates/CreateUserWizard.txt" and its `Subject` property to "Welcome to My Website!</span></span> <span data-ttu-id="18ea3-245">アクティブ化してください、アカウントです。"</span><span class="sxs-lookup"><span data-stu-id="18ea3-245">Please activate your account."</span></span>

<span data-ttu-id="18ea3-246">なお、`CreateUserWizard.txt`電子メール テンプレートが含まれています、`<%VerificationUrl%>`プレース ホルダーです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-246">Note that the `CreateUserWizard.txt` email template includes a `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="18ea3-247">これは、ような場合の URL、`Verification.aspx`ページに配置されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-247">This is where the URL for the `Verification.aspx` page will be placed.</span></span> <span data-ttu-id="18ea3-248">CreateUserWizard が自動的に置き換えられます、`<%UserName%>`と`<%Password%>`プレース ホルダーを新しいアカウントのユーザー名とパスワードで組み込みはありませんが、`<%VerificationUrl%>`プレース ホルダーです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-248">The CreateUserWizard automatically replaces the `<%UserName%>` and `<%Password%>` placeholders with the new account's username and password, but there is no built-in `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="18ea3-249">手動で置き換えて、適切な検証 URL が必要です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-249">We need to manually replace it with the appropriate verification URL.</span></span>

<span data-ttu-id="18ea3-250">これを実現するには、CreateUserWizard のイベント ハンドラーを作成[`SendingMail`イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx)し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-250">To accomplish this, create an event handler for the CreateUserWizard's [`SendingMail` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx) and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample4.cs)]

<span data-ttu-id="18ea3-251">`SendingMail`イベントが発生した後、`CreatedUser`イベント、上記のイベント ハンドラーが、新しいユーザーを実行するとき、アカウントが既に作成されたことを意味します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-251">The `SendingMail` event fires after the `CreatedUser` event, meaning that by the time the above event handler executes the new user account has already been created.</span></span> <span data-ttu-id="18ea3-252">新しいユーザーのアクセスできる`UserId`を呼び出して値、`Membership.GetUser`に渡して、メソッド、 `UserName` CreateUserWizard コントロールに入力します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-252">We can access the new user's `UserId` value by calling the `Membership.GetUser` method, passing in the `UserName` entered into the CreateUserWizard control.</span></span> <span data-ttu-id="18ea3-253">次に、検証 URL が形成されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-253">Next, the verification URL is formed.</span></span> <span data-ttu-id="18ea3-254">ステートメント`Request.Url.GetLeftPart(UriPartial.Authority)`を返します、 `http://yourserver.com` ; URL の部分`Request.ApplicationPath`を返します。 パスが、アプリケーションのルートが指定されています。</span><span class="sxs-lookup"><span data-stu-id="18ea3-254">The statement `Request.Url.GetLeftPart(UriPartial.Authority)` returns the `http://yourserver.com` portion of the URL; `Request.ApplicationPath` returns path where the application is rooted.</span></span> <span data-ttu-id="18ea3-255">URL として定義し、検証`Verification.aspx?ID=userId`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-255">The verification URL is then defined as `Verification.aspx?ID=userId`.</span></span> <span data-ttu-id="18ea3-256">これら 2 つの文字列は、完全な URL を形成し、連結されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-256">These two strings are then concatenated to form the complete URL.</span></span> <span data-ttu-id="18ea3-257">最後に、電子メール メッセージの本文 (`e.Message.Body`) が出現するすべての`<%VerificationUrl%>`完全な URL に置き換えられます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-257">Finally, the email message body (`e.Message.Body`) has all occurrences of `<%VerificationUrl%>` replaced with the full URL.</span></span>

<span data-ttu-id="18ea3-258">実際の影響は、新しいユーザーがないことを承認されているサイトにログインできないことを意味です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-258">The net effect is that new users are unapproved, meaning that they cannot log into the site.</span></span> <span data-ttu-id="18ea3-259">さらに、自動的に送信されるリンクを含む電子メール検証 URL (図 6 を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="18ea3-259">Furthermore, they are automatically sent an email with a link to the verification URL (see Figure 6).</span></span>


<span data-ttu-id="18ea3-260">[![新しいユーザーが検証 URL へのリンクを電子メールを受け取る](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="18ea3-260">[![The New User Receives an Email with a Link to the Verification URL](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span></span>

<span data-ttu-id="18ea3-261">**図 6**: 新しいユーザーが検証 URL へのリンクを電子メールを受け取ります ([フルサイズのイメージを表示するをクリックして](unlocking-and-approving-user-accounts-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="18ea3-261">**Figure 6**: The New User Receives an Email with a Link to the Verification URL  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image18.png))</span></span>


> [!NOTE]
> <span data-ttu-id="18ea3-262">CreateUserWizard コントロールの既定の CreateUserWizard ステップには、自分のアカウントが作成され、[続行] ボタンの表示をユーザーに知らせるメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-262">The CreateUserWizard control's default CreateUserWizard step displays a message informing the user their account has been created and displays a Continue button.</span></span> <span data-ttu-id="18ea3-263">これをクリックすると、ユーザーをコントロールの指定された URL が`ContinueDestinationPageUrl`プロパティです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-263">Clicking this takes the user to the URL specified by the control's `ContinueDestinationPageUrl` property.</span></span> <span data-ttu-id="18ea3-264">CreateUserWizard`EnhancedCreateUserWizard.aspx`新しいユーザーに送信するように構成、 `~/Membership/AdditionalUserInfo.aspx`hometown、ホームページの URL と署名のユーザーを要求します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-264">The CreateUserWizard in `EnhancedCreateUserWizard.aspx` is configured to send new users to the `~/Membership/AdditionalUserInfo.aspx`, which prompts the user for their hometown, homepage URL, and signature.</span></span> <span data-ttu-id="18ea3-265">この情報のみ要素を追加できログオン ユーザー、意味をユーザーに返信するサイトのホーム ページには、このプロパティを更新する (`~/Default.aspx`)。</span><span class="sxs-lookup"><span data-stu-id="18ea3-265">Because this information can only be added by logged on users, it makes sense to update this property to send users back to the site's homepage (`~/Default.aspx`).</span></span> <span data-ttu-id="18ea3-266">さらに、`EnhancedCreateUserWizard.aspx`検証電子メールが送信されましたが、このメールの手順を実行するまでは、自分のアカウントをアクティブ化されませんユーザーに通知するページまたは CreateUserWizard ステップを補完する必要があります。</span><span class="sxs-lookup"><span data-stu-id="18ea3-266">Moreover, the `EnhancedCreateUserWizard.aspx` page or the CreateUserWizard step should be augmented to inform the user that they have been sent a verification email and their account won't be activated until they follow the instructions in this email.</span></span> <span data-ttu-id="18ea3-267">これらの変更は、リーダーの課題として退出です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-267">I leave these modifications as an exercise for the reader.</span></span>


### <a name="creating-the-verification-page"></a><span data-ttu-id="18ea3-268">確認ページを作成します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-268">Creating the Verification Page</span></span>

<span data-ttu-id="18ea3-269">最後のタスクが作成するには、`Verification.aspx`ページ。</span><span class="sxs-lookup"><span data-stu-id="18ea3-269">Our final task is to create the `Verification.aspx` page.</span></span> <span data-ttu-id="18ea3-270">このページを関連付けることで、ルート フォルダーに追加、`Site.master`マスター ページ。</span><span class="sxs-lookup"><span data-stu-id="18ea3-270">Add this page to the root folder, associating it with the `Site.master` master page.</span></span> <span data-ttu-id="18ea3-271">ほとんどのサイトに追加する前のコンテンツ ページで実行した、としてを参照するコンテンツ コントロールを削除、 `LoginContent` ContentPlaceHolder コンテンツ ページで、マスター ページを使用するよう既定のコンテンツ。</span><span class="sxs-lookup"><span data-stu-id="18ea3-271">As we've done with most of the previous content pages added to the site, remove the Content control that references the `LoginContent` ContentPlaceHolder so that the content page uses the master page's default content.</span></span>

<span data-ttu-id="18ea3-272">ラベル Web コントロールを追加、`Verification.aspx`設定 ページで、その`ID`に`StatusMessage`し、text プロパティをオフにします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-272">Add a Label Web control to the `Verification.aspx` page, set its `ID` to `StatusMessage` and clear out its text property.</span></span> <span data-ttu-id="18ea3-273">次に、作成、`Page_Load`イベント ハンドラーを次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-273">Next, create the `Page_Load` event handler and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample5.cs)]

<span data-ttu-id="18ea3-274">上記のコードの大部分であることを確認、 `UserId` 、クエリ文字列が存在し、有効であることを指定された`Guid`値、および既存のユーザー アカウントを参照しています。</span><span class="sxs-lookup"><span data-stu-id="18ea3-274">The bulk of the above code verifies that the `UserId` supplied through the querystring exists, that it is a valid `Guid` value, and that it references an existing user account.</span></span> <span data-ttu-id="18ea3-275">これらのチェックすべてを渡すと、ユーザー アカウントが承認されます。それ以外の場合、適切なステータス メッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-275">If all of these checks pass, the user account is approved; otherwise, a suitable status message is displayed.</span></span>

<span data-ttu-id="18ea3-276">図 7 は、`Verification.aspx`ページをブラウザーからアクセスする場合。</span><span class="sxs-lookup"><span data-stu-id="18ea3-276">Figure 7 shows the `Verification.aspx` page when visited through a browser.</span></span>


<span data-ttu-id="18ea3-277">[![新しいユーザーのアカウントが承認されるようになりました](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="18ea3-277">[![The New User's Account is Now Approved](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span></span>

<span data-ttu-id="18ea3-278">**図 7**: の新しいユーザーのアカウントが承認されるようになりました ([フルサイズのイメージを表示するをクリックして](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="18ea3-278">**Figure 7**: The New User's Account is Now Approved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span></span>


## <a name="summary"></a><span data-ttu-id="18ea3-279">まとめ</span><span class="sxs-lookup"><span data-stu-id="18ea3-279">Summary</span></span>

<span data-ttu-id="18ea3-280">すべてのメンバーシップ ユーザーのアカウントがあるユーザーが、サイトにログインできるかどうかを決定する 2 つの状態:`IsLockedOut`と`IsApproved`です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-280">All Membership user accounts have two statuses that determine whether the user can log into the site: `IsLockedOut` and `IsApproved`.</span></span> <span data-ttu-id="18ea3-281">これらのプロパティの両方があります`true`ユーザーがログインするためです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-281">Both of these properties must be `true` for the user to login.</span></span>

<span data-ttu-id="18ea3-282">ユーザーのロックアウト状態はブルート フォースのメソッドを使用するサイトに互換性に影響するハッカーの可能性を減らすため、セキュリティ対策として使用します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-282">The user's locked out status is used as a security measure to reduce the likelihood of a hacker breaking into a site through brute force methods.</span></span> <span data-ttu-id="18ea3-283">具体的には、ユーザーはロックアウト時間の特定のウィンドウ内で無効なログイン試行数がある場合。</span><span class="sxs-lookup"><span data-stu-id="18ea3-283">Specifically, a user is locked out if there are a certain number of invalid login attempts within a certain window of time.</span></span> <span data-ttu-id="18ea3-284">これらの境界は、メンバーシップ プロバイダーの設定によって構成可能な`Web.config`します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-284">These bounds are configurable through the Membership provider settings in `Web.config`.</span></span>

<span data-ttu-id="18ea3-285">承認済みの状態はで何らかのアクションが指定されるまでのログ記録を新しいユーザーを禁止するための手段としてよく使用されます。</span><span class="sxs-lookup"><span data-stu-id="18ea3-285">The approved status is commonly used as a means to prohibit new users from logging in until some action has transpired.</span></span> <span data-ttu-id="18ea3-286">おそらく、サイトでは最初に新しいアカウントを管理者によって承認することが必要ですか、ユーザーの電子メール アドレスを確認し、手順 3. で示したようにします。</span><span class="sxs-lookup"><span data-stu-id="18ea3-286">Perhaps the site requires that new accounts first be approved by the administrator or, as we saw in Step 3, by verifying their email address.</span></span>

<span data-ttu-id="18ea3-287">満足プログラミング!</span><span class="sxs-lookup"><span data-stu-id="18ea3-287">Happy Programming!</span></span>

### <a name="about-the-author"></a><span data-ttu-id="18ea3-288">作成者について</span><span class="sxs-lookup"><span data-stu-id="18ea3-288">About the Author</span></span>

<span data-ttu-id="18ea3-289">Scott Mitchell、複数の受け取りますブックの作成者と 4GuysFromRolla.com の創設者は、Microsoft の Web テクノロジと 1998 年取り組んできました。</span><span class="sxs-lookup"><span data-stu-id="18ea3-289">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="18ea3-290">Scott は、コンサルタント、トレーナー、ライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="18ea3-290">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="18ea3-291">最新の著書 *[Sam 学べる自分で ASP.NET 2.0 が 24 時間以内に](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-291">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="18ea3-292">Scott に到達できる[ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com)または彼のブログでを介して[ http://ScottOnWriting.NET](http://scottonwriting.net/)です。</span><span class="sxs-lookup"><span data-stu-id="18ea3-292">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="18ea3-293">特別に感謝しています.</span><span class="sxs-lookup"><span data-stu-id="18ea3-293">Special Thanks To…</span></span>

<span data-ttu-id="18ea3-294">このチュートリアルの系列は既に多くの便利なレビュー担当者によって確認済みです。</span><span class="sxs-lookup"><span data-stu-id="18ea3-294">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="18ea3-295">今後、MSDN の記事を確認することに関心のあるですか。</span><span class="sxs-lookup"><span data-stu-id="18ea3-295">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="18ea3-296">場合は、ドロップ me 一度に 1 行ずつ [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="18ea3-296">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="18ea3-297">[前へ](recovering-and-changing-passwords-cs.md)
> [次へ](building-an-interface-to-select-one-user-account-from-many-vb.md)</span><span class="sxs-lookup"><span data-stu-id="18ea3-297">[Previous](recovering-and-changing-passwords-cs.md)
[Next](building-an-interface-to-select-one-user-account-from-many-vb.md)</span></span>
