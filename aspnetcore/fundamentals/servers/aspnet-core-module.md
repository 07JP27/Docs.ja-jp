---
title: "ASP.NET Core モジュール"
author: tdykstra
description: "Kestrel Web サーバーが IIS または IIS Express をリバース プロキシ サーバーとして使用できるようにするための IIS モジュールである ASP.NET Core モジュール (ANCM) について紹介します。"
manager: wpickett
ms.author: tdykstra
ms.custom: H1Hack27Feb2017
ms.date: 08/03/2017
ms.prod: asp.net-core
ms.technology: aspnet
ms.topic: article
uid: fundamentals/servers/aspnet-core-module
ms.openlocfilehash: 4337bc42c5454d6a9634a396d9c89f3518af148b
ms.sourcegitcommit: a510f38930abc84c4b302029d019a34dfe76823b
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/30/2018
---
# <a name="introduction-to-aspnet-core-module"></a><span data-ttu-id="d1ac7-103">ASP.NET Core モジュールの概要</span><span class="sxs-lookup"><span data-stu-id="d1ac7-103">Introduction to ASP.NET Core Module</span></span>

<span data-ttu-id="d1ac7-104">作成者: [Tom Dykstra](https://github.com/tdykstra)、[Rick Strahl](https://github.com/RickStrahl)、[Chris Ross](https://github.com/Tratcher)</span><span class="sxs-lookup"><span data-stu-id="d1ac7-104">By [Tom Dykstra](https://github.com/tdykstra), [Rick Strahl](https://github.com/RickStrahl), and [Chris Ross](https://github.com/Tratcher)</span></span> 

<span data-ttu-id="d1ac7-105">ASP.NET Core モジュール (ANCM) では、IIS の背後で ASP.NET Core アプリケーションを実行することができます。この場合は、セキュリティ、管理容易性、その他さまざまな点で優れている IIS、および高速化に適している [Kestrel](kestrel.md) が使用され、両方の技術の利点が一度に活用されます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-105">ASP.NET Core Module (ANCM) lets you run ASP.NET Core applications behind IIS, using IIS for what it's good at (security, manageability, and lots more) and using [Kestrel](kestrel.md) for what it's good at (being really fast), and getting the benefits from both technologies at once.</span></span> <span data-ttu-id="d1ac7-106">**ANCM は Kestrel でのみ機能します。WebListener (ASP.NET Core 1.x) または HTTP.sys (2.x) と互換性はありません。**</span><span class="sxs-lookup"><span data-stu-id="d1ac7-106">**ANCM works only with Kestrel; it isn't compatible with WebListener (in ASP.NET Core 1.x) or HTTP.sys (in 2.x).**</span></span> 

<span data-ttu-id="d1ac7-107">サポートされている Windows バージョン:</span><span class="sxs-lookup"><span data-stu-id="d1ac7-107">Supported Windows versions:</span></span>

* <span data-ttu-id="d1ac7-108">Windows 7 および Windows Server 2008 R2 以降</span><span class="sxs-lookup"><span data-stu-id="d1ac7-108">Windows 7 and Windows Server 2008 R2 and later</span></span>

<span data-ttu-id="d1ac7-109">[サンプル コードを表示またはダウンロード](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/servers/aspnet-core-module/sample)します ([ダウンロード方法](xref:tutorials/index#how-to-download-a-sample))。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-109">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/servers/aspnet-core-module/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="what-aspnet-core-module-does"></a><span data-ttu-id="d1ac7-110">ASP.NET Core モジュールの機能</span><span class="sxs-lookup"><span data-stu-id="d1ac7-110">What ASP.NET Core Module does</span></span>

<span data-ttu-id="d1ac7-111">ANCM とは、IIS パイプラインにフックしてトラフィックをバックエンドの ASP.NET Core アプリケーションにリダイレクトするネイティブの IIS モジュールです。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-111">ANCM is a native IIS module that hooks into the IIS pipeline and redirects traffic to the backend ASP.NET Core application.</span></span> <span data-ttu-id="d1ac7-112">Windows 認証など、他のほとんどのモジュールは引き続き実行することができます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-112">Most other modules, such as windows authentication, still get a chance to run.</span></span> <span data-ttu-id="d1ac7-113">ANCM が制御を取得するのは、要求に対してハンドラーが選択され、ハンドラー マッピングがアプリケーション *web.config* ファイルに定義される場合のみです。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-113">ANCM only takes control when a handler is selected for the request, and handler mapping is defined in the application *web.config* file.</span></span>

<span data-ttu-id="d1ac7-114">ASP.NET Core アプリケーションは IIS ワーカー プロセスとは独立したプロセスで実行されるため、ANCM もプロセス管理を行います。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-114">Because ASP.NET Core applications run in a process separate from the IIS worker process, ANCM also does process management.</span></span> <span data-ttu-id="d1ac7-115">ANCM は、最初の要求を受信したときに ASP.NET Core アプリケーションのプロセスを開始し、プロセスがクラッシュしたときは再起動します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-115">ANCM starts the process for the ASP.NET Core application when the first request comes in and restarts it when it crashes.</span></span> <span data-ttu-id="d1ac7-116">この動作は、IIS のインプロセスで実行され、WAS (Windows プロセス アクティブ化サービス ) によって管理される従来の ASP.NET アプリケーションと基本的に同じです。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-116">This is essentially the same behavior as classic ASP.NET applications that run in-process in IIS and are managed by WAS (Windows Activation Service).</span></span>

<span data-ttu-id="d1ac7-117">次の図は、IIS アプリケーション、ANCM アプリケーション、および ASP.NET Core アプリケーションの間のリレーションシップを示しています。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-117">Here's a diagram that illustrates the relationship between IIS, ANCM, and ASP.NET Core applications.</span></span>

![ASP.NET Core モジュール](aspnet-core-module/_static/ancm.png)

<span data-ttu-id="d1ac7-119">要求は Web から送信され、カーネル モード Http.Sys ドライバーに到達します。このドライバーはプライマリ ポート (80) または SSL ポート (443) で IIS に要求をルーティングします。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-119">Requests come in from the Web and hit the kernel mode Http.Sys driver which routes them into IIS on the primary port (80) or SSL port (443).</span></span> <span data-ttu-id="d1ac7-120">ANCM は、アプリケーション用に構成された、ポート 80/443 以外の HTTP ポートで ASP.NET Core アプリケーションに要求を転送します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-120">ANCM forwards the requests to the ASP.NET Core application on the HTTP port configured for the application, which isn't port 80/443.</span></span>

<span data-ttu-id="d1ac7-121">Kestrel は ANCM からのトラフィックをリッスンします。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-121">Kestrel listens for traffic coming from ANCM.</span></span>  <span data-ttu-id="d1ac7-122">ANCM が起動時に環境変数を介してポートを指定すると、サーバーは `http://localhost:{port}` をリッスンするように、[UseIISIntegration](#call-useiisintegration) メソッドによって構成されます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-122">ANCM specifies the port via environment variable at startup, and the [UseIISIntegration](#call-useiisintegration) method configures the server to listen on `http://localhost:{port}`.</span></span> <span data-ttu-id="d1ac7-123">ANCM 以外からの要求を拒否するためのに追加のチェックが行われます </span><span class="sxs-lookup"><span data-stu-id="d1ac7-123">There are additional checks to reject requests not from ANCM.</span></span> <span data-ttu-id="d1ac7-124">(ANCM では HTTPS 転送がサポートされていないのため、要求は HTTPS を介して IIS によって受信された場合でも、HTTP を介して転送されます)。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-124">(ANCM doesn't support HTTPS forwarding, so requests are forwarded over HTTP even if received by IIS over HTTPS.)</span></span>

<span data-ttu-id="d1ac7-125">Kestrel は ANCM から要求を取得し、それを ASP.NET Core ミドルウェア パイプラインにプッシュします。そこで要求は処理され、`HttpContext` インスタンスとしてアプリケーション ロジックに渡されます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-125">Kestrel picks up requests from ANCM and pushes them into the ASP.NET Core middleware pipeline, which then handles them and passes them on as `HttpContext` instances to application logic.</span></span> <span data-ttu-id="d1ac7-126">アプリケーションの応答が IIS に渡され、IIS はその応答を、要求を開始した HTTP クライアントに返します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-126">The application's responses are then passed back to IIS, which pushes them back out to the HTTP client that initiated the requests.</span></span>

<span data-ttu-id="d1ac7-127">ANCM には他にもいくつかの機能があります。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-127">ANCM has a few other functions as well:</span></span>

* <span data-ttu-id="d1ac7-128">環境変数を設定します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-128">Sets environment variables.</span></span>
* <span data-ttu-id="d1ac7-129">`stdout` 出力をファイル記憶域にログ記録します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-129">Logs `stdout` output to file storage.</span></span>
* <span data-ttu-id="d1ac7-130">Windows 認証トークンを転送します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-130">Forwards Windows authentication tokens.</span></span>

## <a name="how-to-use-ancm-in-aspnet-core-apps"></a><span data-ttu-id="d1ac7-131">ASP.NET Core アプリで ANCM を使用する方法</span><span class="sxs-lookup"><span data-stu-id="d1ac7-131">How to use ANCM in ASP.NET Core apps</span></span>

<span data-ttu-id="d1ac7-132">このセクションでは、IIS サーバーおよび ASP.NET Core アプリケーションを設定するためのプロセスの概要を説明します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-132">This section provides an overview of the process for setting up an IIS server and ASP.NET Core application.</span></span> <span data-ttu-id="d1ac7-133">詳細については、「[IIS を使用した Windows での ASP.NET Core のホスト](xref:host-and-deploy/iis/index)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-133">For detailed instructions, see [Host on Windows with IIS](xref:host-and-deploy/iis/index).</span></span>

### <a name="install-ancm"></a><span data-ttu-id="d1ac7-134">ANCM をインストールする</span><span class="sxs-lookup"><span data-stu-id="d1ac7-134">Install ANCM</span></span>


<span data-ttu-id="d1ac7-135">ASP.NET Core モジュールは、サーバー上では IIS にインストールし、開発用コンピューター上では IIS Express にインストールする必要があります。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-135">The ASP.NET Core Module has to be installed in IIS on your servers and in IIS Express on your development machines.</span></span> <span data-ttu-id="d1ac7-136">サーバーの場合、ANCM は [.NET Core Windows Server Hosting バンドル](https://aka.ms/dotnetcore-2-windowshosting)に含まれています。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-136">For servers, ANCM is included in the [.NET Core Windows Server Hosting bundle](https://aka.ms/dotnetcore-2-windowshosting).</span></span> <span data-ttu-id="d1ac7-137">開発用コンピューターの場合、ANCM は Visual Studio によって自動的に IIS Express にインストールされ、コンピューターに既にインストールされている場合は IIS にインストールされます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-137">For development machines, Visual Studio automatically installs ANCM in IIS Express, and in IIS if it's already installed on the machine.</span></span>

### <a name="install-the-iisintegration-nuget-package"></a><span data-ttu-id="d1ac7-138">IISIntegration NuGet パッケージをインストールする</span><span class="sxs-lookup"><span data-stu-id="d1ac7-138">Install the IISIntegration NuGet package</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="d1ac7-139">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="d1ac7-139">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="d1ac7-140">[Microsoft.AspNetCore.Server.IISIntegration](https://www.nuget.org/packages/Microsoft.AspNetCore.Server.IISIntegration/) パッケージは、ASP.NET Core メタパッケージ ([Microsoft.AspNetCore](https://www.nuget.org/packages/Microsoft.AspNetCore/) および [Microsoft.AspNetCore.All](xref:fundamentals/metapackage)) に含まれます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-140">The [Microsoft.AspNetCore.Server.IISIntegration](https://www.nuget.org/packages/Microsoft.AspNetCore.Server.IISIntegration/) package is included in the ASP.NET Core metapackages ([Microsoft.AspNetCore](https://www.nuget.org/packages/Microsoft.AspNetCore/) and [Microsoft.AspNetCore.All](xref:fundamentals/metapackage)).</span></span> <span data-ttu-id="d1ac7-141">メタパッケージの 1 つを使用しない場合は、`Microsoft.AspNetCore.Server.IISIntegration` を個別にインストールします。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-141">If you don't use one of the metapackages, install `Microsoft.AspNetCore.Server.IISIntegration` separately.</span></span> <span data-ttu-id="d1ac7-142">`IISIntegration` パッケージは、アプリを設定するために ANCM によってブロードキャストされた環境変数を読み取る相互運用性パックです。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-142">The `IISIntegration` package is an interoperability pack that reads environment variables broadcast by ANCM to set up your app.</span></span> <span data-ttu-id="d1ac7-143">環境変数は、リッスンするポートなどの構成情報を提供します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-143">The environment variables provide configuration information, such as the port to listen on.</span></span> 

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="d1ac7-144">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="d1ac7-144">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="d1ac7-145">アプリケーションで、[Microsoft.AspNetCore.Server.IISIntegration](https://www.nuget.org/packages/Microsoft.AspNetCore.Server.IISIntegration/) をインストールします。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-145">In your application, install [Microsoft.AspNetCore.Server.IISIntegration](https://www.nuget.org/packages/Microsoft.AspNetCore.Server.IISIntegration/).</span></span> <span data-ttu-id="d1ac7-146">`IISIntegration` パッケージは、アプリを設定するために ANCM によってブロードキャストされた環境変数を読み取る相互運用性パックです。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-146">The `IISIntegration` package  is an interoperability pack that reads environment variables broadcast by ANCM to set up your app.</span></span> <span data-ttu-id="d1ac7-147">環境変数は、リッスンするポートなどの構成情報を提供します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-147">The environment variables provide configuration information, such as the port to listen on.</span></span> 

---

### <a name="call-useiisintegration"></a><span data-ttu-id="d1ac7-148">UseIISIntegration の呼び出し</span><span class="sxs-lookup"><span data-stu-id="d1ac7-148">Call UseIISIntegration</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="d1ac7-149">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="d1ac7-149">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="d1ac7-150">[`WebHostBuilder`](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.webhostbuilder) 上の `UseIISIntegration` 拡張メソッドは、IIS で実行するときに自動的に呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-150">The `UseIISIntegration` extension method on [`WebHostBuilder`](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.webhostbuilder) is called automatically when you run with IIS.</span></span>

<span data-ttu-id="d1ac7-151">ASP.NET Core メタパッケージのいずれか 1 つを使用しておらず、さらに `Microsoft.AspNetCore.Server.IISIntegration` パッケージがインストールされていない場合は、実行時エラーが返されます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-151">If you aren't using one of the ASP.NET Core metapackages and haven't installed the  `Microsoft.AspNetCore.Server.IISIntegration` package, you get a runtime error.</span></span> <span data-ttu-id="d1ac7-152">`UseIISIntegration` を明示的に呼び出した場合、パッケージがインストールされていないと、コンパイル時エラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-152">If you call `UseIISIntegration` explicitly, you get a compile time error if the package isn't installed.</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="d1ac7-153">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="d1ac7-153">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="d1ac7-154">アプリケーションの `Main` メソッドでは、[`WebHostBuilder`](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.webhostbuilder) で `UseIISIntegration` 拡張メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-154">In your application's `Main` method, call the `UseIISIntegration` extension method on [`WebHostBuilder`](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.webhostbuilder).</span></span> 

[!code-csharp[](aspnet-core-module/sample/Program.cs?name=snippet_Main&highlight=12)]

---

<span data-ttu-id="d1ac7-155">`UseIISIntegration` メソッドは ANCM によって設定された環境変数を探し、見つからない場合は動作しません。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-155">The `UseIISIntegration` method looks for environment variables that ANCM sets, and it no-ops if they aren't found.</span></span> <span data-ttu-id="d1ac7-156">このようなしくみは、macOS または Linux で開発およびテストを行い、IIS を実行しているサーバーに展開するようなシナリオが容易になります。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-156">This behavior facilitates scenarios like developing and testing on macOS or Linux and deploying to a server that runs IIS.</span></span> <span data-ttu-id="d1ac7-157">macOS または Linux で実行している間、Kestrel は Web サーバーとして機能しますが、アプリが IIS 環境に展開されると、自動的に ANCM および IIS を使用するようになります。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-157">While running on macOS or Linux, Kestrel acts as the web server; but when the app is deployed to the IIS environment, it automatically uses ANCM and IIS.</span></span>

### <a name="ancm-port-binding-overrides-other-port-bindings"></a><span data-ttu-id="d1ac7-158">ANCM ポート バインディングで他のポート バインディングを上書きする</span><span class="sxs-lookup"><span data-stu-id="d1ac7-158">ANCM port binding overrides other port bindings</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="d1ac7-159">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="d1ac7-159">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="d1ac7-160">ANCM は、バックエンド プロセスに割り当てる動的なポートを生成します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-160">ANCM generates a dynamic port to assign to the back-end process.</span></span> <span data-ttu-id="d1ac7-161">`UseIISIntegration` メソッドは、この動的なポートを取得すると共に、`http://locahost:{dynamicPort}/` をリッスンするように Kestrel を構成します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-161">The `UseIISIntegration` method picks up this dynamic port and configures Kestrel to listen on `http://locahost:{dynamicPort}/`.</span></span> <span data-ttu-id="d1ac7-162">これにより、`UseUrls` または [Kestrel の Listen API](xref:fundamentals/servers/kestrel?tabs=aspnetcore2x#endpoint-configuration) の呼び出しなど、その他の URL 構成が上書きされます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-162">This overrides other URL configurations, such as calls to `UseUrls` or [Kestrel's Listen API](xref:fundamentals/servers/kestrel?tabs=aspnetcore2x#endpoint-configuration).</span></span> <span data-ttu-id="d1ac7-163">したがって、ANCM を使用するときに、`UseUrls` または Kestrel の `Listen` API を呼び出す必要はありません。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-163">Therefore, you don't need to call `UseUrls` or Kestrel's `Listen` API when you use ANCM.</span></span> <span data-ttu-id="d1ac7-164">`UseUrls` または `Listen` を呼び出す場合、IIS なしでアプリを実行するときに指定するポートが Kestrel によってリッスンされます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-164">If you do call `UseUrls` or `Listen`, Kestrel listens on the port you specify when you run the app without IIS.</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="d1ac7-165">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="d1ac7-165">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="d1ac7-166">ANCM は、バックエンド プロセスに割り当てる動的なポートを生成します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-166">ANCM generates a dynamic port to assign to the back-end process.</span></span> <span data-ttu-id="d1ac7-167">`UseIISIntegration` メソッドは、この動的なポートを取得すると共に、`http://locahost:{dynamicPort}/` をリッスンするように Kestrel を構成します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-167">The `UseIISIntegration` method picks up this dynamic port and configures Kestrel to listen on `http://locahost:{dynamicPort}/`.</span></span> <span data-ttu-id="d1ac7-168">これにより、`UseUrls` の呼び出しなど、その他の URL 構成が上書きされます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-168">This overrides other URL configurations, such as calls to `UseUrls`.</span></span> <span data-ttu-id="d1ac7-169">したがって、ANCM を使用するときに、`UseUrls` を呼び出す必要はありません。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-169">Therefore, you don't need to call `UseUrls` when you use ANCM.</span></span> <span data-ttu-id="d1ac7-170">`UseUrls` を呼び出す場合、IIS なしでアプリを実行するときに指定するポートが Kestrel によってリッスンされます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-170">If you do call `UseUrls`, Kestrel listens on the port you specify when you run the app without IIS.</span></span>

<span data-ttu-id="d1ac7-171">ASP.NET Core 1.0 では、`UseUrls` を呼び出す場合、これを呼び出して**から**、`UseIISIntegration` を呼び出します。そうすれば、ANCM で構成されたポートは上書きされません。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-171">In ASP.NET Core 1.0, if you call `UseUrls`, call it **before** you call `UseIISIntegration` so that the ANCM-configured port doesn't get overwritten.</span></span> <span data-ttu-id="d1ac7-172">この呼び出しの順序は ASP.NET Core 1.1 では必要ありません。ANCM 設定は `UseUrls` より優先されるからです。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-172">This calling order isn't required in ASP.NET Core 1.1, because the ANCM setting overrides `UseUrls`.</span></span>

---

### <a name="configure-ancm-options-in-webconfig"></a><span data-ttu-id="d1ac7-173">Web.config で ANCM オプションを構成する</span><span class="sxs-lookup"><span data-stu-id="d1ac7-173">Configure ANCM options in Web.config</span></span>

<span data-ttu-id="d1ac7-174">ASP.NET Core モジュールの構成は、アプリケーションのルート フォルダーに配置された *web.config* ファイルに格納されます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-174">Configuration for the ASP.NET Core Module is stored in the *web.config* file that's located in the application's root folder.</span></span> <span data-ttu-id="d1ac7-175">このファイル内の設定は、ASP.NET Core アプリを起動するスタートアップ コマンドと引数をポイントします。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-175">Settings in this file point to the startup command and arguments that start your ASP.NET Core app.</span></span> <span data-ttu-id="d1ac7-176">*web.config* コードのサンプルと構成オプションのガイダンスについては、「[ASP.NET Core Module Configuration Reference](xref:host-and-deploy/aspnet-core-module)」 (ASP.NET Core モジュール構成の参照) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-176">For sample *web.config* code and guidance on configuration options, see [ASP.NET Core Module Configuration Reference](xref:host-and-deploy/aspnet-core-module).</span></span>

### <a name="run-with-iis-express-in-development"></a><span data-ttu-id="d1ac7-177">開発における IIS Express での実行</span><span class="sxs-lookup"><span data-stu-id="d1ac7-177">Run with IIS Express in development</span></span>

<span data-ttu-id="d1ac7-178">IIS Express を Visual Studio で起動するには、ASP.NET Core テンプレートによって定義された既定のプロファイルを使用します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-178">IIS Express can be launched by Visual Studio using the default profile defined by the ASP.NET Core templates.</span></span>

## <a name="proxy-configuration-uses-http-protocol-and-a-pairing-token"></a><span data-ttu-id="d1ac7-179">プロキシの構成で HTTP プロトコルとペアリング トークンを使用する</span><span class="sxs-lookup"><span data-stu-id="d1ac7-179">Proxy configuration uses HTTP protocol and a pairing token</span></span>

<span data-ttu-id="d1ac7-180">ANCM と Kestrel の間で作成されたプロキシで、HTTP プロトコルを使用します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-180">The proxy created between the ANCM and Kestrel uses the HTTP protocol.</span></span> <span data-ttu-id="d1ac7-181">HTTP を使用することは、パフォーマンス最適化の手段です。この場合は、ANCM と Kestrel の間のトラフィックがネットワーク インターフェイスから離れたループバック アドレスで発生します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-181">Using HTTP is a performance optimization where the traffic between the ANCM and Kestrel takes place on a loopback address off of the network interface.</span></span> <span data-ttu-id="d1ac7-182">ANCM と Kestrel の間のトラフィックが、サーバーから離れた場所で傍受される危険性があります。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-182">There's no risk of eavesdropping the traffic between the ANCM and Kestrel from a location off of the server.</span></span>

<span data-ttu-id="d1ac7-183">ペアリング トークンを使用すると、Kestrel によって受信される要求が IIS によってプロキシされたものであり、他のソースからのものでないことを保証できます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-183">A pairing token is used to guarantee that the requests received by Kestrel were proxied by IIS and didn't come from some other source.</span></span> <span data-ttu-id="d1ac7-184">ペアリング トークンは、ANCM によって作成され、環境変数 (`ASPNETCORE_TOKEN`) に設定されます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-184">The pairing token is created and set into an environment variable (`ASPNETCORE_TOKEN`) by the ANCM.</span></span> <span data-ttu-id="d1ac7-185">ペアリング トークンはまた、プロキシされたすべての要求のヘッダー (`MSAspNetCoreToken`) にも設定されます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-185">The pairing token is also set into a header (`MSAspNetCoreToken`) on every proxied request.</span></span> <span data-ttu-id="d1ac7-186">IIS ミドルウェアは、受信した各要求をチェックし、ペアリング トークン ヘッダーの値が環境変数の値と一致することを確認します。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-186">IIS Middleware checks each request it receives to confirm that the pairing token header value matches the environment variable value.</span></span> <span data-ttu-id="d1ac7-187">トークンの値が一致しない場合、要求はログに記録され、拒否されます。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-187">If the token values are mismatched, the request is logged and rejected.</span></span> <span data-ttu-id="d1ac7-188">ペアリング トークン環境変数および、ANCM と Kestrel の間のトラフィックには、サーバーから離れた場所からアクセスすることはできません。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-188">The pairing token environment variable and the traffic between the ANCM and Kestrel aren't accessible from a location off of the server.</span></span> <span data-ttu-id="d1ac7-189">ペアリング トークンの値がわからなければ、攻撃者は IIS ミドルウェアのチェックをバイパスする要求を送信できません。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-189">Without knowing the pairing token value, an attacker can't submit requests that bypass the check in the IIS Middleware.</span></span>

## <a name="next-steps"></a><span data-ttu-id="d1ac7-190">次の手順</span><span class="sxs-lookup"><span data-stu-id="d1ac7-190">Next steps</span></span>

<span data-ttu-id="d1ac7-191">詳細については、次のリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="d1ac7-191">For more information, see the following resources:</span></span>

* [<span data-ttu-id="d1ac7-192">この記事のサンプル アプリ</span><span class="sxs-lookup"><span data-stu-id="d1ac7-192">Sample app for this article</span></span>](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/servers/aspnet-core-module/sample)
* [<span data-ttu-id="d1ac7-193">ASP.NET Core モジュールのソース コード</span><span class="sxs-lookup"><span data-stu-id="d1ac7-193">ASP.NET Core Module source code</span></span>](https://github.com/aspnet/AspNetCoreModule)
* [<span data-ttu-id="d1ac7-194">ASP.NET Core モジュール構成リファレンス</span><span class="sxs-lookup"><span data-stu-id="d1ac7-194">ASP.NET Core Module Configuration Reference</span></span>](xref:host-and-deploy/aspnet-core-module)
* [<span data-ttu-id="d1ac7-195">IIS による Windows 上のホスト</span><span class="sxs-lookup"><span data-stu-id="d1ac7-195">Host on Windows with IIS</span></span>](xref:host-and-deploy/iis/index)
