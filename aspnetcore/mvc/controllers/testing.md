---
title: ASP.NET Core のコントローラーのロジックをテストする
author: ardalis
description: Moq と xUnit を使って ASP.NET Core のコントローラーのロジックをテストする方法を説明します。
ms.author: riande
ms.date: 10/14/2016
uid: mvc/controllers/testing
ms.openlocfilehash: d0b2a25d00187c088671be147844aa892f824c6e
ms.sourcegitcommit: 64c2ca86fff445944b155635918126165ee0f8aa
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/18/2018
ms.locfileid: "41751490"
---
# <a name="test-controller-logic-in-aspnet-core"></a><span data-ttu-id="2b3e1-103">ASP.NET Core のコントローラーのロジックをテストする</span><span class="sxs-lookup"><span data-stu-id="2b3e1-103">Test controller logic in ASP.NET Core</span></span>

<span data-ttu-id="2b3e1-104">作成者: [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="2b3e1-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="2b3e1-105">コントローラーは、すべての ASP.NET Core MVC アプリケーションの中心になるものです。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-105">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="2b3e1-106">そのため、アプリが意図するとおりに動作するという信頼が必要です。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-106">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="2b3e1-107">自動テストを行うと、この信頼が得られ、運用環境に提供する前にエラーを検出できます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-107">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="2b3e1-108">コントローラーに必要のない機能を持たせないようにし、テストではコントローラーの機能だけに注目することが重要です。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-108">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="2b3e1-109">コントローラーのロジックは最小限のものにして、ビジネス ロジックやインフラストラクチャに関すること (たとえば、データ アクセス) には目を向けないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-109">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="2b3e1-110">フレームワークではなく、コントローラーのロジックをテストします。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-110">Test controller logic, not the framework.</span></span> <span data-ttu-id="2b3e1-111">有効または無効な入力に基づいて、コントローラーの "*動作*" をテストします。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-111">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="2b3e1-112">コントローラーが実行するビジネス操作の結果に基づいて、コントローラーの応答をテストします。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-112">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="2b3e1-113">コントローラーの一般的な機能:</span><span class="sxs-lookup"><span data-stu-id="2b3e1-113">Typical controller responsibilities:</span></span>

* <span data-ttu-id="2b3e1-114">`ModelState.IsValid` を確認します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-114">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="2b3e1-115">`ModelState` が無効である場合は、エラー応答を返します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-115">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="2b3e1-116">ビジネス エンティティを永続化から取得します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-116">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="2b3e1-117">ビジネス エンティティに対してアクションを実行します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-117">Perform an action on the business entity.</span></span>
* <span data-ttu-id="2b3e1-118">ビジネス エンティティを永続化に保存します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-118">Save the business entity to persistence.</span></span>
* <span data-ttu-id="2b3e1-119">適切な `IActionResult` を返します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-119">Return an appropriate `IActionResult`.</span></span>

<span data-ttu-id="2b3e1-120">[サンプル コードを表示またはダウンロード](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample)します ([ダウンロード方法](xref:tutorials/index#how-to-download-a-sample))。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-120">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="unit-tests-of-controller-logic"></a><span data-ttu-id="2b3e1-121">コントローラー ロジックの単体テスト</span><span class="sxs-lookup"><span data-stu-id="2b3e1-121">Unit tests of controller logic</span></span>

<span data-ttu-id="2b3e1-122">[単体テスト](/dotnet/articles/core/testing/unit-testing-with-dotnet-test)では、アプリの一部をインフラストラクチャや依存関係から切り離してテストすることが必要とされます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-122">[Unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involve testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="2b3e1-123">コントローラー ロジックの単体テストを行うときは、それが依存しているものやフレームワーク自体の動作ではなく、単一のアクションの内容のみをテストします。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-123">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="2b3e1-124">コントローラーのアクションの単体テストでは、その動作にだけ注目するようにします。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-124">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="2b3e1-125">コントローラーの単体テストからは、[フィルター](xref:mvc/controllers/filters)、[ルーティング](xref:fundamentals/routing)、[モデル バインド](xref:mvc/models/model-binding)などに関することは除外します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-125">A controller unit test avoids things like [filters](xref:mvc/controllers/filters), [routing](xref:fundamentals/routing), or [model binding](xref:mvc/models/model-binding).</span></span> <span data-ttu-id="2b3e1-126">1 つの事柄だけに注目してテストすることにより、一般に、単体テストを簡単に作成してすばやく実行できるようになります。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-126">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="2b3e1-127">適切に記述された一連の単体テストは、大きなオーバーヘッドなしに頻繁に実行できます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-127">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="2b3e1-128">ただし、単体テストではコンポーネント間の相互作用の問題は検出しません。これは、[統合テスト](xref:test/integration-tests)の目的です。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-128">However, unit tests don't detect issues in the interaction between components, which is the purpose of [integration tests](xref:test/integration-tests).</span></span>

<span data-ttu-id="2b3e1-129">カスタム フィルターやルートを作成している場合、それらの単体テストは、コントローラーの特定のアクションに対するテストの一部として行うのではなく、分離環境で行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-129">If you're writing custom filters and routes, you should unit test them in isolation, not as part of your tests on a particular controller action.</span></span>

> [!TIP]
> <span data-ttu-id="2b3e1-130">[Visual Studio で単体テストを作成して実行します](/visualstudio/test/unit-test-your-code)。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-130">[Create and run unit tests with Visual Studio](/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="2b3e1-131">単体テストの方法を説明するための実例として、次のコントローラーを使います。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-131">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="2b3e1-132">このコントローラーは、ブレーンストーミング セッションの一覧を表示し、POST を使って新しいブレーンストーミング セッションを作成できます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-132">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="2b3e1-133">このコントローラーは、[明示的な依存関係の原則](http://deviq.com/explicit-dependencies-principle/)に従い、依存関係の挿入を使って `IBrainstormSessionRepository` のインスタンスを提供されるものと想定しています。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-133">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="2b3e1-134">これにより、[Moq](https://www.nuget.org/packages/Moq/) などのモック オブジェクト フレームワークを使ったテストが非常に簡単になります。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-134">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="2b3e1-135">`HTTP GET Index` メソッドにはループや分岐はなく、1 つのメソッドを呼び出すだけです。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-135">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="2b3e1-136">この `Index` メソッドをテストするには、リポジトリの `List` メソッドからの `ViewModel` で、`ViewResult` が返されることを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-136">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="2b3e1-137">`HomeController` `HTTP POST Index` メソッド (上記) では、次のことを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-137">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="2b3e1-138">`ModelState.IsValid` が `false` の場合、アクション メソッドが無効な要求の `ViewResult` と適切なデータを返すこと。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-138">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`.</span></span>

* <span data-ttu-id="2b3e1-139">`ModelState.IsValid` が true の場合、リポジトリで `Add` メソッドが呼び出されて、`RedirectToActionResult` が適切な引数と共に返されること</span><span class="sxs-lookup"><span data-stu-id="2b3e1-139">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="2b3e1-140">以下の最初のテストで示すように、`AddModelError` を使ってエラーを追加することで、無効なモデルの状態をテストできます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-140">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="2b3e1-141">最初のテストでは、`ModelState` が有効ではないときに、`GET` 要求の場合と同じ `ViewResult` が返されることを確認します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-141">The first test confirms when `ModelState` isn't valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="2b3e1-142">テストでは無効なモデルを渡そうとしていないことに注意してください。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-142">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="2b3e1-143">モデル バインドが動作していないので、いずれにしてもうまくいきません (ただし、[統合テスト](xref:test/integration-tests)では演習のモデル バインドを使います)。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-143">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:test/integration-tests) would use exercise model binding).</span></span> <span data-ttu-id="2b3e1-144">この場合、モデル バインドはテストされていません。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-144">In this case, model binding isn't being tested.</span></span> <span data-ttu-id="2b3e1-145">これらの単体テストでは、アクション メソッドのコードだけをテストしています。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-145">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="2b3e1-146">2 番目のテストでは、`ModelState` が有効であるときに、新しい `BrainstormSession` が (リポジトリによって) 追加され、メソッドが予期されるプロパティと共に `RedirectToActionResult` を返すことを確認します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-146">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="2b3e1-147">呼び出されないモックの呼び出しは通常は無視されますが、Setup の呼び出しの最後で `Verifiable` を呼び出すと、テスト内で検証できます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-147">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="2b3e1-148">これは `mockRepo.Verify` の呼び出しで行われ、予期されるメソッドが呼び出されないとテストは失敗します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-148">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method wasn't called.</span></span>

> [!NOTE]
> <span data-ttu-id="2b3e1-149">このサンプルで使われている Moq ライブラリにより、検証可能な ("厳密な") モックと検証不可能なモック ("厳密でない" モックまたはスタブとも呼ばれます) を簡単に混在させることができます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-149">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="2b3e1-150">詳しくは、Moq の「[Customizing Mock Behavior](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior)」(モックの動作のカスタマイズ) をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-150">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="2b3e1-151">アプリの別のコントローラーでは、特定のブレーンストーミング セッションに関する情報が表示されます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-151">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="2b3e1-152">無効な ID 値を扱うためのロジックが含まれています。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-152">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="2b3e1-153">コントローラーのアクションには、各 `return` ステートメントに 1 つずつ、3 つのテスト ケースがあります。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-153">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="2b3e1-154">アプリでは、Web API として機能が公開されています (ブレーンストーミング セッションに関連付けられているアイデアの一覧と、新しいアイデアをセッションに追加するためのメソッド)。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-154">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="2b3e1-155">`ForSession` メソッドは、`IdeaDTO` 型の一覧を返します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-155">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="2b3e1-156">API の呼び出しで直接ビジネス ドメイン エンティティを返さないでください。ビジネス ドメイン エンティティには API クライアントが要求しているもの以外のデータが含まれることが多く、アプリの内部ドメイン モデルと外部に公開される API との間に必要のない結合が生じます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-156">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="2b3e1-157">ドメイン エンティティと、ネットワーク経由で戻される型の間のマッピングは、手動で (ここで示すように LINQ `Select` を使って)、または [AutoMapper](https://github.com/AutoMapper/AutoMapper) などのライブラリを使って、行うことができます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-157">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span></span>

<span data-ttu-id="2b3e1-158">API メソッド `Create` と `ForSession` の単体テストは次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-158">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="2b3e1-159">前に説明したように、`ModelState` が無効のときのメソッドの動作をテストするには、テストの一部としてコントローラーにモデル エラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-159">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="2b3e1-160">単体テストでは、モデルの検証またはモデル バインドのテストを試さないでください。`ModelState` の特定の値に遭遇したときのアクション メソッドの動作だけをテストしてください。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-160">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="2b3e1-161">2 番目のテストではリポジトリが null を返す必要があるので、モック リポジトリは null を返すように構成されています。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-161">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="2b3e1-162">テスト データベース (メモリ内またはそれ以外の場所) を作成する必要はなく、この結果を返すクエリを作成します。これは、次のように単一のステートメントで実行できます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-162">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="2b3e1-163">最後のテストでは、リポジトリの `Update` メソッドが呼び出されることを確認します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-163">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="2b3e1-164">前に行ったように、`Verifiable` ではモックが呼び出され、モック リポジトリの `Verify` メソッドが呼び出されて、検証可能なメソッドが実行されたことを確認します。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-164">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="2b3e1-165">`Update` メソッドがデータを保存したことを確認するのは、単体テストの役割ではありません。これは、統合テストで実行できます。</span><span class="sxs-lookup"><span data-stu-id="2b3e1-165">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="2b3e1-166">その他の技術情報</span><span class="sxs-lookup"><span data-stu-id="2b3e1-166">Additional resources</span></span>

* <xref:test/integration-tests>
