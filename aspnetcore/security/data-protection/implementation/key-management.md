---
title: "キー管理"
author: rick-anderson
description: "このドキュメントでは、ASP.NET Core データ保護キー管理 Api の実装の詳細について説明します。"
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.technology: aspnet
ms.prod: asp.net-core
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: 9c4d293355e26d8bf5ba1360b070a7b9809bfe56
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/24/2018
---
# <a name="key-management"></a>キー管理

<a name="data-protection-implementation-key-management"></a>

データ保護システムは、自動的に保護し、ペイロードの保護を解除するために使用するマスター _ キーの有効期間を管理します。 各キーは、4 つの段階のいずれかに存在できます。

* 作成されるキーはキー リング内に存在するが、まだアクティブになっていません。 キー使用できない新しい保護する操作のための十分な時間が経過するまで、キーがこのキーのリングを消費しているすべてのマシンに反映されるまでの機会がいること。

* アクティブ - キーは、キー リングに存在し、すべての新しい保護操作に使用する必要があります。

* 期限切れのキーは、自然な有効期間は実行し、保護する操作では使用できなくする必要があります。

* 失効のキーが侵害され、保護する操作では使用しないでください。

作成された、アクティブ、および有効期限が切れたキーにすべて受信ペイロードを解除するために使用できます。 、ペイロードを解除するために、既定では失効のキーを使用しない場合がありますが、アプリケーション開発者[この動作をオーバーライド](../consumer-apis/dangerous-unprotect.md#data-protection-consumer-apis-dangerous-unprotect)必要な場合です。

>[!WARNING]
> 開発者は、(例: ファイル システムから対応するファイルの削除) によってキー リングからキーを削除したくなる可能性があります。 その時点で、キーによって保護されているすべてのデータが完全に解読され、緊急の上書きには、失効したキーではありません。 キーの削除は、完全に破壊的な動作とその結果、データ保護システム公開ありませんファースト クラスの API この操作を実行します。

## <a name="default-key-selection"></a>既定のキーの選択

読み取りときに、データ保護システム キー リング バッキング リポジトリから、キー リングから"default"キーを検索を試みます。 既定のキーは、新しい保護操作に使用されます。

一般的なヒューリスティックは、データ保護システムが、キーの既定のキーとして、最新のライセンス認証日を選択します。 (が許可するようにサーバーのクロック スキューの小規模の一種です。)かどうか、アプリケーションが無効になっていない自動、およびキーの生成、キーの期限切れか失効されたかどうか、は、新しいキーが即時のライセンス認証ごとに生成されます、[キーの有効期限とローリング](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration)ポリシー以下です。

新しいキーの生成を新しいキーの前にライセンス認証されたすべてのキーの有効期限が暗黙の型として扱うことが別のキーにフォールバックするのではなく、データ保護システムの理由がすぐに新しいキーを生成します。 基本的な考え方されている新しいキーが別のアルゴリズムまたはより古いキー、暗号化の両方のメカニズムで構成されたシステムはフォールバック経由では、現在の構成を優先する必要があります。

例外が発生しました。 場合は、アプリケーション開発者がある[自動キーの生成を無効になっている](xref:security/data-protection/configuration/overview#disableautomatickeygeneration)、データ保護システムで、既定のキーとしてものを選択する必要があります。 このフォールバック シナリオでは、システムは、クラスター内の他のマシンに反映されるまでの時間をかけてキーに指定された基本設定の最新のライセンス認証日、失効して非キーを選択します。 フォールバック システムは、その結果、既定の有効期限が切れたキーの選択をなる可能性があります。 フォールバック システムは既定のキーと失効したキーを選択しないと、キー リングが空か、すべてのキーが失効していない場合は、システムが初期化時にエラーが発生します。

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a>キーの期限切れとロール

キーの作成時に、{今すぐ + 2 日間} のアクティブ化された日付と {今すぐ + 90 日間} の有効期限が提供されて自動的にします。 アクティブ化する前に 2 日間の遅延は、システムを通じて伝達されるまでキー時刻を示します。 つまり、そのため、キーのリングが伝達になるはアクティブなときにする必要があるすべてのアプリケーション使用ことになる可能性を最大化、[次へ] の自動更新期間に、キーを観察するバッキング ストアを指して他のアプリケーションことができます。

既定のキーが 2 日以内に失効して、キー リング アクティブ既定のキーの期限を過ぎるとなるキーを持っていない場合は、キー リングに新しいキーが自動的にデータ保護システムに保持します。 この新しいキーがあり、アクティブ化された日付の既定のキーの有効期限 {date} {今すぐ + 90 日間} の有効期限。 これにより、システムがサービスの中断することなくが、定期的にキーを自動的にロールバックできます。

ある可能性がありますの状況で即時のライセンス認証キーを作成する場所です。 アプリケーションも、時間実行されていないし、キーのリングのすべてのキーの期限が切れている場合、1 つの例が挙げられます。 この場合、キーは {now} の通常の 2 日間ライセンス認証遅延なしのアクティブ化日付を付与します。

これが次の例のように構成可能な既定キーの有効期間は 90 日間、意味がします。

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

管理者を変更することも、システム全体で既定値もを明示的に呼び出す`SetDefaultKeyLifetime`システム全体のポリシーよりも優先されます。 既定キーの有効期間は 7 日間よりも短くすることはできません。

## <a name="automatic-key-ring-refresh"></a>自動キー リング更新

データ保護システム初期化すると、基になるリポジトリからのキー リングの読み取りし、メモリ内キャッシュします。 このキャッシュは、保護と保護の解除の操作をバッキング ストアに達することなしに続行できます。 システムでは、約 24 時間ごと、またはどちらか早い方が、現在の既定のキーが経過すると、変更のバッキング ストアが自動的にチェックします。

>[!WARNING]
> 場合は、開発者が非常にまれには、キー管理 Api を直接使用する必要があります。 データ保護システムは上記のように、自動キー管理を実行します。

インターフェイスを公開するデータ保護システム`IKeyManager`を使用して、検査し、キー リングに変更を加えることができます。 インスタンスを提供する DI システム`IDataProtectionProvider`のインスタンスを指定できますも`IKeyManager`の使用量に対するです。 プルする代わりに、`IKeyManager`から直接、`IServiceProvider`次の例のようにします。

キーのリング (明示的に新しいキーを作成または失効を実行する) を変更するすべての操作は、メモリ内キャッシュを無効になります。 次に呼び出した`Protect`または`Unprotect`キー リングを再度読み取るし、キャッシュを再作成するデータ保護システムが発生します。

次の例では、使用方法を示します、`IKeyManager`を検査および取り消しの既存のキーや、新しいキーを手動で生成するなど、キーのリングを操作するインターフェイスです。

[!code-csharp[Main](key-management/samples/key-management.cs)]

## <a name="key-storage"></a>キーの格納

データ保護システムには、適切なキー記憶域の場所と rest のメカニズムに暗号化を自動的に推測しようとする、ヒューリスティックがあります。 これは、アプリの開発者によって構成できます。 次のドキュメントでは、これらのメカニズムのボックスでの実装について説明します。

* [ボックス内のキー記憶域プロバイダー](key-storage-providers.md#data-protection-implementation-key-storage-providers)

* [プロバイダーの rest のボックスでキーの暗号化](key-encryption-at-rest.md#data-protection-implementation-key-encryption-at-rest-providers)
