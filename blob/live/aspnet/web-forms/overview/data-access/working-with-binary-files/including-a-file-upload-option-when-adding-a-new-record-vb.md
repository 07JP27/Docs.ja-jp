---
uid: web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-vb
title: "新しいレコード (VB) を追加するときにオプションをアップロードするファイルを含む |Microsoft ドキュメント"
author: rick-anderson
description: "このチュートリアルでは、両方のテキスト データを入力し、バイナリ ファイルをアップロードするユーザーができる Web インターフェイスを作成する方法を示します。 オプションの使用可能な t について説明しています."
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/27/2007
ms.topic: article
ms.assetid: 5776281d-4637-4d1e-a65b-2621d2cade44
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-vb
msc.type: authoredcontent
ms.openlocfilehash: 4f49c201c71ca8f98d7e15b29f1df9a6bcd1b12e
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/10/2017
---
<a name="including-a-file-upload-option-when-adding-a-new-record-vb"></a><span data-ttu-id="7ab4b-104">新しいレコード (VB) を追加するときに、ファイルのアップロード オプションを含む</span><span class="sxs-lookup"><span data-stu-id="7ab4b-104">Including a File Upload Option When Adding a New Record (VB)</span></span>
====================
<span data-ttu-id="7ab4b-105">によって[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="7ab4b-106">[サンプル アプリをダウンロード](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_VB.exe)または[PDF のダウンロード](including-a-file-upload-option-when-adding-a-new-record-vb/_static/datatutorial56vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-106">[Download Sample App](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_VB.exe) or [Download PDF](including-a-file-upload-option-when-adding-a-new-record-vb/_static/datatutorial56vb1.pdf)</span></span>

> <span data-ttu-id="7ab4b-107">このチュートリアルでは、両方のテキスト データを入力し、バイナリ ファイルをアップロードするユーザーができる Web インターフェイスを作成する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-107">This tutorial shows how to create a Web interface that allows the user to both enter text data and upload binary files.</span></span> <span data-ttu-id="7ab4b-108">バイナリ データの格納に使用できるオプションを示すためはファイル システムに格納されている場合は、他に 1 つのファイル、データベースに保存されます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-108">To illustrate the options available to store binary data, one file will be saved in the database while the other is stored in the file system.</span></span>


## <a name="introduction"></a><span data-ttu-id="7ab4b-109">はじめに</span><span class="sxs-lookup"><span data-stu-id="7ab4b-109">Introduction</span></span>

<span data-ttu-id="7ab4b-110">前の 2 つのチュートリアルではため、探索ファイルアップロード コントロールを使用して、クライアントから web サーバーにファイルを送信および W のデータにこのバイナリ データを表示する方法を説明する方法を見て、アプリケーションのデータ モデルに関連付けられているバイナリ データを格納するための手法eb コントロールです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-110">In the previous two tutorials we explored techniques for storing binary data that is associated with the application s data model, looked at how to use the FileUpload control to send files from the client to the web server, and saw how to present this binary data in a data Web control.</span></span> <span data-ttu-id="7ab4b-111">おただし、データ モデルにアップロードされたデータを関連付ける方法について説明するには、まだしました。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-111">We ve yet to talk about how to associate uploaded data with the data model, though.</span></span>

<span data-ttu-id="7ab4b-112">このチュートリアルでは、新しいカテゴリを追加する web ページを作成します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-112">In this tutorial we will create a web page to add a new category.</span></span> <span data-ttu-id="7ab4b-113">だけでなく、カテゴリの名前と説明のテキスト ボックスは、このページは、新しいカテゴリの図用の 1 つの 2 つのファイルアップロード コントロールとパンフレットのいずれかを含める必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-113">In addition to TextBoxes for the category s name and description, this page will need to include two FileUpload controls one for the new category s picture and one for the brochure.</span></span> <span data-ttu-id="7ab4b-114">アップロードされた画像は、新しいレコード s に直接格納されます`Picture`列、パンフレットに保存されますが、 `~/Brochures` s の新しいレコードに保存されているファイルへのパスを持つフォルダー`BrochurePath`列です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-114">The uploaded picture will be stored directly in the new record s `Picture` column, whereas the brochure will be saved to the `~/Brochures` folder with the path to the file saved in the new record s `BrochurePath` column.</span></span>

<span data-ttu-id="7ab4b-115">この新しい web ページを作成する前に、アーキテクチャを更新する必要になります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-115">Before creating this new web page, we'll need to update the architecture.</span></span> <span data-ttu-id="7ab4b-116">`CategoriesTableAdapter` S メイン クエリを取得することはありません、`Picture`列です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-116">The `CategoriesTableAdapter` s main query does not retrieve the `Picture` column.</span></span> <span data-ttu-id="7ab4b-117">その結果の自動生成された`Insert`メソッドは入力のみが、 `CategoryName`、 `Description`、および`BrochurePath`フィールドです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-117">Consequently, the auto-generated `Insert` method only has inputs for the `CategoryName`, `Description`, and `BrochurePath` fields.</span></span> <span data-ttu-id="7ab4b-118">したがって、4 つすべての入力を求める TableAdapter に追加のメソッドを作成する必要があります`Categories`フィールドです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-118">Therefore, we need to create an additional method in the TableAdapter that prompts for all four `Categories` fields.</span></span> <span data-ttu-id="7ab4b-119">`CategoriesBLL`ビジネス ロジック層内のクラスを更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-119">The `CategoriesBLL` class in the Business Logic Layer will also need to be updated.</span></span>

## <a name="step-1-adding-aninsertwithpicturemethod-to-thecategoriestableadapter"></a><span data-ttu-id="7ab4b-120">手順 1: 追加、`InsertWithPicture`メソッドを`CategoriesTableAdapter`</span><span class="sxs-lookup"><span data-stu-id="7ab4b-120">Step 1: Adding an`InsertWithPicture`Method to the`CategoriesTableAdapter`</span></span>

<span data-ttu-id="7ab4b-121">作成したときに、`CategoriesTableAdapter`に戻り、[データ アクセス レイヤーを作成する](../introduction/creating-a-data-access-layer-vb.md)チュートリアルでは、構成が自動的に生成`INSERT`、 `UPDATE`、および`DELETE`ステートメントは、メインのクエリに基づきます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-121">When we created the `CategoriesTableAdapter` back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) tutorial, we configured it to automatically generate `INSERT`, `UPDATE`, and `DELETE` statements based on the main query.</span></span> <span data-ttu-id="7ab4b-122">DB の直接的な方法は、メソッドの作成を採用する TableAdapter の指示はさらに、 `Insert`、 `Update`、および`Delete`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-122">Moreover, we instructed the TableAdapter to employ the DB Direct approach, which created the methods `Insert`, `Update`, and `Delete`.</span></span> <span data-ttu-id="7ab4b-123">これらのメソッドを自動生成された実行`INSERT`、 `UPDATE`、および`DELETE`ステートメントと、その結果、メインのクエリによって返される列に基づいて入力パラメーターを受け入れます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-123">These methods execute the auto-generated `INSERT`, `UPDATE`, and `DELETE` statements and, consequently, accept input parameters based on the columns returned by the main query.</span></span> <span data-ttu-id="7ab4b-124">[ファイルのアップロード](uploading-files-vb.md)補強したチュートリアル、`CategoriesTableAdapter`メイン クエリを使用する、`BrochurePath`列です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-124">In the [Uploading Files](uploading-files-vb.md) tutorial we augmented the `CategoriesTableAdapter` s main query to use the `BrochurePath` column.</span></span>

<span data-ttu-id="7ab4b-125">以降、 `CategoriesTableAdapter` s メイン クエリを参照していません、`Picture`列、おできる新しいレコードを追加でも値を持つ既存のレコードを更新、`Picture`列です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-125">Since the `CategoriesTableAdapter` s main query does not reference the `Picture` column, we can neither add a new record nor update an existing record with a value for the `Picture` column.</span></span> <span data-ttu-id="7ab4b-126">この情報をキャプチャするのにを作成する新しいメソッドはバイナリ データを持つレコードを挿入するために使用する TableAdapter のかカスタマイズして、自動生成された`INSERT`ステートメントです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-126">In order to capture this information, we can either create a new method in the TableAdapter that is used specifically to insert a record with binary data or we can customize the auto-generated `INSERT` statement.</span></span> <span data-ttu-id="7ab4b-127">自動生成のカスタマイズは、問題`INSERT`ステートメントがあるおリスクが、カスタマイズ、ウィザードによって上書きされます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-127">The problem with customizing the auto-generated `INSERT` statement is that we risk having our customizations overwritten by the wizard.</span></span> <span data-ttu-id="7ab4b-128">たとえば、カスタマイズして、`INSERT`ステートメントを使用している、`Picture`列です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-128">For example, imagine that we customized the `INSERT` statement to include use of the `Picture` column.</span></span> <span data-ttu-id="7ab4b-129">これは、tableadapter を更新`Insert`カテゴリ s s の画像のバイナリ データの追加の入力パラメーターを含める方法です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-129">This would update the TableAdapter s `Insert` method to include an additional input parameter for the category s picture s binary data.</span></span> <span data-ttu-id="7ab4b-130">この DAL メソッドを使用して、プレゼンテーション層を介してこの BLL メソッドを呼び出すビジネス ロジック層でメソッドを作成おでしたし、すばらしく動作させます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-130">We could then create a method in the Business Logic Layer to use this DAL method and invoke this BLL method through the Presentation Layer, and everything would work wonderfully.</span></span> <span data-ttu-id="7ab4b-131">次の時間まで TableAdapter 構成ウィザードを使って、TableAdapter を構成します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-131">That is, until the next time we configured the TableAdapter through the TableAdapter Configuration wizard.</span></span> <span data-ttu-id="7ab4b-132">ウィザードが完了したら、当社のカスタマイズとすぐに、`INSERT`ステートメントが上書きされます、`Insert`メソッドは、以前の形式を元に戻すし、コードがコンパイルされなくなります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-132">As soon as the wizard completed, our customizations to the `INSERT` statement would be overwritten, the `Insert` method would revert to its old form, and our code would no longer compile!</span></span>

> [!NOTE]
> <span data-ttu-id="7ab4b-133">この面倒な作業は、アドホック SQL ステートメントではなくストアド プロシージャを使用する場合以外の問題です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-133">This annoyance is a non-issue when using stored procedures instead of ad-hoc SQL statements.</span></span> <span data-ttu-id="7ab4b-134">今後のチュートリアルは、データ アクセス レイヤーでアドホック SQL ステートメントを使用せずにストアド プロシージャを使用して調査します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-134">A future tutorial will explore using stored procedures in lieu of ad-hoc SQL statements in the Data Access Layer.</span></span>


<span data-ttu-id="7ab4b-135">この可能性を回避するには、自動生成された SQL ステートメントをカスタマイズするのではなく、頭痛の種でした、s、TableAdapter の新しいメソッドを代わりに作成を使用できます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-135">To avoid this potential headache, rather than customizing the auto-generated SQL statements let s instead create a new method for the TableAdapter.</span></span> <span data-ttu-id="7ab4b-136">このメソッドは、名前付き`InsertWithPicture`の値を受け入れる、 `CategoryName`、 `Description`、`BrochurePath`と`Picture`列を実行し、`INSERT`新しいレコードに 4 つすべての値を格納するステートメント。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-136">This method, named `InsertWithPicture`, will accept values for the `CategoryName`, `Description`, `BrochurePath`, and `Picture` columns and execute an `INSERT` statement that stores all four values in a new record.</span></span>

<span data-ttu-id="7ab4b-137">型指定されたデータセットを開くし、デザイナーを右クリックし、`CategoriesTableAdapter`のヘッダーとクエリの追加、コンテキスト メニューをクリックします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-137">Open the Typed DataSet and, from the Designer, right-click on the `CategoriesTableAdapter` s header and choose Add Query from the context menu.</span></span> <span data-ttu-id="7ab4b-138">これは、TableAdapter クエリがデータベースにアクセスする方法を求めてで開始する TableAdapter クエリ構成ウィザードを起動します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-138">This launches the TableAdapter Query Configuration Wizard, which begins by asking us how the TableAdapter query should access the database.</span></span> <span data-ttu-id="7ab4b-139">SQL ステートメントを使用を選択し、[次へ] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-139">Choose Use SQL statements and click Next.</span></span> <span data-ttu-id="7ab4b-140">次の手順は、生成されるクエリの種類に求めます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-140">The next step prompts for the type of query to be generated.</span></span> <span data-ttu-id="7ab4b-141">クエリを作成する新しいレコードを追加する re お以降、`Categories`テーブルを挿入を選択し、[次へ] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-141">Since we re creating a query to add a new record to the `Categories` table, choose INSERT and click Next.</span></span>


<span data-ttu-id="7ab4b-142">[![挿入オプションを選択します。](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-142">[![Select the INSERT Option](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.png)</span></span>

<span data-ttu-id="7ab4b-143">**図 1**: 挿入オプションを選択 ([フルサイズのイメージを表示するをクリックして](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="7ab4b-143">**Figure 1**: Select the INSERT Option ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.png))</span></span>


<span data-ttu-id="7ab4b-144">ここで指定する必要があります、 `INSERT` SQL ステートメント。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-144">We now need to specify the `INSERT` SQL statement.</span></span> <span data-ttu-id="7ab4b-145">ウィザードが自動的に提案、 `INSERT` TableAdapter のメインのクエリに対応するステートメント。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-145">The wizard automatically suggests an `INSERT` statement corresponding to the TableAdapter s main query.</span></span> <span data-ttu-id="7ab4b-146">ここで、s、`INSERT`を挿入するステートメント、 `CategoryName`、`Description`と`BrochurePath`値。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-146">In this case, it s an `INSERT` statement that inserts the `CategoryName`, `Description`, and `BrochurePath` values.</span></span> <span data-ttu-id="7ab4b-147">ステートメントを更新できるように、`Picture`列がと共に含まれる、`@Picture`パラメーター、次のようにします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-147">Update the statement so that the `Picture` column is included along with a `@Picture` parameter, like so:</span></span>


[!code-sql[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample1.sql)]

<span data-ttu-id="7ab4b-148">ウィザードの最終画面では、新しい TableAdapter メソッドの名前を付けることが求められます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-148">The final screen of the wizard asks us to name the new TableAdapter method.</span></span> <span data-ttu-id="7ab4b-149">入力`InsertWithPicture`[完了] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-149">Enter `InsertWithPicture` and click Finish.</span></span>


<span data-ttu-id="7ab4b-150">[![新しい TableAdapter メソッド InsertWithPicture の名前](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-150">[![Name the New TableAdapter Method InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.png)</span></span>

<span data-ttu-id="7ab4b-151">**図 2**: 新しい TableAdapter メソッド名前`InsertWithPicture`([フルサイズのイメージを表示するをクリックして](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="7ab4b-151">**Figure 2**: Name the New TableAdapter Method `InsertWithPicture` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.png))</span></span>


## <a name="step-2-updating-the-business-logic-layer"></a><span data-ttu-id="7ab4b-152">手順 2: ビジネス ロジック層を更新します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-152">Step 2: Updating the Business Logic Layer</span></span>

<span data-ttu-id="7ab4b-153">先ほど作成した DAL メソッドを呼び出す BLL メソッドを作成する必要があります、データ アクセス層に直接移動することをバイパスするのではなく、プレゼンテーション層がビジネス ロジック層とやり取りする必要がありますのみため (`InsertWithPicture`)。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-153">Since the Presentation Layer should only interface with the Business Logic Layer rather than bypassing it to go directly to the Data Access Layer, we need to create a BLL method that invokes the DAL method we just created (`InsertWithPicture`).</span></span> <span data-ttu-id="7ab4b-154">このチュートリアルでメソッドを作成、`CategoriesBLL`という名前のクラス`InsertWithPicture`3 つの入力として受け取る`String`s と`Byte`配列。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-154">For this tutorial, create a method in the `CategoriesBLL` class named `InsertWithPicture` that accepts as input three `String` s and a `Byte` array.</span></span> <span data-ttu-id="7ab4b-155">`String`入力パラメーターは、カテゴリの名前、説明、およびパンフレット ファイルのパス中に、`Byte`配列は、カテゴリの画像のバイナリ コンテンツ。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-155">The `String` input parameters are for the category s name, description, and brochure file path, while the `Byte` array is for the binary contents of the category s picture.</span></span> <span data-ttu-id="7ab4b-156">次のコードに示すこの BLL メソッドは、対応する DAL メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-156">As the following code shows, this BLL method invokes the corresponding DAL method:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample2.vb)]

> [!NOTE]
> <span data-ttu-id="7ab4b-157">追加する前に型指定されたデータセットを保存してあることを確認してください、 `InsertWithPicture` BLL メソッドです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-157">Make sure that you have saved the Typed DataSet before adding the `InsertWithPicture` method to the BLL.</span></span> <span data-ttu-id="7ab4b-158">以降、`CategoriesTableAdapter`クラス コードが自動生成された、型指定されたデータセットに基づいて、表示されない最初の変更を保存、型指定されたデータセット、 `Adapter` t が勝利したプロパティは次のトピック、`InsertWithPicture`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-158">Since the `CategoriesTableAdapter` class code is auto-generated based on the Typed DataSet, if you don t first save your changes to the Typed DataSet the `Adapter` property won t know about the `InsertWithPicture` method.</span></span>


## <a name="step-3-listing-the-existing-categories-and-their-binary-data"></a><span data-ttu-id="7ab4b-159">手順 3: 既存のカテゴリとバイナリ データを一覧表示します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-159">Step 3: Listing the Existing Categories and their Binary Data</span></span>

<span data-ttu-id="7ab4b-160">このチュートリアルでは、ページにより、システムに新しいカテゴリを追加するには、エンドユーザーを作成し、新しいカテゴリの画像とパンフレットを提供することはおです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-160">In this tutorial we will create a page that allows an end user to add a new category to the system, providing a picture and brochure for the new category.</span></span> <span data-ttu-id="7ab4b-161">[前のチュートリアル](displaying-binary-data-in-the-data-web-controls-vb.md)TemplateField ImageField と各カテゴリの名前を表示する GridView を使用しました説明、画像、およびそのパンフレットをダウンロードするリンクです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-161">In the [preceding tutorial](displaying-binary-data-in-the-data-web-controls-vb.md) we used a GridView with a TemplateField and ImageField to display each category s name, description, picture, and a link to download its brochure.</span></span> <span data-ttu-id="7ab4b-162">すべての既存カテゴリの一覧し、新規に作成するのには、両方のページを作成するこのチュートリアルでは、その機能をレプリケート s を使用できます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-162">Let s replicate that functionality for this tutorial, creating a page that both lists all existing categories and allows for new ones to be created.</span></span>

<span data-ttu-id="7ab4b-163">開いて開始、`DisplayOrDownload.aspx`ページから、`BinaryData`フォルダーです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-163">Start by opening the `DisplayOrDownload.aspx` page from the `BinaryData` folder.</span></span> <span data-ttu-id="7ab4b-164">ソース ビューに移動し、GridView と ObjectDataSource s 宣言の構文をコピー、内で貼り付けることにより、`<asp:Content>`内の要素`UploadInDetailsView.aspx`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-164">Go to the Source view and copy the GridView and ObjectDataSource s declarative syntax, pasting it within the `<asp:Content>` element in `UploadInDetailsView.aspx`.</span></span> <span data-ttu-id="7ab4b-165">また、しないことを忘れがちに経由でコピー、`GenerateBrochureLink`の分離コード クラスのメソッドの`DisplayOrDownload.aspx`に`UploadInDetailsView.aspx`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-165">Also, don t forget to copy over the `GenerateBrochureLink` method from the code-behind class of `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx`.</span></span>


<span data-ttu-id="7ab4b-166">[![コピーして貼り付ける UploadInDetailsView.aspx に DisplayOrDownload.aspx から宣言の構文](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-166">[![Copy and Paste the Declarative Syntax from DisplayOrDownload.aspx to UploadInDetailsView.aspx](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.png)</span></span>

<span data-ttu-id="7ab4b-167">**図 3**: コピーしてから、宣言の構文を貼り付ける`DisplayOrDownload.aspx`に`UploadInDetailsView.aspx`([フルサイズのイメージを表示するをクリックして](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="7ab4b-167">**Figure 3**: Copy and Paste the Declarative Syntax from `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.png))</span></span>


<span data-ttu-id="7ab4b-168">宣言の構文をコピーした後、`GenerateBrochureLink`経由でメソッドを`UploadInDetailsView.aspx` ページで、すべてのものが正しくコピーされたことを確認するブラウザーでページを表示します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-168">After copying the declarative syntax and `GenerateBrochureLink` method over to the `UploadInDetailsView.aspx` page, view the page through a browser to ensure that everything was copied over correctly.</span></span> <span data-ttu-id="7ab4b-169">パンフレットだけでなくカテゴリの画像をダウンロードするリンクを含む 8 つのカテゴリを一覧表示する GridView が表示されます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-169">You should see a GridView listing the eight categories that includes a link to download the brochure as well as the category s picture.</span></span>


<span data-ttu-id="7ab4b-170">[![各カテゴリのバイナリ データと共に表示されます。](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-170">[![You Should Now See Each Category Along with Its Binary Data](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.png)</span></span>

<span data-ttu-id="7ab4b-171">**図 4**: する必要がありますようになりました「各カテゴリ沿ったのバイナリ データを ([フルサイズのイメージを表示するには、をクリックして](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="7ab4b-171">**Figure 4**: You Should Now See Each Category Along with Its Binary Data ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.png))</span></span>


## <a name="step-4-configuring-thecategoriesdatasourceto-support-inserting"></a><span data-ttu-id="7ab4b-172">ステップ 4: 構成、`CategoriesDataSource`サポートを挿入するには</span><span class="sxs-lookup"><span data-stu-id="7ab4b-172">Step 4: Configuring the`CategoriesDataSource`to Support Inserting</span></span>

<span data-ttu-id="7ab4b-173">`CategoriesDataSource` ObjectDataSource を使用して、 `Categories` GridView が現在データを挿入する機能では行いません。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-173">The `CategoriesDataSource` ObjectDataSource used by the `Categories` GridView currently does not provide the ability to insert data.</span></span> <span data-ttu-id="7ab4b-174">このデータ ソース コントロールからの挿入をサポートするためにマップするお必要があります。 その`Insert`その基になるオブジェクトのメソッドにメソッド`CategoriesBLL`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-174">In order to support inserting through this data source control, we need to map its `Insert` method to a method in its underlying object, `CategoriesBLL`.</span></span> <span data-ttu-id="7ab4b-175">具体的にマップする、`CategoriesBLL`メソッドのステップ 2 で再び追加お`InsertWithPicture`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-175">In particular, we want to map it to the `CategoriesBLL` method we added back in Step 2, `InsertWithPicture`.</span></span>

<span data-ttu-id="7ab4b-176">ObjectDataSource s のスマート タグからのデータ ソースの構成のリンクをクリックして開始します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-176">Start by clicking the Configure Data Source link from the ObjectDataSource s smart tag.</span></span> <span data-ttu-id="7ab4b-177">最初の画面は、データ ソースを構成すると、オブジェクトを示しています。`CategoriesBLL`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-177">The first screen shows the object the data source is configured to work with, `CategoriesBLL`.</span></span> <span data-ttu-id="7ab4b-178">としてこの設定をそのままで、およびデータ メソッドの定義の画面に詳細の横にあるをクリックします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-178">Leave this setting as-is and click Next to advance to the Define Data Methods screen.</span></span> <span data-ttu-id="7ab4b-179">[挿入] タブに移動し、選択、`InsertWithPicture`ドロップダウン リストからメソッドです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-179">Move to the INSERT tab and pick the `InsertWithPicture` method from the drop-down list.</span></span> <span data-ttu-id="7ab4b-180">ウィザードを完了するには、[完了] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-180">Click Finish to complete the wizard.</span></span>


<span data-ttu-id="7ab4b-181">[![ObjectDataSource InsertWithPicture メソッドを使用して構成します。](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-181">[![Configure the ObjectDataSource to use the InsertWithPicture Method](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.png)</span></span>

<span data-ttu-id="7ab4b-182">**図 5**: 構成を使用する ObjectDataSource、`InsertWithPicture`メソッド ([フルサイズのイメージを表示するをクリックして](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="7ab4b-182">**Figure 5**: Configure the ObjectDataSource to use the `InsertWithPicture` Method ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.png))</span></span>


> [!NOTE]
> <span data-ttu-id="7ab4b-183">ウィザードを完了すると、Visual Studio を要求するフィールドの更新およびキーにする場合は、Web のデータが再生成するフィールドを制御します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-183">Upon completing the wizard, Visual Studio may ask if you want to Refresh Fields and Keys, which will regenerate the data Web controls fields.</span></span> <span data-ttu-id="7ab4b-184">はい を選択すると、フィールドが加えたカスタマイズは上書きためいいえ を選択します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-184">Choose No, because choosing Yes will overwrite any field customizations you may have made.</span></span>


<span data-ttu-id="7ab4b-185">ウィザードの完了後に、ObjectDataSource は今すぐの値を含めるその`InsertMethod`プロパティだけでなく`InsertParameters`の 4 つのカテゴリ列として、次の宣言型マークアップを示しています。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-185">After completing the wizard, the ObjectDataSource will now include a value for its `InsertMethod` property as well as `InsertParameters` for the four category columns, as the following declarative markup illustrates:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample3.aspx)]

## <a name="step-5-creating-the-inserting-interface"></a><span data-ttu-id="7ab4b-186">手順 5: 挿入インターフェイスの作成</span><span class="sxs-lookup"><span data-stu-id="7ab4b-186">Step 5: Creating the Inserting Interface</span></span>

<span data-ttu-id="7ab4b-187">最初に、説明、 [、概要の挿入、更新、およびデータの削除](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md)、DetailsView コントロールの挿入をサポートするデータ ソース コントロールを操作するときに使用できる組み込みの挿入インターフェイスを提供します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-187">As first covered in the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md), the DetailsView control provides a built-in inserting interface that can be utilized when working with a data source control that supports inserting.</span></span> <span data-ttu-id="7ab4b-188">S DetailsView コントロールを簡単に新しいカテゴリを追加するユーザーを許可する、挿入するインターフェイスを完全に表示する GridView の上には、このページを追加できるようにします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-188">Let s add a DetailsView control to this page above the GridView that will permanently render its inserting interface, allowing a user to quickly add a new category.</span></span> <span data-ttu-id="7ab4b-189">DetailsView で新しいカテゴリを追加したときにその下位にある GridView は自動的に更新し、新しいカテゴリを表示します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-189">Upon adding a new category in the DetailsView, the GridView beneath it will automatically refresh and display the new category.</span></span>

<span data-ttu-id="7ab4b-190">DetailsView を設定、GridView 上のデザイナーには、ツールボックスからドラッグして開始その`ID`プロパティを`NewCategory`を消去して、`Height`と`Width`プロパティの値。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-190">Start by dragging a DetailsView from the Toolbox onto the Designer above the GridView, setting its `ID` property to `NewCategory` and clearing out the `Height` and `Width` property values.</span></span> <span data-ttu-id="7ab4b-191">DetailsView s のスマート タグからにバインドして、既存の`CategoriesDataSource`し、挿入を有効にする チェック ボックスを確認します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-191">From the DetailsView s smart tag, bind it to the existing `CategoriesDataSource` and then check the Enable Inserting checkbox.</span></span>


<span data-ttu-id="7ab4b-192">[![DetailsView を CategoriesDataSource にバインドし、挿入を有効にします。](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-192">[![Bind the DetailsView to the CategoriesDataSource and Enable Inserting](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.png)</span></span>

<span data-ttu-id="7ab4b-193">**図 6**: を DetailsView のバインド、`CategoriesDataSource`と挿入を有効にする ([フルサイズのイメージを表示するをクリックして](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="7ab4b-193">**Figure 6**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image12.png))</span></span>


<span data-ttu-id="7ab4b-194">挿入するインターフェイスに DetailsView を完全に表示するには、するために次のように設定します。 その`DefaultMode`プロパティを`Insert`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-194">To permanently render the DetailsView in its inserting interface, set its `DefaultMode` property to `Insert`.</span></span>

<span data-ttu-id="7ab4b-195">DetailsView に 5 つ BoundFields 注`CategoryID`、 `CategoryName`、 `Description`、 `NumberOfProducts`、および`BrochurePath`ですが、`CategoryID`挿入インターフェイスでは、ため BoundField はレンダリングされませんその`InsertVisible`プロパティに設定されている`False`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-195">Note that the DetailsView has five BoundFields `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, and `BrochurePath` although the `CategoryID` BoundField is not rendered in the inserting interface because its `InsertVisible` property is set to `False`.</span></span> <span data-ttu-id="7ab4b-196">によって返される列であるために、これらの BoundFields が存在する、`GetCategories()`メソッドを ObjectDataSource の起動をそのデータを取得します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-196">These BoundFields exists because they are the columns returned by the `GetCategories()` method, which is what the ObjectDataSource invokes to retrieve its data.</span></span> <span data-ttu-id="7ab4b-197">挿入すると、ただし、たくないユーザーが値を指定できるようにする`NumberOfProducts`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-197">For inserting, however, we don t want to let the user specify a value for `NumberOfProducts`.</span></span> <span data-ttu-id="7ab4b-198">さらに、新しいカテゴリの画像のアップロードし、パンフレットの PDF をアップロードできるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-198">Moreover, we need to allow them to upload a picture for the new category as well as upload a PDF for the brochure.</span></span>

<span data-ttu-id="7ab4b-199">削除、 `NumberOfProducts` DetailsView を完全とし、更新プログラムから BoundField、`HeaderText`のプロパティ、`CategoryName`と`BrochurePath`BoundFields カテゴリとパンフレットをそれぞれします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-199">Remove the `NumberOfProducts` BoundField from the DetailsView altogether and then update the `HeaderText` properties of the `CategoryName` and `BrochurePath` BoundFields to Category and Brochure, respectively.</span></span> <span data-ttu-id="7ab4b-200">次に、変換、`BrochurePath`を TemplateField BoundField この新しい TemplateField を与える、画像の新しい TemplateField を追加し、`HeaderText`画像の値。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-200">Next, convert the `BrochurePath` BoundField into a TemplateField and add a new TemplateField for the picture, giving this new TemplateField a `HeaderText` value of Picture.</span></span> <span data-ttu-id="7ab4b-201">移動、 `Picture` TemplateField 間ように、 `BrochurePath` TemplateField と CommandField です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-201">Move the `Picture` TemplateField so that it is between the `BrochurePath` TemplateField and CommandField.</span></span>


![DetailsView を CategoriesDataSource にバインドし、挿入を有効にします。](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.gif)

<span data-ttu-id="7ab4b-203">**図 7**: を DetailsView のバインド、`CategoriesDataSource`挿入を有効にし、</span><span class="sxs-lookup"><span data-stu-id="7ab4b-203">**Figure 7**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting</span></span>


<span data-ttu-id="7ab4b-204">変換する場合、`BrochurePath`フィールドの編集 ダイアログ ボックスで TemplateField に BoundField、TemplateField が含まれています、 `ItemTemplate`、 `EditItemTemplate`、および`InsertItemTemplate`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-204">If you converted the `BrochurePath` BoundField into a TemplateField through the Edit Fields dialog box, the TemplateField includes an `ItemTemplate`, `EditItemTemplate`, and `InsertItemTemplate`.</span></span> <span data-ttu-id="7ab4b-205">のみ、`InsertItemTemplate`は必要に応じて、ただし、制限はないので、他の 2 つのテンプレートを削除します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-205">Only the `InsertItemTemplate` is needed, however, so feel free to remove the other two templates.</span></span> <span data-ttu-id="7ab4b-206">この時点で DetailsView s の宣言構文は次のようになります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-206">At this point your DetailsView s declarative syntax should look like the following:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample4.aspx)]

## <a name="adding-fileupload-controls-for-the-brochure-and-picture-fields"></a><span data-ttu-id="7ab4b-207">画像フィールドとパンフレットのファイルアップロード コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-207">Adding FileUpload Controls for the Brochure and Picture Fields</span></span>

<span data-ttu-id="7ab4b-208">現在、 `BrochurePath` TemplateField s `InsertItemTemplate` 、テキスト ボックスを含む中に、 `Picture` TemplateField に任意のテンプレートが含まれていません。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-208">Presently, the `BrochurePath` TemplateField s `InsertItemTemplate` contains a TextBox, while the `Picture` TemplateField does not contain any templates.</span></span> <span data-ttu-id="7ab4b-209">これら 2 つの TemplateField %s を更新する必要があります`InsertItemTemplate`ファイルアップロード コントロールを使用しています。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-209">We need to update these two TemplateField s `InsertItemTemplate` s to use FileUpload controls.</span></span>

<span data-ttu-id="7ab4b-210">DetailsView s のスマート タグからのテンプレートの編集 オプションを選択してから、 `BrochurePath` TemplateField の`InsertItemTemplate`ドロップダウン リストからです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-210">From the DetailsView s smart tag, choose the Edit Templates option and then select the `BrochurePath` TemplateField s `InsertItemTemplate` from the drop-down list.</span></span> <span data-ttu-id="7ab4b-211">テキスト ボックスを削除し、テンプレートに、ツールボックスからファイルアップロード コントロールをドラッグします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-211">Remove the TextBox and then drag a FileUpload control from the Toolbox into the template.</span></span> <span data-ttu-id="7ab4b-212">ファイルアップロード コントロール s 設定`ID`に`BrochureUpload`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-212">Set the FileUpload control s `ID` to `BrochureUpload`.</span></span> <span data-ttu-id="7ab4b-213">同様に、ファイルアップロード コントロールを追加、 `Picture` TemplateField の`InsertItemTemplate`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-213">Similarly, add a FileUpload control to the `Picture` TemplateField s `InsertItemTemplate`.</span></span> <span data-ttu-id="7ab4b-214">このファイルアップロード コントロール s 設定`ID`に`PictureUpload`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-214">Set this FileUpload control s `ID` to `PictureUpload`.</span></span>


<span data-ttu-id="7ab4b-215">[![後にファイルアップロード コントロールを追加します。](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-215">[![Add a FileUpload Control to the InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image13.png)</span></span>

<span data-ttu-id="7ab4b-216">**図 8**: するファイルアップロード コントロールを追加、 `InsertItemTemplate` ([フルサイズのイメージを表示するをクリックして](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="7ab4b-216">**Figure 8**: Add a FileUpload Control to the `InsertItemTemplate` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image14.png))</span></span>


<span data-ttu-id="7ab4b-217">これらの追加を行った後 TemplateField s の 2 つの宣言構文になります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-217">After making these additions, the two TemplateField s declarative syntax will be:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample5.aspx)]

<span data-ttu-id="7ab4b-218">ユーザーが、新しいカテゴリを追加するパンフレットと画像が、正しいファイルの種類があることを確認します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-218">When a user adds a new category, we want to ensure that the brochure and picture are of the correct file type.</span></span> <span data-ttu-id="7ab4b-219">パンフレット、ユーザーは、PDF を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-219">For the brochure, the user must supply a PDF.</span></span> <span data-ttu-id="7ab4b-220">画像のユーザーが、イメージ ファイルをアップロードする必要がありますが、許可お*任意*画像のファイルまたは Gif、Jpg など、特定の種類のイメージ ファイルだけですか?</span><span class="sxs-lookup"><span data-stu-id="7ab4b-220">For the picture, we need the user to upload an image file, but do we allow *any* image file or only image files of a particular type, such as GIFs or JPGs?</span></span> <span data-ttu-id="7ab4b-221">別のファイルの種類を許容するのには d 必要がありますを拡張する、`Categories`この型を使用してクライアントに送信することができるように、ファイルの種類をキャプチャする列を含めるようにスキーマ`Response.ContentType`で`DisplayCategoryPicture.aspx`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-221">In order to allow for different file types, we d need to extend the `Categories` schema to include a column that captures the file type so that this type can be sent to the client through `Response.ContentType` in `DisplayCategoryPicture.aspx`.</span></span> <span data-ttu-id="7ab4b-222">T たくないこのような列があるため、のみ型を提供する、特定のイメージ ファイルにユーザーを制限する賢明になります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-222">Since we don t have such a column, it would be prudent to restrict users to only providing a specific image file type.</span></span> <span data-ttu-id="7ab4b-223">`Categories`テーブル %s の既存のイメージがビットマップがの Jpg イメージの場合、web 経由で提供された適切なファイル形式。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-223">The `Categories` table s existing images are bitmaps, but JPGs are a more appropriate file format for images served over the web.</span></span>

<span data-ttu-id="7ab4b-224">ユーザーが、正しくないファイルの種類をアップロードする場合、挿入をキャンセルし、問題を示すメッセージを表示する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-224">If a user uploads an incorrect file type, we need to cancel the insert and display a message indicating the problem.</span></span> <span data-ttu-id="7ab4b-225">DetailsView の下にラベル Web コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-225">Add a Label Web control beneath the DetailsView.</span></span> <span data-ttu-id="7ab4b-226">設定の`ID`プロパティを`UploadWarning`をクリア、その`Text`プロパティを設定、`CssClass`が警告にプロパティと`Visible`と`EnableViewState`プロパティを`False`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-226">Set its `ID` property to `UploadWarning`, clear out its `Text` property, set the `CssClass` property to Warning, and the `Visible` and `EnableViewState` properties to `False`.</span></span> <span data-ttu-id="7ab4b-227">`Warning`で CSS クラスが定義されている`Styles.css`大きな、赤、斜体、太字のフォントでテキストを表示します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-227">The `Warning` CSS class is defined in `Styles.css` and renders the text in a large, red, italicized, bold font.</span></span>

> [!NOTE]
> <span data-ttu-id="7ab4b-228">理想的には、`CategoryName`と`Description`BoundFields TemplateFields とカスタマイズの挿入のインターフェイスに変換されます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-228">Ideally, the `CategoryName` and `Description` BoundFields would be converted to TemplateFields and their inserting interfaces customized.</span></span> <span data-ttu-id="7ab4b-229">`Description`インターフェイスなどの挿入は可能性がありますより適切なを通じて複数行テキスト ボックス。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-229">The `Description` inserting interface, for example, would likely be better suited through a multi-line textbox.</span></span> <span data-ttu-id="7ab4b-230">`CategoryName`列は受け入れません`NULL`値、ユーザーが、新しいカテゴリの名の値を提供することを確認する、RequiredFieldValidator を追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-230">And since the `CategoryName` column does not accept `NULL` values, a RequiredFieldValidator should be added to ensure the user provides a value for the new category s name.</span></span> <span data-ttu-id="7ab4b-231">次の手順は、演習として、リーダーに残されます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-231">These steps are left as an exercise to the reader.</span></span> <span data-ttu-id="7ab4b-232">参照[データ変更インターフェイスのカスタマイズ](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md)のデータ変更インターフェイスの拡張について詳しく説明します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-232">Refer back to [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md) for an in-depth look at augmenting the data modification interfaces.</span></span>


## <a name="step-6-saving-the-uploaded-brochure-to-the-web-server-s-file-system"></a><span data-ttu-id="7ab4b-233">手順 6: アップロードされたパンフレットを Web サーバーのファイル システムに保存します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-233">Step 6: Saving the Uploaded Brochure to the Web Server s File System</span></span>

<span data-ttu-id="7ab4b-234">ユーザーは、新しいカテゴリの値を入力、[挿入] ボタンをクリックすると、ポストバックが発生して挿入するワークフロー。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-234">When the user enters the values for a new category and clicks the Insert button, a postback occurs and the inserting workflow unfolds.</span></span> <span data-ttu-id="7ab4b-235">最初に、DetailsView s [ `ItemInserting`イベント](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx)発生します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-235">First, the DetailsView s [`ItemInserting` event](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx) fires.</span></span> <span data-ttu-id="7ab4b-236">次に、ObjectDataSource s`Insert()`メソッドが呼び出され、その結果は、新しいレコードに追加されている、`Categories`テーブル。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-236">Next, the ObjectDataSource s `Insert()` method is invoked, which results in a new record being added to the `Categories` table.</span></span> <span data-ttu-id="7ab4b-237">その後、DetailsView s [ `ItemInserted`イベント](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx)発生します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-237">After that, the DetailsView s [`ItemInserted` event](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx) fires.</span></span>

<span data-ttu-id="7ab4b-238">ObjectDataSource s 前に`Insert()`メソッドが呼び出されるを適切なファイルの種類がユーザーによってアップロードされたことを最初に確認をしパンフレット PDF web サーバーのファイル システムに保存する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-238">Before the ObjectDataSource s `Insert()` method is invoked, we must first ensure that the appropriate file types were uploaded by the user and then save the brochure PDF to the web server s file system.</span></span> <span data-ttu-id="7ab4b-239">DetailsView s のイベント ハンドラーを作成`ItemInserting`イベントし、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-239">Create an event handler for the DetailsView s `ItemInserting` event and add the following code:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample6.vb)]

<span data-ttu-id="7ab4b-240">参照することによって、イベント ハンドラーを開始、 `BrochureUpload` DetailsView のテンプレートからファイルアップロード コントロール。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-240">The event handler starts by referencing the `BrochureUpload` FileUpload control from the DetailsView s templates.</span></span> <span data-ttu-id="7ab4b-241">次に、カタログがアップロードされた場合、アップロードされたファイルの拡張機能が検査されます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-241">Then, if a brochure has been uploaded, the uploaded file s extension is examined.</span></span> <span data-ttu-id="7ab4b-242">拡張機能がない場合です。PDF、し、警告が表示されます、insert は取り消され、イベント ハンドラーの実行が終了します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-242">If the extension is not .PDF, then a warning is displayed, the insert is cancelled, and the execution of the event handler ends.</span></span>

> [!NOTE]
> <span data-ttu-id="7ab4b-243">アップロードされたファイルの拡張機能に証明書利用者がアップロードされたファイルには、PDF ドキュメントを確保するための手法を確実です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-243">Relying on the uploaded file s extension is not a sure-fire technique for ensuring that the uploaded file is a PDF document.</span></span> <span data-ttu-id="7ab4b-244">ユーザーが拡張子を持つ有効な PDF ドキュメントを持つでした`.Brochure`、または非 PDF ドキュメントを取得、その可能性があります、`.pdf`拡張機能です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-244">The user could have a valid PDF document with the extension `.Brochure`, or could have taken a non-PDF document and given it a `.pdf` extension.</span></span> <span data-ttu-id="7ab4b-245">ファイル %s のバイナリ コンテンツは、確定複数ファイルの種類を確認するためにプログラムで調査する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-245">The file s binary content would need to be programmatically examined in order to more conclusively verify the file type.</span></span> <span data-ttu-id="7ab4b-246">このような完全なアプローチも多くの場合、過剰です。拡張機能のチェックはほとんどのシナリオです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-246">Such thorough approaches, though, are often overkill; checking the extension is sufficient for most scenarios.</span></span>


<span data-ttu-id="7ab4b-247">説明したように、[ファイルのアップロード](uploading-files-vb.md)チュートリアルでは、注意する必要がある 1 人のユーザーのアップロードで別の s が上書きされないように、ファイル システムにファイルの保存時にします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-247">As discussed in the [Uploading Files](uploading-files-vb.md) tutorial, care must be taken when saving files to the file system so that one user s upload does not overwrite another s.</span></span> <span data-ttu-id="7ab4b-248">このチュートリアルでは、アップロードされたファイルと同じ名前を使用を試みます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-248">For this tutorial we will attempt to use the same name as the uploaded file.</span></span> <span data-ttu-id="7ab4b-249">内のファイルが既に存在する場合、`~/Brochures`を同じファイル名で、ただし、ディレクトリおあります番号を追加、末尾に一意の名前が見つかるまでです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-249">If there already exists a file in the `~/Brochures` directory with that same file name, however, we'll append a number at the end until a unique name is found.</span></span> <span data-ttu-id="7ab4b-250">たとえば、ユーザーが名前付きパンフレット ファイルをアップロード`Meats.pdf`、という名前のファイルが既に存在が`Meats.pdf`で、`~/Brochures`フォルダーおを保存するファイル名を変更します`Meats-1.pdf`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-250">For example, if the user uploads a brochure file named `Meats.pdf`, but there is already a file named `Meats.pdf` in the `~/Brochures` folder, we'll change the saved file name to `Meats-1.pdf`.</span></span> <span data-ttu-id="7ab4b-251">存在する場合を見ていきます`Meats-2.pdf`など、一意のファイル名が見つかるまでです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-251">If that exists, we'll try `Meats-2.pdf`, and so on, until a unique file name is found.</span></span>

<span data-ttu-id="7ab4b-252">次のコードでは、 [ `File.Exists(path)`メソッド](https://msdn.microsoft.com/en-us/library/system.io.file.exists.aspx)を指定したファイル名のファイルが既に存在するかどうかを判断します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-252">The following code uses the [`File.Exists(path)` method](https://msdn.microsoft.com/en-us/library/system.io.file.exists.aspx) to determine if a file already exists with the specified file name.</span></span> <span data-ttu-id="7ab4b-253">場合は、しようとパンフレットを新しいファイル名の競合が見つからなくなるまで続行します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-253">If so, it continues to try new file names for the brochure until no conflict is found.</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample7.vb)]

<span data-ttu-id="7ab4b-254">ファイルをファイル システムと ObjectDataSource s に保存する必要がある有効なファイル名が見つかった後、`brochurePath``InsertParameter`値は、このファイル名がデータベースに書き込まれるように更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-254">Once a valid file name has been found, the file needs to be saved to the file system and the ObjectDataSource s `brochurePath``InsertParameter` value needs to be updated so that this file name is written to the database.</span></span> <span data-ttu-id="7ab4b-255">バックアップで示したように、*ファイルのアップロード*チュートリアルでは、ファイルを保存する s ファイルアップロード コントロールを使用して`SaveAs(path)`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-255">As we saw back in the *Uploading Files* tutorial, the file can be saved using the FileUpload control s `SaveAs(path)` method.</span></span> <span data-ttu-id="7ab4b-256">ObjectDataSource %s を更新する`brochurePath`パラメーターを使用して、`e.Values`コレクション。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-256">To update the ObjectDataSource s `brochurePath` parameter, use the `e.Values` collection.</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample8.vb)]

## <a name="step-7-saving-the-uploaded-picture-to-the-database"></a><span data-ttu-id="7ab4b-257">手順 7: データベースにアップロードされた画像を保存します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-257">Step 7: Saving the Uploaded Picture to the Database</span></span>

<span data-ttu-id="7ab4b-258">新たにアップロードされた画像を格納する`Categories`レコード、いただくために、ObjectDataSource s にアップロードされたバイナリ コンテンツを割り当てる`picture`DetailsView s パラメーター`ItemInserting`イベント。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-258">To store the uploaded picture in the new `Categories` record, we need to assign the uploaded binary content to the ObjectDataSource s `picture` parameter in the DetailsView s `ItemInserting` event.</span></span> <span data-ttu-id="7ab4b-259">ただし、この割り当てを行う場合、前に、最初にアップロードされた画像が、JPG およびいないその他のイメージの種類であることを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-259">Before we make this assignment, however, we need to first make sure that the uploaded picture is a JPG and not some other image type.</span></span> <span data-ttu-id="7ab4b-260">手順 6 のようにその型を確認するためにアップロードされた画像のファイル拡張子を使用して s を使用できます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-260">As in Step 6, let s use the uploaded picture s file extension to ascertain its type.</span></span>

<span data-ttu-id="7ab4b-261">中に、`Categories`テーブルでは、`NULL`の値を`Picture`画像がある列で、現在のすべてのカテゴリ。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-261">While the `Categories` table allows `NULL` values for the `Picture` column, all categories currently have a picture.</span></span> <span data-ttu-id="7ab4b-262">S 強制的にこのページで、新しいカテゴリを追加するときに、画像を提供するユーザーを使用できます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-262">Let s force the user to provide a picture when adding a new category through this page.</span></span> <span data-ttu-id="7ab4b-263">次のコードは、画像がアップロードされていると、適切な拡張機能を使用していることを確認することを確認します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-263">The following code checks to ensure that a picture has been uploaded and that it has an appropriate extension.</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample9.vb)]

<span data-ttu-id="7ab4b-264">このコードを配置する必要があります*する前に*手順 6. からコード画像アップロード中に問題がある場合、イベント ハンドラーはパンフレット ファイルは、ファイル システムに保存する前に終了できるようにします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-264">This code should be placed *before* the code from Step 6 so that if there is a problem with the picture upload, the event handler will terminate before the brochure file is saved to the file system.</span></span>

<span data-ttu-id="7ab4b-265">を適切なファイルがアップロードされたと想定されるは、次のコード行で画像パラメーター s の値にアップロード済みのバイナリ コンテンツを割り当てます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-265">Assuming that an appropriate file has been uploaded, assign the uploaded binary content to the picture parameter s value with the following line of code:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample10.vb)]

## <a name="the-completeiteminsertingevent-handler"></a><span data-ttu-id="7ab4b-266">完全な`ItemInserting`イベント ハンドラー</span><span class="sxs-lookup"><span data-stu-id="7ab4b-266">The Complete`ItemInserting`Event Handler</span></span>

<span data-ttu-id="7ab4b-267">完全を期すのためここでは、`ItemInserting`全体のイベント ハンドラー。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-267">For completeness, here is the `ItemInserting` event handler in its entirety:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample11.vb)]

## <a name="step-8-fixing-thedisplaycategorypictureaspxpage"></a><span data-ttu-id="7ab4b-268">手順 8: 修正、`DisplayCategoryPicture.aspx`ページ</span><span class="sxs-lookup"><span data-stu-id="7ab4b-268">Step 8: Fixing the`DisplayCategoryPicture.aspx`Page</span></span>

<span data-ttu-id="7ab4b-269">Let s をとって、挿入するインターフェイスをテストし、`ItemInserting`いくつかの手順が最後に作成されたイベント ハンドラー。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-269">Let s take a moment to test out the inserting interface and `ItemInserting` event handler that was created over the last few steps.</span></span> <span data-ttu-id="7ab4b-270">参照してください、`UploadInDetailsView.aspx`しようと、カテゴリを追加するが、画像を省略すると、ブラウザー内でページまたは非 JPG 画像または PDF 以外パンフレットを指定します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-270">Visit the `UploadInDetailsView.aspx` page through a browser and attempt to add a category, but omit the picture, or specify a non-JPG picture or a non-PDF brochure.</span></span> <span data-ttu-id="7ab4b-271">このような場合も、エラー メッセージが表示され、挿入のワークフローが取り消されました。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-271">In any of these cases, an error message will be displayed and the insert workflow cancelled.</span></span>


<span data-ttu-id="7ab4b-272">[![警告メッセージが表示される場合は、無効なファイルの種類がアップロードされます。](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-272">[![A Warning Message is Displayed If an Invalid File Type is Uploaded](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image15.png)</span></span>

<span data-ttu-id="7ab4b-273">**図 9**: A 警告メッセージが表示される場合は、無効なファイルの種類がアップロードされる ([フルサイズのイメージを表示するをクリックして](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="7ab4b-273">**Figure 9**: A Warning Message is Displayed If an Invalid File Type is Uploaded ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image16.png))</span></span>


<span data-ttu-id="7ab4b-274">確認した後、ページ、画像をアップロードして受注 t PDF 以外または非 JPG ファイルを受け入れ、有効な JPG 図を使って新しいカテゴリを追加パンフレット フィールドを空のままです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-274">Once you have verified that the page requires a picture to be uploaded and won t accept non-PDF or non-JPG files, add a new category with a valid JPG picture, leaving the Brochure field empty.</span></span> <span data-ttu-id="7ab4b-275">[挿入] ボタンをクリックすると、ページがポストバックをし、新しいレコードに追加されます、`Categories`データベースに直接格納されているアップロードされた画像のバイナリ コンテンツを含むテーブル。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-275">After clicking the Insert button, the page will postback and a new record will be added to the `Categories` table with the uploaded image s binary contents stored directly in the database.</span></span> <span data-ttu-id="7ab4b-276">GridView が更新され、新しく追加されたカテゴリに属している行を示していますが、図 10 では、新しいカテゴリの画像は正しく表示されません。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-276">The GridView is updated and shows a row for the newly added category, but, as Figure 10 shows, the new category s picture is not rendered correctly.</span></span>


<span data-ttu-id="7ab4b-277">[![新しいカテゴリの画像が表示されていない s](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-277">[![The New Category s Picture is not Displayed](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image17.png)</span></span>

<span data-ttu-id="7ab4b-278">**図 10**: 画像が表示されていない新しいカテゴリ s ([フルサイズのイメージを表示するをクリックして](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="7ab4b-278">**Figure 10**: The New Category s Picture is not Displayed ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image18.png))</span></span>


<span data-ttu-id="7ab4b-279">新しい画像が表示されないためにです、`DisplayCategoryPicture.aspx`いるビットマップを OLE ヘッダーを処理する、指定したカテゴリの画像を返すページが構成されています。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-279">The reason the new picture is not displayed is because the `DisplayCategoryPicture.aspx` page that returns a specified category s picture is configured to process bitmaps that have an OLE header.</span></span> <span data-ttu-id="7ab4b-280">この 78 バイトのヘッダーはから削除されて、`Picture`送信される前に、の column のバイナリ コンテンツがクライアントにバックアップします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-280">This 78 byte header is stripped from the `Picture` column s binary contents before they are sent back to the client.</span></span> <span data-ttu-id="7ab4b-281">新しいカテゴリの JPG ファイル アップロードしたには、この OLE ヘッダーはありません。そのため、画像のバイナリ データから必要な有効なバイトを削除しています。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-281">But the JPG file we just uploaded for the new category does not have this OLE header; therefore, valid, necessary bytes are being removed from the image s binary data.</span></span>

<span data-ttu-id="7ab4b-282">今すぐ OLE ヘッダーとで Jpg を両方のビットマップがあるため、`Categories`テーブルを更新する必要があります`DisplayCategoryPicture.aspx`OLE ヘッダーは、元の 8 つのカテゴリを削除し、この新しいカテゴリ レコードの削除をバイパスできるようにします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-282">Since there are now both bitmaps with OLE headers and JPGs in the `Categories` table, we need to update `DisplayCategoryPicture.aspx` so that it does the OLE header stripping for the original eight categories and bypasses this stripping for the newer category records.</span></span> <span data-ttu-id="7ab4b-283">次のチュートリアルについて確認を既存のレコードのイメージを更新する方法とは、Jpg ようにすべての古いカテゴリ画像が更新されます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-283">In our next tutorial we'll examine how to update an existing record s image, and we'll update all of the old category pictures so that they are JPGs.</span></span> <span data-ttu-id="7ab4b-284">ここでは、次のコードを使用して、`DisplayCategoryPicture.aspx`をその元の 8 つのカテゴリに対してのみ OLE ヘッダーを取り除きます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-284">For now, though, use the following code in `DisplayCategoryPicture.aspx` to strip the OLE headers only for those original eight categories:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample12.vb)]

<span data-ttu-id="7ab4b-285">この変更により、JPG イメージは、今すぐ正しくレンダリング GridView でします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-285">With this change, the JPG image is now rendered correctly in the GridView.</span></span>


<span data-ttu-id="7ab4b-286">[![新しいカテゴリの JPG イメージは正しくレンダリングされます。](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-286">[![The JPG Images for New Categories are Correctly Rendered](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image19.png)</span></span>

<span data-ttu-id="7ab4b-287">**図 11**: 新しいカテゴリの JPG イメージは正しくレンダリングされます ([フルサイズのイメージを表示するをクリックして](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="7ab4b-287">**Figure 11**: The JPG Images for New Categories are Correctly Rendered ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image20.png))</span></span>


## <a name="step-9-deleting-the-brochure-in-the-face-of-an-exception"></a><span data-ttu-id="7ab4b-288">手順 9: 削除例外発生した場合にパンフレット</span><span class="sxs-lookup"><span data-stu-id="7ab4b-288">Step 9: Deleting the Brochure in the Face of an Exception</span></span>

<span data-ttu-id="7ab4b-289">バイナリ データを格納する web サーバーのファイル システム上の課題の 1 つは、データ モデルとそのバイナリ データの間での切断が発生します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-289">One of the challenges of storing binary data on the web server s file system is that it introduces a disconnect between the data model and its binary data.</span></span> <span data-ttu-id="7ab4b-290">そのため、レコードが削除されると、ファイル システムに対応するバイナリ データも削除してください。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-290">Therefore, whenever a record is deleted, the corresponding binary data on the file system must also be removed.</span></span> <span data-ttu-id="7ab4b-291">これは、ことができますになるように挿入すると、同様にします。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-291">This can come into play when inserting, as well.</span></span> <span data-ttu-id="7ab4b-292">次のシナリオを検討してください: ユーザーは有効な画像とパンフレットを指定する、新しいカテゴリを追加します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-292">Consider the following scenario: a user adds a new category, specifying a valid picture and brochure.</span></span> <span data-ttu-id="7ab4b-293">ポストバックが発生した挿入 ボタンをクリックし、DetailsView s に`ItemInserting`パンフレットを web サーバーのファイル システムに保存のイベントが発生します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-293">Upon clicking the Insert button, a postback occurs and the DetailsView s `ItemInserting` event fires, saving the brochure to the web server s file system.</span></span> <span data-ttu-id="7ab4b-294">次に、ObjectDataSource s`Insert()`メソッドが呼び出され、これを呼び出す、`CategoriesBLL`クラス s`InsertWithPicture`メソッドを呼び出して、 `CategoriesTableAdapter` s`InsertWithPicture`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-294">Next, the ObjectDataSource s `Insert()` method is invoked, which calls the `CategoriesBLL` class s `InsertWithPicture` method, which calls the `CategoriesTableAdapter` s `InsertWithPicture` method.</span></span>

<span data-ttu-id="7ab4b-295">ここで、データベースがオフラインの場合の動作またはでエラーがあるかどうか、 `INSERT` SQL ステートメントですか?</span><span class="sxs-lookup"><span data-stu-id="7ab4b-295">Now, what happens if the database is offline, or if there is an error in the `INSERT` SQL statement?</span></span> <span data-ttu-id="7ab4b-296">明確に、挿入は失敗し、ため、データベースに新しいカテゴリの行は追加されません。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-296">Clearly the INSERT will fail, so no new category row will be added to the database.</span></span> <span data-ttu-id="7ab4b-297">Web サーバーのファイル システム上にアップロードされたパンフレット ファイルがまだある!</span><span class="sxs-lookup"><span data-stu-id="7ab4b-297">But we still have the uploaded brochure file sitting on the web server s file system!</span></span> <span data-ttu-id="7ab4b-298">このファイルは、挿入するワークフローの間に例外の発生時に削除する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-298">This file needs to be deleted in the face of an exception during the inserting workflow.</span></span>

<span data-ttu-id="7ab4b-299">既に説明したとおり、[処理 BLL-DAL レベルでの例外および ASP.NET ページ](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md)チュートリアルでは、さまざまな層を通じたをバブル イベント アーキテクチャの深さから例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-299">As discussed previously in the [Handling BLL- and DAL-Level Exceptions in an ASP.NET Page](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md) tutorial, when an exception is thrown from within the depths of the architecture it is bubbled up through the various layers.</span></span> <span data-ttu-id="7ab4b-300">プレゼンテーション層で DetailsView s から、例外が発生したかどうかを判断できます`ItemInserted`イベント。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-300">At the Presentation Layer, we can determine if an exception has occurred from the DetailsView s `ItemInserted` event.</span></span> <span data-ttu-id="7ab4b-301">このイベント ハンドラーは、ObjectDataSource 秒の値も用意されています。`InsertParameters`です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-301">This event handler also provides the values of the ObjectDataSource s `InsertParameters`.</span></span> <span data-ttu-id="7ab4b-302">そのため、イベント ハンドラーを生み出すことができます、 `ItemInserted` ObjectDataSource 秒で指定されたファイルを削除する場合と、例外が発生した場合にチェックするイベント`brochurePath`パラメーター。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-302">Therefore, we can create an event handler for the `ItemInserted` event that checks if there was an exception and, if so, deletes the file specified by the ObjectDataSource s `brochurePath` parameter:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample13.vb)]

## <a name="summary"></a><span data-ttu-id="7ab4b-303">概要</span><span class="sxs-lookup"><span data-stu-id="7ab4b-303">Summary</span></span>

<span data-ttu-id="7ab4b-304">バイナリ データが含まれるレコードを追加するための web ベースのインターフェイスを提供するために必要なステップ数があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-304">There are a number of steps that must be performed in order to provide a web-based interface for adding records that include binary data.</span></span> <span data-ttu-id="7ab4b-305">バイナリ データは、データベースに直接格納される場合は、バイナリ データが挿入されるケースを処理する特定のメソッドを追加する、アーキテクチャを更新する必要ありますが高くなります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-305">If the binary data is being stored directly into the database, chances are you'll need to update the architecture, adding specific methods to handle the case where binary data is being inserted.</span></span> <span data-ttu-id="7ab4b-306">アーキテクチャを更新すると、次の手順はバイナリ データの各フィールドのファイルアップロード コントロールに含めるカスタマイズされた DetailsView を実現できます挿入のインターフェイスを作成しています。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-306">Once the architecture has been updated, the next step is creating the inserting interface, which can be accomplished using a DetailsView that has been customized to include a FileUpload control for each binary data field.</span></span> <span data-ttu-id="7ab4b-307">アップロードされたデータは、web サーバーのファイル システムに保存または DetailsView s でデータ ソースのパラメーターに割り当てられた`ItemInserting`イベント ハンドラー。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-307">The uploaded data can then be saved to the web server s file system or assigned to a data source parameter in the DetailsView s `ItemInserting` event handler.</span></span>

<span data-ttu-id="7ab4b-308">ファイル システムにバイナリ データを保存するには、データベースに直接データを保存するよりも詳細な計画が必要です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-308">Saving binary data to the file system requires more planning than saving data directly into the database.</span></span> <span data-ttu-id="7ab4b-309">もう 1 つの s を上書きする 1 つのユーザーのアップロードを回避するためには、名前付けスキームを選択する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-309">A naming scheme must be chosen in order to avoid one user s upload overwriting another s.</span></span> <span data-ttu-id="7ab4b-310">また、余分な手順を実行して、データベースの挿入が失敗した場合、アップロードされたファイルを削除する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-310">Also, extra steps must be taken to delete the uploaded file if the database insert fails.</span></span>

<span data-ttu-id="7ab4b-311">ようになりましたがあるパンフレットし、画像、ですがを使用してシステムに新しいカテゴリを追加する機能を既存のカテゴリのバイナリ データを更新する方法または削除済みのカテゴリのバイナリ データを正しく削除する方法を確認するには、まだ ve です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-311">We now have the ability to add new categories to the system with a brochure and picture, but we ve yet to look at how to update an existing category s binary data or how to correctly remove the binary data for a deleted category.</span></span> <span data-ttu-id="7ab4b-312">次のチュートリアルでは、これら 2 つのトピックを検討しましょう。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-312">We'll explore these two topics in the next tutorial.</span></span>

<span data-ttu-id="7ab4b-313">満足プログラミング!</span><span class="sxs-lookup"><span data-stu-id="7ab4b-313">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="7ab4b-314">作成者について</span><span class="sxs-lookup"><span data-stu-id="7ab4b-314">About the Author</span></span>

<span data-ttu-id="7ab4b-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)、7 つ受け取りますブックとの創設者の作成者[4GuysFromRolla.com](http://www.4guysfromrolla.com)、1998 年からマイクロソフトの Web テクノロジで取り組んできました。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="7ab4b-316">Scott は、コンサルタント、トレーナー、ライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-316">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="7ab4b-317">最新の著書[ *Sam 学べる自分で ASP.NET 2.0 が 24 時間以内に*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-317">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="7ab4b-318">彼に到達できる[ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)彼のブログを使用して含まれているのか[http://ScottOnWriting.NET](http://ScottOnWriting.NET)です。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-318">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="7ab4b-319">感謝の特別な</span><span class="sxs-lookup"><span data-stu-id="7ab4b-319">Special Thanks To</span></span>

<span data-ttu-id="7ab4b-320">このチュートリアルの系列は既に多くの便利なレビュー担当者によって確認済みです。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-320">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="7ab4b-321">このチュートリアルの潜在顧客レビュー担当者は、Dave ガードナー、Teresa マーフィー、および「社長補佐 Leigh でした。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-321">Lead reviewers for this tutorial were Dave Gardner, Teresa Murphy, and Bernadette Leigh.</span></span> <span data-ttu-id="7ab4b-322">今後、MSDN の記事を確認することに関心のあるですか。</span><span class="sxs-lookup"><span data-stu-id="7ab4b-322">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="7ab4b-323">場合は、ドロップ me 一度に 1 行ずつ[mitchell@4GuysFromRolla.comです。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-323">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="7ab4b-324">[前へ](displaying-binary-data-in-the-data-web-controls-vb.md)
[次へ](updating-and-deleting-existing-binary-data-vb.md)</span><span class="sxs-lookup"><span data-stu-id="7ab4b-324">[Previous](displaying-binary-data-in-the-data-web-controls-vb.md)
[Next](updating-and-deleting-existing-binary-data-vb.md)</span></span>
