---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
title: "Entity Framework 4.0 ObjectDataSource コントロールを使用して、パート 2: ビジネス ロジック層と単体テストを追加する |Microsoft ドキュメント"
author: tdykstra
description: "この一連のチュートリアルについては、Entity Framework 4.0 チュートリアル シリーズの概要を作成した Contoso 大学 web アプリケーションに基づいています。 私。。。"
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/26/2011
ms.topic: article
ms.assetid: efb0e677-10b8-48dc-93d3-9ba3902dd807
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
msc.type: authoredcontent
ms.openlocfilehash: 0440f807c7baa7b92e5f05590eca9cc237b5aef9
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/10/2017
---
<a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests"></a><span data-ttu-id="22bb1-104">Entity Framework 4.0 ObjectDataSource コントロールを使用して、パート 2: ビジネス ロジック層と単体テストを追加します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 2: Adding a Business Logic Layer and Unit Tests</span></span>
====================
<span data-ttu-id="22bb1-105">によって[Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="22bb1-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="22bb1-106">このチュートリアル シリーズのビルドによって作成される Contoso 大学 web アプリケーションで、 [Entity Framework 4.0 の概要](https://asp.net/entity-framework/tutorials#Getting%20Started)一連のチュートリアルです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="22bb1-107">前のチュートリアルを完了していない場合このチュートリアルの開始点とすることができます[アプリケーションをダウンロードして](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)作成したとします。</span><span class="sxs-lookup"><span data-stu-id="22bb1-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="22bb1-108">こともできます[アプリケーションをダウンロードして](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)一連の完全なチュートリアルで作成します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="22bb1-109">チュートリアルについて質問がある場合を投稿、 [ASP.NET Entity Framework フォーラム](https://forums.asp.net/1227.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="22bb1-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>


<span data-ttu-id="22bb1-110">前のチュートリアルでは、Entity Framework を使用して n 層の web アプリケーションを作成し、`ObjectDataSource`コントロール。</span><span class="sxs-lookup"><span data-stu-id="22bb1-110">In the previous tutorial you created an n-tier web application using the Entity Framework and the `ObjectDataSource` control.</span></span> <span data-ttu-id="22bb1-111">このチュートリアルは独立した (BLL) ビジネス ロジック層とデータ アクセス層 (DAL) を維持しながら、ビジネス ロジックを追加する方法を示し、BLL の自動化された単体テストを作成する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-111">This tutorial shows how to add business logic while keeping the business-logic layer (BLL) and the data-access layer (DAL) separate, and it shows how to create automated unit tests for the BLL.</span></span>

<span data-ttu-id="22bb1-112">このチュートリアルでは、次のタスクを完了します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-112">In this tutorial you'll complete the following tasks:</span></span>

- <span data-ttu-id="22bb1-113">必要なデータ アクセス メソッドを宣言しているリポジトリ インターフェイスを作成します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-113">Create a repository interface that declares the data-access methods you need.</span></span>
- <span data-ttu-id="22bb1-114">リポジトリ クラスには、リポジトリ インターフェイスを実装します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-114">Implement the repository interface in the repository class.</span></span>
- <span data-ttu-id="22bb1-115">クラスを呼び出し、リポジトリをデータ アクセス機能を実行するビジネス ロジックのクラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-115">Create a business-logic class that calls the repository class to perform data-access functions.</span></span>
- <span data-ttu-id="22bb1-116">接続、`ObjectDataSource`リポジトリ クラスの代わりに、ビジネス ロジック クラスを制御します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-116">Connect the `ObjectDataSource` control to the business-logic class instead of to the repository class.</span></span>
- <span data-ttu-id="22bb1-117">単体テスト プロジェクトとをそのデータ ストアのメモリ内コレクションを使用してリポジトリ クラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-117">Create a unit-test project and a repository class that uses in-memory collections for its data store.</span></span>
- <span data-ttu-id="22bb1-118">テストを実行して失敗することを確認し、ビジネス ロジックのクラスに追加するビジネス ロジックの単体テストを作成します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-118">Create a unit test for business logic that you want to add to the business-logic class, then run the test and see it fail.</span></span>
- <span data-ttu-id="22bb1-119">クラスではビジネス ロジック、ビジネス ロジックを実装し、単体テストおよびを通過するを参照してくださいを再実行します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-119">Implement the business logic in the business-logic class, then re-run the unit test and see it pass.</span></span>

<span data-ttu-id="22bb1-120">演習では、 *Departments.aspx*と*DepartmentsAdd.aspx*前のチュートリアルで作成したページ。</span><span class="sxs-lookup"><span data-stu-id="22bb1-120">You'll work with the *Departments.aspx* and *DepartmentsAdd.aspx* pages that you created in the previous tutorial.</span></span>

## <a name="creating-a-repository-interface"></a><span data-ttu-id="22bb1-121">リポジトリ インターフェイスを作成します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-121">Creating a Repository Interface</span></span>

<span data-ttu-id="22bb1-122">リポジトリ インターフェイスの作成から始めます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-122">You'll begin by creating the repository interface.</span></span>

<span data-ttu-id="22bb1-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="22bb1-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span></span>

<span data-ttu-id="22bb1-124">*DAL*フォルダーで、新しいクラス ファイルを作成、名前を付けます*ISchoolRepository.cs*、し、既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-124">In the *DAL* folder, create a new class file, name it *ISchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample1.cs)]

<span data-ttu-id="22bb1-125">インターフェイスでは、1 つのメソッドを定義ごと、CRUD (作成、読み取り、更新、削除) リポジトリ クラスで作成したメソッド。</span><span class="sxs-lookup"><span data-stu-id="22bb1-125">The interface defines one method for each of the CRUD (create, read, update, delete) methods that you created in the repository class.</span></span>

<span data-ttu-id="22bb1-126">`SchoolRepository`クラス*SchoolRepository.cs*、このクラスで実装するかを示す、`ISchoolRepository`インターフェイス。</span><span class="sxs-lookup"><span data-stu-id="22bb1-126">In the `SchoolRepository` class in *SchoolRepository.cs*, indicate that this class implements the `ISchoolRepository` interface:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample2.cs)]

## <a name="creating-a-business-logic-class"></a><span data-ttu-id="22bb1-127">ビジネス ロジックのクラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-127">Creating a Business-Logic Class</span></span>

<span data-ttu-id="22bb1-128">次に、ビジネス ロジックのクラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-128">Next, you'll create the business-logic class.</span></span> <span data-ttu-id="22bb1-129">これを行うによって実行されるビジネス ロジックを追加できるように、`ObjectDataSource`ではありませんをまだを制御します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-129">You do this so that you can add business logic that will be executed by the `ObjectDataSource` control, although you will not do that yet.</span></span> <span data-ttu-id="22bb1-130">ここでは、新しいビジネス ロジックのクラスは、リポジトリは同じの CRUD 操作のみを実行します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-130">For now, the new business-logic class will only perform the same CRUD operations that the repository does.</span></span>

<span data-ttu-id="22bb1-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="22bb1-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span></span>

<span data-ttu-id="22bb1-132">新しいフォルダーを作成し、名前を付けます*BLL*です。</span><span class="sxs-lookup"><span data-stu-id="22bb1-132">Create a new folder and name it *BLL*.</span></span> <span data-ttu-id="22bb1-133">(実際のアプリケーションでこれらのビジネス ロジック層は通常、クラス ライブラリとして実装する: 別のプロジェクト: このチュートリアルを簡潔にするに BLL クラスをプロジェクト フォルダーに保存されますが、します)。</span><span class="sxs-lookup"><span data-stu-id="22bb1-133">(In a real-world application, the business-logic layer would typically be implemented as a class library — a separate project — but to keep this tutorial simple, BLL classes will be kept in a project folder.)</span></span>

<span data-ttu-id="22bb1-134">*BLL*フォルダーで、新しいクラス ファイルを作成、名前を付けます*SchoolBL.cs*、し、既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-134">In the *BLL* folder, create a new class file, name it *SchoolBL.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample3.cs)]

<span data-ttu-id="22bb1-135">このコードは、リポジトリ クラスの前半という同じ CRUD メソッドを作成しますが、Entity Framework のメソッドを直接アクセスするには、代わりに、リポジトリ クラス メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-135">This code creates the same CRUD methods you saw earlier in the repository class, but instead of accessing the Entity Framework methods directly, it calls the repository class methods.</span></span>

<span data-ttu-id="22bb1-136">リポジトリ クラスへの参照を保持するクラスの変数は、インターフェイス型として定義され、2 つのコンス トラクターでリポジトリ クラスをインスタンス化するコードが含まれます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-136">The class variable that holds a reference to the repository class is defined as an interface type, and the code that instantiates the repository class is contained in two constructors.</span></span> <span data-ttu-id="22bb1-137">パラメーターなしのコンス トラクターで使用される、`ObjectDataSource`コントロール。</span><span class="sxs-lookup"><span data-stu-id="22bb1-137">The parameterless constructor will be used by the `ObjectDataSource` control.</span></span> <span data-ttu-id="22bb1-138">インスタンスを作成、`SchoolRepository`先ほど作成したクラスです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-138">It creates an instance of the `SchoolRepository` class that you created earlier.</span></span> <span data-ttu-id="22bb1-139">その他のコンス トラクターでは、リポジトリ インターフェイスを実装する任意のオブジェクトを渡すビジネス ロジックのクラスをインスタンス化するコードをすべてを使用します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-139">The other constructor allows whatever code that instantiates the business-logic class to pass in any object that implements the repository interface.</span></span>

<span data-ttu-id="22bb1-140">リポジトリのクラスと 2 つのコンス トラクターを呼び出す CRUD メソッドを使用すればを選択する任意のバックエンド データ ストアとビジネス ロジックのクラスを使用できます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-140">The CRUD methods that call the repository class and the two constructors make it possible to use the business-logic class with whatever back-end data store you choose.</span></span> <span data-ttu-id="22bb1-141">ビジネス ロジックのクラスは、クラスを呼び出しているが、データを保持する方法について注意する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="22bb1-141">The business-logic class does not need to be aware of how the class that it's calling persists the data.</span></span> <span data-ttu-id="22bb1-142">(これは多くの場合と呼ばれる*持続性の無視が適用*)。ビジネス ロジックのクラスを単純なものを使用してリポジトリ実装に接続するため、単体テストを容易にインメモリとして`List`データを格納するコレクション。</span><span class="sxs-lookup"><span data-stu-id="22bb1-142">(This is often called *persistence ignorance*.) This facilitates unit testing, because you can connect the business-logic class to a repository implementation that uses something as simple as in-memory `List` collections to store data.</span></span>

> [!NOTE]
> <span data-ttu-id="22bb1-143">Entity Framework から継承するクラスからそれらをインスタンス化しているためエンティティ オブジェクトがまだない永続化非依存には技術的には、`EntityObject`クラスです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-143">Technically, the entity objects are still not persistence-ignorant, because they're instantiated from classes that inherit from the Entity Framework's `EntityObject` class.</span></span> <span data-ttu-id="22bb1-144">使用できる完全な持続性の無視が適用、 *plain old CLR object*、または*した poco から*から継承するオブジェクトの代わりに、`EntityObject`クラスです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-144">For complete persistence ignorance, you can use *plain old CLR objects*, or *POCOs*, in place of objects that inherit from the `EntityObject` class.</span></span> <span data-ttu-id="22bb1-145">このチュートリアルの範囲を超えてを使用した poco からです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-145">Using POCOs is beyond the scope of this tutorial.</span></span> <span data-ttu-id="22bb1-146">詳細については、次を参照してください[テストの容易性と Entity Framework 4.0](https://msdn.microsoft.com/en-us/library/ff714955.aspx) MSDN web サイトです。)。</span><span class="sxs-lookup"><span data-stu-id="22bb1-146">For more information, see [Testability and Entity Framework 4.0](https://msdn.microsoft.com/en-us/library/ff714955.aspx) on the MSDN website.)</span></span>


<span data-ttu-id="22bb1-147">これで、接続することができます、`ObjectDataSource`にビジネス ロジックのコントロール クラスの代わりに、リポジトリへの動作を確認すべて以前と同じようです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-147">Now you can connect the `ObjectDataSource` controls to the business-logic class instead of to the repository and verify that everything works as it did before.</span></span>

<span data-ttu-id="22bb1-148">*Departments.aspx*と*DepartmentsAdd.aspx*、変更するたびに`TypeName="ContosoUniversity.DAL.SchoolRepository"`に`TypeName="ContosoUniversity.BLL.SchoolBL`"です。</span><span class="sxs-lookup"><span data-stu-id="22bb1-148">In *Departments.aspx* and *DepartmentsAdd.aspx*, change each occurrence of `TypeName="ContosoUniversity.DAL.SchoolRepository"` to `TypeName="ContosoUniversity.BLL.SchoolBL`".</span></span> <span data-ttu-id="22bb1-149">(が 4 つのインスタンスすべて。)</span><span class="sxs-lookup"><span data-stu-id="22bb1-149">(There are four instances in all.)</span></span>

<span data-ttu-id="22bb1-150">実行、 *Departments.aspx*と*DepartmentsAdd.aspx*ページがまだ動作する前に、と同じことを確認します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-150">Run the *Departments.aspx* and *DepartmentsAdd.aspx* pages to verify that they still work as they did before.</span></span>

<span data-ttu-id="22bb1-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="22bb1-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span></span>

<span data-ttu-id="22bb1-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="22bb1-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span></span>

## <a name="creating-a-unit-test-project-and-repository-implementation"></a><span data-ttu-id="22bb1-153">単体テスト プロジェクトとリポジトリの実装を作成します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-153">Creating a Unit-Test Project and Repository Implementation</span></span>

<span data-ttu-id="22bb1-154">新しいプロジェクトを使用して、ソリューションを追加、**テスト プロジェクト**テンプレート、名前を付けます`ContosoUniversity.Tests`です。</span><span class="sxs-lookup"><span data-stu-id="22bb1-154">Add a new project to the solution using the **Test Project** template, and name it `ContosoUniversity.Tests`.</span></span>

<span data-ttu-id="22bb1-155">テスト プロジェクトに参照を追加`System.Data.Entity`への参照をプロジェクトに追加し、`ContosoUniversity`プロジェクト。</span><span class="sxs-lookup"><span data-stu-id="22bb1-155">In the test project, add a reference to `System.Data.Entity` and add a project reference to the `ContosoUniversity` project.</span></span>

<span data-ttu-id="22bb1-156">単体テストで使用するリポジトリ クラスを作成できます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-156">You can now create the repository class that you'll use with unit tests.</span></span> <span data-ttu-id="22bb1-157">このリポジトリのデータ ストアは、クラスになります。</span><span class="sxs-lookup"><span data-stu-id="22bb1-157">The data store for this repository will be within the class.</span></span>

<span data-ttu-id="22bb1-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="22bb1-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span></span>

<span data-ttu-id="22bb1-159">テスト プロジェクトで、新しいクラス ファイルを作成、名前を付けます*MockSchoolRepository.cs*、し、既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-159">In the test project, create a new class file, name it *MockSchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample4.cs)]

<span data-ttu-id="22bb1-160">このリポジトリ クラスは、Entity Framework を直接にアクセスするものと同じ CRUD メソッドを含んでいますが、扱う`List`の代わりに、データベースとのメモリ内のコレクション。</span><span class="sxs-lookup"><span data-stu-id="22bb1-160">This repository class has the same CRUD methods as the one that accesses the Entity Framework directly, but they work with `List` collections in memory instead of with a database.</span></span> <span data-ttu-id="22bb1-161">設定し、ビジネス ロジックのクラスの単体テストを検証するテスト クラスのやすくなります。</span><span class="sxs-lookup"><span data-stu-id="22bb1-161">This makes it easier for a test class to set up and validate unit tests for the business-logic class.</span></span>

## <a name="creating-unit-tests"></a><span data-ttu-id="22bb1-162">単体テストの作成</span><span class="sxs-lookup"><span data-stu-id="22bb1-162">Creating Unit Tests</span></span>

<span data-ttu-id="22bb1-163">**テスト**プロジェクト テンプレートが、スタブ単体テスト クラスを作成し、次のタスクは、ビジネス ロジックのクラスに追加するビジネス ロジックに単体テスト メソッドを追加してこのクラスを変更することです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-163">The **Test** project template created a stub unit test class for you, and your next task is to modify this class by adding unit test methods to it for business logic that you want to add to the business-logic class.</span></span>

<span data-ttu-id="22bb1-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="22bb1-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span></span>

<span data-ttu-id="22bb1-165">Contoso 大学で、個々 の講師が 1 つの部門の管理者をできるだけと、この規則を強制するビジネス ロジックを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="22bb1-165">At Contoso University, any individual instructor can only be the administrator of a single department, and you need to add business logic to enforce this rule.</span></span> <span data-ttu-id="22bb1-166">テストを追加し、失敗することを確認するテストを実行してから始めます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-166">You will start by adding tests and running the tests to see them fail.</span></span> <span data-ttu-id="22bb1-167">コードを追加し、期待どおりに渡すこと、テストを再実行します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-167">You'll then add the code and rerun the tests, expecting to see them pass.</span></span>

<span data-ttu-id="22bb1-168">開く、 *UnitTest1.cs*ファイルし、追加`using`ContosoUniversity プロジェクトで作成したビジネス ロジックとデータ アクセス レイヤーのステートメント。</span><span class="sxs-lookup"><span data-stu-id="22bb1-168">Open the *UnitTest1.cs* file and add `using` statements for the business logic and data-access layers that you created in the ContosoUniversity project:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample5.cs)]

<span data-ttu-id="22bb1-169">置換、`TestMethod1`以下の方法でメソッド。</span><span class="sxs-lookup"><span data-stu-id="22bb1-169">Replace the `TestMethod1` method with the following methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample6.cs)]

<span data-ttu-id="22bb1-170">`CreateSchoolBL`メソッドは、単体テスト プロジェクトで、その後、ビジネス ロジックのクラスの新しいインスタンスを渡します用に作成したリポジトリ クラスのインスタンスを作成します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-170">The `CreateSchoolBL` method creates an instance of the repository class that you created for the unit test project, which it then passes to a new instance of the business-logic class.</span></span> <span data-ttu-id="22bb1-171">メソッドは、ビジネス ロジックのクラスを使用してテスト メソッドで使用できる 3 つの部門を挿入します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-171">The method then uses the business-logic class to insert three departments that you can use in test methods.</span></span>

<span data-ttu-id="22bb1-172">テスト メソッドは、ビジネス ロジックのクラスは、新しい部門、同じ管理者が既存の部署、としてを挿入しようとしています。 場合、またはユーザーの ID に設定することによって、部門の管理者を更新しようとしました。 例外をスローを確認してください。ユーザーは、別の部門の管理者では既にです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-172">The test methods verify that the business-logic class throws an exception if someone tries to insert a new department with the same administrator as an existing department, or if someone tries to update a department's administrator by setting it to the ID of a person who is already the administrator of another department.</span></span>

<span data-ttu-id="22bb1-173">このコードはコンパイルされません例外クラスをまだ作成されていません。</span><span class="sxs-lookup"><span data-stu-id="22bb1-173">You haven't created the exception class yet, so this code will not compile.</span></span> <span data-ttu-id="22bb1-174">コンパイルすることを得るを右クリックして`DuplicateAdministratorException`選択**生成**、し**クラス**です。</span><span class="sxs-lookup"><span data-stu-id="22bb1-174">To get it to compile, right-click `DuplicateAdministratorException` and select **Generate**, and then **Class**.</span></span>

<span data-ttu-id="22bb1-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="22bb1-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span></span>

<span data-ttu-id="22bb1-176">これは、削除することができるテスト プロジェクトでクラスが作成されますメイン プロジェクトでの例外クラスを作成した後にします。</span><span class="sxs-lookup"><span data-stu-id="22bb1-176">This creates a class in the test project which you can delete after you've created the exception class in the main project.</span></span> <span data-ttu-id="22bb1-177">ビジネス ロジックを実装します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-177">and implemented the business logic.</span></span>

<span data-ttu-id="22bb1-178">テスト プロジェクトを実行します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-178">Run the test project.</span></span> <span data-ttu-id="22bb1-179">期待どおりに、テストが失敗します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-179">As expected, the tests fail.</span></span>

<span data-ttu-id="22bb1-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="22bb1-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span></span>

## <a name="adding-business-logic-to-make-a-test-pass"></a><span data-ttu-id="22bb1-181">テストを作成するビジネス ロジックの追加</span><span class="sxs-lookup"><span data-stu-id="22bb1-181">Adding Business Logic to Make a Test Pass</span></span>

<span data-ttu-id="22bb1-182">次に、不可能では既に別の部門の管理者ユーザー、部門の管理者として設定するビジネス ロジックを実装します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-182">Next, you'll implement the business logic that makes it impossible to set as the administrator of a department someone who is already administrator of another department.</span></span> <span data-ttu-id="22bb1-183">ビジネス ロジック層から例外をスローし、それをキャッチ プレゼンテーション層で、ユーザーの部門を編集してクリックすると**更新**誰か、管理者を選択した後です。</span><span class="sxs-lookup"><span data-stu-id="22bb1-183">You'll throw an exception from the business-logic layer, and then catch it in the presentation layer if a user edits a department and clicks **Update** after selecting someone who is already an administrator.</span></span> <span data-ttu-id="22bb1-184">(、ページを表示する前に、管理者は既にドロップ ダウン リストから講習においてインストラクターを削除することもできますが、目的をここでは、ビジネス ロジック層を使用する)。</span><span class="sxs-lookup"><span data-stu-id="22bb1-184">(You could also remove instructors from the drop-down list who are already administrators before you render the page, but the purpose here is to work with the business-logic layer.)</span></span>

<span data-ttu-id="22bb1-185">まず、ユーザーが、インストラクターに 1 つ以上の部門の管理者を作成しようとするときにスローするを例外クラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-185">Start by creating the exception class that you'll throw when a user tries to make an instructor the administrator of more than one department.</span></span> <span data-ttu-id="22bb1-186">メイン プロジェクトで、新しいクラス ファイルを作成、 *BLL*フォルダー、名前を付けます*DuplicateAdministratorException.cs*、し、既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-186">In the main project, create a new class file in the *BLL* folder, name it *DuplicateAdministratorException.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample7.cs)]

<span data-ttu-id="22bb1-187">一時的な削除*DuplicateAdministratorException.cs*先ほど作成したテストのプロジェクトをコンパイルできるようにファイル。</span><span class="sxs-lookup"><span data-stu-id="22bb1-187">Now delete the temporary *DuplicateAdministratorException.cs* file that you created in the test project earlier in order to be able to compile.</span></span>

<span data-ttu-id="22bb1-188">メイン プロジェクトで、開く、 *SchoolBL.cs*ファイルし、検証ロジックを含む次のメソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-188">In the main project, open the *SchoolBL.cs* file and add the following method that contains the validation logic.</span></span> <span data-ttu-id="22bb1-189">(コードは、後で作成するメソッドを指します)。</span><span class="sxs-lookup"><span data-stu-id="22bb1-189">(The code refers to a method that you'll create later.)</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample8.cs)]

<span data-ttu-id="22bb1-190">挿入または更新するときは、このメソッドを呼び出すあります`Department`別の部門は既に同じ管理者かどうかを確認するためにエンティティです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-190">You'll call this method when you're inserting or updating `Department` entities in order to check whether another department already has the same administrator.</span></span>

<span data-ttu-id="22bb1-191">コードは、データベースで検索するメソッドを呼び出す、`Department`が同じエンティティ`Administrator`エンティティとプロパティの値が挿入または更新されました。</span><span class="sxs-lookup"><span data-stu-id="22bb1-191">The code calls a method to search the database for a `Department` entity that has the same `Administrator` property value as the entity being inserted or updated.</span></span> <span data-ttu-id="22bb1-192">1 つが見つかった場合、コードは例外をスローします。</span><span class="sxs-lookup"><span data-stu-id="22bb1-192">If one is found, the code throws an exception.</span></span> <span data-ttu-id="22bb1-193">検証チェックは必要ありません挿入または更新されたエンティティを持たない場合`Administrator`値、および例外はありませんは、更新中に、メソッドが呼び出された場合にスローされると、`Department`エンティティの一致が見つかりませんでした、`Department`更新されるエンティティです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-193">No validation check is required if the entity being inserted or updated has no `Administrator` value, and no exception is thrown if the method is called during an update and the `Department` entity found matches the `Department` entity being updated.</span></span>

<span data-ttu-id="22bb1-194">新しいメソッドを呼び出して、`Insert`と`Update`メソッド。</span><span class="sxs-lookup"><span data-stu-id="22bb1-194">Call the new method from the `Insert` and `Update` methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample9.cs)]

<span data-ttu-id="22bb1-195">*ISchoolRepository.cs*、新しいデータ アクセス メソッドの次の宣言を追加します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-195">In *ISchoolRepository.cs*, add the following declaration for the new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample10.cs)]

<span data-ttu-id="22bb1-196">*SchoolRepository.cs*、次の追加`using`ステートメント。</span><span class="sxs-lookup"><span data-stu-id="22bb1-196">In *SchoolRepository.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample11.cs)]

<span data-ttu-id="22bb1-197">*SchoolRepository.cs*、次の新しいデータ アクセス メソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-197">In *SchoolRepository.cs*, add the following new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample12.cs)]

<span data-ttu-id="22bb1-198">このコードを取得`Department`を指定した管理者を持つエンティティ。</span><span class="sxs-lookup"><span data-stu-id="22bb1-198">This code retrieves `Department` entities that have a specified administrator.</span></span> <span data-ttu-id="22bb1-199">(存在する場合) は、1 つだけの部門を探す必要があります。</span><span class="sxs-lookup"><span data-stu-id="22bb1-199">Only one department should be found (if any).</span></span> <span data-ttu-id="22bb1-200">ただし、データベースに組み込まれている制約はありません、ため戻り値の型は、コレクション複数部門にある場合です。</span><span class="sxs-lookup"><span data-stu-id="22bb1-200">However, because no constraint is built into the database, the return type is a collection in case multiple departments are found.</span></span>

<span data-ttu-id="22bb1-201">既定では、オブジェクト コンテキストは、データベースからエンティティを取得するときの追跡にそのオブジェクトの状態マネージャーにします。</span><span class="sxs-lookup"><span data-stu-id="22bb1-201">By default, when the object context retrieves entities from the database, it keeps track of them in its object state manager.</span></span> <span data-ttu-id="22bb1-202">`MergeOption.NoTracking`パラメーターは、この追跡がこのクエリに対して実行されませんされることを指定します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-202">The `MergeOption.NoTracking` parameter specifies that this tracking will not be done for this query.</span></span> <span data-ttu-id="22bb1-203">これは、クエリを更新しようとしている厳密なエンティティを返す場合がありしていないことができますをそのエンティティをアタッチします。</span><span class="sxs-lookup"><span data-stu-id="22bb1-203">This is necessary because the query might return the exact entity that you're trying to update, and then you would not be able to attach that entity.</span></span> <span data-ttu-id="22bb1-204">履歴の部門を編集する場合など、 *Departments.aspx*ページと、管理者が変更されないように、このクエリは履歴部門を返します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-204">For example, if you edit the History department in the *Departments.aspx* page and leave the administrator unchanged, this query will return the History department.</span></span> <span data-ttu-id="22bb1-205">場合`NoTracking`設定された場合、オブジェクト コンテキストは既に存在して履歴部門 エンティティのオブジェクト状態マネージャーではありません。</span><span class="sxs-lookup"><span data-stu-id="22bb1-205">If `NoTracking` is not set, the object context would already have the History department entity in its object state manager.</span></span> <span data-ttu-id="22bb1-206">オブジェクト コンテキストという例外をスローした場合、状態の表示から再作成される履歴 department エンティティをアタッチする際に、`"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`です。</span><span class="sxs-lookup"><span data-stu-id="22bb1-206">Then when you attach the History department entity that's re-created from view state, the object context would throw an exception that says `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span></span>

<span data-ttu-id="22bb1-207">(代わりを指定する`MergeOption.NoTracking`、このクエリにのみ新しいオブジェクト コンテキストを作成する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="22bb1-207">(As an alternative to specifying `MergeOption.NoTracking`, you could create a new object context just for this query.</span></span> <span data-ttu-id="22bb1-208">新しいオブジェクト コンテキストは、独自のオブジェクト状態マネージャーがあることはない競合を呼び出すとき、`Attach`メソッドです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-208">Because the new object context would have its own object state manager, there would be no conflict when you call the `Attach` method.</span></span> <span data-ttu-id="22bb1-209">新しいオブジェクト コンテキストはこの代替方法のパフォーマンスの低下が最小限に抑えるため、元のオブジェクト コンテキストにメタデータとデータベースの接続を共有するは。</span><span class="sxs-lookup"><span data-stu-id="22bb1-209">The new object context would share metadata and database connection with the original object context, so the performance penalty of this alternate approach would be minimal.</span></span> <span data-ttu-id="22bb1-210">ただし、ここに示す方法が導入されて、`NoTracking`オプション、他のコンテキストで役に立ちますを見つけることができます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-210">The approach shown here, however, introduces the `NoTracking` option, which you'll find useful in other contexts.</span></span> <span data-ttu-id="22bb1-211">`NoTracking`オプションが説明したこのシリーズの後のチュートリアルでこれ以上です)。</span><span class="sxs-lookup"><span data-stu-id="22bb1-211">The `NoTracking` option is discussed further in a later tutorial in this series.)</span></span>

<span data-ttu-id="22bb1-212">テスト プロジェクトで、新しいデータ アクセスにメソッドを追加*MockSchoolRepository.cs*:</span><span class="sxs-lookup"><span data-stu-id="22bb1-212">In the test project, add the new data-access method to *MockSchoolRepository.cs*:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample13.cs)]

<span data-ttu-id="22bb1-213">このコードでは、LINQ を使用して、同じデータの選択を実行する、`ContosoUniversity`プロジェクト リポジトリが使用する LINQ to Entities のです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-213">This code uses LINQ to perform the same data selection that the `ContosoUniversity` project repository uses LINQ to Entities for.</span></span>

<span data-ttu-id="22bb1-214">テスト プロジェクトを再度実行します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-214">Run the test project again.</span></span> <span data-ttu-id="22bb1-215">今回はテストに合格します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-215">This time the tests pass.</span></span>

<span data-ttu-id="22bb1-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="22bb1-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span></span>

## <a name="handling-objectdatasource-exceptions"></a><span data-ttu-id="22bb1-217">ObjectDataSource 例外を処理</span><span class="sxs-lookup"><span data-stu-id="22bb1-217">Handling ObjectDataSource Exceptions</span></span>

<span data-ttu-id="22bb1-218">`ContosoUniversity`プロジェクト、実行、 *Departments.aspx*ページに変更しようとする部門の管理者は、ユーザーは既に別の部門の管理者にします。</span><span class="sxs-lookup"><span data-stu-id="22bb1-218">In the `ContosoUniversity` project, run the *Departments.aspx* page and try to change the administrator for a department to someone who is already administrator for another department.</span></span> <span data-ttu-id="22bb1-219">(データベースが無効なデータを事前に読み込んでになるために、のみ、このチュートリアル中に追加した部門を編集することに注意してください)。次のサーバー エラー ページを取得します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-219">(Remember that you can only edit departments that you added during this tutorial, because the database comes preloaded with invalid data.) You get the following server error page:</span></span>

<span data-ttu-id="22bb1-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="22bb1-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span></span>

<span data-ttu-id="22bb1-221">しないようにするため、エラー処理コードを追加する必要があります。 この種のエラー ページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="22bb1-221">You don't want users to see this kind of error page, so you need to add error-handling code.</span></span> <span data-ttu-id="22bb1-222">開いている*Departments.aspx*のハンドラーを指定し、`OnUpdated`のイベント、`DepartmentsObjectDataSource`です。</span><span class="sxs-lookup"><span data-stu-id="22bb1-222">Open *Departments.aspx* and specify a handler for the `OnUpdated` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="22bb1-223">`ObjectDataSource`開始タグを今すぐには、次の例と似ています。</span><span class="sxs-lookup"><span data-stu-id="22bb1-223">The `ObjectDataSource` opening tag now resembles the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample14.aspx)]

<span data-ttu-id="22bb1-224">*Departments.aspx.cs*、次の追加`using`ステートメント。</span><span class="sxs-lookup"><span data-stu-id="22bb1-224">In *Departments.aspx.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample15.cs)]

<span data-ttu-id="22bb1-225">次のハンドラーを追加、`Updated`イベント。</span><span class="sxs-lookup"><span data-stu-id="22bb1-225">Add the following handler for the `Updated` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample16.cs)]

<span data-ttu-id="22bb1-226">場合、`ObjectDataSource`コントロールは、更新を実行するときに例外をキャッチ、イベント引数は、例外を渡します (`e`) をこのハンドラーにします。</span><span class="sxs-lookup"><span data-stu-id="22bb1-226">If the `ObjectDataSource` control catches an exception when it tries to perform the update, it passes the exception in the event argument (`e`) to this handler.</span></span> <span data-ttu-id="22bb1-227">ハンドラーのコードは、かどうかは、例外が重複している管理者は、例外を確認します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-227">The code in the handler checks to see if the exception is the duplicate administrator exception.</span></span> <span data-ttu-id="22bb1-228">コードがエラー メッセージを含む検証コントロールを作成する場合は、`ValidationSummary`コントロールに表示します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-228">If it is, the code creates a validator control that contains an error message for the `ValidationSummary` control to display.</span></span>

<span data-ttu-id="22bb1-229">ページを実行し、ユーザーが 2 つの部門の管理者は、再度するしようとしてください。</span><span class="sxs-lookup"><span data-stu-id="22bb1-229">Run the page and attempt to make someone the administrator of two departments again.</span></span> <span data-ttu-id="22bb1-230">この時間、`ValidationSummary`コントロールには、エラー メッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-230">This time the `ValidationSummary` control displays an error message.</span></span>

<span data-ttu-id="22bb1-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="22bb1-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span></span>

<span data-ttu-id="22bb1-232">同様に変更を*DepartmentsAdd.aspx*ページ。</span><span class="sxs-lookup"><span data-stu-id="22bb1-232">Make similar changes to the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="22bb1-233">*DepartmentsAdd.aspx*のハンドラーを指定、`OnInserted`のイベント、`DepartmentsObjectDataSource`です。</span><span class="sxs-lookup"><span data-stu-id="22bb1-233">In *DepartmentsAdd.aspx*, specify a handler for the `OnInserted` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="22bb1-234">結果として得られるマークアップは、次の例ようになります。</span><span class="sxs-lookup"><span data-stu-id="22bb1-234">The resulting markup will resemble the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample17.aspx)]

<span data-ttu-id="22bb1-235">*DepartmentsAdd.aspx.cs*、同じ追加`using`ステートメント。</span><span class="sxs-lookup"><span data-stu-id="22bb1-235">In *DepartmentsAdd.aspx.cs*, add the same `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample18.cs)]

<span data-ttu-id="22bb1-236">次のイベント ハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-236">Add the following event handler:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample19.cs)]

<span data-ttu-id="22bb1-237">テストして、 *DepartmentsAdd.aspx.cs*ページを 1 つ以上の部門の管理者は、1 人のユーザーを実行する試行も正しく処理することを確認します。</span><span class="sxs-lookup"><span data-stu-id="22bb1-237">You can now test the *DepartmentsAdd.aspx.cs* page to verify that it also correctly handles attempts to make one person the administrator of more than one department.</span></span>

<span data-ttu-id="22bb1-238">これで完了、リポジトリ パターンを使用するための実装の概要、 `ObjectDataSource` Entity Framework でのコントロールです。</span><span class="sxs-lookup"><span data-stu-id="22bb1-238">This completes the introduction to implementing the repository pattern for using the `ObjectDataSource` control with the Entity Framework.</span></span> <span data-ttu-id="22bb1-239">詳細については、リポジトリ パターンとテストの容易性は、MSDN のホワイト ペーパーを参照してください。[テストの容易性と Entity Framework 4.0](https://msdn.microsoft.com/en-us/library/ff714955.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="22bb1-239">For more information about the repository pattern and testability, see the MSDN whitepaper [Testability and Entity Framework 4.0](https://msdn.microsoft.com/en-us/library/ff714955.aspx).</span></span>

<span data-ttu-id="22bb1-240">次のチュートリアルでは、並べ替えおよびフィルター処理をアプリケーションに機能を追加する方法が表示されます。</span><span class="sxs-lookup"><span data-stu-id="22bb1-240">In the following tutorial you'll see how to add sorting and filtering functionality to the application.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="22bb1-241">[前へ](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[次へ](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span><span class="sxs-lookup"><span data-stu-id="22bb1-241">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Next](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span></span>
